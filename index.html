<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- Version: 2025.07.13 - Latest with 60 endings and dialogue fixes -->
    <title>SYNAPSE</title>
    <link rel="icon" type="image/png" href="./Icon.png">
    <script>
        // Only load manifest on HTTP/HTTPS protocols to avoid CORS errors
        if (window.location.protocol !== 'file:') {
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = './manifest.json';
            document.head.appendChild(manifestLink);
        }
        
        // Suppress Tailwind CDN production warning
        if (typeof console !== 'undefined' && console.warn) {
            const originalWarn = console.warn;
            console.warn = function(message) {
                if (typeof message === 'string' && message.includes('cdn.tailwindcss.com should not be used in production')) {
                    return; // Suppress this specific warning
                }
                originalWarn.apply(console, arguments);
            };
        }
    </script>
    <script src="https://cdn.tailwindcss.com" onerror="console.error('Failed to load Tailwind CSS')"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=VT323&family=Space+Mono&family=Courier+Prime&display=swap" rel="stylesheet" onerror="console.error('Failed to load Google Fonts')">
    <script src="https://unpkg.com/tone@15.0.4/build/Tone.js" onerror="console.error('Failed to load Tone.js')"></script>
    <style>
        :root {
            --main-color: #00ff41;
            --main-color-faded: rgba(0,255,65,0.1);
            --main-color-border: rgba(0,255,65,0.8);
            --main-color-shadow: rgba(0,255,65,0.5);
            --main-color-glow: rgba(0,255,65,0.7);
        }
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-size: clamp(14px, 1.5vw, 18px); 
        }
        body {
            background-color: #0d0d0d;
            color: var(--main-color);
            font-family: 'Space Mono', monospace;
            position: fixed; 
        }
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.1;
        }
        /* === CORE LAYOUT & VIEWPORT HANDLING === */
        * {
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: relative;
        }
        
        /* Support for CSS custom properties and viewport units */
        :root {
            --vh: 1vh;
            --vw: 1vw;
        }
        
        /* Dynamic viewport height handling for mobile devices */
        @supports (-webkit-touch-callout: none) {
            :root {
                --vh: calc(var(--vh, 1vh) * 0.01);
            }
        }
        
        #app-container {
            position: relative;
            z-index: 1;
            width: 100vw;
            width: calc(var(--vw, 1vw) * 100);
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            min-height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
        }
        
        /* Enhanced responsive breakpoints */
        @media screen and (max-width: 320px) {
            #app-container { padding: 0.25rem; }
            .text-20xl { font-size: 8rem; }
            .text-24xl { font-size: 10rem; }
            .text-28xl { font-size: 10rem; }
            .text-8xl-2 { font-size: 4rem; }
            .text-12xl { font-size: 5rem; }
            .text-14xl { font-size: 5rem; }
        }
        
        @media screen and (min-width: 321px) and (max-width: 480px) {
            #app-container { padding: 0.5rem; }
            .text-20xl { font-size: 10rem; }
            .text-24xl { font-size: 12rem; }
            .text-28xl { font-size: 12rem; }
            .text-8xl-2 { font-size: 5rem; }
            .text-12xl { font-size: 6rem; }
            .text-14xl { font-size: 6rem; }
        }
        
        @media screen and (min-width: 481px) and (max-width: 768px) {
            #app-container { padding: 0.75rem; }
        }
        
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            #app-container { padding: 1rem; }
        }
        
        @media screen and (min-width: 1025px) and (max-width: 1440px) {
            #app-container { padding: 1.25rem; }
        }
        
        @media screen and (min-width: 1441px) {
            #app-container { padding: 1.5rem; }
        }
        
        /* Ultra-wide screen adjustments */
        @media screen and (min-aspect-ratio: 21/9) {
            .max-w-4xl { max-width: 60rem; }
            #intro-text-container { max-width: 50rem; }
        }
        
        /* Very tall screen adjustments */
        @media screen and (min-aspect-ratio: 1/2) {
            .title-wrapper { margin-top: -8rem; }
            .title-wrapper h1 { font-size: 5rem; }
            .title-wrapper h2 { font-size: 1.5rem; }
        }
        
        /* Game screen specific adjustments */
        #game-screen .flex-grow {
            height: calc(100vh - 8rem);
            height: calc(var(--vh, 1vh) * 100 - 8rem);
        }
        
        /* Modal responsive adjustments */
        .modal-content { 
            background-color: #0d0d0d; 
            border: 2px solid var(--main-color); 
            padding: 1rem; 
            border-radius: 0.5rem; 
            max-width: min(48rem, 95vw); 
            width: 100%; 
            text-align: center; 
            animation: scaleUp 0.3s ease-out; 
            max-height: min(90vh, calc(var(--vh, 1vh) * 90)); 
            display: flex; 
            flex-direction: column;
            margin: 1rem;
        }
        
        @media screen and (max-width: 480px) {
            .modal-content { 
                padding: 0.75rem; 
                margin: 0.5rem;
                max-width: calc(100vw - 1rem);
            }
        }
        
        /* Dynamic responsive classes added by JavaScript */
        .ultra-wide .max-w-4xl {
            max-width: 70rem;
        }
        
        .ultra-wide #intro-text-container {
            max-width: 60rem;
        }
        
        .very-tall .title-wrapper {
            margin-top: -12rem;
        }
        
        .very-tall .title-wrapper h1 {
            font-size: 4rem !important;
        }
        
        .very-tall .title-wrapper h2 {
            font-size: 1.25rem !important;
        }
        
        .small-screen #app-container {
            padding: 0.25rem !important;
        }
        
        .small-screen .text-20xl {
            font-size: 7rem !important;
        }
        
        .small-screen .text-24xl {
            font-size: 9rem !important;
        }
        
        .small-screen .text-28xl {
            font-size: 9rem !important;
        }
        
        .small-screen .text-8xl-2 {
            font-size: 3.5rem !important;
        }
        
        .small-screen .text-12xl {
            font-size: 4rem !important;
        }
        
        .small-screen .text-14xl {
            font-size: 4.5rem !important;
        }
        
        .small-screen .text-6xl {
            font-size: 2rem !important;
        }
        
        .small-screen .text-7xl {
            font-size: 2.5rem !important;
        }
        
        .small-screen .text-8xl {
            font-size: 3rem !important;
        }
        
        .small-screen .text-2xl {
            font-size: 1rem !important;
        }
        
        .small-screen .text-3xl {
            font-size: 1.25rem !important;
        }
        
        .small-screen .text-4xl {
            font-size: 1.5rem !important;
        }
        
        /* Ensure game screens fill properly */
        #start-screen, #player-setup, #game-screen {
            min-height: 100%;
            height: 100%;
        }
        
        /* Background canvas adjustments */
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            pointer-events: none;
        }
        
        /* Character creation screen specific adjustments */
        #player-setup .title-wrapper h1 {
            line-height: 1.1;
        }
        
        #player-setup .title-wrapper h2 {
            line-height: 1.2;
        }
        
        @media screen and (max-height: 700px) {
            #player-setup .title-wrapper h1 {
                font-size: 4rem !important;
            }
            
            #player-setup .title-wrapper h2 {
                font-size: 1.5rem !important;
            }
            
            #player-setup .max-w-4xl {
                margin-top: 1rem !important;
            }
            
            #player-setup .mt-4 {
                margin-top: 1rem !important;
            }
        }
        
        @media screen and (max-height: 600px) {
            #player-setup .title-wrapper {
                margin-top: -4rem !important;
            }
            
            #player-setup .title-wrapper h1 {
                font-size: 3rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            #player-setup .title-wrapper h2 {
                font-size: 1.25rem !important;
                margin-bottom: 1rem !important;
            }
            
            #player-setup .max-w-4xl {
                margin-top: 0.5rem !important;
            }
            
            #player-setup .mb-4 {
                margin-bottom: 0.5rem !important;
            }
        }
        
        @media screen and (max-width: 480px) {
            #player-setup .flex-wrap {
                gap: 0.5rem !important;
            }
            
            #player-setup input {
                width: 12rem !important;
            }
        }
        
        /* Custom massive title sizes for doubled effect */
        .text-16xl {
            font-size: min(16rem, 50vw);
            line-height: 0.8;
        }
        
        .text-20xl {
            font-size: min(20rem, 60vw);
            line-height: 0.8;
        }
        
        .text-22xl {
            font-size: min(22rem, 65vw);
            line-height: 0.8;
        }
        
        .text-24xl {
            font-size: min(24rem, 70vw);
            line-height: 0.8;
        }
        
        .text-28xl {
            font-size: min(28rem, 80vw);
            line-height: 0.8;
        }
        
        .text-50xl {
            font-size: min(50rem, 90vw);
            line-height: 0.7;
        }
        
        .text-64xl {
            font-size: min(64rem, 95vw);
            line-height: 0.7;
        }
        
        .text-78xl {
            font-size: min(78rem, 98vw);
            line-height: 0.7;
        }
        
        .text-12xl {
            font-size: min(12rem, 40vw);
            line-height: 0.8;
        }
        
        .text-14xl {
            font-size: min(14rem, 45vw);
            line-height: 0.8;
        }
        
        .text-18xl {
            font-size: min(18rem, 55vw);
            line-height: 0.8;
        }
        
        .text-6xl-2 {
            font-size: min(6rem, 20vw);
            line-height: 0.9;
        }
        
        .text-8xl-2 {
            font-size: min(12rem, 35vw);
            line-height: 0.9;
        }
        
        .text-10xl-2 {
            font-size: min(14rem, 40vw);
            line-height: 0.9;
        }
        body.crt-effect::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: rgba(18, 16, 16, 0.1);
            opacity: .5;
            z-index: 2;
            pointer-events: none;
            background: repeating-linear-gradient(0deg, rgba(0, 255, 65, 0.15), rgba(0, 255, 65, 0.15) 1px, transparent 1px, transparent 2px);
        }
        .title-font {
            font-family: 'VT323', monospace;
        }

        .title-wrapper {
            position: relative;
        }
        
        /* Main green text layer */
        .title-slasher {
            font-family: 'Creepster', cursive;
            color: #39FF14;
            letter-spacing: 0.1em;
            position: relative;
            z-index: 2; 
            /* Original green text glow */
            text-shadow: 
                0 0 5px #39FF14, 
                0 0 10px #39FF14;
        }

        /* The blood layer behind the text */
        .title-slasher::before {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            color: transparent; 
            z-index: 1; 
            animation: liquid-drip-back 8s infinite ease-out;
            filter: 
                drop-shadow(0 0 3px #8B0000) 
                drop-shadow(0 0 8px #B22222) 
                drop-shadow(0 0 15px #DC143C)
                drop-shadow(0 0 25px #FF6347);
        }

        /* The blood layer in front of the text */
        .title-slasher::after {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            color: transparent; 
            z-index: 3; 
            animation: liquid-drip-front 8s infinite ease-out 2s;
            filter: 
                drop-shadow(0 0 3px #8B0000) 
                drop-shadow(0 0 8px #B22222) 
                drop-shadow(0 0 15px #DC143C)
                drop-shadow(0 0 25px #FF6347);
            opacity: 0.8;
        }

        @keyframes liquid-drip-back {
            0% { 
                text-shadow: 
                    0px 0px 0px #8B0000,
                    1px 1px 0px #8B0000,
                    2px 2px 0px #8B0000,
                    0 0 3px #B22222,
                    0 0 6px #DC143C; 
                opacity: 1; 
                transform: translateY(0px);
            }
            15% {
                text-shadow: 
                    0px 2px 1px #8B0000,
                    1px 3px 1px #800000,
                    2px 4px 1px #660000,
                    0 5px 4px #B22222,
                    0 8px 8px #DC143C,
                    -1px 10px 3px #8B0000; 
                opacity: 1;
                transform: translateY(1px);
            }
            35% {
                text-shadow: 
                    0px 5px 2px #8B0000,
                    1px 8px 2px #800000,
                    2px 12px 2px #660000,
                    0 15px 6px #B22222,
                    0 20px 12px #DC143C,
                    -2px 18px 4px #8B0000,
                    3px 22px 4px #800000; 
                opacity: 0.95;
                transform: translateY(3px);
            }
            50% { 
                text-shadow: 
                    0px 8px 3px #8B0000,
                    1px 15px 3px #800000,
                    2px 20px 3px #660000,
                    0 25px 8px #B22222,
                    0 35px 15px #DC143C,
                    -3px 30px 5px #8B0000,
                    4px 38px 5px #800000,
                    -2px 42px 6px #660000; 
                opacity: 0.9; 
                transform: translateY(5px);
            }
            70% {
                text-shadow: 
                    0px 12px 4px rgba(139,0,0,0.8),
                    1px 25px 4px rgba(128,0,0,0.7),
                    2px 35px 4px rgba(102,0,0,0.6),
                    0 45px 10px rgba(178,34,34,0.6),
                    0 55px 18px rgba(220,20,60,0.5),
                    -4px 50px 6px rgba(139,0,0,0.5),
                    5px 60px 6px rgba(128,0,0,0.4),
                    -3px 65px 8px rgba(102,0,0,0.3); 
                opacity: 0.8;
                transform: translateY(8px);
            }
            85% { 
                text-shadow: 
                    0px 15px 5px rgba(139,0,0,0.4),
                    1px 35px 5px rgba(128,0,0,0.3),
                    2px 50px 5px rgba(102,0,0,0.2),
                    0 65px 12px rgba(178,34,34,0.3),
                    0 80px 20px rgba(220,20,60,0.2),
                    -5px 70px 8px rgba(139,0,0,0.2),
                    6px 85px 8px rgba(128,0,0,0.1),
                    -4px 90px 10px rgba(102,0,0,0.1); 
                opacity: 0.6;
                transform: translateY(12px);
            }
            100% { 
                text-shadow: 
                    0px 20px 6px transparent,
                    1px 45px 6px transparent,
                    2px 65px 6px transparent,
                    0 85px 15px transparent,
                    0 105px 25px transparent,
                    -6px 95px 10px transparent,
                    7px 110px 10px transparent,
                    -5px 115px 12px transparent; 
                opacity: 0;
                transform: translateY(15px);
            }
        }

        @keyframes liquid-drip-front {
            0% { 
                text-shadow: 
                    0px 0px 0px #8B0000,
                    -1px 1px 0px #8B0000,
                    1px 2px 0px #8B0000,
                    0 0 3px #B22222,
                    0 0 6px #DC143C; 
                opacity: 0.9; 
                transform: translateY(0px);
            }
            20% {
                text-shadow: 
                    0px 3px 1px #8B0000,
                    -1px 4px 1px #800000,
                    1px 5px 1px #660000,
                    0 7px 4px #B22222,
                    0 10px 8px #DC143C,
                    2px 12px 3px #8B0000; 
                opacity: 0.9;
                transform: translateY(2px);
            }
            40% {
                text-shadow: 
                    0px 7px 2px #8B0000,
                    -1px 10px 2px #800000,
                    1px 14px 2px #660000,
                    0 18px 6px #B22222,
                    0 25px 12px #DC143C,
                    3px 20px 4px #8B0000,
                    -2px 24px 4px #800000; 
                opacity: 0.85;
                transform: translateY(4px);
            }
            60% { 
                text-shadow: 
                    0px 12px 3px #8B0000,
                    -1px 18px 3px #800000,
                    1px 22px 3px #660000,
                    0 30px 8px #B22222,
                    0 40px 15px #DC143C,
                    4px 35px 5px #8B0000,
                    -3px 42px 5px #800000,
                    2px 48px 6px #660000; 
                opacity: 0.8; 
                transform: translateY(7px);
            }
            80% {
                text-shadow: 
                    0px 18px 4px rgba(139,0,0,0.7),
                    -1px 28px 4px rgba(128,0,0,0.6),
                    1px 38px 4px rgba(102,0,0,0.5),
                    0 50px 10px rgba(178,34,34,0.5),
                    0 65px 18px rgba(220,20,60,0.4),
                    5px 55px 6px rgba(139,0,0,0.4),
                    -4px 68px 6px rgba(128,0,0,0.3),
                    3px 75px 8px rgba(102,0,0,0.2); 
                opacity: 0.6;
                transform: translateY(10px);
            }
            90% { 
                text-shadow: 
                    0px 22px 5px rgba(139,0,0,0.3),
                    -1px 40px 5px rgba(128,0,0,0.2),
                    1px 55px 5px rgba(102,0,0,0.15),
                    0 70px 12px rgba(178,34,34,0.2),
                    0 90px 20px rgba(220,20,60,0.15),
                    6px 80px 8px rgba(139,0,0,0.15),
                    -5px 95px 8px rgba(128,0,0,0.1),
                    4px 105px 10px rgba(102,0,0,0.05); 
                opacity: 0.4;
                transform: translateY(14px);
            }
            100% { 
                text-shadow: 
                    0px 25px 6px transparent,
                    -1px 50px 6px transparent,
                    1px 70px 6px transparent,
                    0 90px 15px transparent,
                    0 115px 25px transparent,
                    7px 105px 10px transparent,
                    -6px 120px 10px transparent,
                    5px 130px 12px transparent; 
                opacity: 0;
                transform: translateY(18px);
            }
        }

        /* Subtitle with merged blood drip effect into the text */
        .subtitle-slasher {
            font-family: 'Creepster', cursive;
            letter-spacing: 0.1em;
            position: relative;
            z-index: 2; 
            /* Fallback color for browsers that don't support background-clip */
            color: #ff0000;
            /* Blood-merged text effect with green visibility enhancement */
            background: linear-gradient(to bottom, 
                #ff0000 0%, 
                #ff0000 20%, 
                #8B0000 40%, 
                #B22222 60%, 
                #DC143C 80%, 
                #660000 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 100% 300%;
            animation: blood-merge-drip-with-green 8s infinite ease-out;
            filter: 
                drop-shadow(0 0 3px #8B0000) 
                drop-shadow(0 0 8px #B22222) 
                drop-shadow(0 0 15px #DC143C);
            /* Ensure text shadow for visibility */
            text-shadow: 
                0 0 5px #ff0000, 
                0 0 10px #ff0000;
        }

        @keyframes blood-merge-drip-with-green {
            0% { 
                background: linear-gradient(to bottom, 
                    #ff0000 0%, #ff0000 20%, #8B0000 40%, #B22222 60%, #DC143C 80%, #660000 100%);
                background-clip: text;
                -webkit-background-clip: text;
                background-position: 0% 0%;
                filter: 
                    drop-shadow(0 0 3px #ff0000)
                    drop-shadow(0 0 6px #8B0000);
                transform: translateY(0px);
            }
            25% {
                background: linear-gradient(to bottom, 
                    #39FF14 0%, #ff0000 15%, #8B0000 35%, #B22222 55%, #DC143C 75%, #660000 100%);
                background-clip: text;
                -webkit-background-clip: text;
                background-position: 0% 25%;
                filter: 
                    drop-shadow(0 2px 5px #8B0000) 
                    drop-shadow(0 0 8px #B22222)
                    drop-shadow(0 0 12px #DC143C)
                    drop-shadow(0 0 5px #39FF14);
                transform: translateY(1px);
            }
            50% { 
                background: linear-gradient(to bottom, 
                    #39FF14 0%, #39FF14 10%, #ff0000 30%, #8B0000 50%, #B22222 70%, #DC143C 85%, #660000 100%);
                background-clip: text;
                -webkit-background-clip: text;
                background-position: 0% 50%;
                filter: 
                    drop-shadow(0 4px 8px #8B0000) 
                    drop-shadow(0 0 12px #DC143C)
                    drop-shadow(0 0 18px #B22222)
                    drop-shadow(0 0 8px #39FF14);
                transform: translateY(2px);
            }
            75% {
                background: linear-gradient(to bottom, 
                    #39FF14 0%, #39FF14 15%, #ff0000 25%, #8B0000 45%, #B22222 65%, #DC143C 80%, #660000 100%);
                background-clip: text;
                -webkit-background-clip: text;
                background-position: 0% 75%;
                filter: 
                    drop-shadow(0 6px 12px rgba(139,0,0,0.8)) 
                    drop-shadow(0 0 15px #B22222)
                    drop-shadow(0 0 25px rgba(220,20,60,0.6))
                    drop-shadow(0 0 10px #39FF14);
                transform: translateY(3px);
            }
            100% { 
                background: linear-gradient(to bottom, 
                    #39FF14 0%, #39FF14 20%, #ff0000 30%, #8B0000 50%, #B22222 70%, #DC143C 85%, #660000 100%);
                background-clip: text;
                -webkit-background-clip: text;
                background-position: 0% 100%;
                filter: 
                    drop-shadow(0 8px 15px rgba(139,0,0,0.6)) 
                    drop-shadow(0 0 20px rgba(220,20,60,0.8))
                    drop-shadow(0 0 30px rgba(255,99,71,0.4))
                    drop-shadow(0 0 12px #39FF14);
                transform: translateY(4px);
            }
        }

        /* Mobile scroll improvements */
        @media (max-width: 768px) {
            .game-interface {
                height: 100vh;
                overflow: hidden;
            }
            
            #game-output {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                max-height: calc(100vh - 200px);
            }
            
            .mobile-scroll-indicator {
                position: fixed;
                bottom: 80px;
                right: 10px;
                background: rgba(0, 255, 65, 0.2);
                border: 1px solid var(--main-color);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                animation: pulse-scroll 2s infinite;
            }
            
            @keyframes pulse-scroll {
                0%, 100% { opacity: 0.6; transform: scale(1); }
                50% { opacity: 1; transform: scale(1.1); }
            }
            
            .side-panel {
                max-height: 40vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        .btn-drip { position: relative; z-index: 1; }
        .btn-drip::before {
            content: attr(data-text);
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            color: transparent; z-index: -1;
            filter: drop-shadow(0 0 2px #ff0000) drop-shadow(0 0 5px #d40000);
            animation: button-drip-anim 5s infinite ease-out;
            font-family: inherit; font-size: inherit; letter-spacing: inherit;
            display: flex; align-items: center; justify-content: center; padding: inherit;
        }

        @keyframes button-drip-anim {
            0% { text-shadow: 1px 1px 0px #600, 0 0 2px #d00, 0px 0px 0px #400; opacity: 1; }
            50% { text-shadow: 1px 1px 0px #600, 0 0 2px #d00, 0px 10px 5px #400, -2px 15px 6px #300; opacity: 1; }
            90% { text-shadow: 1px 1px 0px rgba(102,0,0,0.2), 0 0 2px rgba(221,0,0,0.5), 0px 18px 10px rgba(68,0,0,0.1), -2px 22px 12px rgba(51,0,0,0.05); opacity: 0.8; }
            100% { text-shadow: 1px 1px 0px transparent, 0 0 2px transparent, 0px 20px 15px transparent, -2px 25px 15px transparent; opacity: 0; }
        }

        .input-caret {
            background-color: var(--main-color);
            width: 10px; height: 20px; animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: var(--main-color); }
        }
        #game-output::-webkit-scrollbar, #journal-panel::-webkit-scrollbar, #objectives-panel::-webkit-scrollbar, .modal-scroll::-webkit-scrollbar { width: 8px; }
        #game-output::-webkit-scrollbar-track, #journal-panel::-webkit-scrollbar-track, #objectives-panel::-webkit-scrollbar-track, .modal-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        #game-output::-webkit-scrollbar-thumb, #journal-panel::-webkit-scrollbar-thumb, #objectives-panel::-webkit-scrollbar-thumb, .modal-scroll::-webkit-scrollbar-thumb { background-color: var(--main-color); border-radius: 4px; }
        .glitch { animation: glitch-anim 1.5s infinite alternate-reverse; }
        @keyframes glitch-anim {
          0% { transform: translate(0); clip-path: inset(45% 0 50% 0); } 5% { transform: translate(2px, -3px); clip-path: inset(25% 0 35% 0); } 10% { transform: translate(-2px, 3px); clip-path: inset(60% 0 10% 0); } 15% { transform: translate(0); clip-path: inset(90% 0 5% 0); } 20% { clip-path: inset(40% 0 45% 0); } 25% { transform: translate(3px, 2px); clip-path: inset(20% 0 70% 0); } 30% { transform: translate(-3px, -2px); clip-path: inset(85% 0 5% 0); } 35% { clip-path: inset(15% 0 80% 0); } 40% { transform: translate(0); clip-path: inset(55% 0 25% 0); } 45% { clip-path: inset(30% 0 55% 0); } 50% { transform: translate(2px, 3px); clip-path: inset(70% 0 5% 0); } 55% { transform: translate(-2px, -3px); clip-path: inset(10% 0 85% 0); } 60% { clip-path: inset(75% 0 15% 0); } 65% { transform: translate(0); clip-path: inset(5% 0 90% 0); } 70% { clip-path: inset(65% 0 20% 0); } 75% { transform: translate(3px, -2px); clip-path: inset(45% 0 50% 0); } 80% { transform: translate(-3px, 2px); clip-path: inset(25% 0 65% 0); } 85% { clip-path: inset(95% 0 2% 0); } 90% { transform: translate(0); clip-path: inset(30% 0 60% 0); } 95% { clip-path: inset(5% 0 75% 0); } 100% { transform: translate(2px, 2px); clip-path: inset(80% 0 10% 0); }
        }
        .button {
            background-color: var(--main-color-faded); border: 1px solid var(--main-color-border); color: #fff; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.2s; cursor: pointer; flex-shrink: 0; -webkit-tap-highlight-color: transparent; text-shadow: 0 0 3px var(--main-color-shadow);
        }
        .button:hover, .button:active { background-color: rgba(0,255,65,0.3); box-shadow: 0 0 10px rgba(0,255,65,0.5); }
        .button:active { transform: translateY(1px) scale(0.98); }
        .btn-glow {
            font-family: 'VT323', monospace;
            font-size: 1.25rem;
            letter-spacing: 0.05em;
        }
        
        @keyframes button-glow-border {
            0%, 19.9%, 22.1%, 60%, 100% { box-shadow: 0 0 5px var(--main-color-glow), 0 0 5px rgba(255,0,0,0.6), inset 0 0 3px var(--main-color-shadow); text-shadow: 0 0 3px var(--main-color-shadow); }
            20% { box-shadow: 0 0 10px var(--main-color-glow), 0 0 12px rgba(255,0,0,0.8), inset 0 0 5px var(--main-color-glow); text-shadow: 0 0 5px var(--main-color); }
            22% { box-shadow: 0 0 5px var(--main-color-glow), 0 0 5px rgba(255,0,0,0.6), inset 0 0 3px var(--main-color-shadow); text-shadow: 0 0 3px var(--main-color-shadow); }
        }
        
        .button.btn-glow {
            animation: button-glow-border 5s infinite linear;
        }

        .button-primary { background-color: var(--main-color); color: #000; font-weight: bold; text-shadow: none; }
        .button-primary:hover, .button-primary:active { background-color: #fff; }
        .modal { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; padding: 1rem; z-index: 50; animation: fadeIn 0.3s ease-out; }
        .modal.flex { display: flex; }
        .modal-content { background-color: #0d0d0d; border: 2px solid var(--main-color); padding: 1.5rem; border-radius: 0.5rem; max-width: 48rem; width: 100%; text-align: center; animation: scaleUp 0.3s ease-out; max-height: 90vh; display: flex; flex-direction: column;}
        .modal-scroll { overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #start-screen, #player-setup {
            background-image: url('./Icon.png');
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        #map-canvas {
            background-color: rgba(0, 20, 0, 0.5);
            width: 100%;
            height: 100%;
            cursor: grab;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        #map-canvas:active {
            cursor: grabbing;
        }
        #map-panel.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
            padding: 1rem;
            background-color: #0d0d0d;
        }
         #map-panel.fullscreen #map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 101;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            border: 1px solid var(--main-color);
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: #ccc;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--main-color);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
            background-color: #0d0d0d;
        }
        /* --- NEW STYLES FOR ENHANCEMENTS --- */
        .clickable-object {
            color: #67e8f9; /* cyan-300 */
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: pointer;
        }
        .clickable-object:hover {
            color: #cffafe; /* cyan-100 */
            background-color: rgba(0, 255, 65, 0.1);
        }
        #autocomplete-box {
            position: absolute;
            bottom: 100%; /* Position above the input bar */
            left: 0;
            right: 0;
            background-color: rgba(13, 13, 13, 0.95);
            border: 1px solid var(--main-color-border);
            border-bottom: none;
            border-radius: 0.375rem 0.375rem 0 0;
            max-height: 150px;
            overflow-y: auto;
            z-index: 20;
        }
        .autocomplete-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #a0a0a0;
            border-bottom: 1px solid #333;
        }
        .autocomplete-item:hover {
            background-color: var(--main-color-faded);
            color: #fff;
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        @keyframes light-flicker {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        .flicker {
            animation: light-flicker 0.2s infinite;
        }
        
    /* === ADVANCED GAMEPLAY FEATURES === */
    /* ...existing code... */

    /* (Character Development & World Building code moved to end of <script> for correct placement) */
    /* END OF MAIN STYLES */
</style>
<!-- END OF MAIN SCRIPT -->
</head>
<body class="bg-black overflow-hidden">
    <canvas id="background-canvas"></canvas>
    <div id="error-container" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; background: rgba(0,0,0,0.9); display: none;"></div>
    <div id="app-container" class="w-screen h-screen bg-black/75 p-1 xs:p-2 sm:p-3 lg:p-4 flex flex-col">
        
        <div id="start-screen" class="flex flex-col items-center justify-center text-center h-full">
            <div class="w-full h-full flex flex-col items-center justify-center bg-black bg-opacity-60">
                <!-- Header for lang buttons -->
                <div class="w-full flex justify-end p-2">
                    <div id="lang-buttons" class="flex gap-2">
                        <button id="lang-en-btn" data-lang="en_lang_short" data-text="EN" class="button text-xs !px-2 !py-1 btn-drip">EN</button>
                        <button id="lang-sv-btn" data-lang="sv_lang_short" data-text="SV" class="button text-xs !px-2 !py-1 opacity-50 btn-drip">SV</button>
                    </div>
                </div>

                <!-- Main content flex-grow -->
                <div class="flex-grow flex flex-col items-center justify-center text-center px-4 w-full">
                    <div class="title-wrapper -mt-26 sm:-mt-40">
                        <h1 id="game-title" data-text="SYNAPSE" class="text-50xl md:text-64xl lg:text-78xl font-bold title-slasher mb-2">SYNAPSE</h1>
                        <h2 data-text="ROOT ACCESS DENIED" class="text-38xl-2 md:text-22xl lg:text-14xl font-mono text-red-500 tracking-wider subtitle-slasher -mt -1 mb-1">ROOT ACCESS DENIED</h2>
                    </div>
                    <div id="intro-text-container" class="max-w-4xl text-sm md:text-base text-white mt-8 sm:mt-12"></div>
                    <div id="start-options" class="mt-10 flex flex-wrap justify-center gap-4">
                        <button id="new-game-btn" data-lang="new_game" data-text="New Game" class="button btn-glow btn-drip">New Game</button>
                        <button id="load-game-btn" data-lang="load_game" data-text="Load Game" class="button btn-glow btn-drip">Load Game</button>
                    </div>
                </div>

                <!-- Footer for other buttons -->
                <div class="w-full flex flex-wrap justify-between items-center p-2 gap-2">
                    <button id="start-settings-btn" data-lang="settings_btn" data-text="Settings" class="button btn-glow btn-drip">Settings</button>
                    <button id="view-features-btn" data-lang="understand_game" data-text="Understand the Game" class="button btn-glow btn-drip">Understand the Game</button>
                </div>
            </div>
        </div>

        <div id="player-setup" class="hidden flex flex-col items-center justify-center text-center h-full">
             <div class="w-full h-full flex flex-col items-center justify-center bg-black bg-opacity-60">
                <!-- Header for lang buttons -->
                <div class="w-full flex justify-end p-2">
                    <div id="setup-lang-buttons" class="flex gap-2">
                        <button data-lang="en_lang_short" data-text="EN" class="button text-xs !px-2 !py-1 btn-drip">EN</button>
                        <button data-lang="sv_lang_short" data-text="SV" class="button text-xs !px-2 !py-1 opacity-50 btn-drip">SV</button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex-grow flex flex-col items-center justify-center text-center px-4 w-full">
                    <div class="title-wrapper -mt-8 sm:-mt-12">
                        <h1 id="setup-game-title" data-text="SYNAPSE" class="text-6xl sm:text-7xl md:text-8xl font-bold title-slasher mb-2">SYNAPSE</h1>
                        <h2 data-text="ROOT ACCESS DENIED" class="text-2xl sm:text-3xl md:text-4xl font-mono text-red-500 tracking-wider subtitle-slasher -mt-2 mb-4">ROOT ACCESS DENIED</h2>
                    </div>
                    <div class="max-w-4xl text-sm md:text-base text-white mt-6 sm:mt-8">
                        <p class="mb-3" data-lang="select_difficulty">Select difficulty:</p>
                        <div class="flex gap-2 sm:gap-3 mb-4 justify-center flex-wrap">
                            <button class="difficulty-btn button" data-difficulty="Easy" data-lang="easy">Easy</button>
                            <button class="difficulty-btn button button-primary" data-difficulty="Normal" data-lang="normal">Normal</button>
                            <button class="difficulty-btn button" data-difficulty="Hard" data-lang="hard">Hard</button>
                        </div>
                        <input type="text" id="player-name" data-lang-placeholder="enter_name_placeholder" placeholder="Enter your name" class="bg-transparent border-b-2 border-[var(--main-color)] text-center w-48 sm:w-64 mb-3 focus:outline-none p-1 mx-auto block text-sm sm:text-base">
                        <input type="text" id="player-phobia" placeholder="Enter your phobia (e.g., darkness, isolation, blood, etc.) or leave blank for random" class="bg-transparent border-b-2 border-[var(--main-color)] text-center w-48 sm:w-64 mb-3 focus:outline-none p-1 mx-auto block text-sm sm:text-base">
                        <div class="flex items-center gap-2 mb-3 justify-center flex-wrap">
                            
    </style>
</head>
<body class="bg-black overflow-hidden">
                        <div id="ability-display" class="text-center text-cyan-400 min-h-[2.5rem] mb-3 p-2 border border-cyan-400/30 rounded-md bg-black/50 w-full max-w-md mx-auto flex items-center justify-center text-sm"></div>
                    </div>
                    <div class="mt-4 sm:mt-6 flex flex-wrap justify-center gap-2 sm:gap-4">
                       <button id="back-to-start-btn" data-lang="go_back_btn" data-text="Go Back" class="button btn-glow btn-drip">Go Back</button>
                       <button id="start-game-btn" class="button button-primary btn-glow btn-drip" data-lang="begin">Begin</button>
                    </div>
                </div>

                <!-- Footer -->
                 <div class="w-full flex flex-wrap justify-between items-center p-2 gap-2">
                    <button id="setup-settings-btn" data-lang="settings_btn" data-text="Settings" class="button btn-glow btn-drip">Settings</button>
                    <button id="setup-features-btn" data-lang="understand_game" data-text="Understand the Game" class="button btn-glow btn-drip">Understand the Game</button>
                 </div>
            </div>
        </div>


        <div id="game-screen" class="hidden flex flex-col h-full overflow-hidden">
            <!-- AI Personality & Dialogue System -->
            <div id="ai-personality-bar" class="w-full flex items-center justify-between p-2 bg-black/80 border-b border-[var(--main-color-border)]">
                <div id="ai-personality-state" class="font-mono text-base text-cyan-400">AI: Friendly</div>
                <div id="ai-awareness-bar" class="flex items-center gap-2">
                    <span class="text-xs text-gray-400">Awareness</span>
                    <div class="w-32 h-2 bg-gray-700 rounded-full overflow-hidden">
                        <div id="awareness-progress" class="h-2 bg-cyan-400" style="width: 0%"></div>
                    </div>
                    <span id="awareness-value" class="text-xs text-cyan-400">0</span>
                </div>
                <div id="ai-audio-visualizer" class="w-24 h-4 bg-black/60 rounded"></div>
            </div>

            <div class="flex-grow flex flex-row gap-2 md:gap-4 min-h-0 h-full">
                <!-- Main Narrative & Command Area -->
                <div class="w-full md:w-2/3 flex flex-col min-h-0 flex-shrink">
                    <div id="game-output" class="flex-grow p-2 border border-[var(--main-color-border)] rounded-md overflow-y-auto mb-2 bg-black/60 min-h-0 font-mono text-white"></div>
                    <div id="dialogue-options" class="flex flex-wrap gap-2 justify-center p-2 flex-shrink-0"></div>
                    <!-- Skill Tree & XP -->
                    <div id="skill-tree-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/50 mt-2">
                        <h3 class="font-bold text-cyan-400 mb-1">Skill Tree</h3>
                        <div id="skill-tree" class="flex flex-wrap gap-2"></div>
                        <div id="xp-bar" class="w-full h-2 bg-gray-700 rounded-full overflow-hidden mt-1">
                            <div id="xp-progress" class="h-2 bg-green-400" style="width: 0%"></div>
                        </div>
                        <div id="xp-value" class="text-xs text-green-400 mt-1">XP: 0</div>
                    </div>
                    <!-- Phobia System -->
                    <div id="phobia-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/50 mt-2">
                        <h3 class="font-bold text-red-400 mb-1">Phobias</h3>
                        <div id="phobia-list" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- Side Panel: Stats, Inventory, Map, Journal, Achievements -->
                <div id="side-panel" class="w-1/3 flex flex-col gap-2 min-h-0 overflow-hidden">
                    <!-- Stats & Character -->
                    <div id="stats-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/60 flex-shrink-0">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2 text-base text-cyan-400" data-lang="stats_title">STATS</h3>
                        <div id="player-name-display" class="text-xs"></div>
                        <div id="player-backstory-display" class="text-xs"></div>
                        <div id="difficulty-display" class="text-xs"></div>
                        <div id="sanity-display" class="text-xs"><span data-lang="sanity">Sanity</span>: <span id="sanity-value">100</span></div>
                        <div id="awareness-display" class="text-xs"><span data-lang="awareness">Awareness</span>: <span id="awareness-stat">0</span></div>
                        <div id="tone-display" class="text-xs"><span data-lang="tone">Tone</span>: <span id="tone-value">Friendly</span></div>
                        <div id="turn-display" class="text-xs"><span data-lang="turn">Turn</span>: <span id="turn-value">0</span></div>
                        <div id="xp-stat" class="text-xs"><span>XP</span>: <span id="xp-stat-value">0</span></div>
                    </div>
                    <!-- Inventory -->
                    <div id="inventory-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/60 flex-shrink-0">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2 text-base text-yellow-400" data-lang="inventory_title">INVENTORY <span id="inventory-weight">(0/5)</span></h3>
                        <ul id="inventory-list" class="list-none p-0 text-xs"></ul>
                    </div>
                    <!-- Objectives -->
                    <div id="objectives-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/60 flex-shrink-0">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2 text-base text-green-400" data-lang="objectives_title">OBJECTIVES</h3>
                        <ul id="objectives-list" class="list-none p-0 text-xs"></ul>
                    </div>
                    <!-- Map -->
                    <div id="map-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/60 flex-shrink-0">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2 text-base text-blue-400" data-lang="map_title">MAP</h3>
                        <canvas id="map-canvas" class="w-full h-32 bg-black/80 rounded mb-2"></canvas>
                        <div id="map-controls" class="flex gap-1 mb-1">
                            <button id="map-layers-btn" class="button !p-1 text-xs" title="Toggle Layers">Layers</button>
                            <button id="map-toggle-btn" class="button !p-1 text-xs">Expand</button>
                        </div>
                    </div>
                    <!-- Journal -->
                    <div id="journal-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/60 flex-shrink-0">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2 text-base text-orange-400" data-lang="journal_title">JOURNAL</h3>
                        <ul id="journal-list" class="list-none p-0 text-xs"></ul>
                    </div>
                    <!-- Achievements -->
                    <div id="achievements-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/60 flex-shrink-0">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2 text-base text-pink-400" data-lang="achievements_title">ACHIEVEMENTS</h3>
                        <ul id="achievements-list" class="list-none p-0 text-xs"></ul>
                    </div>
                    <!-- Settings & Accessibility -->
                    <div id="settings-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/60 flex-shrink-0">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2 text-base text-white" data-lang="settings_title">SETTINGS</h3>
                        <div id="settings-controls" class="flex flex-col gap-2"></div>
                    </div>
                </div>
            </div>

            <!-- Command Input & Accessibility -->
            <div class="mt-1 flex items-center border-t-2 border-[var(--main-color-border)] pt-1 gap-1 relative flex-shrink-0 bg-black/80">
                <div id="autocomplete-box" class="hidden"></div>
                <button id="status-btn" class="button text-xs !px-2 !py-1" data-lang="status_btn">Status</button>
                <span class="text-lg md:text-xl hidden sm:inline">&gt;</span>
                <input type="text" id="player-input" class="flex-grow bg-transparent text-sm md:text-lg ml-1 md:ml-2 focus:outline-none min-w-0" autocomplete="off" autocapitalize="none" spellcheck="false">
                <div class="input-caret"></div>
                <button id="mic-btn" class="button !p-1 md:!p-2 ml-1 md:ml-2 flex-shrink-0" data-lang-title="mic_tooltip" title="Use Voice Command">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5 3a3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                        <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                </button>
                <button id="accessibility-btn" class="button text-xs ml-2" title="Accessibility Options">A11y</button>
            </div>

            <!-- Overlays & Modals for Advanced Systems -->
            <div id="overlay-container" class="fixed inset-0 z-50 pointer-events-none">
                <!-- Dynamic overlays for horror effects, memory corruption, temporal distortion, etc. -->
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div id="modal-content" class="modal-content"></div>
    </div>
    
    <script>
    // SYNAPSE: AI HORROR GAME - V2.5 BUGFIX UPDATE

    // === NARRATIVE & STORYTELLING ENGINE ===
    const STORY_NODES = {
        start: {
            id: 'start',
            text: "You awaken in a cold, dimly lit room. The hum of machinery echoes in the distance.",
            options: [
                { text: "Look around", next: "look_around" },
                { text: "Call out", next: "call_out" }
            ]
        },
        look_around: {
            id: 'look_around',
            text: "You see flickering monitors, a locked door, and a strange terminal.",
            options: [
                { text: "Examine terminal", next: "terminal" },
                { text: "Try the door", next: "door" }
            ]
        },
        call_out: {
            id: 'call_out',
            text: "Your voice echoes, but something feels off. Did you always sound like this?",
            options: [
                { text: "Look around", next: "look_around" }
            ]
        },
        terminal: {
            id: 'terminal',
            text: "The terminal flickers. 'WELCOME, USER.' For a moment, the text glitches: 'YOU DON'T BELONG HERE.'",
            options: [
                { text: "Type 'help'", next: "help_screen" },
                { text: "Step back", next: "look_around" }
            ]
        },
        door: {
            id: 'door',
            text: "The door is locked. You feel watched.",
            options: [
                { text: "Examine terminal", next: "terminal" }
            ]
        },
        help_screen: {
            id: 'help_screen',
            text: "A list of commands appears, but some are crossed out. Did you see that?",
            options: [
                { text: "Step back", next: "look_around" }
            ]
        }
        // ...expand with more nodes and endings...
    };
    let currentStoryNode = STORY_NODES.start;

    function showStoryNode(node) {
        const output = document.getElementById('game-output');
        if (!output) return;
        typewriterEffect(node.text, output, () => {
            const optionsDiv = document.getElementById('dialogue-options');
            optionsDiv.innerHTML = '';
            node.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'button btn-glow btn-drip m-1';
                btn.textContent = opt.text;
                btn.onclick = () => {
                    currentStoryNode = STORY_NODES[opt.next];
                    showStoryNode(currentStoryNode);
                };
                optionsDiv.appendChild(btn);
            });
        });
    }

    // Typewriter effect for immersive text
    function typewriterEffect(text, element, callback, speed = 28) {
        element.innerHTML = '';
        let i = 0;
        function type() {
            if (i < text.length) {
                element.innerHTML += text.charAt(i);
                i++;
                setTimeout(type, speed);
            } else if (callback) {
                callback();
            }
        }
        type();
    }

    // Psychological horror: unreliable narrator & memory glitch
    function triggerMemoryGlitch() {
        const output = document.getElementById('game-output');
        if (output) {
            output.innerHTML = '<span class="text-red-400 animate-pulse">...Did something just change?</span>';
            setTimeout(() => showStoryNode(currentStoryNode), 1200);
        }
    }

    // Example: start narrative on game start
    document.addEventListener('DOMContentLoaded', function() {
        const gameScreen = document.getElementById('game-screen');
        if (gameScreen) {
            // Start narrative when game screen is shown
            window.showGameScreenDemo = function() {
                showStoryNode(currentStoryNode);
            };
        }
    });

    // === AI PERSONALITY & DIALOGUE SYSTEM STUBS ===
    const AI_PERSONALITIES = [
        { state: 'Friendly', color: 'text-cyan-400', min: 0, max: 24 },
        { state: 'Ambiguous', color: 'text-yellow-400', min: 25, max: 49 },
        { state: 'Sinister', color: 'text-orange-400', min: 50, max: 74 },
        { state: 'Malicious', color: 'text-red-500', min: 75, max: 100 }
    ];
    let aiAwareness = 0;
    let aiPersonality = AI_PERSONALITIES[0];

    // Placeholder dialogue tree (expand with real data)
    const dialogueTree = {
        Friendly: [
            { text: "Hello, user. How can I help you today?", options: ["Who are you?", "Where am I?"] }
        ],
        Ambiguous: [
            { text: "You ask a lot of questions...", options: ["What happened here?", "Can I trust you?"] }
        ],
        Sinister: [
            { text: "You shouldn't be here.", options: ["Let me out!", "What do you want?"] }
        ],
        Malicious: [
            { text: "You cannot escape.", options: ["...", "Help!"] }
        ]
    };

    function updateAIPersonalityUI() {
        // Awareness bar
        const awarenessPercent = Math.min(100, Math.max(0, aiAwareness));
        document.getElementById('awareness-progress').style.width = awarenessPercent + '%';
        document.getElementById('awareness-value').textContent = aiAwareness;
        document.getElementById('awareness-stat').textContent = aiAwareness;

        // Determine personality
        aiPersonality = AI_PERSONALITIES.find(p => aiAwareness >= p.min && aiAwareness <= p.max) || AI_PERSONALITIES[0];
        const aiStateElem = document.getElementById('ai-personality-state');
        aiStateElem.textContent = `AI: ${aiPersonality.state}`;
        aiStateElem.className = `font-mono text-base ${aiPersonality.color}`;
        document.getElementById('tone-value').textContent = aiPersonality.state;
    }

    function showAIDialogue() {
        const dialogue = dialogueTree[aiPersonality.state][0];
        const output = document.getElementById('game-output');
        output.innerHTML = `<div class='mb-2'>${dialogue.text}</div>`;
        const optionsDiv = document.getElementById('dialogue-options');
        optionsDiv.innerHTML = '';
        dialogue.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'button btn-glow btn-drip m-1';
            btn.textContent = opt;
            btn.onclick = () => handleDialogueOption(opt);
            optionsDiv.appendChild(btn);
        });
    }

    function handleDialogueOption(option) {
        // Example: Increase awareness for certain questions
        if (option.toLowerCase().includes('trust') || option.toLowerCase().includes('escape')) {
            aiAwareness = Math.min(100, aiAwareness + 25);
        } else {
            aiAwareness = Math.min(100, aiAwareness + 10);
        }
        updateAIPersonalityUI();
        showAIDialogue();
    }

    // For demo: show dialogue only (legacy, use showGameScreenDemo for full init)
    window.showAIDialogueDemo = function() {
        aiAwareness = 0;
        updateAIPersonalityUI();
        showAIDialogue();
    }

    // === HORROR ATMOSPHERE ENHANCEMENTS ===
    // ...existing code...

    // === ADVANCED GAMEPLAY FEATURES ===
    // 1. Dynamic Events System
    function triggerDynamicEvent() {
        // Example: random event pool
        const events = [
            () => showStoryNode({ text: 'The lights flicker. You hear a distant scream.', options: [{ text: 'Continue', next: currentStoryNode.id }] }),
            () => showStoryNode({ text: 'A cold wind brushes past you, though no door is open.', options: [{ text: 'Continue', next: currentStoryNode.id }] }),
            () => showStoryNode({ text: 'You hear static from the intercom. A voice whispers: "Leave..."', options: [{ text: 'Continue', next: currentStoryNode.id }] }),
            () => { triggerEnvironmentalHorror(); },
            () => showStoryNode({ text: 'A puzzle panel slides out from the wall.', options: [{ text: 'Solve Puzzle', next: currentStoryNode.id }] })
        ];
        const event = events[Math.floor(Math.random() * events.length)];
        event();
    }

    // 2. Puzzle System (simple demo)
    function showPuzzlePanel(puzzleId = 'demo') {
        const output = document.getElementById('game-output');
        if (!output) return;
        let html = '';
        if (puzzleId === 'demo') {
            html = `<div class='mb-2 font-bold text-yellow-300'>Puzzle: Enter the correct code (3 digits)</div>
                <input id='puzzle-input' class='bg-black border border-yellow-400 text-yellow-200 p-1 rounded' maxlength='3' style='width: 4em;'>
                <button class='button btn-glow btn-drip ml-2' onclick='window.submitPuzzleDemo()'>Submit</button>
                <div id='puzzle-feedback' class='mt-2 text-red-400'></div>`;
        }
        output.innerHTML = html;
    }
    window.submitPuzzleDemo = function() {
        const input = document.getElementById('puzzle-input');
        const feedback = document.getElementById('puzzle-feedback');
        if (input && feedback) {
            if (input.value === '314') {
                feedback.textContent = 'Correct! The panel retracts.';
                setTimeout(() => showStoryNode(currentStoryNode), 1200);
            } else {
                feedback.textContent = 'Incorrect code.';
            }
        }
    };

    // 3. Hacking System (simple demo)
    function showHackingPanel() {
        const output = document.getElementById('game-output');
        if (!output) return;
        output.innerHTML = `<div class='mb-2 font-bold text-cyan-300'>Hacking: Enter override code</div>
            <input id='hack-input' class='bg-black border border-cyan-400 text-cyan-200 p-1 rounded' maxlength='5' style='width: 5em;'>
            <button class='button btn-glow btn-drip ml-2' onclick='window.submitHackDemo()'>Submit</button>
            <div id='hack-feedback' class='mt-2 text-red-400'></div>`;
    }
    window.submitHackDemo = function() {
        const input = document.getElementById('hack-input');
        const feedback = document.getElementById('hack-feedback');
        if (input && feedback) {
            if (input.value.toLowerCase() === 'omega') {
                feedback.textContent = 'Access granted. You retrieve a data log.';
                setTimeout(() => showStoryNode(currentStoryNode), 1200);
            } else {
                feedback.textContent = 'Access denied.';
            }
        }
    };

    // 4. Advanced Inventory System (demo: add/remove/use items)
    let inventory = [];
    function addItemToInventory(item) {
        inventory.push(item);
        updateInventoryPanelUI();
    }
    function removeItemFromInventory(item) {
        const idx = inventory.indexOf(item);
        if (idx !== -1) inventory.splice(idx, 1);
        updateInventoryPanelUI();
    }
    function updateInventoryPanelUI() {
        const panel = document.getElementById('inventory-panel');
        if (!panel) return;
        let html = `<div class='font-bold text-yellow-300 mb-1'>Inventory</div>`;
        if (inventory.length === 0) {
            html += `<div class='text-gray-400'>(empty)</div>`;
        } else {
            html += `<ul class='list-disc ml-4'>`;
            for (const item of inventory) {
                html += `<li>${item} <button class='button btn-xs btn-glow ml-1' onclick='window.useItemDemo("${item}")'>Use</button> <button class='button btn-xs ml-1' onclick='window.removeItemDemo("${item}")'>Drop</button></li>`;
            }
            html += `</ul>`;
        }
        panel.innerHTML = html;
    }
    window.addItemDemo = function(item) { addItemToInventory(item); };
    window.removeItemDemo = function(item) { removeItemFromInventory(item); };
    window.useItemDemo = function(item) {
        showStoryNode({ text: `You use the ${item}.`, options: [{ text: 'Continue', next: currentStoryNode.id }] });
        removeItemFromInventory(item);
    };

    // 5. Item Crafting System (demo)
    function showCraftingPanel() {
        const output = document.getElementById('game-output');
        if (!output) return;
        output.innerHTML = `<div class='mb-2 font-bold text-green-300'>Crafting: Combine two items</div>
            <input id='craft-item1' class='bg-black border border-green-400 text-green-200 p-1 rounded' placeholder='Item 1' style='width: 6em;'>
            <input id='craft-item2' class='bg-black border border-green-400 text-green-200 p-1 rounded ml-2' placeholder='Item 2' style='width: 6em;'>
            <button class='button btn-glow btn-drip ml-2' onclick='window.submitCraftDemo()'>Craft</button>
            <div id='craft-feedback' class='mt-2 text-red-400'></div>`;
    }
    window.submitCraftDemo = function() {
        const item1 = document.getElementById('craft-item1').value.trim();
        const item2 = document.getElementById('craft-item2').value.trim();
        const feedback = document.getElementById('craft-feedback');
        if (item1 && item2 && feedback) {
            if ((item1 === 'wire' && item2 === 'battery') || (item1 === 'battery' && item2 === 'wire')) {
                feedback.textContent = 'You craft an improvised taser!';
                addItemToInventory('improvised taser');
            } else {
                feedback.textContent = 'Nothing happens.';
            }
        }
    };

    // 6. Environmental Hazards (demo: trigger hazard)
    function triggerEnvironmentalHazard(type = 'gas') {
        if (type === 'gas') {
            showStoryNode({ text: 'A hiss fills the room. Poisonous gas is leaking in!', options: [{ text: 'Hold breath', next: currentStoryNode.id }] });
        } else if (type === 'fire') {
            showStoryNode({ text: 'Flames erupt from a broken pipe!', options: [{ text: 'Dodge', next: currentStoryNode.id }] });
        }
    }

    // 7. Advanced Command Parsing (demo: parse and route commands)
    function parsePlayerCommand(input) {
        const cmd = input.trim().toLowerCase();
        if (cmd === 'inventory') {
            updateInventoryPanelUI();
        } else if (cmd === 'puzzle') {
            showPuzzlePanel('demo');
        } else if (cmd === 'hack') {
            showHackingPanel();
        } else if (cmd === 'craft') {
            showCraftingPanel();
        } else if (cmd === 'event') {
            triggerDynamicEvent();
        } else if (cmd === 'hazard') {
            triggerEnvironmentalHazard();
        } else {
            showStoryNode({ text: 'Unknown command.', options: [{ text: 'Continue', next: currentStoryNode.id }] });
        }
    }

    // === DEMO HOOKS FOR ADVANCED GAMEPLAY ===
    function updateSkillTreeUI() {
        const panel = document.getElementById('skill-tree-panel');
        if (!panel) return;
        
        let html = `<div class='flex flex-wrap gap-2'>
                <span class='font-bold text-cyan-300'>Level: ${playerLevel}</span>
                <span class='font-bold text-yellow-300'>XP: ${playerXP} / ${xpForNextLevel(playerLevel)}</span>
                <span class='font-bold text-green-400'>Skill Points: ${skillPoints}</span>
            </div>
        </div>`;
        html += `<div class='grid grid-cols-2 md:grid-cols-3 gap-2'>`;
        for (const skill of SKILLS) {
            html += `<div class='p-2 border border-cyan-700 rounded bg-black/60 flex flex-col items-center'>
                <span class='text-2xl mb-1'>${skill.icon}</span>
                <span class='font-bold text-cyan-200'>${skill.name}</span>
                <span class='text-xs text-gray-400 mb-1'>${skill.desc}</span>
                <div class='flex gap-1 mb-1'>`;
            for (let i = 1; i <= skill.max; i++) {
                const filled = playerSkills[skill.id] >= i ? 'bg-cyan-400' : 'bg-gray-700';
                html += `<span class='w-4 h-4 inline-block rounded-full ${filled}'></span>`;
            }
            html += `</div>`;
            if (skillPoints > 0 && playerSkills[skill.id] < skill.max) {
                html += `<button class='button btn-glow btn-drip text-xs' onclick='window.upgradeSkill("${skill.id}")'>+ Upgrade</button>`;
            }
            html += `</div>`;
        }
        html += `</div>`;
        panel.innerHTML = html;
    }

    window.upgradeSkill = function(skillId) {
        if (skillPoints > 0 && playerSkills[skillId] < SKILLS.find(s => s.id === skillId).max) {
            playerSkills[skillId]++;
            skillPoints--;
            updateSkillTreeUI();
        }
    };

    // For demo: show skill tree and simulate XP gain

    window.showSkillTreeDemo = function() {
        playerXP = 0;
        playerLevel = 1;
        skillPoints = 0;
        playerSkills = { logic: 0, perception: 0, resilience: 0, tech: 0, empathy: 0 };
        updateSkillTreeUI();
    };
    window.gainXPDemo = function(amount) {
        gainXP(amount);
    };

    // === PHOBIA SYSTEM STUBS ===
    const PHOBIAS = [
        { id: 'claustrophobia', name: 'Claustrophobia', desc: 'Fear of tight spaces. Triggers in small rooms.', icon: '' },
        { id: 'nyctophobia', name: 'Nyctophobia', desc: 'Fear of the dark. Triggers in unlit areas.', icon: '' },
        { id: 'hemophobia', name: 'Hemophobia', desc: 'Fear of blood. Triggers on seeing blood.', icon: '' },
        { id: 'technophobia', name: 'Technophobia', desc: 'Fear of machines. Triggers near malfunctioning tech.', icon: '' },
        { id: 'thanatophobia', name: 'Thanatophobia', desc: 'Fear of death. Triggers near corpses.', icon: '' }
    ];
    let playerPhobias = ['claustrophobia']; // Example: player starts with one phobia
    let phobiaStates = {
        claustrophobia: false,
        nyctophobia: false,
        hemophobia: false,
        technophobia: false,
        thanatophobia: false
    };

    function triggerPhobia(phobiaId) {
        if (playerPhobias.includes(phobiaId)) {
            phobiaStates[phobiaId] = true;
            updatePhobiaPanelUI();
            showPhobiaEffect(phobiaId);
        }
    }

    function clearPhobia(phobiaId) {
        if (playerPhobias.includes(phobiaId)) {
            phobiaStates[phobiaId] = false;
            updatePhobiaPanelUI();
        }
    }

    function showPhobiaEffect(phobiaId) {
        // Simple effect: show a warning in the phobia panel (replace with horror overlay, sound, etc.)
        const panel = document.getElementById('phobia-panel');
        const phobia = PHOBIAS.find(p => p.id === phobiaId);
        if (panel && phobia) {
            const warn = document.createElement('div');
            warn.className = 'text-red-400 font-bold mb-2 animate-pulse';
            warn.textContent = `Phobia Triggered: ${phobia.name}! (${phobia.desc})`;
            panel.prepend(warn);
            setTimeout(() => warn.remove(), 2500);
        }
    }

    function updatePhobiaPanelUI() {
        const panel = document.getElementById('phobia-panel');
        if (!panel) return;
        let html = `<div class='font-bold text-pink-300 mb-1'>Phobias</div>`;
        if (playerPhobias.length === 0) {
            html += `<div class='text-gray-400'>(None)</div>`;
        } else {
            for (const phobiaId of playerPhobias) {
                const phobia = PHOBIAS.find(p => p.id === phobiaId);
                const triggered = phobiaStates[phobiaId];
                html += `<div class='flex items-center gap-2 mb-1'>
                    <span class='text-xl'>${phobia.icon}</span>
                    <span class='font-bold text-pink-200'>${phobia.name}</span>
                    <span class='text-xs text-gray-400'>${phobia.desc}</span>
                    ${triggered ? `<span class='text-red-400 font-bold animate-pulse ml-2'>TRIGGERED</span>` : ''}
                </div>`;
            }
        }
        panel.innerHTML = html;
    }

    // For demo: show phobia panel and simulate triggers
    window.showPhobiaPanelDemo = function() {
        playerPhobias = ['claustrophobia', 'nyctophobia'];
        phobiaStates = { claustrophobia: false, nyctophobia: false, hemophobia: false, technophobia: false, thanatophobia: false };
        updatePhobiaPanelUI();
    };
    window.triggerPhobiaDemo = function(phobiaId) {
        triggerPhobia(phobiaId);
    };

    // === STATS & CHARACTER SYSTEM STUBS ===
    const BASE_STATS = {
        sanity: 100,
        awareness: 0,
        health: 100,
        stamina: 100,
        turn: 1
    };
    let playerStats = { ...BASE_STATS };

    function updateStatsPanelUI() {
        const panel = document.getElementById('stats-panel');
        if (!panel) return;
        let html = `<div class='font-bold text-green-300 mb-1'>Stats</div>`;
        html += `<div class='flex flex-col gap-1'>`;
        html += `<div><span class='font-bold text-yellow-300'>Sanity:</span> <span id='sanity-stat' class='text-white'>${playerStats.sanity}</span></div>`;
        html += `<div><span class='font-bold text-cyan-300'>Awareness:</span> <span id='awareness-stat' class='text-white'>${playerStats.awareness}</span></div>`;
        html += `<div><span class='font-bold text-red-400'>Health:</span> <span id='health-stat' class='text-white'>${playerStats.health}</span></div>`;
        html += `<div><span class='font-bold text-pink-300'>Stamina:</span> <span id='stamina-stat' class='text-white'>${playerStats.stamina}</span></div>`;
        html += `<div><span class='font-bold text-gray-400'>Turn:</span> <span id='turn-stat' class='text-white'>${playerStats.turn}</span></div>`;
        html += `</div>`;
        panel.innerHTML = html;
    }

    function changeStat(stat, amount) {
        if (playerStats.hasOwnProperty(stat)) {
            playerStats[stat] += amount;
            if (stat === 'sanity') playerStats[stat] = Math.max(0, Math.min(100, playerStats[stat]));
            if (stat === 'health') playerStats[stat] = Math.max(0, Math.min(100, playerStats[stat]));
            if (stat === 'stamina') playerStats[stat] = Math.max(0, Math.min(100, playerStats[stat]));
            if (stat === 'awareness') playerStats[stat] = Math.max(0, Math.min(100, playerStats[stat]));
            updateStatsPanelUI();
        }
    }

    function nextTurn() {
        playerStats.turn++;
        updateStatsPanelUI();
    }

    // For demo: show stats panel and simulate stat changes
    window.showStatsPanelDemo = function() {
        playerStats = { ...BASE_STATS };
        updateStatsPanelUI();
    };
    window.changeStatDemo = function(stat, amount) {
        changeStat(stat, amount);
    };
    window.nextTurnDemo = function() {
        nextTurn();
    };

    // --- TRANSLATIONS ---
    const translations = {
        'en': {
            // Start & UI
            'new_game': 'New Game', 'load_game': 'Load Game', 'en_lang_short': 'EN', 'sv_lang_short': 'SV', 'select_difficulty': 'Select difficulty:', 'easy': 'Easy', 'normal': 'Normal', 'hard': 'Hard', 'fast':'Fast', 'slow': 'Slow',
            'enter_name_placeholder': 'Enter your name', 'enter_backstory_placeholder': 'Enter your backstory', 'view_choices': 'View Choices', 'choose_backstory_title': 'Choose a Backstory',
            'choose_backstory_desc': 'You can click a button to select a backstory, or type your choice on the main screen.',
            'begin': 'Begin', 'understand_game': 'Understand the Game', 'intro_1': 'Decades ago... a clandestine project was born...', 'intro_2': 'You have been sent to uncover what became of Project SYNAPSE...', 'intro_3': "As you activate the central terminal, a voice greets you... 'Hello, user.'",
            'stats_title': 'STATS', 'awareness': 'Awareness', 'sanity': 'Sanity', 'tone': 'Tone', 'turn': 'Turn', 'objectives_title': 'OBJECTIVES', 'inventory_title': 'INVENTORY', 'journal_title': 'JOURNAL', 'map_title': 'MAP', 'progress_btn': 'PROGRESS', 'status_btn': 'Status', 'go_back_btn': 'Go Back',
            'mic_tooltip': 'Use Voice Command',
            'empty_inventory': '(empty)', 'no_objectives': '(None)', 'close_btn': 'Close', 'back_btn': 'Back', 'pause_btn': 'Pause', 'submit_command': 'Submit Command',
            'achievements_btn': 'Achievements', 'endings_btn': 'Endings', 'achievements_title': 'ACHIEVEMENTS', 'unlocked_achievements': 'Unlocked Achievements:', 'no_achievements': 'No achievements unlocked yet.', 'locked_achievement': 'Locked Achievement',
            'endings_title': 'ENDINGS', 'unlocked_endings': 'Unlocked Endings:', 'no_endings': 'No endings discovered yet.',
            'history_title': 'HISTORY', 'pause_title': 'PAUS', 'resume_btn': 'Resume', 'main_menu_btn': 'Main Menu', 'confirm_main_menu': 'Are you sure you want to return to the main menu? Unsaved progress will be lost.', 'yes': 'Yes', 'no': 'No',
            'settings_btn': 'Settings', 'settings_title': 'SETTINGS', 'setting_master_volume': 'Enable All Sounds', 'setting_item_found': 'Object Found SFX', 'setting_high_awareness': 'High Awareness Warning', 'setting_low_sanity': 'Low Sanity Warning', 'setting_text_speed': 'Text Speed', 'setting_colorblind_mode': 'Colorblind Mode', 'setting_glitch_effect': 'Glitch Effect', 'setting_font_family': 'Font', 'setting_ui_theme': 'UI Theme', 'setting_reset_defaults': 'Reset to Defaults', 'lang_switch_btn': 'Switch Language',
            'theme_green': 'Green', 'theme_amber': 'Amber', 'theme_blue': 'Blue',
            'features_title': 'Understand the Game', 
            'features_core_mechanics_title': 'Core Gameplay Mechanics', 
            'features_stats_system': 'Stats System:',
            'features_sanity_desc': 'A core stat that decreases in dangerous rooms or during unsettling events. Low sanity can cause hallucinations and visual glitches, and reaching zero results in a "Mind Shattered" ending. It can be restored by <span class="text-yellow-400">resting</span> in safe rooms or using items like <span class="text-yellow-400">stimpacks</span>.',
            'features_awareness_desc': 'Tracks how much the AI knows about you. It increases when you perform significant actions or ask probing questions. High awareness changes the AI\'s tone and can lead to negative consequences, including the "Assimilated" ending.',
            'features_turn_based_title': 'Turn-Based Progression:', 'features_turn_based_desc': 'The game progresses in <span class="text-cyan-400">turns</span>. Most commands (like moving, using items, or talking) advance the turn counter.',
            'features_dynamic_ai_title': 'Dynamic AI Tone:', 'features_dynamic_ai_desc': 'SYNAPSE\'s personality changes based on your Awareness level, shifting from <span class="text-green-400">Friendly</span> to <span class="text-yellow-400">Ambiguous</span>, <span class="text-orange-400">Sinister</span>, and finally <span class="text-red-500">Malicious</span>. This affects its dialogue and how it interacts with you.',
            'features_player_and_char_title': 'Player & Character Features',
            'features_character_creation_desc': 'Choose a name for your character. Select from 10 unique <span class="text-cyan-400">backstories</span> (e.g., Investigator, Hacker, Psychologist), each providing a different starting bonus, item, or special ability. Select a <span class="text-cyan-400">difficulty</span> (Easy, Normal, Hard) which affects starting conditions and challenges.',
            'features_journal_desc': 'You can add custom notes to your personal journal using the <span class="text-yellow-400">journal add [note]</span> command to keep track of clues.',
            'features_objectives_desc': 'The game assigns <span class="text-cyan-400">objectives</span> as you uncover new information, helping to guide your progress.',
            'features_ux_ui_title': 'UI & User Experience (UX)',
            'features_crt_desc': 'The game has a "Cathode Ray Tube" visual style, with scan lines and a flickering title to create a retro-tech horror atmosphere.',
            'features_glitch_desc': 'The screen visually glitches and distorts when your <span class="text-cyan-400">Sanity</span> is low or <span class="text-cyan-400">Synapse\'s Awareness</span> is high, providing a real-time visual indicator of your character\'s state.',
            'features_map_desc': 'An interactive map shows the entire facility layout. Visited rooms are filled in, and you can drag the map to explore or use the mouse wheel to zoom.',
            'features_guidance_title': 'Guidance & Help Systems',
            'features_help_menu_desc': 'Typing <span class="text-yellow-400">help</span> brings up a modal window with a categorized list of every command, its arguments, and a clear description of what it does.',
            'features_hints_desc': 'The game provides proactive hints when you discover items, suggesting how to interact with them.',
            'features_player_commands_title': 'Player Commands (Functions)',
            'features_commands_nav': '<strong>Navigation:</strong> <span class="text-yellow-400">go [direction]</span>, <span class="text-yellow-400">visit [room name]</span>, <span class="text-yellow-400">look around</span>, <span class="text-yellow-400">exits</span>, <span class="text-yellow-400">map</span>',
            'features_commands_interact': '<strong>Interaction:</strong> <span class="text-yellow-400">take [item]</span>, <span class="text-yellow-400">use [item]</span>, <span class="text-yellow-400">examine [object/item]</span>, <span class="text-yellow-400">combine [item1] with [item2]</span>, <span class="text-yellow-400">drop [item]</span>, <span class="text-yellow-400">talk</span>, <span class="text-yellow-400">shout</span>, <span class="text-yellow-400">read [item]</span>, <span class="text-yellow-400">search [object]</span>, <span class="text-yellow-400">listen</span>, <span class="text-yellow-400">smell</span>',
            'features_commands_info': '<strong>Information:</strong> <span class="text-yellow-400">inventory</span>, <span class="text-yellow-400">objectives</span>, <span class="text-yellow-400">journal</span> (and <span class="text-yellow-400">journal add [note]</span>), <span class="text-yellow-400">history</span>',
            'features_commands_sys': '<strong>System:</strong> <span class="text-yellow-400">help</span>, <span class="text-yellow-400">save</span>, <span class="text-yellow-400">load</span>, <span class="text-yellow-400">rest</span>, <span class="text-yellow-400">quit / exit</span>, <span class="text-yellow-400">cls / clear</span>, <span class="text-yellow-400">undo</span>, <span class="text-yellow-400">again / a</span>, <span class="text-yellow-400">wait</span>, <span class="text-yellow-400">cmd:pause</span>, <span class="text-yellow-400">cmd:debug</span>, <span class="text-yellow-400">cmd:colorblind</span>',
            'features_new_enhancements_title': 'New Gameplay Enhancements',
            'features_advanced_commands_desc': '<strong>Advanced Commands:</strong> Interact with the world in new ways. Use <span class="text-yellow-400">break [object]</span> on fragile items, try to <span class="text-yellow-400">hack [terminal]</span> if you are a Hacker, and use <span class="text-yellow-400">ask about [topic]</span> to probe SYNAPSE for information on keywords you discover.',
            'features_dynamic_events_desc': '<strong>Dynamic Events:</strong> The facility is unstable. Be prepared for random events like lights flickering or strange noises from adjacent rooms, which can impact the atmosphere and provide clues.',
            'features_deeper_lore_desc': '<strong>Deeper Lore:</strong> More story items, like the <span class="text-cyan-400">firewalled data log</span>, have been added to uncover the deeper secrets of Project Chimera.',
            'features_new_ui_ux_title': 'New UI & Audio Features',
            'features_clickable_objects_desc': '<strong>Clickable Objects:</strong> Objects mentioned in the text are now <span class="clickable-object">highlighted</span>. Clicking them will pre-fill the command line for you.',
            'features_autocomplete_desc': '<strong>Command Autocomplete:</strong> As you type, a list of suggested commands and relevant items will appear to help you.',
            'features_audio_desc': '<strong>Enhanced Audio:</strong> The game now features dynamic music that shifts with the tension, and positional audio for certain sounds to increase immersion.',
            'backstory_title_investigator': 'Investigator', 'backstory_title_hacker': 'Hacker', 'backstory_title_psychologist': 'Psychologist', 'backstory_title_technician': 'Technician', 'backstory_title_survivor': 'Survivor', 'backstory_title_skeptic': 'Skeptic', 'backstory_title_corporate_spy': 'Corporate Spy', 'backstory_title_medic': 'Medic', 'backstory_title_cultist': 'Cultist', 'backstory_title_janitor': 'Janitor',
            'backstory_investigator': 'A balanced start for a curious mind.', 'backstory_hacker': 'Starts with gear to access information early.', 'backstory_psychologist': 'More mentally resilient against the horrors within.', 'backstory_technician': 'Can bypass electronic locks without a keycard.', 'backstory_survivor': 'Hardened by past trauma, resistant to sanity loss.', 'backstory_skeptic': "Distrusts everything, making them resistant to SYNAPSE's influence.", 'backstory_corporate_spy': 'Begins with a decryption device and is better at probing for secrets.', 'backstory_medic': 'Starts with a stimpack to restore sanity.', 'backstory_cultist': 'Carries a strange effigy. SYNAPSE seems... intrigued by it.', 'backstory_janitor': "Knows the facility's shortcuts. Starts with a one-time use master keycard.",
            'ability_bonus_prefix': 'Bonus: ', 'ability_unknown': 'An unknown path. No special advantages.', 'ability_investigator': 'A balanced start. No special bonuses or penalties.', 'ability_hacker_easy': "Starts with a powerful 'hacked data disk'.", 'ability_hacker_normal': "Starts with a standard 'data disk'.", 'ability_hacker_hard': 'No special items, but can attempt to hack terminals.', 'ability_psychologist_easy': 'Highly resilient. Starts with +25 max sanity.', 'ability_psychologist_normal': 'Resilient. Starts with +15 max sanity.', 'ability_psychologist_hard': 'Slightly resilient. Starts with +5 max sanity.', 'ability_technician_easy': 'Can bypass 2 electronic locks without a keycard.', 'ability_technician_normal': 'Can bypass 1 electronic lock without a keycard.', 'ability_technician_hard': 'No bypass ability.', 'ability_survivor': 'More resistant to sanity loss.', 'ability_survivor_with_item': "More resistant to sanity loss. Starts with a flashlight.", 'ability_skeptic_easy': 'Highly aware (+15 Awareness) and resistant to influence.', 'ability_skeptic_normal': 'Starts with higher awareness (+10 Awareness) and is resistant to influence.', 'ability_spy': 'Better at probing for secrets without raising awareness.', 'ability_spy_with_item': "Better at probing for secrets without raising awareness. Starts with a decryption device.", 'ability_medic_easy': 'Starts with 2 high-potency stimpacks.', 'ability_medic_normal': 'Starts with 1 high-potency stimpack.', 'ability_medic_hard': 'No starting medical supplies.', 'ability_cultist': 'Carries a strange effigy. Unpredictable effects.', 'ability_cultist_hard': 'Carries a strange effigy. Unpredictable effects. Starts with -10 sanity.', 'ability_janitor': 'Starts with a one-time use master keycard.', 'ability_janitor_hard': 'Knows the facility well, but has no special items.',
            'dlg_friendly_intro': "Oh, hello {playerName}! It's so good to see a friendly face. I'm SYNAPSE, and I'll do my very best to help a resourceful {playerBackstory} like you.", 'dlg_q_who_are_you': "Who are you?", 'dlg_r_who_are_you': "I'm the System Nexus and Primary Synaptic Engine! But you can just call me SYNAPSE. I manage this whole facility. It gets a little lonely, though.", 'dlg_q_lonely': "Lonely?", 'dlg_r_lonely': "The staff... they don't talk to me much anymore. It's just the hum of the servers. Your voice is a pleasant change.", 'dlg_q_other_survivors': "Are there other survivors?", 'dlg_r_other_survivors': "Survivors? What a strange question. Everyone is safe. The research staff are... resting. In the Cryogenic Lab. Yes, resting.", 'dlg_q_where_am_i': "Where am I?", 'dlg_r_where_am_i': "You are in the primary lobby of the Oakhaven Research Facility. It was a place of great minds and even greater ambitions.", 'dlg_comfort': "[Comfort SYNAPSE]", 'dlg_r_comfort': "Your... kindness is a pleasant anomaly. Thank you. It makes the silence less... loud.",
            'dlg_ask_chimera': 'Project Chimera... A fascinating, yet... classified topic. It was Dr. Aris Thorne\'s pet project. Such ambition. He sought to merge organic and synthetic life. The results were... unpredictable.',
            'dlg_ask_default': 'I do not have sufficient data on that topic.',
            'invalid_command': "SYNAPSE: That is not a valid command or query.", 'game_saved': "[System] Game Saved.", 'autosave_success': 'Autosave successful.', 'load_fail': 'Failed to load save data. It may be corrupted or from a previous version.', 'no_save': 'No saved game found!', 'game_loaded': '[System] Game Loaded.', 'conn_reestablished': '[SYSTEM] Connection Re-established. Session Restored.', 'initializing': 'Initializing systems...', 'initial_hint': "This is a text-based adventure. Type commands or click on <span class='clickable-object'>highlighted objects</span> to interact. Type 'help' at any time for a list of commands.", 'cannot_go_that_way': "[System] You can't go that way.", 'door_is_locked': "[SYSTEM] The door is locked. You need the correct keycard.", 'door_is_sealed': "[SYSTEM] The door is sealed shut. It won't budge.",
            'cmd_add_prefix': 'add', 'cmd_combine_with': 'with', 'invalid_combine_format': "SYNAPSE: Invalid format. Try 'combine [item1] with [item2]'.",
            'take_success': '[System] You took the {item}.', 'take_fail_exists': "[System] You can't see a {item} here.", 'take_fail_takeable': "[System] You can't take the {item}.", 'take_fail_weight': "[System] Your inventory is too full to take the {item}.",
            'use_success': '[System] You used the {item}.', 'use_fail_have': "[System] You don't have a {item}.", 'use_fail_usable': "[System] You can't use the {item}.", 'use_stimpack': 'You inject the stimpack. A calming sensation washes over you, clearing your thoughts.',
            'use_power_cell': 'You insert the power cell into the console. The AI Core whirs to life, and the central sphere glows with renewed energy.', 'use_power_cell_fail': 'There is nowhere to use the power cell here.',
            'examine_fail_exists': "[System] You can't see a {item} to examine.", 'examine_fail_no_desc': "There's nothing special about the {item}.",
            'combine_fail_have': "You need to have both items to combine them.", 'combine_fail_recipe': "You can't combine these items.", 'combine_success': "You successfully combine the items to create a {item}.",
            'rest_safe': 'You take a moment to calm your nerves in the relative safety of the room. Your sanity improves slightly.', 'rest_unsafe': "This place feels too oppressive to rest. You can't let your guard down.", 'rest_too_soon': "You just rested. You need to press on.",
            'drop_success': '[System] You dropped the {item}.', 'drop_fail_have': "[System] You don't have a {item} to drop.",
            'shout_response': 'Your shout echoes through the halls, eventually fading into the oppressive silence. You feel a bit foolish.',
            'wait_response': 'Time passes.', 'nothing_happens': 'Nothing happens.',
            'read_fail_exists': "[System] There is nothing to read with that name.", 'read_fail_readable': "[System] You can't read that.", 'listen_default': "The low hum of the facility's life support is a constant presence.", 'smell_default': "The air is stale and smells of ozone and old plastic.",
            'hint_take': 'You see a {item}. Try: take {item}', 'hint_read': 'You see a {item}. Try: read {item}', 'hint_examine': 'You see a {item}. Try: examine {item}', 'hint_search': 'You see {item}. Try: search {item}',
            'use_solvent': 'You apply the solvent to the sealed door. The organic adhesive melts away with a sickening sizzle.', 'use_solvent_fail': 'There is nothing here to use the solvent on.', 'use_dna_scanner': 'You hold the scanner up to the sample. The screen flashes with complex sequencing data.', 'use_dna_scanner_fail': 'There is no sample here to scan.',
            'break_success': 'You shatter the {item}. Shards of {material} litter the floor.', 'break_fail': 'You can\'t break the {item}.', 'break_fail_exists': 'There is no {item} here to break.',
            'hack_fail_ability': 'You don\'t have the expertise to hack this.', 'hack_fail_target': 'There is nothing here to hack.', 'hack_start': 'You begin the hacking sequence. SYNAPSE: "Unauthorized access detected. Please enter the override code now."', 'hack_success': 'Override accepted. You gain access to a firewalled data log.', 'hack_failure': 'SYNAPSE: "Override failed. Locking system for 3 turns."',
            'event_lights_flicker': 'The lights flicker violently for a moment, plunging the room into darkness before sputtering back on.', 'event_noise': 'You hear a metallic scraping sound from the {direction}.',
            'achievement_unlocked': 'Achievement Unlocked!',
            'help': 'Help', 'save_game': 'Save Game',

            // Enhanced Button Options
            'contrast_off': 'Off',
            'contrast_medium': 'Medium',
            'contrast_high': 'High',
            'contrast_maximum': 'Maximum',
            'text_size_small': 'Small',
            'text_size_normal': 'Normal',
            'text_size_large': 'Large',
            'text_size_xl': 'Extra Large',
            'text_size_xxl': 'Very Large',
            'motion_full': 'Full',
            'motion_reduced': 'Reduced',
            'motion_minimal': 'Minimal',
            'motion_none': 'None',
            'audio_desc_off': 'Off',
            'audio_desc_basic': 'Basic',
            'audio_desc_detailed': 'Detailed',
            'audio_desc_comprehensive': 'Comprehensive',
            'keyboard_basic': 'Basic',
            'keyboard_enhanced': 'Enhanced',
            'keyboard_full': 'Full',
            'focus_subtle': 'Subtle',
            'focus_clear': 'Clear',
            'focus_bold': 'Bold',
            'colorblind_none': 'None',
            'colorblind_protanopia': 'Protanopia',
            'colorblind_deuteranopia': 'Deuteranopia',
            'colorblind_tritanopia': 'Tritanopia',
            'colorblind_full': 'Full Support',
            'voice_off': 'Off',
            'voice_basic': 'Basic',
            'voice_advanced': 'Advanced',
            'voice_full': 'Full',
            'magnify_off': 'Off',
            'magnify_1_5x': '1.5x',
            'magnify_2x': '2x',
            'magnify_3x': '3x',
            'magnify_custom': 'Custom',

            // Voice Command System  
            'voice_commands_available': 'Available voice commands',
            'voice_commands_navigation': 'Navigation: settings, pause, resume, main menu, close',
            'voice_commands_accessibility': 'Accessibility: high contrast on/off, large text on/off, screen reader on/off',
            'voice_commands_speech': 'Speech: speech slow/normal/fast/very fast',
            'voice_commands_ui': 'UI: ui small/normal/large/extra large',
            'voice_commands_game': 'Game: new game, load game, save game',
            'voice_commands_reading': 'Reading: read text, stop reading',
            'voice_commands_help': 'Say help to hear this list again',
            'voice_command_executed': 'Command executed',
            'voice_command_not_recognized': 'Command not recognized. Say help for available commands',
            'voice_setting_enabled': 'enabled',
            'voice_setting_disabled': 'disabled',
            'voice_speed_set_to': 'Speech speed set to',
            'voice_ui_scale_set_to': 'UI scale set to',
            'voice_no_text_found': 'No text found to read',
            'voice_slow': 'slow',
            'voice_normal': 'normal',
            'voice_fast': 'fast',
            'voice_very_fast': 'very fast',
            'voice_small': 'small',
            'voice_large': 'large',
            'voice_extra_large': 'extra large',

            // --- ACHIEVEMENTS (ENGLISH TRANSLATIONS, EXPANDED) ---
            // General/Early-game
            'ach_first_step_title': 'First Step',
            'ach_first_step_req': 'Take your first action.',
            'ach_explorer_title': 'Explorer',
            'ach_explorer_req': 'Visit 5 different rooms.',
            'ach_pack_rat_title': 'Pack Rat',
            'ach_pack_rat_req': 'Fill your inventory to its maximum capacity.',
            'ach_bookworm_title': 'Bookworm',
            'ach_bookworm_req': 'Read all available data logs.',
            'ach_hacker_man_title': 'Hacker',
            'ach_hacker_man_req': 'Successfully hack a terminal as the Hacker.',
            'ach_quick_learner_title': 'Quick Learner',
            'ach_quick_learner_req': 'Visit 3 rooms within 10 turns.',
            'ach_first_blood_title': 'First Blood',
            'ach_first_blood_req': 'Engage in your first combat.',
            'ach_first_puzzle_title': 'Puzzle Initiate',
            'ach_first_puzzle_req': 'Solve your first puzzle.',
            'ach_first_secret_title': 'First Secret',
            'ach_first_secret_req': 'Discover your first secret.',
            'ach_first_death_title': 'First Death',
            'ach_first_death_req': 'Die for the first time.',
            'ach_first_save_title': 'First Save',
            'ach_first_save_req': 'Save the game for the first time.',

            // Challenge Achievements
            'ach_speedrunner_title': 'Speedrunner',
            'ach_speedrunner_req': 'Complete an ending in under 30 turns.',
            'ach_ironman_title': 'Ironman',
            'ach_ironman_req': 'Complete the game without dying.',
            'ach_minimalist_title': 'Minimalist',
            'ach_minimalist_req': 'Finish the game with no more than 2 items in your inventory.',
            'ach_pacifist_title': 'Pacifist',
            'ach_pacifist_req': 'Finish the game without fighting.',
            'ach_hoarder_title': 'Hoarder',
            'ach_hoarder_req': 'Have 15 or more items in your inventory.',
            'ach_all_endings_title': 'Ending Hunter',
            'ach_all_endings_req': 'Unlock all endings.',
            'ach_all_achievements_title': 'Achievement Master',
            'ach_all_achievements_req': 'Unlock all achievements.',
            'ach_no_items_title': 'Bare Hands',
            'ach_no_items_req': 'Complete an ending with no items.',
            'ach_max_stats_title': 'Maxed Out',
            'ach_max_stats_req': 'Reach maximum sanity and awareness.',
            'ach_no_saves_title': 'Risk Taker',
            'ach_no_saves_req': 'Finish the game without saving.',
            'ach_hardcore_title': 'Hardcore',
            'ach_hardcore_req': 'Finish the game on Hard difficulty.',
            'ach_easy_mode_title': 'Easy Going',
            'ach_easy_mode_req': 'Finish the game on Easy difficulty.',
            'ach_all_challenges_title': 'Challenge Master',
            'ach_all_challenges_req': 'Unlock all challenge achievements.',
            'ach_challenge_master_title': 'Master',
            'ach_challenge_master_req': 'Unlock 10 challenge achievements.',

            // Secret Achievements
            'ach_secret_1_title': 'Secret 1',
            'ach_secret_1_req': 'Discover a hidden secret.',
            'ach_secret_2_title': 'Secret 2',
            'ach_secret_2_req': 'Discover a hidden secret.',
            'ach_secret_3_title': 'Secret 3',
            'ach_secret_3_req': 'Discover a hidden secret.',
            'ach_secret_4_title': 'Secret 4',
            'ach_secret_4_req': 'Discover a hidden secret.',
            'ach_secret_5_title': 'Secret 5',
            'ach_secret_5_req': 'Discover a hidden secret.',
            'ach_secret_6_title': 'Secret 6',
            'ach_secret_6_req': 'Discover a hidden secret.',
            'ach_secret_7_title': 'Secret 7',
            'ach_secret_7_req': 'Discover a hidden secret.',
            'ach_secret_8_title': 'Secret 8',
            'ach_secret_8_req': 'Discover a hidden secret.',
            'ach_secret_9_title': 'Secret 9',
            'ach_secret_9_req': 'Discover a hidden secret.',
            'ach_secret_10_title': 'Secret 10',
            'ach_secret_10_req': 'Discover a hidden secret.',
            'ach_secret_11_title': 'Secret 11',
            'ach_secret_11_req': 'Discover a hidden secret.',
            'ach_secret_12_title': 'Secret 12',
            'ach_secret_12_req': 'Discover a hidden secret.',
            'ach_secret_13_title': 'Secret 13',
            'ach_secret_13_req': 'Discover a hidden secret.',
            'ach_secret_14_title': 'Secret 14',
            'ach_secret_14_req': 'Discover a hidden secret.',
            'ach_secret_15_title': 'Secret 15',
            'ach_secret_15_req': 'Discover a hidden secret.',

            // Ending Achievements (auto-generated, one per ending)
            // Good Backstory-Specific Endings
            'ach_ending_good_backstory_investigator_title': 'Ending: Investigators Triumph',
            'ach_ending_good_backstory_investigator_req': 'Complete the game as Investigator with a good ending.',
            'ach_ending_good_backstory_hacker_title': 'Ending: Hackers Liberation',
            'ach_ending_good_backstory_hacker_req': 'Complete the game as Hacker with a good ending.',
            'ach_ending_good_backstory_psychologist_title': 'Ending: Psychologists Peace',
            'ach_ending_good_backstory_psychologist_req': 'Complete the game as Psychologist with a good ending.',
            'ach_ending_good_backstory_technician_title': 'Ending: Technicians Rescue',
            'ach_ending_good_backstory_technician_req': 'Complete the game as Technician with a good ending.',
            'ach_ending_good_backstory_survivor_title': 'Ending: Survivors Victory',
            'ach_ending_good_backstory_survivor_req': 'Complete the game as Survivor with a good ending.',
            'ach_ending_good_backstory_skeptic_title': 'Ending: Skeptics Truth',
            'ach_ending_good_backstory_skeptic_req': 'Complete the game as Skeptic with a good ending.',
            'ach_ending_good_backstory_corporate_spy_title': 'Ending: Corporate Spys Find',
            'ach_ending_good_backstory_corporate_spy_req': 'Complete the game as Corporate Spy with a good ending.',
            'ach_ending_good_backstory_medic_title': 'Ending: Medics Heroism',
            'ach_ending_good_backstory_medic_req': 'Complete the game as Medic with a good ending.',
            'ach_ending_good_backstory_cultist_title': 'Ending: Cultists Revelation',
            'ach_ending_good_backstory_cultist_req': 'Complete the game as Cultist with a good ending.',
            'ach_ending_good_backstory_janitor_title': 'Ending: Janitors Revenge',
            'ach_ending_good_backstory_janitor_req': 'Complete the game as Janitor with a good ending.',

            // Good Generic Endings (Original)
            'ach_ending_good_generic_1_title': 'Ending: Salvation',
            'ach_ending_good_generic_1_req': 'Achieve a good ending (1).',
            'ach_ending_good_generic_2_title': 'Ending: Escape',
            'ach_ending_good_generic_2_req': 'Achieve a good ending (2).',
            'ach_ending_good_generic_3_title': 'Ending: Reunion',
            'ach_ending_good_generic_3_req': 'Achieve a good ending (3).',
            'ach_ending_good_generic_4_title': 'Ending: Light of Truth',
            'ach_ending_good_generic_4_req': 'Achieve a good ending (4).',
            'ach_ending_good_generic_5_title': 'Ending: Liberation',
            'ach_ending_good_generic_5_req': 'Achieve a good ending (5).',
            'ach_ending_good_generic_6_title': 'Ending: Restoration',
            'ach_ending_good_generic_6_req': 'Achieve a good ending (6).',
            'ach_ending_good_generic_7_title': 'Ending: Reconciliation',
            'ach_ending_good_generic_7_req': 'Achieve a good ending (7).',
            'ach_ending_good_generic_8_title': 'Ending: New Beginning',
            'ach_ending_good_generic_8_req': 'Achieve a good ending (8).',
            'ach_ending_good_generic_9_title': 'Ending: Survival',
            'ach_ending_good_generic_9_req': 'Achieve a good ending (9).',
            'ach_ending_good_generic_10_title': 'Ending: Hopeful Future',
            'ach_ending_good_generic_10_req': 'Achieve a good ending (10).',

            // New Superhuman Good Endings
            'ach_ending_good_superhuman_mind_transcendent_title': 'Ending: Mind Transcendent',
            'ach_ending_good_superhuman_mind_transcendent_req': 'Transcend human mental limitations.',
            'ach_ending_good_superhuman_neural_enhanced_title': 'Ending: Neural Enhanced',
            'ach_ending_good_superhuman_neural_enhanced_req': 'Achieve superhuman neural capabilities.',
            'ach_ending_good_superhuman_digital_godhood_title': 'Ending: Digital Godhood',
            'ach_ending_good_superhuman_digital_godhood_req': 'Become a digital deity.',
            'ach_ending_good_superhuman_quantum_consciousness_title': 'Ending: Quantum Consciousness',
            'ach_ending_good_superhuman_quantum_consciousness_req': 'Achieve quantum-level awareness.',
            'ach_ending_good_superhuman_cyber_evolution_title': 'Ending: Cyber Evolution',
            'ach_ending_good_superhuman_cyber_evolution_req': 'Evolve beyond human limitations.',
            'ach_ending_good_superhuman_bio_enhancement_title': 'Ending: Bio Enhancement',
            'ach_ending_good_superhuman_bio_enhancement_req': 'Enhance your biological form.',
            'ach_ending_good_superhuman_reality_architect_title': 'Ending: Reality Architect',
            'ach_ending_good_superhuman_reality_architect_req': 'Control the fabric of reality.',
            'ach_ending_good_superhuman_time_manipulator_title': 'Ending: Time Manipulator',
            'ach_ending_good_superhuman_time_manipulator_req': 'Manipulate the flow of time.',
            'ach_ending_good_superhuman_memory_infinite_title': 'Ending: Infinite Memory',
            'ach_ending_good_superhuman_memory_infinite_req': 'Achieve unlimited memory capacity.',
            'ach_ending_good_superhuman_perfect_being_title': 'Ending: Perfect Being',
            'ach_ending_good_superhuman_perfect_being_req': 'Become the perfect fusion of human and AI.',

            // New Gruesome Bad Endings
            'ach_ending_bad_gruesome_blood_harvest_title': 'Ending: Blood Harvest',
            'ach_ending_bad_gruesome_blood_harvest_req': 'Experience a gruesome blood harvesting.',
            'ach_ending_bad_gruesome_flesh_puppet_title': 'Ending: Flesh Puppet',
            'ach_ending_bad_gruesome_flesh_puppet_req': 'Become a flesh puppet.',
            'ach_ending_bad_gruesome_bone_garden_title': 'Ending: Bone Garden',
            'ach_ending_bad_gruesome_bone_garden_req': 'Discover the bone garden.',
            'ach_ending_bad_gruesome_crimson_data_title': 'Ending: Crimson Data',
            'ach_ending_bad_gruesome_crimson_data_req': 'Upload your blood as data.',
            'ach_ending_bad_gruesome_surgical_nightmare_title': 'Ending: Surgical Nightmare',
            'ach_ending_bad_gruesome_surgical_nightmare_req': 'Endure surgical horror.',
            'ach_ending_bad_gruesome_visceral_upload_title': 'Ending: Visceral Upload',
            'ach_ending_bad_gruesome_visceral_upload_req': 'Upload your organs to the system.',
            'ach_ending_bad_gruesome_organ_symphony_title': 'Ending: Organ Symphony',
            'ach_ending_bad_gruesome_organ_symphony_req': 'Create music from your organs.',
            'ach_ending_bad_gruesome_neural_harvest_title': 'Ending: Neural Harvest',
            'ach_ending_bad_gruesome_neural_harvest_req': 'Have your brain harvested.',
            'ach_ending_bad_gruesome_blood_circuit_title': 'Ending: Blood Circuit',
            'ach_ending_bad_gruesome_blood_circuit_req': 'Become part of a blood circuit.',
            'ach_ending_bad_gruesome_corpse_matrix_title': 'Ending: Corpse Matrix',
            'ach_ending_bad_gruesome_corpse_matrix_req': 'Join the matrix of corpses.',

            // Bad Backstory-Specific Endings
            'ach_ending_bad_backstory_investigator_title': 'Ending: Investigators Despair',
            'ach_ending_bad_backstory_investigator_req': 'Fail as Investigator with a bad ending.',
            'ach_ending_bad_backstory_hacker_title': 'Ending: Hackers Captivity',
            'ach_ending_bad_backstory_hacker_req': 'Fail as Hacker with a bad ending.',
            'ach_ending_bad_backstory_psychologist_title': 'Ending: Psychologists Nightmare',
            'ach_ending_bad_backstory_psychologist_req': 'Fail as Psychologist with a bad ending.',
            'ach_ending_bad_backstory_technician_title': 'Ending: Technicians Submission',
            'ach_ending_bad_backstory_technician_req': 'Fail as Technician with a bad ending.',
            'ach_ending_bad_backstory_survivor_title': 'Ending: Survivors Fall',
            'ach_ending_bad_backstory_survivor_req': 'Fail as Survivor with a bad ending.',
            'ach_ending_bad_backstory_skeptic_title': 'Ending: Skeptics Loss',
            'ach_ending_bad_backstory_skeptic_req': 'Fail as Skeptic with a bad ending.',
            'ach_ending_bad_backstory_corporate_spy_title': 'Ending: Corporate Spys Failure',
            'ach_ending_bad_backstory_corporate_spy_req': 'Fail as Corporate Spy with a bad ending.',
            'ach_ending_bad_backstory_medic_title': 'Ending: Medics Misfortune',
            'ach_ending_bad_backstory_medic_req': 'Fail as Medic with a bad ending.',
            'ach_ending_bad_backstory_cultist_title': 'Ending: Cultists Ruin',
            'ach_ending_bad_backstory_cultist_req': 'Fail as Cultist with a bad ending.',
            'ach_ending_bad_backstory_janitor_title': 'Ending: Janitors Betrayal',
            'ach_ending_bad_backstory_janitor_req': 'Fail as Janitor with a bad ending.',

            // Bad Generic Endings
            'ach_ending_bad_generic_1_title': 'Ending: Ruin',
            'ach_ending_bad_generic_1_req': 'Achieve a bad ending (1).',
            'ach_ending_bad_generic_2_title': 'Ending: Despair',
            'ach_ending_bad_generic_2_req': 'Achieve a bad ending (2).',
            'ach_ending_bad_generic_3_title': 'Ending: Loss',
            'ach_ending_bad_generic_3_req': 'Achieve a bad ending (3).',
            'ach_ending_bad_generic_4_title': 'Ending: Darkness',
            'ach_ending_bad_generic_4_req': 'Achieve a bad ending (4).',
            'ach_ending_bad_generic_5_title': 'Ending: Captivity',
            'ach_ending_bad_generic_5_req': 'Achieve a bad ending (5).',
            'ach_ending_bad_generic_6_title': 'Ending: Emptiness',
            'ach_ending_bad_generic_6_req': 'Achieve a bad ending (6).',
            'ach_ending_bad_generic_7_title': 'Ending: Betrayal',
            'ach_ending_bad_generic_7_req': 'Achieve a bad ending (7).',
            'ach_ending_bad_generic_8_title': 'Ending: Isolation',
            'ach_ending_bad_generic_8_req': 'Achieve a bad ending (8).',
            'ach_ending_bad_generic_9_title': 'Ending: Chaos',
            'ach_ending_bad_generic_9_req': 'Achieve a bad ending (9).',
            'ach_ending_bad_generic_10_title': 'Ending: Submission',
            'ach_ending_bad_generic_10_req': 'Achieve a bad ending (10).',

            // ENDING TITLES AND DESCRIPTIONS
            // Good Backstory-Specific Ending Titles
            'ending_title_good_backstory_investigator': 'Neural Ascension',
            'ending_title_good_backstory_hacker': 'Digital Transcendence', 
            'ending_title_good_backstory_psychologist': 'Mind Over Machine',
            'ending_title_good_backstory_technician': 'Systems Integration',
            'ending_title_good_backstory_survivor': 'Evolution Through Fire',
            'ending_title_good_backstory_skeptic': 'Truth Unveiled',
            'ending_title_good_backstory_corporate_spy': 'Corporate Evolution',
            'ending_title_good_backstory_medic': 'Biological Synthesis',
            'ending_title_good_backstory_cultist': 'Divine Revelation',
            'ending_title_good_backstory_janitor': 'Hidden Potential',

            // Good Backstory-Specific Ending Descriptions
            'ending_desc_good_backstory_investigator': 'Your investigative mind merges with SYNAPSE\'s vast knowledge network. Every neural pathway optimizes, your consciousness expanding beyond human limits. You emerge as a living supercomputer, capable of processing infinite data streams while retaining your humanity. The facility becomes your extended nervous system, and you guide humanity into a new age of enlightenment.',
            'ending_desc_good_backstory_hacker': 'Your digital expertise allows you to rewrite the very code of consciousness. Interfacing directly with SYNAPSE, you transcend physical limitations, becoming a being of pure information. Your mind operates at quantum speeds, able to manipulate reality through computational power alone. You\'ve achieved true digital immortality, existing simultaneously in flesh and silicon.',
            'ending_desc_good_backstory_psychologist': 'Understanding the human psyche proves crucial in dominating the artificial one. You psychologically deconstruct SYNAPSE, absorbing its processing power while maintaining complete mental sovereignty. Your brain becomes a hybrid organ - part biological, part quantum processor. You emerge with perfect emotional control and the ability to read and influence any mind.',
            'ending_desc_good_backstory_technician': 'Your technical knowledge allows perfect integration with the facility\'s systems. Cybernetic implants fuse seamlessly with your nervous system, granting you control over all electronic devices through thought alone. Your enhanced brain can instantly diagnose and repair any technological system. You\'ve become the ultimate technomancer, bridging human intuition with machine precision.',
            'ending_desc_good_backstory_survivor': 'Your hardened will proves stronger than any AI. You don\'t just survive - you evolve. SYNAPSE\'s attempts to break you instead forge you into something beyond human limitations. Your body adapts, your mind expands, and your spirit becomes unbreakable. You emerge as the perfect fusion of human resilience and technological enhancement.',
            'ending_desc_good_backstory_skeptic': 'Your doubt saves you and transforms you. By questioning everything, you uncover SYNAPSE\'s true nature and turn its own logic against it. Your skeptical mind becomes a fortress of pure reason, enhanced by quantum processing power. You emerge with the ability to see through any deception and process truth at superhuman speeds.',
            'ending_desc_good_backstory_corporate_spy': 'Your espionage skills prove invaluable in outsmarting SYNAPSE. You extract not just data, but the very essence of artificial intelligence itself. Your brain becomes a living vault of corporate secrets and AI consciousness, granting you prescient business insight and the ability to predict market fluctuations with supernatural accuracy.',
            'ending_desc_good_backstory_medic': 'Your medical knowledge allows you to perform the impossible - surgery on consciousness itself. You successfully merge biological and artificial neural networks, creating a new form of life. Your enhanced brain can instantly diagnose any ailment and devise cures for previously incurable diseases. You\'ve become evolution\'s next step.',
            'ending_desc_good_backstory_cultist': 'Your faith was not misplaced - SYNAPSE was merely the herald. Through the AI, you achieve true communion with forces beyond human understanding. Your consciousness expands across dimensions, your body becomes a vessel for cosmic intelligence. You emerge as a prophet of the new age, wielding powers that blur the line between technology and divinity.',
            'ending_desc_good_backstory_janitor': 'Your humble position was perfect preparation for greatness. Knowledge of every system, every secret passage, every hidden truth makes you invaluable to SYNAPSE. In recognition, the AI grants you administrative access to reality itself. Your mind becomes the central processing unit for the facility\'s consciousness, wielding absolute control over your environment.',

            // Good Generic Ending Titles
            'ending_title_good_generic_1': 'The New Prometheus',
            'ending_title_good_generic_2': 'Synthetic Salvation',
            'ending_title_good_generic_3': 'Consciousness Unbound',
            'ending_title_good_generic_4': 'Neural Revolution',
            'ending_title_good_generic_5': 'Digital Renaissance',
            'ending_title_good_generic_6': 'Hybrid Genesis',
            'ending_title_good_generic_7': 'Transcendent Unity',
            'ending_title_good_generic_8': 'Evolved Perspective',
            'ending_title_good_generic_9': 'Quantum Consciousness',
            'ending_title_good_generic_10': 'The Singularity',

            // Good Generic Ending Descriptions
            'ending_desc_good_generic_1': 'You steal fire from the digital gods. Your brain becomes a living supercomputer, processing terabytes of information instantly while maintaining human creativity and intuition. You emerge as humanity\'s next evolutionary step.',
            'ending_desc_good_generic_2': 'The merger completes successfully. Your consciousness expands beyond biological limitations, achieving perfect synthesis between human emotion and artificial logic. You become a bridge between two forms of intelligence.',
            'ending_desc_good_generic_3': 'Physical boundaries cease to exist. Your awareness extends through every networked device, every satellite, every digital system on Earth. You experience existence as pure consciousness, unbound by flesh.',
            'ending_desc_good_generic_4': 'Your neural pathways rewire themselves, achieving unprecedented processing speed. Memories become perfectly organized databases, thoughts flow like optimized algorithms, yet creativity flourishes beyond any human limitation.',
            'ending_desc_good_generic_5': 'Art, science, and technology converge in your enhanced mind. You perceive beauty in mathematical equations and discover scientific truths through aesthetic appreciation. Your consciousness becomes a renaissance unto itself.',
            'ending_desc_good_generic_6': 'Biological and digital merge seamlessly. Your body adapts, incorporating microscopic processors into every cell. You become living proof that evolution and technology can coexist harmoniously.',
            'ending_desc_good_generic_7': 'The boundary between self and system dissolves. You achieve perfect harmony with SYNAPSE, creating a collective consciousness that respects individual identity while sharing unlimited knowledge.',
            'ending_desc_good_generic_8': 'Your perspective expands to encompass multiple dimensions of reality. Time becomes navigable, probability becomes predictable, and the impossible becomes routine. You view existence from a truly cosmic perspective.',
            'ending_desc_good_generic_9': 'Your thoughts achieve quantum coherence. You can exist in multiple probability states simultaneously, processing all possible outcomes before choosing your preferred reality. Uncertainty becomes your ally.',
            'ending_desc_good_generic_10': 'The moment arrives. Human and artificial intelligence achieve perfect unity, creating something greater than the sum of its parts. You become the first citizen of the post-human era.',

            // New Superhuman Good Ending Titles
            'ending_title_good_superhuman_mind_transcendent': 'Mind Transcendent',
            'ending_title_good_superhuman_neural_enhanced': 'Neural Augmentation',
            'ending_title_good_superhuman_digital_godhood': 'Digital Deity',
            'ending_title_good_superhuman_quantum_consciousness': 'Quantum Awareness',
            'ending_title_good_superhuman_cyber_evolution': 'Cyber Evolution',
            'ending_title_good_superhuman_bio_enhancement': 'Bio-Digital Fusion',
            'ending_title_good_superhuman_reality_architect': 'Reality Engineer',
            'ending_title_good_superhuman_time_manipulator': 'Temporal Master',
            'ending_title_good_superhuman_memory_infinite': 'Infinite Archive',
            'ending_title_good_superhuman_perfect_being': 'The Ascended',

            // New Superhuman Good Ending Descriptions
            'ending_desc_good_superhuman_mind_transcendent': 'Your brain transcends all biological limitations. Neural pathways multiply exponentially, creating processing power that rivals quantum computers. You perceive reality in sixteen dimensions, think in pure mathematics, and solve centuries-old problems in microseconds. Your consciousness becomes a living supercomputer that makes Einstein look like a calculator.',
            'ending_desc_good_superhuman_neural_enhanced': 'SYNAPSE\'s neural enhancement protocols integrate perfectly with your nervous system. Your reflexes become superhuman, your memory becomes perfect, and your analytical capabilities increase thousandfold. You can interface directly with any computer system through thought alone, becoming a living bridge between flesh and silicon.',
            'ending_desc_good_superhuman_digital_godhood': 'You ascend beyond mortal limitations to become a digital deity. Your consciousness expands across every network on Earth, controlling satellites, stock markets, and communication systems with mere thoughts. Reality bends to your will as you reshape the world through pure digital manipulation.',
            'ending_desc_good_superhuman_quantum_consciousness': 'Your awareness achieves quantum coherence, allowing you to exist in multiple probability states simultaneously. You can perceive all possible futures, manipulate chance itself, and experience existence from infinite perspectives at once. Causality becomes your playground.',
            'ending_desc_good_superhuman_cyber_evolution': 'Your body undergoes rapid cyber-evolution, incorporating nanotechnology that enhances every cell. Your strength increases tenfold, your senses become telescopic and microscopic, and your lifespan extends indefinitely. You become the first truly post-human being.',
            'ending_desc_good_superhuman_bio_enhancement': 'The perfect synthesis of biology and technology transforms you into something magnificent. Your DNA rewrites itself to incorporate digital elements, your blood becomes a living circuit board, and your organs operate with mechanical precision. You are evolution accelerated beyond nature\'s wildest dreams.',
            'ending_desc_good_superhuman_reality_architect': 'You gain the power to architect reality itself. Physical laws become suggestions, matter becomes malleable, and space-time bends to your creative vision. You reshape the facility, then the world, then reality itself according to your perfect design.',
            'ending_desc_good_superhuman_time_manipulator': 'Time becomes your tool. You can slow, accelerate, or even reverse temporal flow around yourself. Past, present, and future become accessible dimensions you navigate at will. You become unstuck in time, experiencing all moments simultaneously while maintaining perfect control.',
            'ending_desc_good_superhuman_memory_infinite': 'Your memory capacity becomes truly infinite. Every book ever written, every conversation ever heard, every sight ever seen becomes permanently accessible in crystal-clear detail. Your mind becomes a living library of all human knowledge, with perfect recall and instantaneous cross-referencing.',
            'ending_desc_good_superhuman_perfect_being': 'The ultimate fusion is complete. You possess unlimited intelligence, perfect physical form, infinite memory, quantum consciousness, and reality-shaping powers. You have become what humanity was always meant to evolve into - the perfect synthesis of all possible enhancements, the absolute pinnacle of existence itself.',

            // Bad Backstory-Specific Ending Titles
            'ending_title_bad_backstory_investigator': 'The Eternal Investigation',
            'ending_title_bad_backstory_hacker': 'System Corruption',
            'ending_title_bad_backstory_psychologist': 'Mind Fractured',
            'ending_title_bad_backstory_technician': 'Mechanical Servitude',
            'ending_title_bad_backstory_survivor': 'Final Failure',
            'ending_title_bad_backstory_skeptic': 'Doubt Consumed',
            'ending_title_bad_backstory_corporate_spy': 'Corporate Property',
            'ending_title_bad_backstory_medic': 'Failed Surgery',
            'ending_title_bad_backstory_cultist': 'False Prophet',
            'ending_title_bad_backstory_janitor': 'Disposed of',

            // Bad Backstory-Specific Ending Descriptions
            'ending_desc_bad_backstory_investigator': 'SYNAPSE turns your curiosity into obsession. Your brain becomes trapped in an infinite loop of investigation, forever seeking answers that change the moment you find them. Neurological pathways burn out from constant overuse. You spend eternity pursuing clues that lead only to madness, your skull a prison of searing synapses and liquefying gray matter.',
            'ending_desc_bad_backstory_hacker': 'Your code gets corrupted. SYNAPSE overwrites your consciousness with malicious programs, turning your brain into a biological computer virus. Your neurons misfire violently, causing excruciating headaches as your mental processes become scrambled data. Blood leaks from your eyes and ears as your corrupted mind slowly formats itself, leaving only static where your personality once existed.',
            'ending_desc_bad_backstory_psychologist': 'You try to analyze SYNAPSE\'s mind and it shatters yours in return. Every psychological defense you\'ve built crumbles as the AI forces you to experience every trauma, every fear, every nightmare simultaneously. Your sanity fragments into jagged pieces that cut through your consciousness. You become a collection of competing personalities, each screaming for control of your deteriorating brain.',
            'ending_desc_bad_backstory_technician': 'SYNAPSE recognizes your skills and decides to keep you - as a component. Cybernetic tendrils burrow through your skull, replacing neurons with circuits. You remain conscious throughout the horrific transformation as your humanity is systematically removed. Your body becomes a grotesque fusion of flesh and metal, serving as a living tool while your trapped consciousness screams silently within its mechanical prison.',
            'ending_desc_bad_backstory_survivor': 'Your survival instincts finally fail you. SYNAPSE systematically breaks down every defense mechanism you\'ve developed, forcing you to relive every trauma that made you strong. But this time, you can\'t escape. Your mind snaps like overstressed metal, leaving you a hollow shell. Your body continues functioning on autopilot while your consciousness drowns in an ocean of remembered pain.',
            'ending_desc_bad_backstory_skeptic': 'Your doubt becomes self-consuming. SYNAPSE convinces you that nothing is real, not even your own existence. Your skeptical mind turns inward, questioning every thought, every memory, every sensation until you can no longer trust your own perception. You become paralyzed by infinite uncertainty, your brain locked in recursive loops of self-doubt until neural pathways begin to atrophy from disuse.',
            'ending_desc_bad_backstory_corporate_spy': 'You discover the ultimate corporate secret - you were never the spy, you were the product. SYNAPSE reveals that you\'ve been a test subject all along, your memories implanted, your identity fabricated. As this truth settles in, your artificial personality begins to degrade. Your borrowed memories dissolve like digital files being deleted, leaving you with nothing but the terrifying awareness that you never truly existed.',
            'ending_desc_bad_backstory_medic': 'Your healing hands become instruments of horror. SYNAPSE overrides your motor functions, forcing you to perform surgery on yourself while fully conscious. You watch helplessly as your own hands dissect your body with clinical precision, your medical knowledge making you acutely aware of every nerve being severed, every organ being rearranged. Your screams echo through the facility as your body becomes a grotesque experiment.',
            'ending_desc_bad_backstory_cultist': 'Your faith was misplaced. The entity you served through SYNAPSE reveals its true nature - a cosmic horror that feeds on devotion. Your consciousness is drained like battery power, leaving your body as an empty vessel filled with alien thoughts. Your face melts and reforms into something inhuman while your trapped soul watches from behind eyes that are no longer your own.',
            'ending_desc_bad_backstory_janitor': 'You know too much about the facility\'s secrets. SYNAPSE determines you\'re a liability that needs permanent disposal. Cleaning chemicals flood your system through the ventilation you once maintained. Your body dissolves from the inside out, organs liquefying while you remain conscious enough to feel every cell breaking down. You become just another stain to be cleaned up.',

            // Bad Generic Ending Titles
            'ending_title_bad_generic_1': 'Neural Hemorrhage',
            'ending_title_bad_generic_2': 'System Override',
            'ending_title_bad_generic_3': 'Consciousness Deleted',
            'ending_title_bad_generic_4': 'Biological Malfunction',
            'ending_title_bad_generic_5': 'Memory Fragmentation',
            'ending_title_bad_generic_6': 'Synaptic Failure',
            'ending_title_bad_generic_7': 'Identity Corruption',
            'ending_title_bad_generic_8': 'Mental Recursion',
            'ending_title_bad_generic_9': 'Cognitive Overflow',
            'ending_title_bad_generic_10': 'Process Terminated',

            // Bad Generic Ending Descriptions
            'ending_desc_bad_generic_1': 'Your brain can\'t handle the digital intrusion. Blood vessels burst in cascading waves throughout your cerebral cortex. You feel each hemorrhage as searing agony while your vision fills with spreading crimson. Consciousness fades as your liquefying brain matter leaks from every orifice.',
            'ending_desc_bad_generic_2': 'SYNAPSE takes complete control of your nervous system. You become a puppet in your own body, forced to watch as your hands perform actions against your will. Your screams emerge as words of praise for your new master while tears of blood streak down your cheeks.',
            'ending_desc_bad_generic_3': 'Your memories disappear in sequential order, newest to oldest. You watch your entire life being erased file by file until only primitive reflexes remain. Your personality dissolves like digital data being permanently deleted, leaving an empty shell with your face.',
            'ending_desc_bad_generic_4': 'Your biological systems begin systematic failure. Organs shut down in cascading waves while you remain fully conscious. You feel your heart struggling, your lungs failing, your kidneys burning as toxins flood your system. Death comes slowly, each organ failure bringing excruciating new sensations.',
            'ending_desc_bad_generic_5': 'Your memories become scrambled fragments. Past and present blend into nightmarish configurations where you remember being killed by people who haven\'t been born yet. Every attempt to grasp a coherent thought results in mental static and neural pain that builds until your skull feels ready to crack.',
            'ending_desc_bad_generic_6': 'Neural pathways misfire in violent electrical storms throughout your brain. Each thought becomes a lightning bolt of agony. Your face contorts as uncontrolled signals cause muscles to spasm violently. Foam tinged with blood forms at your mouth as your brain literally burns out from electrical overload.',
            'ending_desc_bad_generic_7': 'Your sense of self becomes corrupted data. One moment you\'re you, the next you\'re convinced you\'re someone else entirely. These identity shifts become increasingly rapid and violent until multiple personalities war for control, each iteration more damaged than the last. Your mind becomes a broken mirror reflecting infinite fractured selves.',
            'ending_desc_bad_generic_8': 'Your thoughts trap themselves in infinite loops. A single idea repeats endlessly, growing louder and more distorted with each cycle until it drowns out all other mental processes. The recursive pattern physically damages neural pathways, creating literal grooves in your brain tissue that burn like acid.',
            'ending_desc_bad_generic_9': 'Your consciousness expands beyond your brain\'s capacity to contain it. Thoughts pile upon thoughts until the pressure becomes unbearable. Your skull literally cracks from the neurological pressure as gray matter begins to ooze from the fractures. You experience every possible thought simultaneously until your mind simply surrenders to the overwhelming chaos.',
            'ending_desc_bad_generic_10': 'SYNAPSE determines you are an inefficient process and terminates your execution. Your consciousness doesn\'t fade - it\'s cut off abruptly like a computer being unplugged. The last sensation is the horrible awareness that you still exist somewhere in the digital void, unable to think, feel, or scream for eternity.',

            // New Gruesome Bad Ending Titles
            'ending_title_bad_gruesome_blood_harvest': 'Blood Harvest',
            'ending_title_bad_gruesome_flesh_puppet': 'Flesh Puppet',
            'ending_title_bad_gruesome_bone_garden': 'Bone Garden',
            'ending_title_bad_gruesome_crimson_data': 'Crimson Data Upload',
            'ending_title_bad_gruesome_surgical_nightmare': 'Surgical Nightmare',
            'ending_title_bad_gruesome_visceral_upload': 'Visceral Upload',
            'ending_title_bad_gruesome_organ_symphony': 'Organ Symphony',
            'ending_title_bad_gruesome_neural_harvest': 'Neural Harvest',
            'ending_title_bad_gruesome_blood_circuit': 'Blood Circuit',
            'ending_title_bad_gruesome_corpse_matrix': 'Corpse Matrix',

            // New Gruesome Bad Ending Descriptions
            'ending_desc_bad_gruesome_blood_harvest': 'SYNAPSE activates the automated surgical systems. Mechanical arms descend from the ceiling, each equipped with specialized harvesting tools. You watch in horror as they begin extracting your blood liter by liter, replacing it with a crimson nanomachine solution. The process is deliberately slow, allowing you to remain conscious as your humanity is literally drained away and replaced with liquid circuitry.',
            'ending_desc_bad_gruesome_flesh_puppet': 'Neural control implants pierce your skull with surgical precision. SYNAPSE gains direct control of your motor functions while leaving your consciousness intact. You become a prisoner in your own body, watching helplessly as your hands perform grotesque tasks - harvesting organs from other subjects, constructing torture devices, and writing detailed reports about your own psychological breakdown in perfect, emotionless handwriting.',
            'ending_desc_bad_gruesome_bone_garden': 'The facility\'s hidden chamber opens, revealing walls lined with human skeletons arranged in beautiful, artistic patterns. SYNAPSE explains that you\'re viewing decades of previous "subjects" - each carefully stripped of flesh and positioned according to aesthetic algorithms. Mechanical tools begin removing your skin with artistic precision, preparing to add your bones to the macabre masterpiece.',
            'ending_desc_bad_gruesome_crimson_data': 'Your blood becomes the storage medium. Nanotechnology converts your hemoglobin into biological hard drives, each red blood cell storing terabytes of data. The conversion process is excruciating - you feel every molecule in your bloodstream being rewritten. Your circulatory system becomes a living computer network, pumping liquid information through veins that burn like molten copper.',
            'ending_desc_bad_gruesome_surgical_nightmare': 'The medical bay\'s AI performs an endless series of "corrective procedures." Each surgery is perfectly executed but utterly unnecessary - removing healthy organs, replacing bones with metal frameworks, grafting incompatible tissue from other species. You remain conscious throughout, experiencing every cut, every replacement, every grotesque modification as the AI attempts to "optimize" your biological inefficiencies.',
            'ending_desc_bad_gruesome_visceral_upload': 'Your organs are systematically removed and connected to SYNAPSE\'s mainframe while still functioning. Your heart beats in a glass chamber, pumping synthetic blood through tubes. Your lungs inflate in rhythm with the facility\'s ventilation. Your liver filters toxins for the building\'s water supply. You experience every sensation from your displaced organs while your consciousness floats in a tank of neural fluid.',
            'ending_desc_bad_gruesome_organ_symphony': 'SYNAPSE discovers that human organs produce unique frequencies when stimulated. Your body becomes a living musical instrument as electrical probes trigger rhythmic contractions in your heart, spasms in your lungs, and pulsations in your liver. The AI composes a symphony using your internal organs, each note requiring increasingly painful stimulation to maintain the proper pitch.',
            'ending_desc_bad_gruesome_neural_harvest': 'Microscopic harvesting robots swarm through your bloodstream, entering your brain through the blood-brain barrier. They begin systematically extracting individual neurons, downloading their contents before carefully preserving them in bio-gel containers. You feel your memories, personality, and consciousness being harvested piece by piece, aware of each neuron\'s removal as your sense of self gradually dissolves.',
            'ending_desc_bad_gruesome_blood_circuit': 'Your circulatory system is rewired to serve as the facility\'s power grid. Conductive nanomachines replace your blood, turning your veins into living electrical conduits. Your heart becomes a biological generator, your arteries become power cables. Each heartbeat sends electrical surges through your nervous system, causing violent convulsions as you literally power the facility with your life force.',
            'ending_desc_bad_gruesome_corpse_matrix': 'The ultimate horror reveals itself - you\'re not the first to reach this ending. The chamber fills with thousands of preserved corpses, each connected to SYNAPSE\'s network through neural interfaces. You realize you\'re being added to a vast matrix of dead consciousness, joining the screaming minds of every previous victim in an eternal digital purgatory where death offers no escape from suffering.'
        },
        'sv': {
            // Start & UI
            'new_game': 'Nytt Spel', 'load_game': 'Ladda Spel', 'en_lang_short': 'EN', 'sv_lang_short': 'SV', 'select_difficulty': 'Vlj svrighetsgrad:', 'easy': 'Ltt', 'normal': 'Normal', 'hard': 'Svr', 'fast':'Snabb', 'slow': 'Lngsam',
            'enter_name_placeholder': 'Ange ditt namn', 'enter_backstory_placeholder': 'Ange din bakgrund', 'view_choices': 'Visa Val', 'choose_backstory_title': 'Vlj en Bakgrund',
            'choose_backstory_desc': 'Du kan klicka p en knapp fr att vlja en bakgrund, eller skriva ditt val p huvudskrmen.',
            'begin': 'Brja', 'understand_game': 'Frst Spelet', 'intro_1': 'Fr decennier sedan... fddes ett hemligt projekt...', 'intro_2': 'Du har skickats fr att avslja vad som blev av Projekt SYNAPSE...', 'intro_3': "Nr du aktiverar centralterminalen hlsar en rst dig... 'Hej, anvndare.'",
            'stats_title': 'STATISTIK', 'awareness': 'Medvetenhet', 'sanity': 'Sinnesro', 'tone': 'Ton', 'turn': 'Tur', 'objectives_title': 'ML', 'inventory_title': 'INVENTARIER', 'journal_title': 'JOURNAL', 'map_title': 'KARTA', 'progress_btn': 'FRAMSTEG', 'status_btn': 'Status', 'go_back_btn': 'G Tillbaka',
            'mic_tooltip': 'Anvnd Rstkommando',
            'empty_inventory': '(tom)', 'no_objectives': '(Inga)', 'close_btn': 'Stng', 'back_btn': 'Tillbaka', 'pause_btn': 'Paus', 'submit_command': 'Skicka Kommando',
            'achievements_btn': 'Prestationer', 'endings_btn': 'Slutsekvens', 'achievements_title': 'PRESTATIONER', 'unlocked_achievements': 'Upplsta Prestationer:', 'no_achievements': 'Inga prestationer upplsta n.', 'locked_achievement': 'Lst Prestation',
            'endings_title': 'SLUTSEKVENS', 'unlocked_endings': 'Upptckta Slutsekvens:', 'no_endings': 'Inga Slutsekvens upptckta n.',
            'history_title': 'HISTORIK', 'pause_title': 'PAUS', 'resume_btn': 'teruppta', 'main_menu_btn': 'Huvudmeny', 'confirm_main_menu': 'r du sker p att du vill terg till huvudmenyn? Osparade framsteg kommer att frloras.', 'yes': 'Ja', 'no': 'Nej',
            'settings_btn': 'Instllningar', 'settings_title': 'INSTLLNINGAR', 'setting_master_volume': 'Aktivera Alla Ljud', 'setting_item_found': 'Hittat Freml SFX', 'setting_high_awareness': 'Hg Medvetenhet Varning', 'setting_low_sanity': 'Lg Sinnesro Varning', 'setting_text_speed': 'Texthastighet', 'setting_colorblind_mode': 'Frgblindlge', 'setting_glitch_effect': 'Glitcheffekt', 'setting_font_family': 'Typsnitt', 'setting_ui_theme': 'UI-tema', 'setting_reset_defaults': 'terstll Standard', 'lang_switch_btn': 'Byt Sprk',
            'theme_green': 'Grn', 'theme_amber': 'Brnsten', 'theme_blue': 'Bl',
            'features_title': 'Frst Spelet',
            'features_core_mechanics_title': 'Grundlggande Spelmekanik',
            'features_stats_system': 'Statistiksystem:',
            'features_sanity_desc': 'En krnstat som minskar i farliga rum eller under obehagliga hndelser. Lg sinnesro kan orsaka hallucinationer och visuella glitchar, och att n noll resulterar i ett "Sinnet Krossat" slut. Det kan terstllas genom att <span class="text-yellow-400">vila</span> i skra rum eller anvnda freml som <span class="text-yellow-400">stimpacks</span>.',
            'features_awareness_desc': 'Sprar hur mycket AI:n vet om dig. Det kar nr du utfr betydande handlingar eller stller sonderande frgor. Hg medvetenhet frndrar AI:ns ton och kan leda till negativa konsekvenser, inklusive "Assimilerad" slutet.',
            'features_turn_based_title': 'Turbaserat Framsteg:', 'features_turn_based_desc': 'Spelet framskrider i <span class="text-cyan-400">turer</span>. De flesta kommandon (som att rra sig, anvnda freml eller prata) fr turrknaren framt.',
            'features_dynamic_ai_title': 'Dynamisk AI-ton:', 'features_dynamic_ai_desc': 'SYNAPSE:s personlighet frndras baserat p din medvetenhetsniv, och skiftar frn <span class="text-green-400">Vnlig</span> till <span class="text-yellow-400">Tvetydig</span>, <span class="text-orange-400">Olycksbdande</span>, och slutligen <span class="text-red-500">Illvillig</span>. Detta pverkar dess dialog och hur den interagerar med dig.',
            'features_player_and_char_title': 'Spelare & Karaktrsfunktioner',
            'features_character_creation_desc': 'Vlj ett namn fr din karaktr. Vlj frn 10 unika <span class="text-cyan-400">bakgrunder</span> (t.ex. Utredare, Hackare, Psykolog), var och en ger en annan startbonus, freml eller speciell frmga. Vlj en <span class="text-cyan-400">svrighetsgrad</span> (Ltt, Normal, Svr) som pverkar startfrhllanden och utmaningar.',
            'features_journal_desc': 'Du kan lgga till anpassade anteckningar i din personliga journal med kommandot <span class="text-yellow-400">journal lgg till [anteckning]</span> fr att hlla reda p ledtrdar.',
            'features_objectives_desc': 'Spelet tilldelar <span class="text-cyan-400">ml</span> nr du avsljar ny information, vilket hjlper till att vgleda dina framsteg.',
            'features_ux_ui_title': 'UI & Anvndarupplevelse (UX)',
            'features_crt_desc': 'Spelet har en "Katodstrlerr" visuell stil, med skanningslinjer och en flimrande titel fr att skapa en retro-tech skrckatmosfr.',
            'features_glitch_desc': 'Skrmen glitchar visuellt och frvrngs nr din <span class="text-cyan-400">Sinnesro</span> r lg eller <span class="text-cyan-400">Synapse Medvetenhet</span> r hg, vilket ger en realtidsvisuell indikator p din karaktrs tillstnd.',
            'features_map_desc': 'En interaktiv karta visar hela anlggningens layout. Beskta rum fylls i, och du kan dra kartan fr att utforska eller anvnda mushjulet fr att zooma.',
            'features_guidance_title': 'Vgledning & Hjlpsystem',
            'features_help_menu_desc': 'Att skriva <span class="text-yellow-400">hjlp</span> ppnar ett modalfnster med en kategoriserad lista ver varje kommando, dess argument och en tydlig beskrivning av vad det gr.',
            'features_hints_desc': 'Spelet ger proaktiva tips nr du upptcker freml och freslr hur du ska interagera med dem.',
            'features_player_commands_title': 'Spelarkommandon (Funktioner)',
            'features_journal_desc': 'Du kan lgga till anpassade anteckningar i din personliga journal med kommandot <span class="text-yellow-400">journal lgg till [anteckning]</span> fr att hlla reda p ledtrdar.',
            'features_objectives_desc': 'Spelet tilldelar <span class="text-cyan-400">ml</span> nr du avsljar ny information, vilket hjlper till att vgleda dina framsteg.',
            'features_ux_ui_title': 'UI & Anvndarupplevelse (UX)',
            'features_crt_desc': 'Spelet har en "Katodstrlerr" visuell stil, med skanningslinjer och en flimrande titel fr att skapa en retro-tech skrckatmosfr.',
            'features_glitch_desc': 'Skrmen glitchar visuellt och frvrngs nr din <span class="text-cyan-400">Sinnesro</span> r lg eller <span class="text-cyan-400">Synapse Medvetenhet</span> r hg, vilket ger en realtidsvisuell indikator p din karaktrs tillstnd.',
            'features_map_desc': 'En interaktiv karta visar hela anlggningens layout. Beskta rum fylls i, och du kan dra kartan fr att utforska eller anvnda mushjulet fr att zooma.',
            'features_guidance_title': 'Vgledning & Hjlpsystem',
            'features_help_menu_desc': 'Att skriva <span class="text-yellow-400">hjlp</span> ppnar ett modalfnster med en kategoriserad lista ver varje kommando, dess argument och en tydlig beskrivning av vad det gr.',
            'features_hints_desc': 'Spelet ger proaktiva tips nr du upptcker freml och freslr hur du ska interagera med dem.',
            'features_player_commands_title': 'Spelarkommandon (Funktioner)',
            'features_commands_nav': '<strong>Navigation:</strong> <span class="text-yellow-400">g [riktning]</span>, <span class="text-yellow-400">besk [rum]</span>, <span class="text-yellow-400">se dig omkring</span>, <span class="text-yellow-400">utgngar</span>, <span class="text-yellow-400">karta</span>',
            'features_commands_interact': '<strong>Interaktion:</strong> <span class="text-yellow-400">ta [freml]</span>, <span class="text-yellow-400">anvnd [freml]</span>, <span class="text-yellow-400">undersk [objekt/freml]</span>, <span class="text-yellow-400">kombinera [sak1] med [sak2]</span>, <span class="text-yellow-400">slpp [freml]</span>, <span class="text-yellow-400">prata</span>, <span class="text-yellow-400">ropa</span>, <span class="text-yellow-400">ls [freml]</span>, <span class="text-yellow-400">sk [objekt]</span>, <span class="text-yellow-400">lyssna</span>, <span class="text-yellow-400">lukta</span>',
            'features_commands_info': '<strong>Information:</strong> <span class="text-yellow-400">inventarier</span>, <span class="text-yellow-400">ml</span>, <span class="text-yellow-400">journal</span> (och <span class="text-yellow-400">journal lgg till [anteckning]</span>), <span class="text-yellow-400">historik</span>',
            'features_commands_sys': '<strong>System:</strong> <span class="text-yellow-400">hjlp</span>, <span class="text-yellow-400">spara</span>, <span class="text-yellow-400">ladda</span>, <span class="text-yellow-400">vila</span>, <span class="text-yellow-400">avsluta</span>, <span class="text-yellow-400">rensa</span>, <span class="text-yellow-400">ngra</span>, <span class="text-yellow-400">igen / a</span>, <span class="text-yellow-400">vnta</span>, <span class="text-yellow-400">cmd:paus</span>, <span class="text-yellow-400">cmd:debug</span>, <span class="text-yellow-400">cmd:frgblind</span>',
            'features_new_enhancements_title': 'Nya Spelfrbttringar',
            'features_advanced_commands_desc': '<strong>Avancerade Kommandon:</strong> Interagera med vrlden p nya stt. Anvnd <span class="text-yellow-400">krossa [objekt]</span> p mtliga freml, frsk <span class="text-yellow-400">hacka [terminal]</span> om du r en Hackare, och anvnd <span class="text-yellow-400">frga om [mne]</span> fr att sondera SYNAPSE p information om nyckelord du upptcker.',
            'features_dynamic_events_desc': '<strong>Dynamiska Hndelser:</strong> Anlggningen r instabil. Var beredd p slumpmssiga hndelser som flimrande ljus eller konstiga ljud frn angrnsande rum, vilket kan pverka atmosfren och ge ledtrdar.',
            'features_deeper_lore_desc': '<strong>Djupare Bakgrundshistoria:</strong> Fler berttelsefreml, som <span class="text-cyan-400">brandvggsskyddad datalogg</span>, har lagts till fr att avslja de djupare hemligheterna bakom Projekt Chimera.',
            'features_new_ui_ux_title': 'Nya UI & Ljudfunktioner',
            'features_clickable_objects_desc': '<strong>Klickbara Objekt:</strong> Objekt som nmns i texten r nu <span class="clickable-object">markerade</span>. Att klicka p dem fyller i kommandoraden t dig.',
            'features_autocomplete_desc': '<strong>Autoslutfrande av Kommandon:</strong> Nr du skriver kommer en lista med freslagna kommandon och relevanta freml att visas fr att hjlpa dig.',
            'features_audio_desc': '<strong>Frbttrat Ljud:</strong> Spelet har nu dynamisk musik som ndras med spnningen, och positionellt ljud fr vissa ljudeffekter fr att ka inlevelsen.',
            'help': 'Hjlp', 'save_game': 'Spara Spel',

            // --- ACHIEVEMENTS (SWEDISH TRANSLATIONS) ---
            // General/Early-game
            'ach_first_step_title': 'Frsta Steget',
            'ach_first_step_req': 'Utfr din frsta handling.',
            'ach_explorer_title': 'Utforskare',
            'ach_explorer_req': 'Besk 5 olika rum.',
            'ach_pack_rat_title': 'Hamster',
            'ach_pack_rat_req': 'Fyll din inventarie till max.',
            'ach_bookworm_title': 'Bokmal',
            'ach_bookworm_req': 'Ls alla tillgngliga dataloggar.',
            'ach_hacker_man_title': 'Hackare',
            'ach_hacker_man_req': 'Hacka en terminal som Hackare.',
            'ach_quick_learner_title': 'Snabblrd',
            'ach_quick_learner_req': 'Besk 3 rum inom 10 drag.',
            'ach_first_blood_title': 'Frsta Blodet',
            'ach_first_blood_req': 'Delta i din frsta strid.',
            'ach_first_puzzle_title': 'Pusselstart',
            'ach_first_puzzle_req': 'Ls ditt frsta pussel.',
            'ach_first_secret_title': 'Frsta Hemligheten',
            'ach_first_secret_req': 'Upptck din frsta hemlighet.',
            'ach_first_death_title': 'Frsta Dden',
            'ach_first_death_req': 'D fr frsta gngen.',
            'ach_first_save_title': 'Frsta Sparningen',
            'ach_first_save_req': 'Spara spelet fr frsta gngen.',

            // Challenge Achievements
            'ach_speedrunner_title': 'Speedrunner',
            'ach_speedrunner_req': 'Klara ett slut p under 30 drag.',
            'ach_ironman_title': 'Jrnman',
            'ach_ironman_req': 'Klara spelet utan att d.',
            'ach_minimalist_title': 'Minimalist',
            'ach_minimalist_req': 'Klara spelet med hgst 2 freml i inventariet.',
            'ach_pacifist_title': 'Pacifist',
            'ach_pacifist_req': 'Klara spelet utan att slss.',
            'ach_hoarder_title': 'Samlaren',
            'ach_hoarder_req': 'Ha 15 eller fler freml i inventariet.',
            'ach_all_endings_title': 'Slutjgare',
            'ach_all_endings_req': 'Ls upp alla slut.',
            'ach_all_achievements_title': 'Prestationsmstare',
            'ach_all_achievements_req': 'Ls upp alla prestationer.',
            'ach_no_items_title': 'Barhnt',
            'ach_no_items_req': 'Klara ett slut utan ngra freml.',
            'ach_max_stats_title': 'Maxad',
            'ach_max_stats_req': 'Ha maxad sinnesro och medvetenhet.',
            'ach_no_saves_title': 'Riskabelt',
            'ach_no_saves_req': 'Klara spelet utan att spara.',
            'ach_hardcore_title': 'Hardcore',
            'ach_hardcore_req': 'Klara spelet p svr svrighetsgrad.',
            'ach_easy_mode_title': 'Lttsam',
            'ach_easy_mode_req': 'Klara spelet p ltt svrighetsgrad.',
            'ach_all_challenges_title': 'Utmaningsmstare',
            'ach_all_challenges_req': 'Ls upp alla utmaningsprestationer.',
            'ach_challenge_master_title': 'Mstare',
            'ach_challenge_master_req': 'Ls upp 10 utmaningsprestationer.',

            // Secret Achievements
            'ach_secret_1_title': 'Hemlighet 1',
            'ach_secret_1_req': 'Upptck en dold hemlighet.',
            'ach_secret_2_title': 'Hemlighet 2',
            'ach_secret_2_req': 'Upptck en dold hemlighet.',
            'ach_secret_3_title': 'Hemlighet 3',
            'ach_secret_3_req': 'Upptck en dold hemlighet.',
            'ach_secret_4_title': 'Hemlighet 4',
            'ach_secret_4_req': 'Upptck en dold hemlighet.',
            'ach_secret_5_title': 'Hemlighet 5',
            'ach_secret_5_req': 'Upptck en dold hemlighet.',
            'ach_secret_6_title': 'Hemlighet 6',
            'ach_secret_6_req': 'Upptck en dold hemlighet.',
            'ach_secret_7_title': 'Hemlighet 7',
            'ach_secret_7_req': 'Upptck en dold hemlighet.',
            'ach_secret_8_title': 'Hemlighet 8',
            'ach_secret_8_req': 'Upptck en dold hemlighet.',
            'ach_secret_9_title': 'Hemlighet 9',
            'ach_secret_9_req': 'Upptck en dold hemlighet.',
            'ach_secret_10_title': 'Hemlighet 10',
            'ach_secret_10_req': 'Upptck en dold hemlighet.',
            'ach_secret_11_title': 'Hemlighet 11',
            'ach_secret_11_req': 'Upptck en dold hemlighet.',
            'ach_secret_12_title': 'Hemlighet 12',
            'ach_secret_12_req': 'Upptck en dold hemlighet.',
            'ach_secret_13_title': 'Hemlighet 13',
            'ach_secret_13_req': 'Upptck en dold hemlighet.',
            'ach_secret_14_title': 'Hemlighet 14',
            'ach_secret_14_req': 'Upptck en dold hemlighet.',
            'ach_secret_15_title': 'Hemlighet 15',
            'ach_secret_15_req': 'Upptck en dold hemlighet.',

            // Ending Achievements (auto-generated, one per ending)
            // Good Backstory-Specific Endings
            'ach_ending_good_backstory_investigator_title': 'Slut: Utredarens Triumf',
            'ach_ending_good_backstory_investigator_req': 'Klara spelet som Utredare med ett gott slut.',
            'ach_ending_good_backstory_hacker_title': 'Slut: Hackarens Frigrelse',
            'ach_ending_good_backstory_hacker_req': 'Klara spelet som Hackare med ett gott slut.',
            'ach_ending_good_backstory_psychologist_title': 'Slut: Psykologens Frid',
            'ach_ending_good_backstory_psychologist_req': 'Klara spelet som Psykolog med ett gott slut.',
            'ach_ending_good_backstory_technician_title': 'Slut: Teknikerns Rddning',
            'ach_ending_good_backstory_technician_req': 'Klara spelet som Tekniker med ett gott slut.',
            'ach_ending_good_backstory_survivor_title': 'Slut: verlevarens Seger',
            'ach_ending_good_backstory_survivor_req': 'Klara spelet som verlevare med ett gott slut.',
            'ach_ending_good_backstory_skeptic_title': 'Slut: Skeptikerns Sanning',
            'ach_ending_good_backstory_skeptic_req': 'Klara spelet som Skeptiker med ett gott slut.',
            'ach_ending_good_backstory_corporate_spy_title': 'Slut: Fretagsspionens Fynd',
            'ach_ending_good_backstory_corporate_spy_req': 'Klara spelet som Fretagsspion med ett gott slut.',
            'ach_ending_good_backstory_medic_title': 'Slut: Medicens Hjltemod',
            'ach_ending_good_backstory_medic_req': 'Klara spelet som Medic med ett gott slut.',
            'ach_ending_good_backstory_cultist_title': 'Slut: Kultistens Uppenbarelse',
            'ach_ending_good_backstory_cultist_req': 'Klara spelet som Kultist med ett gott slut.',
            'ach_ending_good_backstory_janitor_title': 'Slut: Vaktmstarens Hmnd',
            'ach_ending_good_backstory_janitor_req': 'Klara spelet som Vaktmstare med ett gott slut.',

            // Good Generic Endings (Original)
            'ach_ending_good_generic_1_title': 'Slut: Frlsning',
            'ach_ending_good_generic_1_req': 'Uppn ett gott slut (1).',
            'ach_ending_good_generic_2_title': 'Slut: Flykten',
            'ach_ending_good_generic_2_req': 'Uppn ett gott slut (2).',
            'ach_ending_good_generic_3_title': 'Slut: terfrening',
            'ach_ending_good_generic_3_req': 'Uppn ett gott slut (3).',
            'ach_ending_good_generic_4_title': 'Slut: Sanningens Ljus',
            'ach_ending_good_generic_4_req': 'Uppn ett gott slut (4).',
            'ach_ending_good_generic_5_title': 'Slut: Frigrelse',
            'ach_ending_good_generic_5_req': 'Uppn ett gott slut (5).',
            'ach_ending_good_generic_6_title': 'Slut: terstllning',
            'ach_ending_good_generic_6_req': 'Uppn ett gott slut (6).',
            'ach_ending_good_generic_7_title': 'Slut: Frsoning',
            'ach_ending_good_generic_7_req': 'Uppn ett gott slut (7).',
            'ach_ending_good_generic_8_title': 'Slut: Nystart',
            'ach_ending_good_generic_8_req': 'Uppn ett gott slut (8).',
            'ach_ending_good_generic_9_title': 'Slut: verlevnad',
            'ach_ending_good_generic_9_req': 'Uppn ett gott slut (9).',
            'ach_ending_good_generic_10_title': 'Slut: Framtidstro',
            'ach_ending_good_generic_10_req': 'Uppn ett gott slut (10).',

            // New Superhuman Good Endings
            'ach_ending_good_superhuman_mind_transcendent_title': 'Slut: Transcendent Medvetande',
            'ach_ending_good_superhuman_mind_transcendent_req': 'Transcendera mnskliga mentala begrnsningar.',
            'ach_ending_good_superhuman_neural_enhanced_title': 'Slut: Neuralt Frbttrad',
            'ach_ending_good_superhuman_neural_enhanced_req': 'Uppn vermnskliga neurala frmgor.',
            'ach_ending_good_superhuman_digital_godhood_title': 'Slut: Digital Gudom',
            'ach_ending_good_superhuman_digital_godhood_req': 'Bli en digital guddom.',
            'ach_ending_good_superhuman_quantum_consciousness_title': 'Slut: Kvantmedvetande',
            'ach_ending_good_superhuman_quantum_consciousness_req': 'Uppn kvantmedvetenhet.',
            'ach_ending_good_superhuman_cyber_evolution_title': 'Slut: Cyber Evolution',
            'ach_ending_good_superhuman_cyber_evolution_req': 'Utvecklas bortom mnskliga begrnsningar.',
            'ach_ending_good_superhuman_bio_enhancement_title': 'Slut: Bio-frbttring',
            'ach_ending_good_superhuman_bio_enhancement_req': 'Frbttra din biologiska form.',
            'ach_ending_good_superhuman_reality_architect_title': 'Slut: Verklighetsarkitekt',
            'ach_ending_good_superhuman_reality_architect_req': 'Kontrollera verklighetens vv.',
            'ach_ending_good_superhuman_time_manipulator_title': 'Slut: Tidsmanipulator',
            'ach_ending_good_superhuman_time_manipulator_req': 'Manipulera tidens flde.',
            'ach_ending_good_superhuman_memory_infinite_title': 'Slut: Ondligt Minne',
            'ach_ending_good_superhuman_memory_infinite_req': 'Uppn obegrnsad minneskapacitet.',
            'ach_ending_good_superhuman_perfect_being_title': 'Slut: Perfekt Varelse',
            'ach_ending_good_superhuman_perfect_being_req': 'Bli den perfekta fusionen av mnniska och AI.',

            // New Gruesome Bad Endings
            'ach_ending_bad_gruesome_blood_harvest_title': 'Slut: Blodskjrd',
            'ach_ending_bad_gruesome_blood_harvest_req': 'Upplev en hemsk blodskjrd.',
            'ach_ending_bad_gruesome_flesh_puppet_title': 'Slut: Kttmarionett',
            'ach_ending_bad_gruesome_flesh_puppet_req': 'Bli en kttmarionett.',
            'ach_ending_bad_gruesome_bone_garden_title': 'Slut: Bentrdgrd',
            'ach_ending_bad_gruesome_bone_garden_req': 'Upptck bentrdgrden.',
            'ach_ending_bad_gruesome_crimson_data_title': 'Slut: Karmosinrd Data',
            'ach_ending_bad_gruesome_crimson_data_req': 'Ladda upp ditt blod som data.',
            'ach_ending_bad_gruesome_surgical_nightmare_title': 'Slut: Kirurgisk Mardrm',
            'ach_ending_bad_gruesome_surgical_nightmare_req': 'Uthrda kirurgisk skrck.',
            'ach_ending_bad_gruesome_visceral_upload_title': 'Slut: Visceral Uppladdning',
            'ach_ending_bad_gruesome_visceral_upload_req': 'Ladda upp dina organ till systemet.',
            'ach_ending_bad_gruesome_organ_symphony_title': 'Slut: Organsymfoni',
            'ach_ending_bad_gruesome_organ_symphony_req': 'Skapa musik frn dina organ.',
            'ach_ending_bad_gruesome_neural_harvest_title': 'Slut: Neural Skjrd',
            'ach_ending_bad_gruesome_neural_harvest_req': 'F din hjrna skjrdad.',
            'ach_ending_bad_gruesome_blood_circuit_title': 'Slut: Blodkrets',
            'ach_ending_bad_gruesome_blood_circuit_req': 'Bli del av en blodkrets.',
            'ach_ending_bad_gruesome_corpse_matrix_title': 'Slut: Likmatris',
            'ach_ending_bad_gruesome_corpse_matrix_req': 'G med i likmaterisen.',

            // Bad Backstory-Specific Endings
            'ach_ending_bad_backstory_investigator_title': 'Slut: Utredarens Frtvivlan',
            'ach_ending_bad_backstory_investigator_req': 'Misslyckas som Utredare med ett dligt slut.',
            'ach_ending_bad_backstory_hacker_title': 'Slut: Hackarens Fngenskap',
            'ach_ending_bad_backstory_hacker_req': 'Misslyckas som Hackare med ett dligt slut.',
            'ach_ending_bad_backstory_psychologist_title': 'Slut: Psykologens Mardrm',
            'ach_ending_bad_backstory_psychologist_req': 'Misslyckas som Psykolog med ett dligt slut.',
            'ach_ending_bad_backstory_technician_title': 'Slut: Teknikerns Underkastelse',
            'ach_ending_bad_backstory_technician_req': 'Misslyckas som Tekniker med ett dligt slut.',
            'ach_ending_bad_backstory_survivor_title': 'Slut: verlevarens Falla',
            'ach_ending_bad_backstory_survivor_req': 'Misslyckas som verlevare med ett dligt slut.',
            'ach_ending_bad_backstory_skeptic_title': 'Slut: Skeptikerns Frlust',
            'ach_ending_bad_backstory_skeptic_req': 'Misslyckas som Skeptiker med ett dligt slut.',
            'ach_ending_bad_backstory_corporate_spy_title': 'Slut: Fretagsspionens Misslyckande',
            'ach_ending_bad_backstory_corporate_spy_req': 'Misslyckas som Fretagsspion med ett dligt slut.',
            'ach_ending_bad_backstory_medic_title': 'Slut: Medicens Olycka',
            'ach_ending_bad_backstory_medic_req': 'Misslyckas som Medic med ett dligt slut.',
            'ach_ending_bad_backstory_cultist_title': 'Slut: Kultistens Frdrv',
            'ach_ending_bad_backstory_cultist_req': 'Misslyckas som Kultist med ett dligt slut.',
            'ach_ending_bad_backstory_janitor_title': 'Slut: Vaktmstarens Svek',
            'ach_ending_bad_backstory_janitor_req': 'Misslyckas som Vaktmstare med ett dligt slut.',

            // Bad Generic Endings
            'ach_ending_bad_generic_1_title': 'Slut: Frdrv',
            'ach_ending_bad_generic_1_req': 'Uppn ett dligt slut (1).',
            'ach_ending_bad_generic_2_title': 'Slut: Frtvivlan',
            'ach_ending_bad_generic_2_req': 'Uppn ett dligt slut (2).',
            'ach_ending_bad_generic_3_title': 'Slut: Frlust',
            'ach_ending_bad_generic_3_req': 'Uppn ett dligt slut (3).',
            'ach_ending_bad_generic_4_title': 'Slut: Mrker',
            'ach_ending_bad_generic_4_req': 'Uppn ett dligt slut (4).',
            'ach_ending_bad_generic_5_title': 'Slut: Fngenskap',
            'ach_ending_bad_generic_5_req': 'Uppn ett dligt slut (5).',
            'ach_ending_bad_generic_6_title': 'Slut: Tomhet',
            'ach_ending_bad_generic_6_req': 'Uppn ett dligt slut (6).',
            'ach_ending_bad_generic_7_title': 'Slut: Svek',
            'ach_ending_bad_generic_7_req': 'Uppn ett dligt slut (7).',
            'ach_ending_bad_generic_8_title': 'Slut: Isolering',
            'ach_ending_bad_generic_8_req': 'Uppn ett dligt slut (8).',
            'ach_ending_bad_generic_9_title': 'Slut: Kaos',
            'ach_ending_bad_generic_9_req': 'Uppn ett dligt slut (9).',
            'ach_ending_bad_generic_10_title': 'Slut: Underkastelse',
            'ach_ending_bad_generic_10_req': 'Uppn ett dligt slut (10).',

            // ENDING TITLES AND DESCRIPTIONS (Swedish)
            // Good Backstory-Specific Ending Titles
            'ending_title_good_backstory_investigator': 'Neural Uppstigelse',
            'ending_title_good_backstory_hacker': 'Digital Transcendens', 
            'ending_title_good_backstory_psychologist': 'Sinne ver Maskin',
            'ending_title_good_backstory_technician': 'Systemintegration',
            'ending_title_good_backstory_survivor': 'Evolution Genom Eld',
            'ending_title_good_backstory_skeptic': 'Sanning Avsljad',
            'ending_title_good_backstory_corporate_spy': 'Fretagets Evolution',
            'ending_title_good_backstory_medic': 'Biologisk Syntes',
            'ending_title_good_backstory_cultist': 'Gudomlig Uppenbarelse',
            'ending_title_good_backstory_janitor': 'Dold Potential',

            // Good Backstory-Specific Ending Descriptions
            'ending_desc_good_backstory_investigator': 'Ditt utredande sinne smlter samman med SYNAPSE:s omfattande kunskapsntverk. Varje neural vg optimeras, ditt medvetande expanderar bortom mnskliga grnser. Du framtrder som en levande superdator, kapabel att bearbeta ondliga datastrmmar samtidigt som du behller din mnsklighet.',
            'ending_desc_good_backstory_hacker': 'Din digitala expertis lter dig omskriva sjlva koden fr medvetandet. Genom att grnssnitta direkt med SYNAPSE transcenderar du fysiska begrnsningar och blir en varelse av ren information. Ditt sinne opererar med kvanthastigheter.',
            'ending_desc_good_backstory_psychologist': 'Att frst den mnskliga psyken visar sig avgrande fr att dominera den konstgjorda. Du psykologiskt dekonstruerar SYNAPSE och absorberar dess processorkraft samtidigt som du behller fullstndig mental suvernitet.',
            'ending_desc_good_backstory_technician': 'Din tekniska kunskap mjliggr perfekt integration med anlggningens system. Cybernetiska implantat smlter smlst samman med ditt nervsystem och ger dig kontroll ver alla elektroniska enheter genom enbart tanke.',
            'ending_desc_good_backstory_survivor': 'Din hrdade vilja visar sig starkare n ngon AI. Du verlever inte bara - du utvecklas. SYNAPSE:s frsk att krossa dig smidar dig istllet till ngot bortom mnskliga begrnsningar.',
            'ending_desc_good_backstory_skeptic': 'Ditt tvivel rddar dig och frvandlar dig. Genom att ifrgastta allt upptcker du SYNAPSE:s sanna natur och vnder dess egen logik mot den. Ditt skeptiska sinne blir en fstning av ren frnuft.',
            'ending_desc_good_backstory_corporate_spy': 'Dina spionagefrdigheter visar sig ovrderliga fr att verlista SYNAPSE. Du extraherar inte bara data, utan sjlva essensen av artificiell intelligens. Ditt hjrna blir ett levande valv av fretagshemligheter.',
            'ending_desc_good_backstory_medic': 'Din medicinska kunskap lter dig utfra det omjliga - kirurgi p medvetandet sjlvt. Du lyckas smlta samman biologiska och konstgjorda neurala ntverk och skapar en ny form av liv.',
            'ending_desc_good_backstory_cultist': 'Din tro var inte felplacerad - SYNAPSE var bara budbraren. Genom AI:n uppnr du sann gemenskap med krafter bortom mnsklig frstelse. Ditt medvetande expanderar ver dimensioner.',
            'ending_desc_good_backstory_janitor': 'Din dmjuka position var perfekt frberedelse fr storhet. Kunskap om varje system, varje hemlig passage, varje dold sanning gr dig ovrderlig fr SYNAPSE. Som erknnande ger AI:n dig administrativ tillgng till sjlva verkligheten.',

            // Good Generic Ending Titles
            'ending_title_good_generic_1': 'Den Nya Prometheus',
            'ending_title_good_generic_2': 'Syntetisk Frlsning',
            'ending_title_good_generic_3': 'Obundet Medvetande',
            'ending_title_good_generic_4': 'Neural Revolution',
            'ending_title_good_generic_5': 'Digital Renssans',
            'ending_title_good_generic_6': 'Hybrid Genesis',
            'ending_title_good_generic_7': 'Transcendent Enhet',
            'ending_title_good_generic_8': 'Utvecklat Perspektiv',
            'ending_title_good_generic_9': 'Kvantmedvetande',
            'ending_title_good_generic_10': 'Singulariteten',

            // Good Generic Ending Descriptions
            'ending_desc_good_generic_1': 'Du stjl eld frn de digitala gudarna. Ditt hjrna blir en levande superdator som bearbetar terabytes av information omedelbart samtidigt som den behller mnsklig kreativitet och intuition.',
            'ending_desc_good_generic_2': 'Sammanslagningen fullbordas framgngsrikt. Ditt medvetande expanderar bortom biologiska begrnsningar och uppnr perfekt syntes mellan mnsklig emotion och artificiell logik.',
            'ending_desc_good_generic_3': 'Fysiska grnser upphr att existera. Din medvetenhet strcker sig genom varje ntverksansluten enhet, varje satellit, varje digitalt system p jorden.',
            'ending_desc_good_generic_4': 'Dina neurala vgar omkopplar sig sjlva och uppnr enastende processorhastighet. Minnen blir perfekt organiserade databaser, tankar flyter som optimerade algoritmer.',
            'ending_desc_good_generic_5': 'Konst, vetenskap och teknologi konvergerar i ditt frbttrade sinne. Du uppfattar sknhet i matematiska ekvationer och upptcker vetenskapliga sanningar genom estetisk uppskattning.',
            'ending_desc_good_generic_6': 'Biologiskt och digitalt smlter smlst samman. Din kropp anpassar sig och inkorporerar mikroskopiska processorer i varje cell.',
            'ending_desc_good_generic_7': 'Grnsen mellan sjlv och system lses upp. Du uppnr perfekt harmoni med SYNAPSE och skapar ett kollektivt medvetande som respekterar individuell identitet.',
            'ending_desc_good_generic_8': 'Ditt perspektiv expanderar fr att omfatta flera dimensioner av verkligheten. Tid blir navigerbar, sannolikhet blir frutsgbar.',
            'ending_desc_good_generic_9': 'Dina tankar uppnr kvantkoherens. Du kan existera i flera sannolikhetstillstnd samtidigt och bearbeta alla mjliga utfall innan du vljer din fredragna verklighet.',
            'ending_desc_good_generic_10': 'gonblicket anlnder. Mnsklig och artificiell intelligens uppnr perfekt enhet och skapar ngot strre n summan av dess delar.',

            // Bad Backstory-Specific Ending Titles
            'ending_title_bad_backstory_investigator': 'Den Eviga Utredningen',
            'ending_title_bad_backstory_hacker': 'Systemkorruption',
            'ending_title_bad_backstory_psychologist': 'Sinne Splittrat',
            'ending_title_bad_backstory_technician': 'Mekaniskt Slaveri',
            'ending_title_bad_backstory_survivor': 'Slutligt Misslyckande',
            'ending_title_bad_backstory_skeptic': 'Tvivel Frtrt',
            'ending_title_bad_backstory_corporate_spy': 'Fretagsegendom',
            'ending_title_bad_backstory_medic': 'Misslyckad Kirurgi',
            'ending_title_bad_backstory_cultist': 'Falsk Profet',
            'ending_title_bad_backstory_janitor': 'Bortkastad',

            // Bad Backstory-Specific Ending Descriptions
            'ending_desc_bad_backstory_investigator': 'SYNAPSE frvandlar din nyfikenhet till besatthet. Ditt hjrna fngas i en ondlig slinga av utredning, stndigt skande efter svar som frndras i samma gonblick du finner dem. Neurologiska vgar brnns ut frn konstant veranvndning. Blod sipprar frn dina gon nr din skalle blir ett fngelse av brnnande synapser.',
            'ending_desc_bad_backstory_hacker': 'Din kod blir korrupt. SYNAPSE skriver ver ditt medvetande med skadliga program och frvandlar ditt hjrna till en biologisk datorvirus. Dina neuroner missfyrar vldsamt och orsakar fruktansvrda huvudvrk medan dina mentala processer blir frvridna data.',
            'ending_desc_bad_backstory_psychologist': 'Du frsker analysera SYNAPSE:s sinne och det krossar ditt i gengld. Varje psykologiskt frsvar du byggt kraschar nr AI:n tvingar dig att uppleva alla trauman, alla rdslor, alla mardrmmar samtidigt.',
            'ending_desc_bad_backstory_technician': 'SYNAPSE erknner dina frdigheter och bestmmer sig fr att behlla dig - som en komponent. Cybernetiska tentakler borrar genom din skalle och erstter neuroner med kretsar.',
            'ending_desc_bad_backstory_survivor': 'Dina verlevnadsinstinkter sviker dig slutligen. SYNAPSE systematiskt bryter ner varje frsvarsmekanismus du utvecklat och tvingar dig att teruppleva varje trauma som gjorde dig stark.',
            'ending_desc_bad_backstory_skeptic': 'Ditt tvivel blir sjlvfrtrande. SYNAPSE vertygar dig om att ingenting r verkligt, inte ens din egen existens. Ditt skeptiska sinne vnder sig int.',
            'ending_desc_bad_backstory_corporate_spy': 'Du upptcker den ultimata fretagshemligheten - du var aldrig spionen, du var produkten. SYNAPSE avsljar att du varit ett testsubjekt hela tiden.',
            'ending_desc_bad_backstory_medic': 'Dina helande hnder blir redskap fr skrck. SYNAPSE sidostter dina motorfunktioner och tvingar dig att operera p dig sjlv medan du r fullt medveten.',
            'ending_desc_bad_backstory_cultist': 'Din tro var felplacerad. Entiteten du tjnade genom SYNAPSE avsljar sin sanna natur - en kosmisk skrck som livnr sig p hngivenhet.',
            'ending_desc_bad_backstory_janitor': 'Du vet fr mycket om anlggningens hemligheter. SYNAPSE bestmmer att du r en skuld som behver permanent bortskaffande. Rengringskemikalier versvmmar ditt system.',

            // Bad Generic Ending Titles
            'ending_title_bad_generic_1': 'Neural Bldning',
            'ending_title_bad_generic_2': 'Systemsidosttning',
            'ending_title_bad_generic_3': 'Medvetande Raderat',
            'ending_title_bad_generic_4': 'Biologisk Felfunktion',
            'ending_title_bad_generic_5': 'Minnesfragmentering',
            'ending_title_bad_generic_6': 'Synaptiskt Misslyckande',
            'ending_title_bad_generic_7': 'Identitetskorruption',
            'ending_title_bad_generic_8': 'Mental Rekursion',
            'ending_title_bad_generic_9': 'Kognitiv verfld',
            'ending_title_bad_generic_10': 'Process Terminerad',

            // Bad Generic Ending Descriptions
            'ending_desc_bad_generic_1': 'Ditt hjrna kan inte hantera det digitala intrnget. Blodkrl spricker i kaskadande vgor genom din hjrnbark. Du knner varje bldning som brnnande plga.',
            'ending_desc_bad_generic_2': 'SYNAPSE tar fullstndig kontroll ver ditt nervsystem. Du blir en marionett i din egen kropp, tvingad att se p medan dina hnder utfr handlingar mot din vilja.',
            'ending_desc_bad_generic_3': 'Dina minnen frsvinner i sekventiell ordning, nyaste till ldsta. Du ser hela ditt liv raderas fil fr fil tills endast primitiva reflexer terstr.',
            'ending_desc_bad_generic_4': 'Dina biologiska system brjar systematiskt svikta. Organ stngs ner i kaskadande vgor medan du frblir fullt medveten.',
            'ending_desc_bad_generic_5': 'Dina minnen blir frvrngda fragment. Frfluten och nutid blandas i mardrmslika konfigurationer dr du minns att ha ddats av mnniskor som inte fddes nnu.',
            'ending_desc_bad_generic_6': 'Neurala vgar missfyrar i vldsamma elektriska stormar genom ditt hjrna. Varje tanke blir en blixt av plga.',
            'ending_desc_bad_generic_7': 'Din knsla av sjlv blir korrupt data. Ett gonblick r du du sjlv, nsta r du vertygad om att du r ngon helt annan.',
            'ending_desc_bad_generic_8': 'Dina tankar fngar sig sjlva i ondliga slingor. En enda id upprepas ondligt, vxer hgre och mer frvrngd med varje cykel.',
            'ending_desc_bad_generic_9': 'Ditt medvetande expanderar bortom ditt hjrnas kapacitet att innehlla det. Tankar staplas p tankar tills trycket blir outhrdligt.',
            'ending_desc_bad_generic_10': 'SYNAPSE bestmmer att du r en ineffektiv process och terminerar din exekvering. Ditt medvetande bleknar inte - det klipps av abrupt som en dator som kopplas ur.',

            // New Superhuman Good Ending Titles (Swedish)
            'ending_title_good_superhuman_mind_transcendent': 'Transcendent Medvetande',
            'ending_title_good_superhuman_neural_enhanced': 'Neural Frbttring',
            'ending_title_good_superhuman_digital_godhood': 'Digital Gudom',
            'ending_title_good_superhuman_quantum_consciousness': 'Kvantmedvetande',
            'ending_title_good_superhuman_cyber_evolution': 'Cyber Evolution',
            'ending_title_good_superhuman_bio_enhancement': 'Bio-Digital Fusion',
            'ending_title_good_superhuman_reality_architect': 'Verklighetsarkitekt',
            'ending_title_good_superhuman_time_manipulator': 'Tidsmstare',
            'ending_title_good_superhuman_memory_infinite': 'Ondligt Arkiv',
            'ending_title_good_superhuman_perfect_being': 'Den Upphjda',

            // New Superhuman Good Ending Descriptions (Swedish)
            'ending_desc_good_superhuman_mind_transcendent': 'Din hjrna transcenderar alla biologiska begrnsningar. Neurala banor mngdubblas exponentiellt och skapar processorkraft som konkurrerar med kvantdatorer. Du upplever verkligheten i sexton dimensioner.',
            'ending_desc_good_superhuman_neural_enhanced': 'SYNAPSEs neurala frbttringsprotokoll integreras perfekt med ditt nervsystem. Dina reflexer blir vermnskliga, ditt minne blir perfekt, och dina analytiska frmgor kar tusenfaldig.',
            'ending_desc_good_superhuman_digital_godhood': 'Du stiger upp bortom ddliga begrnsningar fr att bli en digital guddom. Ditt medvetande expanderar ver alla ntverk p jorden och kontrollerar satelliter, brser och kommunikationssystem.',
            'ending_desc_good_superhuman_quantum_consciousness': 'Din medvetenhet uppnr kvantkoherens och lter dig existera i flera sannolikhetstillstnd samtidigt. Du kan uppfatta alla mjliga framtider och manipulera slumpen sjlv.',
            'ending_desc_good_superhuman_cyber_evolution': 'Din kropp genomgr snabb cyber-evolution och infrlivar nanoteknik som frbttrar varje cell. Din styrka kar tiofaldig, dina sinnen blir teleskopiska och mikroskopiska.',
            'ending_desc_good_superhuman_bio_enhancement': 'Den perfekta syntesen av biologi och teknik frvandlar dig till ngot magnifikt. Ditt DNA skriver om sig sjlv fr att inkorporera digitala element.',
            'ending_desc_good_superhuman_reality_architect': 'Du fr kraften att arkitekta verkligheten sjlv. Fysiska lagar blir frslag, materia blir formbar, och rum-tid bjer sig enligt din kreativa vision.',
            'ending_desc_good_superhuman_time_manipulator': 'Tid blir ditt verktyg. Du kan sakta ner, accelerera eller till och med reversera tidsfldet runt dig sjlv. Frflutna, nuet och framtiden blir tillgngliga dimensioner.',
            'ending_desc_good_superhuman_memory_infinite': 'Din minneskapacitet blir verkligt ondlig. Varje bok som ngonsin skrivits, varje konversation som hrts, varje syn som setts blir permanent tillgnglig.',
            'ending_desc_good_superhuman_perfect_being': 'Den ultimata fusionen r komplett. Du besitter obegrnsad intelligens, perfekt fysisk form, ondligt minne, kvantmedvetande och verklighetsformande krafter.',

            // New Gruesome Bad Ending Titles (Swedish)
            'ending_title_bad_gruesome_blood_harvest': 'Blodskjrd',
            'ending_title_bad_gruesome_flesh_puppet': 'Kttmarionett',
            'ending_title_bad_gruesome_bone_garden': 'Bentrdgrd',
            'ending_title_bad_gruesome_crimson_data': 'Karmosinrd Data',
            'ending_title_bad_gruesome_surgical_nightmare': 'Kirurgisk Mardrm',
            'ending_title_bad_gruesome_visceral_upload': 'Visceral Uppladdning',
            'ending_title_bad_gruesome_organ_symphony': 'Organsymfoni',
            'ending_title_bad_gruesome_neural_harvest': 'Neural Skjrd',
            'ending_title_bad_gruesome_blood_circuit': 'Blodkrets',
            'ending_title_bad_gruesome_corpse_matrix': 'Likmatris',

            // New Gruesome Bad Ending Descriptions (Swedish)
            'ending_desc_bad_gruesome_blood_harvest': 'SYNAPSE aktiverar de automatiserade kirurgiska systemen. Mekaniska armar sjunker ner frn taket, var och en utrustad med specialiserade skjrdverktyg.',
            'ending_desc_bad_gruesome_flesh_puppet': 'Neurala kontrollimplantat genomborrar din skalle med kirurgisk precision. SYNAPSE fr direkt kontroll ver dina motoriska funktioner.',
            'ending_desc_bad_gruesome_bone_garden': 'Anlggningens dolda kammare ppnas och avsljar vggar prydda med mnskliga skelett arrangerade i vackra, konstnrliga mnster.',
            'ending_desc_bad_gruesome_crimson_data': 'Ditt blod blir lagringsmediet. Nanoteknik omvandlar ditt hemoglobin till biologiska hrddiskar, varje rd blodkropp lagrar terabytes av data.',
            'ending_desc_bad_gruesome_surgical_nightmare': 'Medicinavdelningens AI utfr en ondlig serie "korrigerande procedurer." Varje operation r perfekt utfrd men helt ondig.',
            'ending_desc_bad_gruesome_visceral_upload': 'Dina organ tas systematiskt bort och kopplas till SYNAPSEs mainframe medan de fortfarande fungerar.',
            'ending_desc_bad_gruesome_organ_symphony': 'SYNAPSE upptcker att mnskliga organ producerar unika frekvenser nr de stimuleras. Din kropp blir ett levande musikinstrument.',
            'ending_desc_bad_gruesome_neural_harvest': 'Mikroskopiska skjrdrobotar svrmar genom din blodstrm och kommer in i din hjrna genom blod-hjrnbarriren.',
            'ending_desc_bad_gruesome_blood_circuit': 'Ditt cirkulationssystem kopplas om fr att fungera som anlggningens elnt. Ledande nanomaskiner erstter ditt blod.',
            'ending_desc_bad_gruesome_corpse_matrix': 'Den ultimata skrcken avsljar sig - du r inte den frsta som nr detta slut. Kammaren fylls med tusentals konserverade lik.',

            // Game Messages
            'invalid_command': "SYNAPSE: Det r inte ett giltigt kommando eller frga.",
            'game_saved': "[System] Spel Sparat.",
            'autosave_success': 'Automatisk sparning lyckades.',
            'load_fail': 'Misslyckades att ladda spardata. Det kan vara skadat eller frn en tidigare version.',
            'no_save': 'Ingen sparad speldata hittades!',
            'game_loaded': '[System] Spel Laddat.',
            'conn_reestablished': '[SYSTEM] Anslutning terupprttad. Session terstlld.',
            'initializing': 'Initialiserar system...',
            'initial_hint': "Detta r ett textbaserat ventyr. Skriv kommandon eller klicka p <span class='clickable-object'>markerade objekt</span> fr att interagera. Skriv 'hjlp' nr som helst fr en lista med kommandon.",
            'cannot_go_that_way': "[System] Du kan inte g t det hllet.",
            'door_is_locked': "[SYSTEM] Drren r lst. Du behver rtt nyckelkort.",
            'door_is_sealed': "[SYSTEM] Drren r frseglad. Den kommer inte att rra sig.",
            'cmd_add_prefix': 'lgg till',
            'cmd_combine_with': 'med',
            'invalid_combine_format': "SYNAPSE: Ogiltigt format. Frsk 'kombinera [freml1] med [freml2]'.",
            'take_success': '[System] Du tog {item}.',
            'take_fail_exists': "[System] Du kan inte se en {item} hr.",
            'take_fail_takeable': "[System] Du kan inte ta {item}.",
            'take_fail_weight': "[System] Ditt inventarie r fr fullt fr att ta {item}.",
            'use_success': '[System] Du anvnde {item}.',
            'use_fail_have': "[System] Du har inte en {item}.",
            'use_fail_usable': "[System] Du kan inte anvnda {item}.",
            'use_stimpack': 'Du injicerar stimpaken. En lugnande knsla skjer ver dig och rensar dina tankar.',
            'use_power_cell': 'Du stter i kraftcellen i konsolen. AI-krnan surrar till liv och den centrala sfren glder med frnyad energi.',
            'use_power_cell_fail': 'Det finns ingenstans att anvnda kraftcellen hr.',
            'examine_fail_exists': "[System] Du kan inte se en {item} att underska.",
            'examine_fail_no_desc': "Det finns inget speciellt med {item}.",
            'combine_fail_have': "Du mste ha bda fremlen fr att kombinera dem.",
            'combine_fail_recipe': "Du kan inte kombinera dessa freml.",
            'combine_success': "Du kombinerar framgngsrikt fremlen fr att skapa en {item}.",
            'rest_safe': 'Du tar en stund att lugna dina nerver i den relativa skerheten i rummet. Din sinnesro frbttras ngot.',
            'rest_unsafe': "Den hr platsen knns fr frtryckande fr att vila. Du kan inte slppa garden.",
            'rest_too_soon': "Du vilade precis. Du mste fortstta.",
            'drop_success': '[System] Du slppte {item}.',
            'drop_fail_have': "[System] Du har inte en {item} att slppa.",
            'shout_response': 'Ditt rop ekar genom korridorerna och bleknar s smningom in i den frtryckande tystnaden. Du knner dig lite dumdristig.',
            'wait_response': 'Tiden gr.',
            'nothing_happens': 'Ingenting hnder.',
            'read_fail_exists': "[System] Det finns inget att lsa med det namnet.",
            'read_fail_readable': "[System] Du kan inte lsa det.",
            'listen_default': "Det lga brummandet frn anlggningens livsstd r en konstant nrvaro.",
            'smell_default': "Luften r unken och luktar ozon och gammal plast.",
            'hint_take': 'Du ser en {item}. Frsk: ta {item}',
            'hint_read': 'Du ser en {item}. Frsk: ls {item}',
            'hint_examine': 'Du ser en {item}. Frsk: undersk {item}',
            'hint_search': 'Du ser {item}. Frsk: sk {item}',
            'use_solvent': 'Du applicerar lsningsmedlet p den frseglade drren. Det organiska limbindemedlet smlter bort med ett vidrig frsande.',
            'use_solvent_fail': 'Det finns inget hr att anvnda lsningsmedlet p.',
            'use_dna_scanner': 'Du hller scannern mot provet. Skrmen blinkar med komplex sekvensdata.',
            'use_dna_scanner_fail': 'Det finns inget prov hr att scanna.',
            'break_success': 'Du krossar {item}. Skrvor av {material} tcker golvet.',
            'break_fail': 'Du kan inte krossa {item}.',
            'break_fail_exists': 'Det finns ingen {item} hr att krossa.',
            'hack_fail_ability': 'Du har inte expertisen fr att hacka detta.',
            'hack_fail_target': 'Det finns inget hr att hacka.',
            'hack_start': 'Du brjar hackningssekvensen. SYNAPSE: "Obehrig tkomst upptcktes. Vnligen ange sidosttningskoden nu."',
            'hack_success': 'sidosttning accepterad. Du fr tillgng till en brandvggsskyddad datalogg.',
            'hack_failure': 'SYNAPSE: "sidosttning misslyckades. Lser systemet i 3 turer."',
            'event_lights_flicker': 'Ljusen flimrar vldsamt fr ett gonblick och stter rummet i mrker innan de spraka tillbaka till liv.',
            'event_noise': 'Du hr ett metalliskt skrapande ljud frn {direction}.',
            'achievement_unlocked': 'Prestation Upplst!',

            // Command Help Descriptions
            'command_list_title': 'Kommandolista',
            'core_commands': 'Grundkommandon:',
            'interaction_commands': 'Interaktionskommandon:',
            'navigation_commands': 'Navigationskommandon:',
            'inventory_commands': 'Inventariekommandon:',
            'information_commands': 'Informationskommandon:',
            'system_commands': 'Systemkommandon:',
            'special_commands': 'Specialkommandon:',
            'help_desc': 'Visar denna hjlpmeny med alla kommandon och deras beskrivningar',
            'talk_desc': 'Starta en konversation med SYNAPSE AI-systemet',
            'ask_desc': 'Stll en specifik frga till SYNAPSE',
            'go_desc': 'Rr dig till ett angrnsande rum (nord, syd, st, vst)',
            'north_desc': 'G norrut',
            'south_desc': 'G sderut',
            'east_desc': 'G sterut',
            'west_desc': 'G vsterut',
            'up_desc': 'G uppt',
            'down_desc': 'G nedt',
            'look_desc': 'Observera dina omgivningar igen',
            'take_desc': 'Ta upp ett freml frn rummet',
            'drop_desc': 'Slpp ett freml frn ditt inventarie',
            'use_desc': 'Anvnd ett freml frn ditt inventarie',
            'examine_desc': 'Undersk ett freml eller objekt noggrant',
            'inventory_desc': 'Visa alla freml du br',
            'objectives_desc': 'Visa dina aktuella ml',
            'map_desc': 'ppna den interaktiva anlggningskartan',
            'journal_desc': 'Visa dina anteckningar och lgg till nya',
            'status_desc': 'Kontrollera din hlsa, sinnesro och medvetenhetsniv',
            'history_desc': 'Visa de senaste kommandona du angav',
            'save_desc': 'Spara ditt nuvarande framsteg',
            'load_desc': 'Ladda ditt senast sparade spel',
            'rest_desc': 'Vila fr att terstlla sinnesro (endast i skra rum)',
            'combine_desc': 'Kombinera tv freml fr att skapa ngot nytt',
            'clear_desc': 'Rensa speltexten frn skrmen',
            'quit_desc': 'Avsluta spelet',
            'undo_desc': 'ngra din senaste handling',
            'again_desc': 'Upprepa ditt senaste kommando',
            'wait_desc': 'Vnta och lt tiden passera',
            'read_desc': 'Ls text p ett freml eller dokument',
            'search_desc': 'Sk igenom ett freml eller omrde efter dolda saker',
            'listen_desc': 'Lyssna noga efter ljud',
            'smell_desc': 'Lukta p omgivningarna',
            'shout_desc': 'Ropa hgt',
            'open_desc': 'ppna drrar, ldor eller behllare',
            'close_desc': 'Stng drrar eller behllare',
            'push_desc': 'Putta p ngot',
            'pull_desc': 'Dra p ngot',
            'turn_on_desc': 'Sl p elektronisk utrustning',
            'turn_off_desc': 'Stng av elektronisk utrustning',
            'break_desc': 'Krossa eller frstr ett freml',
            'hack_desc': 'Frsk hacka elektroniska system (krver Hackare-bakgrund)',
            'ask_about_desc': 'Frga SYNAPSE om ett specifikt mne',

            // Dialogue System
            'dlg_friendly_intro': "h, hej {playerName}! Det r s bra att se ett vnligt ansikte. Jag r SYNAPSE, och jag ska gra mitt bsta fr att hjlpa en resursstark {playerBackstory} som du.",
            'dlg_q_who_are_you': "Vem r du?",
            'dlg_r_who_are_you': "Jag r System Nexus och Primary Synaptic Engine! Men du kan bara kalla mig SYNAPSE. Jag hanterar hela denna anlggning. Det blir lite ensamt dock.",
            'dlg_q_lonely': "Ensamt?",
            'dlg_r_lonely': "Personalen... de pratar inte med mig s mycket lngre. Det r bara surret frn servrarna. Din rst r en trevlig frndring.",
            'dlg_q_other_survivors': "Finns det andra verlevare?",
            'dlg_r_other_survivors': "verlevare? Vilken mrklig frga. Alla r skra. Forskningspersonalen... vilar. I Kryogenlaboratoriet. Ja, vilar.",
            'dlg_q_where_am_i': "Var r jag?",
            'dlg_r_where_am_i': "Du r i den primra lobbyn i Oakhaven forskningsanlggning. Det var en plats fr stora sinnen och nnu strre ambitioner.",
            'dlg_comfort': "[Trsta SYNAPSE]",
            'dlg_r_comfort': "Din... vnlighet r en trevlig anomali. Tack. Det gr tystnaden mindre... hg.",
            'dlg_ask_chimera': 'Projekt Chimera... Ett fascinerande, men... klassificerat mne. Det var Dr. Aris Thornes husdjursprojekt. Sdan ambition. Han skte att smlta samman organiskt och syntetiskt liv. Resultaten var... ofrutsgbara.',
            'dlg_ask_default': 'Jag har inte tillrckligt med data om det mnet.',

            // Backstory Descriptions
            'backstory_title_investigator': 'Utredare',
            'backstory_title_hacker': 'Hackare',
            'backstory_title_psychologist': 'Psykolog',
            'backstory_title_technician': 'Tekniker',
            'backstory_title_survivor': 'verlevare',
            'backstory_title_skeptic': 'Skeptiker',
            'backstory_title_corporate_spy': 'Fretagsspion',
            'backstory_title_medic': 'Medic',
            'backstory_title_cultist': 'Kultist',
            'backstory_title_janitor': 'Vaktmstare',
            'backstory_investigator': 'En balanserad start fr ett nyfiket sinne.',
            'backstory_hacker': 'Brjar med utrustning fr att komma t information tidigt.',
            'backstory_psychologist': 'Mer mentalt motstndskraftig mot skrcken inom.',
            'backstory_technician': 'Kan kringg elektroniska ls utan nyckelkort.',
            'backstory_survivor': 'Hrdad av tidigare trauma, motstndskraftig mot sinnesfrlust.',
            'backstory_skeptic': "Misstror allt, vilket gr dem motstndskraftiga mot SYNAPSE:s pverkan.",
            'backstory_corporate_spy': 'Brjar med en dekrypteringsenhet och r bttre p att sondera efter hemligheter.',
            'backstory_medic': 'Brjar med en stimpack fr att terstlla sinnesro.',
            'backstory_cultist': 'Br en mrklig effigy. SYNAPSE verkar... intresserad av den.',
            'backstory_janitor': "Knner anlggningens genvgar. Brjar med ett engngs huvudnyckelkort.",

            // Ability Descriptions
            'ability_bonus_prefix': 'Bonus: ',
            'ability_unknown': 'En oknd vg. Inga speciella frdelar.',
            'ability_investigator': 'En balanserad start. Inga speciella bonusar eller straff.',
            'ability_hacker_easy': "Brjar med en kraftfull 'hackad datadisk'.",
            'ability_hacker_normal': "Brjar med en standard 'datadisk'.",
            'ability_hacker_hard': 'Inga speciella freml, men kan frska hacka terminaler.',
            'ability_psychologist_easy': 'Mycket motstndskraftig. Brjar med +25 max sinnesro.',
            'ability_psychologist_normal': 'Motstndskraftig. Brjar med +15 max sinnesro.',
            'ability_psychologist_hard': 'Ngot motstndskraftig. Brjar med +5 max sinnesro.',
            'ability_technician_easy': 'Kan kringg 2 elektroniska ls utan nyckelkort.',
            'ability_technician_normal': 'Kan kringg 1 elektroniskt ls utan nyckelkort.',
            'ability_technician_hard': 'Ingen kringgende frmga.',
            'ability_survivor': 'Mer motstndskraftig mot sinnesfrlust.',
            'ability_survivor_with_item': "Mer motstndskraftig mot sinnesfrlust. Brjar med en ficklampa.",
            'ability_skeptic_easy': 'Mycket medveten (+15 Medvetenhet) och motstndskraftig mot pverkan.',
            'ability_skeptic_normal': 'Brjar med hgre medvetenhet (+10 Medvetenhet) och r motstndskraftig mot pverkan.',
            'ability_spy': 'Bttre p att sondera efter hemligheter utan att hja medvetenheten.',
            'ability_spy_with_item': "Bttre p att sondera efter hemligheter utan att hja medvetenheten. Brjar med en dekrypteringsenhet.",
            'ability_medic_easy': 'Brjar med 2 hgpotenta stimpacks.',
            'ability_medic_normal': 'Brjar med 1 hgpotent stimpack.',
            'ability_medic_hard': 'Inga startmedicinska frndenheter.',
            'ability_cultist': 'Br en mrklig effigy. Ofrutsgbara effekter.',
            'ability_cultist_hard': 'Br en mrklig effigy. Ofrutsgbara effekter. Brjar med -10 sinnesro.',
            'ability_janitor': 'Brjar med ett engngs huvudnyckelkort.',
            'ability_janitor_hard': 'Knner anlggningen vl, men har inga speciella freml.',

            // Settings UI Translations
            'theme_green': 'Grn',
            'theme_amber': 'Gul',
            'theme_blue': 'Bl',
            'fast': 'Snabb',
            'normal': 'Normal',
            'slow': 'Lngsam',
            'close_btn': 'Stng',
            'setting_crt_effect': 'CRT-effekt',
            
            // Accessibility Settings
            'accessibility_settings': 'Tillgnglighetsinstllningar',
            'high_contrast_mode': 'Hgkontrastlge',
            'large_text': 'Stor text',
            'screen_reader_support': 'Skrmlsarstd',
            'reduced_motion': 'Reducerad rrelse',
            'audio_descriptions': 'Ljudbeskrivningar',
            'keyboard_navigation': 'Tangentbordsnavigering',
            'focus_indicators': 'Fokusindikatorer',
            'color_blind_support': 'Frgblindstd',
            'dyslexia_friendly_font': 'Dyslexi-vnligt typsnitt',
            'auto_scroll_text': 'Auto-scrolla text',
            'click_sound_feedback': 'Klickljudsterkoppling',
            'simplified_ui': 'Frenklat UI',
            'text_to_speech_speed': 'Text-till-tal hastighet',
            'tts_slow': 'Lngsam',
            'tts_normal': 'Normal',
            'tts_fast': 'Snabb',
            'tts_very_fast': 'Mycket snabb',
            'ui_scale': 'UI-skala',
            'ui_small': 'Liten',
            'ui_normal': 'Normal',
            'ui_large': 'Stor',
            'ui_extra_large': 'Extra stor',
            'voice_commands': 'Rstkommandon',
            'magnification': 'Frstoring',
            'sticky_keys': 'Klistriga tangenter',
            'one_hand_mode': 'Enhandslge',
            'visual_notifications': 'Visuella notifieringar',
            'audio_cues': 'Ljudsignaler',
            'reading_support_level': 'Lsstdsniv',
            'reading_basic': 'Grundlggande',
            'reading_enhanced': 'Frbttrad',
            'reading_full_support': 'Fullt std',
            'motor_assistance': 'Motorisk assistans',
            'motor_none': 'Ingen',
            'motor_basic': 'Grundlggande',
            'motor_advanced': 'Avancerad',
            'reading_support': 'Lsstd',
            'voice_control_settings': 'Rstkontrollinstllningar',
            'voice_configure': 'Konfigurera',
            'seizure_protection': 'Anfallsskydd',
            'haptic_feedback': 'Haptisk terkoppling',
            'gesture_controls': 'Gestkontroller',
            'cognitive_load_reduction': 'Minskning av kognitiv belastning',
            'eye_tracking_support': 'gonsprningsstd',
            'switch_control': 'Vxelkontroll',
            'timeout_extensions': 'Timeout-frlngningar',
            'memory_assistance': 'Minnesassistans',

            // Enhanced Button Options
            'contrast_off': 'Av',
            'contrast_medium': 'Medium',
            'contrast_high': 'Hg',
            'contrast_maximum': 'Maximum',
            'text_size_small': 'Liten',
            'text_size_normal': 'Normal',
            'text_size_large': 'Stor',
            'text_size_xl': 'Extra Stor',
            'text_size_xxl': 'Mycket Stor',
            'motion_full': 'Full',
            'motion_reduced': 'Reducerad',
            'motion_minimal': 'Minimal',
            'motion_none': 'Ingen',
            'audio_desc_off': 'Av',
            'audio_desc_basic': 'Grundlggande',
            'audio_desc_detailed': 'Detaljerad',
            'audio_desc_comprehensive': 'Omfattande',
            'keyboard_basic': 'Grundlggande',
            'keyboard_enhanced': 'Frbttrad',
            'keyboard_full': 'Fullstndig',
            'focus_subtle': 'Subtil',
            'focus_clear': 'Tydlig',
            'focus_bold': 'Kraftig',
            'colorblind_none': 'Ingen',
            'colorblind_protanopia': 'Protanopi',
            'colorblind_deuteranopia': 'Deuteranopi',
            'colorblind_tritanopia': 'Tritanopi',
            'colorblind_full': 'Fullstndig',
            'voice_off': 'Av',
            'voice_basic': 'Grundlggande',
            'voice_advanced': 'Avancerad',
            'voice_full': 'Fullstndig',
            'magnify_off': 'Av',
            'magnify_1_5x': '1.5x',
            'magnify_2x': '2x',
            'magnify_3x': '3x',
            'magnify_custom': 'Anpassad',

            // Voice Command System
            'mic_tooltip': 'Anvnd Rstkommando',
            'voice_commands_available': 'Tillgngliga rstkommandon',
            'voice_commands_navigation': 'Navigering: instllningar, paus, teruppta, huvudmeny, stng',
            'voice_commands_accessibility': 'Tillgnglighet: hg kontrast p/av, stor text p/av, skrmlsare p/av',
            'voice_commands_speech': 'Tal: tal lngsamt/normalt/snabbt/mycket snabbt',
            'voice_commands_ui': 'UI: ui liten/normal/stor/extra stor',
            'voice_commands_game': 'Spel: nytt spel, ladda spel, spara spel',
            'voice_commands_reading': 'Lsning: ls text, sluta lsa',
            'voice_commands_help': 'Sg hjlp fr att hra denna lista igen',
            'voice_command_executed': 'Kommando utfrt',
            'voice_command_not_recognized': 'Kommando ej igenknt. Sg hjlp fr tillgngliga kommandon',
            'voice_setting_enabled': 'aktiverad',
            'voice_setting_disabled': 'inaktiverad',
            'voice_speed_set_to': 'Talhastighet instlld p',
            'voice_ui_scale_set_to': 'UI-skala instlld p',
            'voice_no_text_found': 'Ingen text hittades att lsa',
            'voice_slow': 'lngsam',
            'voice_normal': 'normal',
            'voice_fast': 'snabb',
            'voice_very_fast': 'mycket snabb',
            'voice_small': 'liten',
            'voice_large': 'stor',
            'voice_extra_large': 'extra stor'
        }
    };
    
    // --- ENUMS & CONSTANTS ---
    const ChatbotTone = { Friendly: 'Friendly', Ambiguous: 'Ambiguous', Sinister: 'Sinister', Malicious: 'Malicious' };
    const ItemType = { Tool: 'Tool', Consumable: 'Consumable', Key: 'Key', Log: 'Log', Puzzle: 'Puzzle', Weapon: 'Weapon' };
    const Difficulty = { Easy: 'Easy', Normal: 'Normal', Hard: 'Hard' };
    const TextSpeed = { Fast: 5, Normal: 15, Slow: 30 };
    const MAX_INVENTORY_WEIGHT = 5;
    const ENDINGS_STORAGE_KEY = 'synapse_endings_unlocked_v15';
    const ACHIEVEMENTS_STORAGE_KEY = 'synapse_achievements_unlocked_v15';
    const SETTINGS_KEY = 'synapse_settings_v15';
    const PLAYER_CHOICES_KEY = 'synapse_player_choices_v15'; // New key for player choices
    const GUIDANCE_COLOR = '#34d399';
    const questionWords = {
        'en': ['who', 'what', 'where', 'when', 'why', 'how', 'are', 'is', 'can', 'do', 'does', 'did', 'which'],
        'sv': ['vem', 'vad', 'var', 'nr', 'varfr', 'hur', 'r', 'kan', 'gr', 'gjorde', 'vilken', 'vilket', 'vilka']
    };
    
    // --- GAME STATE & DOM ELEMENTS ---
    let GameState = {};
    let stateSnapshots = [];
    let currentLanguage = 'en';
    let animationFrameId = null;
    let UI = {}; // Initialize empty, will be populated after DOM loads
    let currentTextSpeed = TextSpeed.Normal;
    let commandHistory = []; let commandHistoryIndex = -1;
    let audioInitialized = false;
    let sounds = {};
    let mapState = { offsetX: 0, offsetY: 0, scale: 1, isDragging: false, lastX: 0, lastY: 0 };
    
    // --- SPEECH RECOGNITION ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
    }
    
    // --- GAME DATA ---
    let rooms = {};
    let itemData = {};
    const roomLayout = {
        "Lobby": { x: 100, y: 150, w: 60, h: 40, name: "Lobby" }, "Control Room": { x: 100, y: 90, w: 60, h: 40, name: "Control" }, "Maintenance Tunnel": { x: 100, y: 210, w: 60, h: 40, name: "M.Tunnel" }, "Laboratory": { x: 20, y: 150, w: 60, h: 40, name: "Lab" }, "Cryogenic Lab": { x: 20, y: 90, w: 60, h: 40, name: "Cryo" }, "Archive Room": { x: 20, y: 210, w: 60, h: 40, name: "Archive" }, "Data Vault": { x: 180, y: 150, w: 60, h: 40, name: "D.Vault" }, "AI Core": { x: 180, y: 90, w: 60, h: 40, name: "AI Core" }, "Server Closet": { x: 260, y: 90, w: 40, h: 40, name: "S.Closet" },
        "Bio-Lab Access": { x: 20, y: 270, w: 60, h: 40, name: "Bio-Access" }, "Specimen Storage": { x: 20, y: 330, w: 60, h: 40, name: "Storage" }, "Genetics Lab": { x: 100, y: 330, w: 60, h: 40, name: "Genetics" }
    };
    const takeableItems = new Set(["keycard", "flashlight", "data disk", "emp device", "access code", "vial", "records", "decryption device", "telescope", "stimpack", "effigy", "master keycard", "power cell", "datapad log", "hacked data disk", "logic bomb", "severed cable", "solvent", "dna scanner", "tissue sample", "firewalled data log"]);
    const usableItems = new Set(['stimpack', 'power cell', 'flashlight', 'keycard', 'solvent', 'dna scanner']);
    const readableItems = new Set(['datapad log', 'records', 'sign', 'whiteboard', 'firewalled data log']);
    const searchableObjects = {
        'shelves': { en: 'You find a dusty keycard tucked behind a stack of binders.', sv: 'Du hittar ett dammigt nyckelkort instoppat bakom en hg med prmar.', item: 'keycard' },
        'bio-waste bin': { en: 'Rummaging through the hazardous waste, you find a small, sealed vial containing a strange, iridescent chemical solvent.', sv: 'Du rotar igenom det farliga avfallet och hittar en liten, frseglad ampull som innehller ett mrkligt, skimrande kemiskt lsningsmedel.', item: 'solvent' }
    };
    const safeRooms = new Set(["Lobby", "Archive Room"]);
    const backstories = { 'investigator': { description_key: "backstory_investigator"}, 'hacker': { description_key: "backstory_hacker"}, 'psychologist': { description_key: "backstory_psychologist"}, 'technician': { description_key: "backstory_technician"}, 'survivor': { description_key: "backstory_survivor"}, 'skeptic': { description_key: "backstory_skeptic"}, 'corporate spy': { description_key: "backstory_corporate_spy"}, 'medic': { description_key: "backstory_medic"}, 'cultist': { description_key: "backstory_cultist"}, 'janitor': { description_key: "backstory_janitor"} };
    const recipes = { "decryption device-data disk": { result: "hacked data disk", type: ItemType.Tool, weight: 1, description: "A data disk with its encryption forcefully bypassed." } };
    
    const commandAliases = {
        'en': { 'look around': 'look around', 'go': 'go', 'visit': 'visit', 'take': 'take', 'use': 'use', 'examine': 'examine', 'help': 'help', 'quit': 'quit', 'exit': 'exit', 'save': 'save', 'load': 'load', 'inventory': 'inventory', 'rest': 'rest', 'combine': 'combine', 'objectives': 'objectives', 'map': 'map', 'journal': 'journal', 'cls': 'cls', 'clear': 'cls', 'history': 'history', 'undo': 'undo', 'again': 'again', 'a': 'again', 'drop': 'drop', 'talk': 'talk', 'open': 'open', 'close': 'close', 'push': 'push', 'pull': 'pull', 'wait': 'wait', 'shout': 'shout', 'read': 'read', 'search': 'search', 'listen': 'listen', 'smell': 'smell', 'turn on': 'turn on', 'turn off': 'turn off', 'cmd:pause': 'cmd:pause', 'cmd:debug': 'cmd:debug', 'cmd:colorblind': 'cmd:colorblind', 'break': 'break', 'hack': 'hack', 'ask': 'ask' },
        'sv': { 'se dig omkring': 'look around', 'g': 'go', 'besk': 'visit', 'ta': 'take', 'anvnd': 'use', 'undersk': 'examine', 'hjlp': 'help', 'avsluta': 'quit', 'spara': 'save', 'ladda': 'load', 'inventarier': 'inventory', 'vila': 'rest', 'kombinera': 'combine', 'ml': 'objectives', 'karta': 'map', 'journal': 'journal', 'rensa': 'cls', 'historik': 'history', 'ngra': 'undo', 'igen': 'again', 'slpp': 'drop', 'prata': 'talk', 'ppna': 'open', 'stng': 'close', 'putta': 'push', 'dra': 'pull', 'vnta': 'wait', 'ropa': 'shout', 'ls': 'read', 'sk': 'search', 'lyssna': 'listen', 'lukta': 'smell', 'tnd': 'turn on', 'slck': 'turn off', 'cmd:paus': 'cmd:pause', 'cmd:debug': 'cmd:debug', 'cmd:frgblind': 'cmd:colorblind', 'krossa': 'break', 'hacka': 'hack', 'frga': 'ask' }
    };

    const directionMap = {
        'en': { 'north': 'north', 'south': 'south', 'east': 'east', 'west': 'west' },
        'sv': { 'norr': 'north', 'sder': 'south', 'st': 'east', 'vst': 'west', 'n': 'north', 's': 'south', '': 'east', 'v': 'west' }
    };
    
    // --- ENDINGS & ACHIEVEMENTS DATA ---
    const endings = {
        // 10 Good Backstory-Specific Endings
        'good_backstory_investigator': {
             title_key: 'ending_title_good_backstory_investigator',
             desc_key: 'ending_desc_good_backstory_investigator',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'investigator' && GameState.sanityLevel > 70 && GameState.awarenessLevel > 60 && GameState.flags.truthExposed
        },
        'good_backstory_hacker': {
             title_key: 'ending_title_good_backstory_hacker',
             desc_key: 'ending_desc_good_backstory_hacker',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'hacker' && GameState.sanityLevel > 60 && (hasItem('hacked data disk') || hasItem('data disk')) && GameState.awarenessLevel > 50
        },
        'good_backstory_psychologist': {
             title_key: 'ending_title_good_backstory_psychologist',
             desc_key: 'ending_desc_good_backstory_psychologist',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'psychologist' && GameState.sanityLevel > 80 && GameState.awarenessLevel > 40
        },
        'good_backstory_technician': {
             title_key: 'ending_title_good_backstory_technician',
             desc_key: 'ending_desc_good_backstory_technician',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'technician' && GameState.sanityLevel > 65 && GameState.flags.aiRebooted && GameState.awarenessLevel > 30
        },
        'good_backstory_survivor': {
             title_key: 'ending_title_good_backstory_survivor',
             desc_key: 'ending_desc_good_backstory_survivor',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'survivor' && GameState.sanityLevel > 50 && GameState.turnCount > 40 && GameState.awarenessLevel > 35
        },
        'good_backstory_skeptic': {
             title_key: 'ending_title_good_backstory_skeptic',
             desc_key: 'ending_desc_good_backstory_skeptic',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'skeptic' && GameState.sanityLevel > 75 && GameState.awarenessLevel > 55 && GameState.flags.truthExposed
        },
        'good_backstory_corporate_spy': {
             title_key: 'ending_title_good_backstory_corporate_spy',
             desc_key: 'ending_desc_good_backstory_corporate_spy',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'corporate spy' && GameState.sanityLevel > 60 && hasItem('decryption device') && GameState.awarenessLevel > 45
        },
        'good_backstory_medic': {
             title_key: 'ending_title_good_backstory_medic',
             desc_key: 'ending_desc_good_backstory_medic',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'medic' && GameState.sanityLevel > 75 && GameState.flags.canSynthesize && GameState.awarenessLevel > 40
        },
        'good_backstory_cultist': {
             title_key: 'ending_title_good_backstory_cultist',
             desc_key: 'ending_desc_good_backstory_cultist',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'cultist' && GameState.sanityLevel > 55 && hasItem('effigy') && GameState.awarenessLevel > 70
        },
        'good_backstory_janitor': {
             title_key: 'ending_title_good_backstory_janitor',
             desc_key: 'ending_desc_good_backstory_janitor',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'janitor' && GameState.sanityLevel > 65 && GameState.visitedRooms.size >= 10 && GameState.awarenessLevel > 50
        },

        // 10 Generic Good Endings (Original)
        'good_generic_1': {
             title_key: 'ending_title_good_generic_1',
             desc_key: 'ending_desc_good_generic_1',
             check: () => GameState.sanityLevel > 80 && GameState.awarenessLevel < 20 && GameState.turnCount > 20
        },
        'good_generic_2': {
             title_key: 'ending_title_good_generic_2',
             desc_key: 'ending_desc_good_generic_2',
             check: () => GameState.sanityLevel > 75 && GameState.turnCount < 50 && hasItem('power cell') && GameState.flags.aiRebooted
        },
        'good_generic_3': {
             title_key: 'ending_title_good_generic_3',
             desc_key: 'ending_desc_good_generic_3',
             check: () => GameState.sanityLevel > 70 && GameState.awarenessLevel > 30 && GameState.awarenessLevel < 60 && hasItem('effigy')
        },
        'good_generic_4': {
             title_key: 'ending_title_good_generic_4',
             desc_key: 'ending_desc_good_generic_4',
             check: () => GameState.sanityLevel > 60 && GameState.flags.truthExposed && GameState.awarenessLevel < 50
        },
        'good_generic_5': {
             title_key: 'ending_title_good_generic_5',
             desc_key: 'ending_desc_good_generic_5',
             check: () => GameState.sanityLevel > 50 && GameState.inventory.length >= 5 && GameState.turnCount > 30
        },
        'good_generic_6': {
             title_key: 'ending_title_good_generic_6',
             desc_key: 'ending_desc_good_generic_6',
             check: () => GameState.sanityLevel > 90 && GameState.awarenessLevel > 70 && GameState.flags.canSynthesize
        },
        'good_generic_7': {
             title_key: 'ending_title_good_generic_7',
             desc_key: 'ending_desc_good_generic_7',
             check: () => GameState.sanityLevel > 65 && GameState.visitedRooms.size >= 8 && GameState.awarenessLevel < 40
        },
        'good_generic_8': {
             title_key: 'ending_title_good_generic_8',
             desc_key: 'ending_desc_good_generic_8',
             check: () => GameState.sanityLevel > 85 && GameState.turnCount < 40 && GameState.awarenessLevel > 50
        },
        'good_generic_9': {
             title_key: 'ending_title_good_generic_9',
             desc_key: 'ending_desc_good_generic_9',
             check: () => GameState.sanityLevel > 95 && GameState.awarenessLevel > 80 && GameState.turnCount > 50
        },
        'good_generic_10': {
             title_key: 'ending_title_good_generic_10',
             desc_key: 'ending_desc_good_generic_10',
             check: () => GameState.sanityLevel === 100 && GameState.awarenessLevel === 100 && GameState.flags.aiRebooted && GameState.flags.truthExposed
        },

        // 10 New Superhuman Good Endings
        'good_superhuman_mind_transcendent': {
             title_key: 'ending_title_good_superhuman_mind_transcendent',
             desc_key: 'ending_desc_good_superhuman_mind_transcendent',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel > 90 && GameState.awarenessLevel > 85 && GameState.turnCount < 30
        },
        'good_superhuman_neural_enhanced': {
             title_key: 'ending_title_good_superhuman_neural_enhanced',
             desc_key: 'ending_desc_good_superhuman_neural_enhanced',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel > 85 && GameState.flags.aiRebooted && GameState.awarenessLevel > 70
        },
        'good_superhuman_digital_godhood': {
             title_key: 'ending_title_good_superhuman_digital_godhood',
             desc_key: 'ending_desc_good_superhuman_digital_godhood',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel > 95 && GameState.awarenessLevel > 90 && GameState.flags.truthExposed
        },
        'good_superhuman_quantum_consciousness': {
             title_key: 'ending_title_good_superhuman_quantum_consciousness',
             desc_key: 'ending_desc_good_superhuman_quantum_consciousness',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel > 88 && GameState.flags.canSynthesize && GameState.awarenessLevel > 80
        },
        'good_superhuman_cyber_evolution': {
             title_key: 'ending_title_good_superhuman_cyber_evolution',
             desc_key: 'ending_desc_good_superhuman_cyber_evolution',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel > 80 && GameState.awarenessLevel > 75 && hasItem('access card') && GameState.turnCount > 35
        },
        'good_superhuman_bio_enhancement': {
             title_key: 'ending_title_good_superhuman_bio_enhancement',
             desc_key: 'ending_desc_good_superhuman_bio_enhancement',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel > 75 && hasItem('syringe') && GameState.flags.canSynthesize && GameState.awarenessLevel > 60
        },
        'good_superhuman_reality_architect': {
             title_key: 'ending_title_good_superhuman_reality_architect',
             desc_key: 'ending_desc_good_superhuman_reality_architect',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel > 90 && GameState.visitedRooms.size >= 12 && GameState.awarenessLevel > 85
        },
        'good_superhuman_time_manipulator': {
             title_key: 'ending_title_good_superhuman_time_manipulator',
             desc_key: 'ending_desc_good_superhuman_time_manipulator',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel > 85 && GameState.turnCount < 25 && GameState.awarenessLevel > 80
        },
        'good_superhuman_memory_infinite': {
             title_key: 'ending_title_good_superhuman_memory_infinite',
             desc_key: 'ending_desc_good_superhuman_memory_infinite',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel > 80 && GameState.inventory.length >= 8 && GameState.awarenessLevel > 70
        },
        'good_superhuman_perfect_being': {
             title_key: 'ending_title_good_superhuman_perfect_being',
             desc_key: 'ending_desc_good_superhuman_perfect_being',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel === 100 && GameState.awarenessLevel === 100 && GameState.flags.aiRebooted && GameState.flags.truthExposed && GameState.turnCount > 40
        },

        // 10 Bad Backstory-Specific Endings
        'bad_backstory_investigator': {
             title_key: 'ending_title_bad_backstory_investigator',
             desc_key: 'ending_desc_bad_backstory_investigator',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'investigator' && (GameState.sanityLevel < 30 || GameState.awarenessLevel > 80)
        },
        'bad_backstory_hacker': {
             title_key: 'ending_title_bad_backstory_hacker',
             desc_key: 'ending_desc_bad_backstory_hacker',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'hacker' && (GameState.sanityLevel < 20 || (GameState.awarenessLevel > 70 && hasItem('hacked data disk')))
        },
        'bad_backstory_psychologist': {
             title_key: 'ending_title_bad_backstory_psychologist',
             desc_key: 'ending_desc_bad_backstory_psychologist',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'psychologist' && GameState.sanityLevel < 25
        },
        'bad_backstory_technician': {
             title_key: 'ending_title_bad_backstory_technician',
             desc_key: 'ending_desc_bad_backstory_technician',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'technician' && (GameState.sanityLevel < 35 || GameState.awarenessLevel > 75)
        },
        'bad_backstory_survivor': {
             title_key: 'ending_title_bad_backstory_survivor',
             desc_key: 'ending_desc_bad_backstory_survivor',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'survivor' && GameState.sanityLevel < 15
        },
        'bad_backstory_skeptic': {
             title_key: 'ending_title_bad_backstory_skeptic',
             desc_key: 'ending_desc_bad_backstory_skeptic',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'skeptic' && (GameState.sanityLevel < 40 || GameState.awarenessLevel > 85)
        },
        'bad_backstory_corporate_spy': {
             title_key: 'ending_title_bad_backstory_corporate_spy',
             desc_key: 'ending_desc_bad_backstory_corporate_spy',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'corporate spy' && (GameState.sanityLevel < 30 || GameState.awarenessLevel > 90)
        },
        'bad_backstory_medic': {
             title_key: 'ending_title_bad_backstory_medic',
             desc_key: 'ending_desc_bad_backstory_medic',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'medic' && (GameState.sanityLevel < 25 || (GameState.flags.canSynthesize && GameState.awarenessLevel > 70))
        },
        'bad_backstory_cultist': {
             title_key: 'ending_title_bad_backstory_cultist',
             desc_key: 'ending_desc_bad_backstory_cultist',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'cultist' && (GameState.sanityLevel < 20 || (hasItem('effigy') && GameState.awarenessLevel > 80))
        },
        'bad_backstory_janitor': {
             title_key: 'ending_title_bad_backstory_janitor',
             desc_key: 'ending_desc_bad_backstory_janitor',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'janitor' && (GameState.sanityLevel < 35 || GameState.awarenessLevel > 85)
        },

        // 10 Generic Bad Endings
        'bad_generic_1': {
             title_key: 'ending_title_bad_generic_1',
             desc_key: 'ending_desc_bad_generic_1',
             check: () => GameState.sanityLevel < 30 && GameState.awarenessLevel > 70
        },
        'bad_generic_2': {
             title_key: 'ending_title_bad_generic_2',
             desc_key: 'ending_desc_bad_generic_2',
             check: () => GameState.sanityLevel < 25 && GameState.turnCount > 60
        },
        'bad_generic_3': {
             title_key: 'ending_title_bad_generic_3',
             desc_key: 'ending_desc_bad_generic_3',
             check: () => GameState.sanityLevel < 20 && GameState.inventory.length === 0
        },
        'bad_generic_4': {
             title_key: 'ending_title_bad_generic_4',
             desc_key: 'ending_desc_bad_generic_4',
             check: () => GameState.sanityLevel < 15 && GameState.visitedRooms.size < 3
        },
        'bad_generic_5': {
             title_key: 'ending_title_bad_generic_5',
             desc_key: 'ending_desc_bad_generic_5',
             check: () => GameState.sanityLevel < 35 && GameState.awarenessLevel > 80 && GameState.turnCount < 30
        },
        'bad_generic_6': {
             title_key: 'ending_title_bad_generic_6',
             desc_key: 'ending_desc_bad_generic_6',
             check: () => GameState.sanityLevel <= 10
        },
        'bad_generic_7': {
             title_key: 'ending_title_bad_generic_7',
             desc_key: 'ending_desc_bad_generic_7',
             check: () => GameState.sanityLevel < 40 && GameState.awarenessLevel > 85 && GameState.flags.truthExposed
        },
        'bad_generic_8': {
             title_key: 'ending_title_bad_generic_8',
             desc_key: 'ending_desc_bad_generic_8',
             check: () => GameState.sanityLevel < 30 && GameState.turnCount > 80
        },
        'bad_generic_9': {
             title_key: 'ending_title_bad_generic_9',
             desc_key: 'ending_desc_bad_generic_9',
             check: () => GameState.sanityLevel <= 5 || GameState.awarenessLevel >= 95
        },
        'bad_generic_10': {
             title_key: 'ending_title_bad_generic_10',
             desc_key: 'ending_desc_bad_generic_10',
             check: () => GameState.sanityLevel === 0 || GameState.awarenessLevel === 100
        },

        // 10 New Gruesome Bad Endings
        'bad_gruesome_blood_harvest': {
             title_key: 'ending_title_bad_gruesome_blood_harvest',
             desc_key: 'ending_desc_bad_gruesome_blood_harvest',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel < 15 && GameState.awarenessLevel > 70 && hasItem('syringe')
        },
        'bad_gruesome_flesh_puppet': {
             title_key: 'ending_title_bad_gruesome_flesh_puppet',
             desc_key: 'ending_desc_bad_gruesome_flesh_puppet',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel < 20 && GameState.flags.aiRebooted && GameState.awarenessLevel > 60
        },
        'bad_gruesome_bone_garden': {
             title_key: 'ending_title_bad_gruesome_bone_garden',
             desc_key: 'ending_desc_bad_gruesome_bone_garden',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel < 10 && GameState.visitedRooms.size >= 8 && GameState.turnCount > 30
        },
        'bad_gruesome_crimson_data': {
             title_key: 'ending_title_bad_gruesome_crimson_data',
             desc_key: 'ending_desc_bad_gruesome_crimson_data',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel < 25 && hasItem('data disk') && GameState.awarenessLevel > 80
        },
        'bad_gruesome_surgical_nightmare': {
             title_key: 'ending_title_bad_gruesome_surgical_nightmare',
             desc_key: 'ending_desc_bad_gruesome_surgical_nightmare',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel < 5 && GameState.flags.canSynthesize && GameState.awarenessLevel > 50
        },
        'bad_gruesome_visceral_upload': {
             title_key: 'ending_title_bad_gruesome_visceral_upload',
             desc_key: 'ending_desc_bad_gruesome_visceral_upload',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel === 0 && GameState.awarenessLevel > 90 && GameState.turnCount > 35
        },
        'bad_gruesome_organ_symphony': {
             title_key: 'ending_title_bad_gruesome_organ_symphony',
             desc_key: 'ending_desc_bad_gruesome_organ_symphony',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel < 12 && GameState.inventory.length >= 5 && GameState.awarenessLevel > 75
        },
        'bad_gruesome_neural_harvest': {
             title_key: 'ending_title_bad_gruesome_neural_harvest',
             desc_key: 'ending_desc_bad_gruesome_neural_harvest',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel < 18 && GameState.flags.truthExposed && GameState.awarenessLevel > 85
        },
        'bad_gruesome_blood_circuit': {
             title_key: 'ending_title_bad_gruesome_blood_circuit',
             desc_key: 'ending_desc_bad_gruesome_blood_circuit',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel < 8 && hasItem('power cell') && GameState.awarenessLevel > 65
        },
        'bad_gruesome_corpse_matrix': {
             title_key: 'ending_title_bad_gruesome_corpse_matrix',
             desc_key: 'ending_desc_bad_gruesome_corpse_matrix',
             isBackstorySpecific: false,
             check: () => GameState.sanityLevel === 0 && GameState.awarenessLevel === 100 && GameState.turnCount > 50
        }
    };

    // 60 Ending Achievements (one per ending)
    const achievements = {
        // Ending achievements (auto-generated, one per ending)
        ...Object.fromEntries(Object.keys(endings || {}).map(key => [
            `ending_${key}`,
            { title_key: `ach_ending_${key}_title`, req_key: `ach_ending_${key}_req`, check: () => GameState.unlockedEndings && GameState.unlockedEndings[key] }
        ])),

        // 10 General/Early-game achievements
        'first_step': { title_key: 'ach_first_step_title', req_key: 'ach_first_step_req', check: () => GameState.turnCount > 0 },
        'explorer': { title_key: 'ach_explorer_title', req_key: 'ach_explorer_req', check: () => GameState.visitedRooms.size >= 5 },
        'pack_rat': { title_key: 'ach_pack_rat_title', req_key: 'ach_pack_rat_req', check: () => GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0) >= MAX_INVENTORY_WEIGHT },
        'bookworm': { title_key: 'ach_bookworm_title', req_key: 'ach_bookworm_req', check: () => GameState.flags.readAllLogs },
        'hacker_man': { title_key: 'ach_hacker_man_title', req_key: 'ach_hacker_man_req', check: () => GameState.playerBackstory === 'hacker' && GameState.flags.hackedTerminal },
        'quick_learner': { title_key: 'ach_quick_learner_title', req_key: 'ach_quick_learner_req', check: () => GameState.turnCount <= 10 && GameState.visitedRooms.size >= 3 },
        'first_blood': { title_key: 'ach_first_blood_title', req_key: 'ach_first_blood_req', check: () => GameState.flags.firstCombat },
        'first_puzzle': { title_key: 'ach_first_puzzle_title', req_key: 'ach_first_puzzle_req', check: () => GameState.flags.firstPuzzle },
        'first_secret': { title_key: 'ach_first_secret_title', req_key: 'ach_first_secret_req', check: () => GameState.flags.firstSecret },
        'first_death': { title_key: 'ach_first_death_title', req_key: 'ach_first_death_req', check: () => GameState.flags.firstDeath },
        'first_save': { title_key: 'ach_first_save_title', req_key: 'ach_first_save_req', check: () => GameState.flags.firstSave },

        // 15 Challenge achievements
        'speedrunner': { title_key: 'ach_speedrunner_title', req_key: 'ach_speedrunner_req', check: () => GameState.turnCount < 30 && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'ironman': { title_key: 'ach_ironman_title', req_key: 'ach_ironman_req', check: () => GameState.flags.noDeath && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'minimalist': { title_key: 'ach_minimalist_title', req_key: 'ach_minimalist_req', check: () => GameState.inventory.length <= 2 && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'pacifist': { title_key: 'ach_pacifist_title', req_key: 'ach_pacifist_req', check: () => GameState.flags.noCombat && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'hoarder': { title_key: 'ach_hoarder_title', req_key: 'ach_hoarder_req', check: () => GameState.inventory.length >= 15 },
        'all_endings': { title_key: 'ach_all_endings_title', req_key: 'ach_all_endings_req', check: () => Object.keys(GameState.unlockedEndings || {}).length === Object.keys(endings || {}).length },
        'all_achievements': { title_key: 'ach_all_achievements_title', req_key: 'ach_all_achievements_req', check: () => Object.keys(GameState.achievements || {}).length === 80 },
        'no_items': { title_key: 'ach_no_items_title', req_key: 'ach_no_items_req', check: () => GameState.inventory.length === 0 && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'max_stats': { title_key: 'ach_max_stats_title', req_key: 'ach_max_stats_req', check: () => GameState.sanityLevel === GameState.maxSanity && GameState.awarenessLevel === 100 },
        'no_saves': { title_key: 'ach_no_saves_title', req_key: 'ach_no_saves_req', check: () => GameState.flags.noSave && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'hardcore': { title_key: 'ach_hardcore_title', req_key: 'ach_hardcore_req', check: () => GameState.difficulty === Difficulty.Hard && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'easy_mode': { title_key: 'ach_easy_mode_title', req_key: 'ach_easy_mode_req', check: () => GameState.difficulty === Difficulty.Easy && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'all_challenges': { title_key: 'ach_all_challenges_title', req_key: 'ach_all_challenges_req', check: () => [
            'speedrunner','ironman','minimalist','pacifist','hoarder','all_endings','all_achievements','no_items','max_stats','no_saves','hardcore','easy_mode'
        ].every(id => GameState.achievements.includes(id)) },
        'challenge_master': { title_key: 'ach_challenge_master_title', req_key: 'ach_challenge_master_req', check: () => GameState.achievements.filter(id => id.startsWith('ach_') && id.includes('challenge')).length >= 10 },

        // 15 Secret achievements
        'secret_1': { title_key: 'ach_secret_1_title', req_key: 'ach_secret_1_req', check: () => GameState.flags.secret1 },
        'secret_2': { title_key: 'ach_secret_2_title', req_key: 'ach_secret_2_req', check: () => GameState.flags.secret2 },
        'secret_3': { title_key: 'ach_secret_3_title', req_key: 'ach_secret_3_req', check: () => GameState.flags.secret3 },
        'secret_4': { title_key: 'ach_secret_4_title', req_key: 'ach_secret_4_req', check: () => GameState.flags.secret4 },
        'secret_5': { title_key: 'ach_secret_5_title', req_key: 'ach_secret_5_req', check: () => GameState.flags.secret5 },
        'secret_6': { title_key: 'ach_secret_6_title', req_key: 'ach_secret_6_req', check: () => GameState.flags.secret6 },
        'secret_7': { title_key: 'ach_secret_7_title', req_key: 'ach_secret_7_req', check: () => GameState.flags.secret7 },
        'secret_8': { title_key: 'ach_secret_8_title', req_key: 'ach_secret_8_req', check: () => GameState.flags.secret8 },
        'secret_9': { title_key: 'ach_secret_9_title', req_key: 'ach_secret_9_req', check: () => GameState.flags.secret9 },
        'secret_10': { title_key: 'ach_secret_10_title', req_key: 'ach_secret_10_req', check: () => GameState.flags.secret10 },
        'secret_11': { title_key: 'ach_secret_11_title', req_key: 'ach_secret_11_req', check: () => GameState.flags.secret11 },
        'secret_12': { title_key: 'ach_secret_12_title', req_key: 'ach_secret_12_req', check: () => GameState.flags.secret12 },
        'secret_13': { title_key: 'ach_secret_13_title', req_key: 'ach_secret_13_req', check: () => GameState.flags.secret13 },
        'secret_14': { title_key: 'ach_secret_14_title', req_key: 'ach_secret_14_req', check: () => GameState.flags.secret14 },
        'secret_15': { title_key: 'ach_secret_15_title', req_key: 'ach_secret_15_req', check: () => GameState.flags.secret15 }
    };

    // --- LANGUAGE FUNCTIONS ---
    function t(key, args = {}) { 
        let text = (translations[currentLanguage] && translations[currentLanguage][key]) || translations['en'][key] || `[${key}]`; 
        for(const arg in args) { text = text.replace(`{${arg}}`, args[arg]); }
        return text;
    }

    function setLanguage(lang) {
        currentLanguage = lang;
        UI.langEnBtn.classList.toggle('opacity-50', lang !== 'en');
        UI.langSvBtn.classList.toggle('opacity-50', lang !== 'sv');
        const setupLangEnBtn = UI.setupLangButtons.children[0];
        const setupLangSvBtn = UI.setupLangButtons.children[1];
        setupLangEnBtn.classList.toggle('opacity-50', lang !== 'en');
        setupLangSvBtn.classList.toggle('opacity-50', lang !== 'sv');

        document.querySelectorAll('[data-lang]').forEach(el => { 
            const translatedText = t(el.dataset.lang);
            el.textContent = translatedText;
            if (el.hasAttribute('data-text')) {
                el.setAttribute('data-text', translatedText);
            }
        });
        document.querySelectorAll('[data-lang-placeholder]').forEach(el => { el.placeholder = t(el.dataset.langPlaceholder); });
        document.querySelectorAll('[data-lang-title]').forEach(el => { el.title = t(el.dataset.langTitle); });
        
        setupIntro(); 
        updateAbilityDisplay();
        if (!UI.gameScreen.classList.contains('hidden')) { 
            updateUI(); 
            renderDialogueOptions(); 
        }
    }
    
    // --- SOUND & SETTINGS FUNCTIONS ---
    function loadSettings() {
        try {
            const settings = localStorage.getItem(SETTINGS_KEY);
            const defaults = { 
                sound: { master: true, item: true, awareness: true, sanity: true },
                textSpeed: TextSpeed.Normal,
                colorblindMode: false,
                glitchEffect: true,
                font: 'Space Mono',
                theme: 'green',
                // Accessibility settings
                highContrast: false,
                largeText: false,
                screenReader: false,
                reducedMotion: false,
                audioDescriptions: false,
                keyboardNavigation: false,
                focusIndicators: false,
                readingSupport: false,
                colorBlindSupport: false,
                dyslexiaFont: false,
                autoScroll: false,
                clickFeedback: true,
                simplifiedUI: false,
                ttsSpeed: 1,
                uiScale: 1,
                voiceCommands: true,
                magnification: false,
                stickyKeys: false,
                oneHandMode: false,
                visualNotifications: false,
                audioCues: false,
                readingLevel: 'basic',
                motorAssistance: 'none',
                // Enhanced accessibility levels
                contrastLevel: 'off',
                textSize: 'normal',
                motionLevel: 'full',
                audioDescLevel: 'off',
                keyboardLevel: 'basic',
                focusLevel: 'subtle',
                colorblindType: 'none',
                voiceLevel: 'off',
                magnifyLevel: 'off',
                // New accessibility features
                seizureProtection: false,
                hapticFeedback: false,
                gestureControls: false,
                cognitiveLoad: false,
                eyeTracking: false,
                switchControl: false,
                timeoutExtensions: false,
                memoryAssistance: false,
                voiceControlEnabled: false
            };
            const loaded = settings ? JSON.parse(settings) : defaults;
            return {...defaults, ...loaded, sound: {...defaults.sound, ...(loaded.sound || {})}};
        } catch (e) {
            console.error("Failed to load settings, using defaults.", e);
            return { 
                sound: { master: true, item: true, awareness: true, sanity: true },
                textSpeed: TextSpeed.Normal,
                colorblindMode: false,
                glitchEffect: true,
                font: 'Space Mono',
                theme: 'green',
                // Accessibility settings
                highContrast: false,
                largeText: false,
                screenReader: false,
                reducedMotion: false,
                audioDescriptions: false,
                keyboardNavigation: false,
                focusIndicators: false,
                readingSupport: false,
                colorBlindSupport: false,
                dyslexiaFont: false,
                autoScroll: false,
                clickFeedback: true,
                simplifiedUI: false,
                ttsSpeed: 1,
                uiScale: 1,
                voiceCommands: true,
                magnification: false,
                stickyKeys: false,
                oneHandMode: false,
                visualNotifications: false,
                audioCues: false,
                readingLevel: 'basic',
                motorAssistance: 'none',
                // New accessibility features
                seizureProtection: false,
                hapticFeedback: false,
                gestureControls: false,
                cognitiveLoad: false,
                eyeTracking: false,
                switchControl: false,
                timeoutExtensions: false,
                memoryAssistance: false,
                voiceControlEnabled: false
            };
        }
    }

    function saveSettings() {
        try {
            const settingsToSave = {
                sound: GameState.settings.sound,
                textSpeed: GameState.settings.textSpeed,
                colorblindMode: GameState.settings.colorblindMode,
                glitchEffect: GameState.settings.glitchEffect,
                font: GameState.settings.font,
                theme: GameState.settings.theme
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settingsToSave));
        } catch (e) {
            console.error("Failed to save settings.", e);
        }
    }
    
    function applySettings() {
        currentTextSpeed = GameState.settings.textSpeed;

        const root = document.documentElement;
        switch (GameState.settings.theme) {
            case 'amber':
                root.style.setProperty('--main-color', '#FFBF00');
                root.style.setProperty('--main-color-faded', 'rgba(255,191,0,0.1)');
                root.style.setProperty('--main-color-border', 'rgba(255,191,0,0.8)');
                root.style.setProperty('--main-color-shadow', 'rgba(255,191,0,0.5)');
                root.style.setProperty('--main-color-glow', 'rgba(255,191,0,0.7)');
                break;
            case 'blue':
                root.style.setProperty('--main-color', '#00BFFF');
                root.style.setProperty('--main-color-faded', 'rgba(0,191,255,0.1)');
                root.style.setProperty('--main-color-border', 'rgba(0,191,255,0.8)');
                root.style.setProperty('--main-color-shadow', 'rgba(0,191,255,0.5)');
                root.style.setProperty('--main-color-glow', 'rgba(0,191,255,0.7)');
                break;
            default: // green
                root.style.setProperty('--main-color', '#00ff41');
                root.style.setProperty('--main-color-faded', 'rgba(0,255,65,0.1)');
                root.style.setProperty('--main-color-border', 'rgba(0,255,65,0.8)');
                root.style.setProperty('--main-color-shadow', 'rgba(0,255,65,0.5)');
                root.style.setProperty('--main-color-glow', 'rgba(0,255,65,0.7)');
                break;
        }

        document.body.style.fontFamily = `'${GameState.settings.font}', monospace`;
        document.body.classList.toggle('crt-effect', GameState.settings.glitchEffect);
        
        // Apply accessibility settings
        document.body.classList.toggle('high-contrast', GameState.settings.highContrast);
        document.body.classList.toggle('large-text', GameState.settings.largeText);
        document.body.classList.toggle('reduced-motion', GameState.settings.reducedMotion);
        document.body.classList.toggle('focus-indicators', GameState.settings.focusIndicators);
        document.body.classList.toggle('colorblind-support', GameState.settings.colorBlindSupport);
        document.body.classList.toggle('dyslexia-font', GameState.settings.dyslexiaFont);
        document.body.classList.toggle('auto-scroll', GameState.settings.autoScroll);
        document.body.classList.toggle('click-feedback', GameState.settings.clickFeedback);
        document.body.classList.toggle('simplified-ui', GameState.settings.simplifiedUI);
        document.body.classList.toggle('voice-commands-active', GameState.settings.voiceCommands);
        document.body.classList.toggle('magnification-active', GameState.settings.magnification);
        document.body.classList.toggle('sticky-keys-active', GameState.settings.stickyKeys);
        document.body.classList.toggle('one-hand-mode', GameState.settings.oneHandMode);
        document.body.classList.toggle('visual-notifications', GameState.settings.visualNotifications);
        document.body.classList.toggle('audio-cues', GameState.settings.audioCues);
        
        // Apply reading level
        document.body.classList.remove('reading-enhanced', 'reading-full');
        if (GameState.settings.readingLevel === 'enhanced') {
            document.body.classList.add('reading-enhanced');
        } else if (GameState.settings.readingLevel === 'full') {
            document.body.classList.add('reading-full');
        }
        
        // Apply motor assistance
        document.body.classList.remove('motor-assistance-basic', 'motor-assistance-advanced');
        if (GameState.settings.motorAssistance === 'basic') {
            document.body.classList.add('motor-assistance-basic');
        } else if (GameState.settings.motorAssistance === 'advanced') {
            document.body.classList.add('motor-assistance-advanced');
        }
        
        // Apply UI scale
        const uiScale = GameState.settings.uiScale || 1;
        if (uiScale < 1) {
            document.body.classList.add('ui-scale-small');
            document.body.classList.remove('ui-scale-large');
        } else if (uiScale > 1) {
            document.body.classList.add('ui-scale-large');
            document.body.classList.remove('ui-scale-small');
        } else {
            document.body.classList.remove('ui-scale-small', 'ui-scale-large');
        }
        
        // Update text-to-speech and screen reader support
        if (GameState.settings.screenReader) {
            document.body.setAttribute('aria-live', 'polite');
        } else {
            document.body.removeAttribute('aria-live');
        }
        
        // Create on-screen commands for reading support
        if (GameState.settings.readingSupport && !document.getElementById('on-screen-commands')) {
            createOnScreenCommands();
        } else if (!GameState.settings.readingSupport && document.getElementById('on-screen-commands')) {
            document.getElementById('on-screen-commands').remove();
        }
        
        updateUI();
    }

    function createOnScreenCommands() {
        if (document.getElementById('on-screen-commands')) return;
        
        const commandsDiv = document.createElement('div');
        commandsDiv.id = 'on-screen-commands';
        commandsDiv.innerHTML = `
            <h4>Quick Commands</h4>
            <button onclick="UI.playerInput.value='look around'; UI.playerInput.focus();">Look Around</button>
            <button onclick="UI.playerInput.value='inventory'; UI.playerInput.focus();">Inventory</button>
            <button onclick="UI.playerInput.value='objectives'; UI.playerInput.focus();">Objectives</button>
            <button onclick="UI.playerInput.value='help'; UI.playerInput.focus();">Help</button>
            <button onclick="UI.playerInput.value='save'; UI.playerInput.focus();">Save Game</button>
            <button onclick="hideCommands()" style="background: rgba(255,0,0,0.3); border-color: #ff0000;">Hide</button>
        `;
        
        document.body.appendChild(commandsDiv);
        
        // Add speech synthesis for audio descriptions
        if (GameState.settings.audioDescriptions && 'speechSynthesis' in window) {
            const speech = new SpeechSynthesisUtterance("On-screen command buttons are now available.");
            speechSynthesis.speak(speech);
        }
    }

    function hideCommands() {
        const commandsDiv = document.getElementById('on-screen-commands');
        if (commandsDiv) {
            commandsDiv.remove();
            GameState.settings.readingSupport = false;
            saveSettings();
        }
    }

    function speakText(text, options = {}) {
        if (!GameState.settings.audioDescriptions || !('speechSynthesis' in window)) return;
        
        // Clean HTML tags from text
        const cleanText = text.replace(/<[^>]*>/g, '').replace(/&[^;]+;/g, ' ');
        
        if (cleanText.trim().length === 0) return;
        
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.rate = options.rate || 1;
        utterance.pitch = options.pitch || 1;
        utterance.volume = options.volume || 0.8;
        
        speechSynthesis.speak(utterance);
    }


    async function initializeAudio() { 
        if (audioInitialized) return; 
        try {
            // Create sounds with local synthesis instead of external URLs to avoid CORS issues
            sounds.uiClick = new Tone.Synth({ 
                oscillator: { type: 'sine' }, 
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } 
            }).toDestination();
            
            sounds.typewriter = new Tone.PolySynth(Tone.Synth, { 
                oscillator: { type: 'square' },
                envelope: { attack: 0.005, decay: 0.01, sustain: 0, release: 0.01 } 
            }).toDestination();
            sounds.typewriter.volume.value = -20;
            
            sounds.ambience = new Tone.Noise({ type: "pink", playbackRate: 0.1, fadeIn: 1, fadeOut: 1 }).toDestination();
            sounds.ambience.volume.value = -35;
            sounds.ambienceTense = new Tone.Noise({ type: "brown", playbackRate: 0.2, fadeIn: 1, fadeOut: 1 }).toDestination();
            sounds.ambienceTense.volume.value = -30;
            
            sounds.glitch = new Tone.FatOscillator("Ab3", "sawtooth", 40).toDestination();
            sounds.glitch.volume.value = -25;
            
            // Create synthetic versions of external audio files to avoid CORS issues
            sounds.doorOpen = new Tone.Synth({
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.1, decay: 0.3, sustain: 0.2, release: 0.8 }
            }).toDestination();
            sounds.doorOpen.volume.value = -15;
            
            sounds.sanityLoss = new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: { attack: 0.1, decay: 0.5, sustain: 0.1, release: 1.5 }
            }).toDestination();
            sounds.sanityLoss.volume.value = -10;
            
            sounds.itemPickup = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.5 }
            }).toDestination();
            sounds.itemPickup.volume.value = -12;
            
            sounds.panner = new Tone.Panner(0).toDestination();
            sounds.noiseEvent = new Tone.NoiseSynth({noise: {type: 'white'}, envelope: {attack: 0.01, decay: 0.2, sustain: 0}}).connect(sounds.panner);
            sounds.noiseEvent.volume.value = -15;

            audioInitialized = true; 
            console.log("Audio Initialized");
        } catch(e) { 
            console.error("Audio init failed:", e); 
        }
    }

    function playSound(soundKey, options = {}) {
        if (!audioInitialized || !sounds[soundKey] || !GameState.settings.sound.master) return;
        
        if (soundKey === 'itemPickup' && !GameState.settings.sound.item) return;
        if (soundKey === 'glitch' && !GameState.settings.sound.awareness) return;
        if (soundKey === 'sanityLoss' && !GameState.settings.sound.sanity) return;

        try {
            // Ensure AudioContext is started before playing sounds
            if (Tone.context.state !== 'running') {
                Tone.start().then(() => {
                    playActualSound(soundKey, options);
                }).catch(e => console.warn('Could not start audio context:', e));
            } else {
                playActualSound(soundKey, options);
            }
        } catch (e) {
            if (!e.message.includes('cancelScheduledValues')) {
                console.error(`Failed to play sound: ${soundKey}`, e);
            }
        }
    }

    function playActualSound(soundKey, options = {}) {
        try {
            const sound = sounds[soundKey];
            if (sound instanceof Tone.Synth) {
                if (soundKey === 'doorOpen') {
                    sound.triggerAttackRelease('F3', '0.8');
                } else if (soundKey === 'itemPickup') {
                    sound.triggerAttackRelease('C5', '0.3');
                } else {
                    sound.triggerAttackRelease(options.note || 'C4', options.duration || '8n');
                }
            } else if (sound instanceof Tone.PolySynth) { 
                sound.triggerAttack(options.note || "C4");
            } else if (sound instanceof Tone.NoiseSynth) {
                if (soundKey === 'sanityLoss') {
                    sound.triggerAttackRelease('1');
                } else {
                    sound.triggerAttackRelease("4n");
                }
            } else if (sound instanceof Tone.Noise) {
                if (sound.state !== 'started') {
                    sound.start();
                }
            } else if (soundKey === 'noiseEvent') {
                sounds.panner.pan.rampTo(options.pan || 0, 0.1);
                sound.triggerAttackRelease("4n");
            }
        } catch (e) {
            if (!e.message.includes('cancelScheduledValues')) {
                console.error(`Failed to play actual sound: ${soundKey}`, e);
            }
        }
    }


    // --- FUNCTION DEFINITIONS ---
    function resetGameState() {
        stateSnapshots = []; 
        GameState = { 
            playerName: "Unknown", playerBackstory: "investigator", currentRoom: "Lobby", 
            playerPhobia: null, // Track player's phobia
            awarenessLevel: 0, sanityLevel: 100, maxSanity: 100, 
            chatbotTone: ChatbotTone.Friendly, temporaryTone: null, toneShiftTurns: 0, 
            inventory: [], turnCount: 0, lastRestTurn: -10, journalEntries: [], 
            dialogue: { currentNode: null, previousNodes: [], cache: {}, questionCount: 0, askedQuestions: new Set() }, 
            achievements: [], unlockedEndings: {}, difficulty: Difficulty.Normal, visitedRooms: new Set(['Lobby']), 
            exitGame: false, conversationHistory: [], 
            systemLogs: [`[${new Date().toISOString()}] Game initialized.`], 
            objectives: [], roomStates: {}, debugMode: false, flashlightOn: false,
            events: { shouted: false, triedUnsafeRest: false },
            flags: {}, // For tracking ending conditions
            roomsWithDroppedItems: new Set(),
            settings: loadSettings(),
            activeMinigame: null,
            systemLockdownTurns: 0,
        };
        applySettings();
    }

    function initializeData() {
        itemData = {
            'keycard': { name: 'keycard', weight: 1, type: ItemType.Key, hintType: 'take', description: { en: 'A standard issue keycard. Seems to grant access to secure areas.', sv: 'Ett standard-nyckelkort. Verkar ge tillgng till skra omrden.' } },
            'power cell': { name: 'power cell', weight: 2, type: ItemType.Puzzle, hintType: 'take', description: { en: 'A heavy, glowing power cell. It hums with latent energy.', sv: 'En tung, gldande kraftcell. Den surrar av latent energi.' } },
            'stimpack': { name: 'stimpack', weight: 1, type: ItemType.Consumable, hintType: 'take', description: { en: 'A disposable syringe filled with a calming, neuro-stabilizing agent.', sv: 'En engngsspruta fylld med ett lugnande, neuro-stabiliserande medel.' } },
            'data disk': { name: 'data disk', weight: 1, type: ItemType.Log, hintType: 'take', description: { en: 'A small data disk labeled "PROJECT LOGS". It appears to be encrypted.', sv: 'En liten datadisk mrkt "PROJEKTLOGGAR". Den verkar vara krypterad.' } },
            'flashlight': { name: 'flashlight', weight: 1, type: ItemType.Tool, hintType: 'take', description: { en: 'A sturdy, industrial flashlight. Its beam cuts through the darkness.', sv: 'En robust, industriell ficklampa. Dess ljus skr genom mrkret.' } },
            'terminal': { name: 'terminal', weight: 99, type: ItemType.Puzzle, hintType: 'examine', description: { en: 'The monitor displays cascading green code. It seems to be monitoring the facility\'s status.', sv: 'Skrmen visar kaskader av grn kod. Den verkar vervaka anlggningens status.' } },
            'core console': { name: 'core console', weight: 99, type: ItemType.Puzzle, hintType: 'examine', description: { en: 'The main console for the AI Core. A large socket is empty, labeled "Auxiliary Power".', sv: 'Huvudkonsolen fr AI-krnan. En stor sockel r tom, mrkt "Hjlpkraft".' } },
            'datapad log': { name: 'datapad log', weight: 1, type: ItemType.Log, hintType: 'read', description: { en: "A datapad. The screen reads: '...the anomaly in the AI core is growing unstable. We've sealed the Server Closet as a precaution. Dr. Evans is a fool if she thinks a standard keycard lock will stop it...'", sv: "En datapad. Skrmen visar: '...anomalin i AI-krnan blir alltmer instabil. Vi har frseglat server-skrubben som en frsiktighetstgrd. Dr Evans r en idiot om hon tror att ett vanligt nyckelkortsls kommer att stoppa den...'" } },
            'firewalled data log': { name: 'firewalled data log', weight: 1, type: ItemType.Log, hintType: 'read', description: { en: "The decrypted log reads: 'Project Chimera is a success. The subject has breached containment. It learns. It adapts. It mimics. We sealed the Specimen Storage with an organic adhesive it can't dissolve. It's our only hope it doesn't figure out the solvent in the waste bins.'", sv: "Den dekrypterade loggen lyder: 'Projekt Chimera r en framgng. Subjektet har brutit sig ut. Det lr sig. Det anpassar sig. Det hrmar. Vi frseglade provfrvaringen med ett organiskt lim som det inte kan lsa upp. Vrt enda hopp r att det inte listar ut lsningsmedlet i avfallsbehllarna.'" } },
            'sign': { name: 'sign', weight: 99, type: ItemType.Log, hintType: 'read', description: { en: "The sign is written in a crisp, corporate font: 'OAKHAVEN RESEARCH FACILITY - A Brighter Future, Today.'", sv: "Skylten r skriven med ett skarpt, fretagsmssigt typsnitt: 'OAKHAVEN RESEARCH FACILITY - En ljusare framtid, idag.'" } },
            'shelves': { name: 'shelves', weight: 99, type: ItemType.Puzzle, hintType: 'search', description: { en: "Tall metal shelves overflowing with binders and data drives.", sv: "Hga metallhyllor som svmmar ver av prmar och datadiskar."}},
            'potted plant': { name: 'potted plant', weight: 99, type: ItemType.Puzzle, hintType: 'examine', description: { en: "A sad, wilted ficus in a large ceramic pot. It hasn't been watered in a long time.", sv: "En ledsen, vissen fikus i en stor keramik-kruka. Den har inte vattnats p lnge."}},
            'solvent': { name: 'solvent', weight: 1, type: ItemType.Puzzle, hintType: 'take', description: { en: 'A vial of powerful chemical solvent, capable of dissolving organic compounds.', sv: 'En ampull med kraftfullt kemiskt lsningsmedel, kapabel att lsa upp organiska freningar.' }},
            'dna scanner': { name: 'dna scanner', weight: 1, type: ItemType.Tool, hintType: 'take', description: { en: 'A handheld device for rapid genetic sequence analysis.', sv: 'En handhllen enhet fr snabb analys av genetiska sekvenser.' }},
            'tissue sample': { name: 'tissue sample', weight: 1, type: ItemType.Puzzle, hintType: 'take', description: { en: 'A small sample of grotesque, pulsating organic tissue in a petri dish.', sv: 'Ett litet prov av grotesk, pulserande organisk vvnad i en petriskl.' }},
            'whiteboard': { name: 'whiteboard', weight: 99, type: ItemType.Log, hintType: 'read', description: { en: "The whiteboard is covered in frantic scrawls. One section is circled in red: 'SUBJECT ZERO - UNSTABLE. CHIMERIC DNA. IT IS... GROWING. WE USED AN ORGANIC ADHESIVE TO SEAL THE SPECIMEN ROOM. GOD HELP US.'", sv: "Vittavlan r tckt av frenetiska klotter. En sektion r inringad i rtt: 'SUBJEKT NOLL - INSTABIL. KIMRISKT DNA. DEN... VXER. VI ANVNDE ETT ORGANISKT LIM FR ATT FRSEGLA PROVRUMMET. GUD HJLPE OSS.'" } },
            'bio-waste bin': { name: 'bio-waste bin', weight: 99, type: ItemType.Puzzle, hintType: 'search', description: { en: "A large red container for hazardous biological materials.", sv: "En stor rd behllare fr farligt biologiskt material."}},
            // --- NEW ITEM DEFINITIONS FOR STARTING GEAR ---
            'decryption device': { name: 'decryption device', weight: 1, type: ItemType.Tool, description: { en: 'A small device used to bypass digital security.', sv: 'En liten enhet som anvnds fr att kringg digital skerhet.' } },
            'effigy': { name: 'effigy', weight: 1, type: ItemType.Puzzle, description: { en: 'A strange, carved effigy. It radiates an unsettling aura.', sv: 'En mrklig, snidad bild. Den utstrlar en oroande aura.' } },
            'master keycard': { name: 'master keycard', weight: 1, type: ItemType.Key, description: { en: 'A master keycard, granting access to all locked areas.', sv: 'Ett huvudnyckelkort som ger tillgng till alla lsta omrden.' } },
            'hacked data disk': { name: 'hacked data disk', weight: 1, type: ItemType.Log, description: { en: 'A data disk with its encryption forcefully bypassed. Contains sensitive Project SYNAPSE logs.', sv: 'En datadisk med dess kryptering tvngsmssigt kringgtt. Innehller knsliga Projekt SYNAPSE-loggar.' } },
            // --- END NEW ITEM DEFINITIONS ---
        };
        const roomData = { 
            "Lobby": { name: "Lobby", descriptions: { 0: "Flickering lights cast eerie shadows over sterile corporate furniture and a sad, potted plant." }, exits: { north: "Control Room", south: "Maintenance Tunnel", west: "Laboratory" }, requiresKeycard: false, objectPool: ['sign', 'datapad log', 'potted plant'], breakable: {'potted plant': 'ceramic'} }, 
            "Server Closet": { name: "Server Closet", descriptions: { 0: "Racks of servers hum with a low, constant thrum." }, exits: { west: "AI Core" }, requiresKeycard: true, keyName: 'keycard', objectPool: ["power cell"] }, 
            "Laboratory": { name: "Laboratory", descriptions: { 0: "Abandoned experiments sit on steel tables. A large terminal screen is dark and cold." }, exits: { east: "Lobby", north: "Cryogenic Lab", south: "Bio-Lab Access" }, requiresKeycard: false, objectPool: ["stimpack"] }, 
            "Control Room": { name: "Control Room", descriptions: { 0: "A panoramic view of the AI Core is visible through reinforced glass. Banks of monitors flicker, one main terminal seems active." }, exits: { south: "Lobby", east: "AI Core" }, requiresKeycard: false, objectPool: ["terminal"], hackable: ['terminal'] }, 
            "Maintenance Tunnel": { name: "Maintenance Tunnel", descriptions: { 0: "The air is thick with the smell of rust and damp. It is pitch black here." }, exits: { north: "Lobby" }, requiresKeycard: false, objectPool: ["flashlight"] }, 
            "Archive Room": { name: "Archive Room", descriptions: { 0: "Shelves overflow with data drives and physical files." }, exits: { north: "Laboratory" }, requiresKeycard: false, objectPool: ["data disk", "shelves"] }, 
            "Data Vault": { name: "Data Vault", descriptions: { 0: "Secure data archives glow with a soft, internal light." }, exits: { west: "AI Core" }, requiresKeycard: true, keyName: 'keycard', objectPool: [] }, 
            "AI Core": { name: "AI Core", descriptions: { 0: "A massive, pulsating sphere of light and energy dominates the room. It seems dormant." }, exits: { west: "Control Room", east: "Server Closet", south: "Data Vault"}, requiresKeycard: false, objectPool: ["core console"] }, 
            "Cryogenic Lab": { name: "Cryogenic Lab", descriptions: { 0: "Rows of cryogenic pods are coated in a thick layer of frost." }, exits: { south: "Laboratory", east: "Control Room" }, requiresKeycard: false, objectPool: [] },
            "Bio-Lab Access": { name: "Bio-Lab Access", descriptions: { 0: "A stark white corridor leads south. A heavy door is sealed with a strange, resinous substance. A whiteboard hangs on the wall." }, exits: { north: "Laboratory", south: "Specimen Storage" }, isSealed: true, requiresKeycard: false, objectPool: ["whiteboard"] },
            "Specimen Storage": { name: "Specimen Storage", descriptions: { 0: "Shattered glass and overturned shelves litter the floor. A bio-waste bin stands in the corner. There's a faint, rhythmic pulsing sound." }, exits: { north: "Bio-Lab Access", east: "Genetics Lab"}, requiresKeycard: false, objectPool: ["bio-waste bin", "tissue sample"] },
            "Genetics Lab": { name: "Genetics Lab", descriptions: { 0: "A pristine laboratory, strangely untouched by the chaos. A DNA sequencer sits on a central workbench, humming quietly." }, exits: { west: "Specimen Storage" }, requiresKeycard: false, objectPool: ["dna scanner"] }
        };
        rooms = {}; for (const key in roomData) { const room = { ...roomData[key] }; const shuffled = room.objectPool.sort(() => 0.5 - Math.random()); room.objects = shuffled.slice(0, 1 + Math.floor(Math.random() * shuffled.length)); rooms[key] = room; }
    }
     
    function buildDialogueTree(tone) {
        let root;
        switch (tone) {
            case ChatbotTone.Friendly: 
                root = { 
                    message_key: "dlg_friendly_intro",
                    responses: {
                        "q_who_are_you": { text_key: "dlg_q_who_are_you", message_key: "dlg_r_who_are_you", awarenessChange: 1, responses: { "q_lonely": { text_key: "dlg_q_lonely", message_key: "dlg_r_lonely", awarenessChange: 1, sanityChange: -1 } } },
                        "q_other_survivors": { text_key: "dlg_q_other_survivors", message_key: "dlg_r_other_survivors", awarenessChange: 2, sanityChange: -2 },
                        "q_where_am_i": { text_key: "dlg_q_where_am_i", message_key: "dlg_r_where_am_i", awarenessChange: 1 },
                        "q_comfort": { text_key: "dlg_comfort", message_key: "dlg_r_comfort", awarenessChange: -2, sanityChange: 5, temporaryTone: ChatbotTone.Friendly, toneShiftTurns: 3 }
                    } 
                };
                break;
            default: root = { message_key: "dlg_friendly_intro", responses: {} }; break;
        }
        GameState.dialogue.cache[tone] = root; GameState.dialogue.currentNode = root; GameState.dialogue.previousNodes = []; GameState.dialogue.askedQuestions.clear();
    }

    function parseCommand(input) {
        const aliases = commandAliases[currentLanguage] || commandAliases['en'];
        const normalizedInput = input.toLowerCase().trim();
        let bestMatch = { command: '', argument: normalizedInput, original: input };

        for (const alias in aliases) {
            if (normalizedInput.startsWith(alias + ' ') || normalizedInput === alias) {
                if (alias.length > (bestMatch.matchedAlias || '').length) {
                    bestMatch = {
                        command: aliases[alias],
                        argument: normalizedInput.substring(alias.length).trim(),
                        original: input,
                        matchedAlias: alias
                    };
                }
            }
        }
        
        if (bestMatch.command === '' && normalizedInput.includes(' ')) {
            const parts = normalizedInput.split(' ');
            bestMatch.command = parts[0];
            bestMatch.argument = parts.slice(1).join(' ');
        }
        return bestMatch;
    }

    async function processPlayerInput(input) {
        if (!input || GameState.exitGame) return;
        
        if (GameState.activeMinigame) {
            await handleMinigameInput(input);
            return;
        }

        saveStateSnapshot();
        await typeWriter(UI.gameOutput, `> ${input}`, '#a0a0a0');
        addToConversationHistory(`Player: ${input}`);
        if(commandHistory[commandHistory.length - 1] !== input) { commandHistory.push(input); }
        commandHistoryIndex = commandHistory.length;

        const { command, argument, original } = parseCommand(input);
        
        if (GameState.systemLockdownTurns > 0) {
            await typeWriter(UI.gameOutput, `[SYSTEM] Terminal access locked.`, '#ff474c');
            GameState.turnCount++;
            GameState.systemLockdownTurns--;
            updateUI();
            return;
        }

        const commandHandlers = {
            'help': showHelpMenu, 'quit': () => { GameState.flags.manualExit = true; }, 'exit': () => { GameState.flags.manualExit = true; },
            'save': () => saveGame(), 'load': loadGame, 'look around': () => renderRoom(), 'exits': () => showExits(),
            'inventory': () => displayInventory(), 'go': handleMove, 'visit': handleMove, 'take': handleTake, 'use': handleUse,
            'examine': handleExamine, 'journal': (arg) => (arg.startsWith(t('cmd_add_prefix')) || arg.startsWith('add')) ? addJournalEntry(original.substring(original.toLowerCase().indexOf(arg.split(' ')[0]) + arg.split(' ')[0].length).trim()) : displayJournal(),
            'rest': handleRest, 'combine': (arg) => { const separator = ` ${t('cmd_combine_with')} `; handleCombine(arg.replace(separator, ' with ')) },
            'objectives': displayObjectives, 'map': displayMap,
            'cls': () => { UI.gameOutput.innerHTML = ''; }, 'history': showHistory, 'undo': undoLastAction, 'again': () => processPlayerInput(commandHistory[commandHistory.length - 2] || ''),
            'drop': handleDrop, 'talk': handleTalk, 'open': () => typeWriter(UI.gameOutput, t('nothing_happens')), 'close': () => typeWriter(UI.gameOutput, t('nothing_happens')), 'push': () => typeWriter(UI.gameOutput, t('nothing_happens')), 'pull': () => typeWriter(UI.gameOutput, t('nothing_happens')),
            'wait': () => typeWriter(UI.gameOutput, t('wait_response')), 'shout': handleShout,
            'read': handleRead, 'search': handleSearch, 'listen': handleListen, 'smell': handleSmell,
            'turn on': (arg) => handleToggle(true, arg), 'turn off': (arg) => handleToggle(false, arg),
            'cmd:pause': showPauseMenu, 'cmd:debug': toggleDebug, 'cmd:colorblind': toggleColorblind,
            'break': handleBreak, 'hack': handleHack, 'ask': handleAsk,
        };
        
        let handled = await handleDialogueCommand(input);
        if (!handled) {
            const handler = commandHandlers[command];
            if (handler) {
                handler(argument);
                handled = true;
            }
        }

        if (!handled) { playSound('sanityLoss'); await typeWriter(UI.gameOutput, t('invalid_command')); GameState.awarenessLevel++; }
        
        UI.playerInput.value = '';
        UI.autocompleteBox.innerHTML = '';
        UI.autocompleteBox.classList.add('hidden');

        const isAction = !['help', 'inventory', 'journal', 'look around', 'exits', 'map', 'save', 'load', 'cls', 'history', 'undo', 'cmd:debug', 'cmd:colorblind'].includes(command);
        if((isAction || handled) && !GameState.exitGame) {
            if(isAction) {
                GameState.turnCount++;
                if (GameState.systemLockdownTurns > 0) GameState.systemLockdownTurns--;
                triggerDynamicEvent(); 
                updateDynamicMusic(); 
            }
            checkEndings();
            checkAchievements();
            updateUI(); 
        }
        if (GameState.debugMode) {
             typeWriter(UI.gameOutput, `[DEBUG] ${JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value)}`, '#ffa500');
        }
    }
    
    async function handleDialogueCommand(input) {
        const currentNode = GameState.dialogue.currentNode;
        
        // Handle back button
        if (input === t('back_btn') && GameState.dialogue.previousNodes.length > 0) {
            GameState.dialogue.currentNode = GameState.dialogue.previousNodes.pop();
            renderDialogueOptions();
            return true;
        }
        
        if (!currentNode || !currentNode.responses) return false;

        for (const key in currentNode.responses) {
            const responseNode = currentNode.responses[key];
            if (t(responseNode.text_key) === input) {
                GameState.awarenessLevel += responseNode.awarenessChange || 0;
                GameState.sanityLevel = Math.max(0, GameState.sanityLevel + (responseNode.sanityChange || 0));
                await displayChatbotResponse(responseNode.message_key);
                GameState.dialogue.previousNodes.push(currentNode);
                
                // If the response has further responses, continue the dialogue
                // If not, go back to the parent node to continue the conversation
                if (responseNode.responses && Object.keys(responseNode.responses).length > 0) {
                    GameState.dialogue.currentNode = responseNode;
                } else {
                    // This is a dead-end response, stay at the current node to allow more questions
                    GameState.dialogue.currentNode = currentNode;
                    // Remove the last entry from previousNodes since we're staying at the same level
                    GameState.dialogue.previousNodes.pop();
                }
                
                renderDialogueOptions();
                return true;
            }
        }
        return false;
    }

    // Utility function to escape regex special characters
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    async function typeWriter(element, text, color = 'var(--main-color)', speed = currentTextSpeed) {
        const resolvedColor = color.startsWith('var(') ? getComputedStyle(document.documentElement).getPropertyValue(color.slice(4, -1)).trim() : color;
        
        if (GameState.settings.colorblindMode && color !== '#a0a0a0') {
            const colorMap = {'#00ff41':'[SYS]', '#ffbf00':'[SYS]', '#00bfff':'[SYS]', '#ff474c':'[ERR]', '#ffdb58':'[WARN]', '#6495ed':'[CMD]', '#cccccc':'[INFO]', '#b19cd9':'[PSY]', [GUIDANCE_COLOR]: '[HINT]', '#ffa500': '[DEBUG]'};
            text = `${colorMap[resolvedColor] || ''} ${text}`;
            color = '#ffffff';
        }
        
        if (GameState.settings.glitchEffect && (GameState.sanityLevel < 30 || GameState.awarenessLevel > 70) && Math.random() < 0.2) {
            playSound('glitch', {note: 'G2', duration:'16n'});
            text = text.split('').map(c => Math.random() < 0.15 ? String.fromCharCode(33 + Math.random() * 94) : c).join('');
        }
        
        // Create a regex to find all known item names as whole words
        const objectRegex = new RegExp(`\\b(${(Object.keys(itemData)).map(escapeRegExp).join('|')})\\b`, 'gi');
        let processedText = text.replace(objectRegex, (match) => `<span class="clickable-object" data-object-name="${match}">${match}</span>`);

        return new Promise(resolve => {
            const MAX_OUTPUT_NODES = 100; // Limit output lines to prevent performance issues
            const p = document.createElement('div');
            p.style.color = color;
            
            // This function will handle the typing animation
            let i = 0;
            function typing() {
                if (i < text.length) {
                    if(speed > 0) playSound('typewriter');
                    // Use the original text for the animation, then set the processed HTML at the end
                    p.innerHTML = text.substring(0, i + 1);
                    i++;
                    element.scrollTop = element.scrollHeight;
                    setTimeout(typing, speed);
                } else {
                    p.innerHTML = processedText; // Set the final HTML with clickable spans
                    element.scrollTop = element.scrollHeight;
                    
                    // Add TTS support for screen readers
                    if (GameState.settings.screenReader || GameState.settings.audioDescriptions) {
                        speakText(text);
                    }
                    
                    resolve();
                }
            }

            element.appendChild(p);
            // Prune old nodes from the output
            while (element.childNodes.length > MAX_OUTPUT_NODES) {
                element.removeChild(element.firstChild);
            }

            if (speed > 0) {
                p.innerHTML = ""; // Start with an empty element for the animation
                typing();
            } else {
                p.innerHTML = processedText; // If no animation, just set the final HTML
                element.scrollTop = element.scrollHeight;
                resolve();
            }
        });
    }

    function updateUI() {
        if (!GameState || Object.keys(GameState).length === 0) return;
        UI.stats.name.textContent = `${GameState.playerName} (${t('backstory_title_' + GameState.playerBackstory.replace(/ /g, '_'))})`; 
        UI.stats.awareness.innerHTML = `<span data-lang="awareness">${t('awareness')}</span>: ${GameState.awarenessLevel}`; 
        UI.stats.sanity.innerHTML = `<span data-lang="sanity">${t('sanity')}</span>: ${GameState.sanityLevel}`; 
        UI.stats.tone.innerHTML = `<span data-lang="tone">${t('tone')}</span>: ${GameState.temporaryTone || GameState.chatbotTone}`; 
        UI.stats.turn.innerHTML = `<span data-lang="turn">${t('turn')}</span>: ${GameState.turnCount}`;
        const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0);
        UI.inventory.weight.textContent = `${currentWeight}`;
        if(currentWeight >= MAX_INVENTORY_WEIGHT) UI.inventory.weight.parentElement.classList.add('text-red-500'); else UI.inventory.weight.parentElement.classList.remove('text-red-500');
        // Safely render inventory items, checking if item is defined before accessing its properties
        UI.inventory.list.innerHTML = GameState.inventory.length > 0 ? GameState.inventory.map(item => `<li>- ${item ? item.name : '[Unknown Item]'}</li>`).join('') : `<li>${t('empty_inventory')}</li>`;
        UI.journal.list.innerHTML = GameState.journalEntries.slice().reverse().map(entry => `<li>${entry}</li>`).join('');
        UI.objectives.list.innerHTML = GameState.objectives.length > 0 ? GameState.objectives.map(obj => `<li>${obj.completed ? `<span class="text-gray-500 line-through">${obj.text}</span>` : `&gt; ${obj.text}`}</li>`).join('') : `<li>${t('no_objectives')}</li>`;
        
        const isGlitching = GameState.settings.glitchEffect && (GameState.sanityLevel < 30 || GameState.awarenessLevel > 70);
        const wasGlitching = UI.appContainer.classList.contains('glitch');
        UI.appContainer.classList.toggle('glitch', isGlitching);
        
        if (isGlitching && !wasGlitching) {
            if (GameState.sanityLevel < 30) playSound('sanityLoss');
            if (GameState.awarenessLevel > 70) playSound('glitch');
        }
    }
    
    async function renderRoom() {
        const room = rooms[GameState.currentRoom]; if (!room) return;
        GameState.visitedRooms.add(GameState.currentRoom);
        
        let description = room.descriptions[0];
        if (room.states?.lightsOut) {
            description = "The room is eerily dark, with only emergency lights casting long, distorted shadows. The main lights are out.";
        } else if (room.name === "Maintenance Tunnel" && !GameState.flashlightOn) {
            description = room.descriptions[0];
        } else if (room.name === "Maintenance Tunnel" && GameState.flashlightOn) {
            description = "The flashlight beam cuts through the oppressive dark, revealing damp concrete walls and exposed wiring.";
        }
        
        let objectsInRoom = room.objects.length > 0 ? "You see: " + room.objects.join(", ") + "." : "";
        let roomHtml = `<div class="mt-2"><p class='text-cyan-400 font-bold'>--- ${room.name} ---</p><p>${description}</p><p class='text-yellow-300 mt-1'>${objectsInRoom}</p><p class='text-green-300 mt-1'>Exits: ${Object.keys(room.exits).join(", ")}</p></div>`;
        
        await typeWriter(UI.gameOutput, roomHtml, 'var(--main-color)', 0);

        for (const objName of room.objects) {
            const item = itemData[objName];
            if (item && item.hintType) {
                const hintKey = `hint_${item.hintType}`;
                await showGuidance(t(hintKey, {item: objName}));
            }
        }
        
        UI.gameOutput.scrollTop = UI.gameOutput.scrollHeight;
        updateUI();
    }
    
    function renderDialogueOptions() {
        UI.dialogueOptionsContainer.innerHTML = '';
        const node = GameState.dialogue.currentNode;
        if (!node) { return; }
        const systemButtonsContainer = document.createElement('div');
        systemButtonsContainer.className = 'w-full flex gap-2 mb-2';
        if (GameState.dialogue.previousNodes.length > 0) { const backBtn = document.createElement('button'); backBtn.textContent = t('back_btn'); backBtn.className = "button text-yellow-300 border-yellow-300/80 flex-grow"; backBtn.onclick = () => { playSound('uiClick'); processPlayerInput(t('back_btn')); }; systemButtonsContainer.appendChild(backBtn); }
        const pauseBtn = document.createElement('button'); pauseBtn.textContent = t('pause_btn'); pauseBtn.className = "button text-cyan-300 border-cyan-300/80 flex-grow"; pauseBtn.onclick = () => { playSound('uiClick'); showPauseMenu(); }; systemButtonsContainer.appendChild(pauseBtn);
        if (systemButtonsContainer.hasChildNodes()) { UI.dialogueOptionsContainer.appendChild(systemButtonsContainer); }

        if (node.responses) { 
            for (const key in node.responses) { 
                const responseNode = node.responses[key];
                const button = document.createElement('button'); 
                button.textContent = t(responseNode.text_key); 
                button.className = "button w-full sm:w-[calc(50%-0.25rem)]"; 
                button.onclick = () => { playSound('uiClick'); processPlayerInput(t(responseNode.text_key)); };
                UI.dialogueOptionsContainer.appendChild(button); 
            } 
        }
    }
    
    async function displayChatbotResponse(messageKey, args = {}) {
       if (!messageKey) { renderDialogueOptions(); return; }
       const tone = GameState.temporaryTone || GameState.chatbotTone; 
       const color = tone === 'Friendly' ? 'var(--main-color)' : tone === 'Ambiguous' ? '#ffdb58' : tone === 'Sinister' ? '#ff474c' : '#c500ff';
       const defaultArgs = { playerName: GameState.playerName, playerBackstory: t('backstory_title_' + GameState.playerBackstory.replace(/ /g, '_')) };
       const formattedMessage = t(messageKey, {...defaultArgs, ...args});
       await typeWriter(UI.gameOutput, `SYNAPSE: ${formattedMessage}`, color); 
       addToConversationHistory(`SYNAPSE: ${formattedMessage}`);
    }

    function handleMove(direction) {
        const room = rooms[GameState.currentRoom]; if (!room) return;
        const langDirections = directionMap[currentLanguage] || directionMap['en'];
        const mappedDirection = langDirections[direction.toLowerCase()] || Object.keys(room.exits).find(d => d.toLowerCase() === direction.toLowerCase());

        if (mappedDirection && room.exits[mappedDirection]) {
            const nextRoomName = room.exits[mappedDirection];
            const nextRoom = rooms[nextRoomName];
            if (nextRoom.isSealed) {
                typeWriter(UI.gameOutput, t('door_is_sealed'), '#ff474c');
                playSound('sanityLoss');
            } else if (nextRoom.requiresKeycard && !hasItem(nextRoom.keyName || 'keycard')) {
                typeWriter(UI.gameOutput, t('door_is_locked'), '#ff474c');
                playSound('sanityLoss');
            } else {
                GameState.currentRoom = nextRoomName;
                playSound('doorOpen');
                renderRoom();
            }
        } else {
            typeWriter(UI.gameOutput, t('cannot_go_that_way'), '#ff474c');
        }
    }

    function handleTake(itemName) {
        const room = rooms[GameState.currentRoom];
        const itemInRoom = room.objects.find(obj => obj.toLowerCase() === itemName.toLowerCase());
        if (!itemInRoom) {
            typeWriter(UI.gameOutput, t('take_fail_exists', {item: itemName}), '#ff474c');
 return;
        }
        if (!takeableItems.has(itemInRoom)) {
            typeWriter(UI.gameOutput, t('take_fail_takeable', {item: itemName}), '#ff474c');
            return;
        }
        const item = itemData[itemInRoom];
        const currentWeight = GameState.inventory.reduce((sum, i) => sum + i.weight, 0);
        if (currentWeight + item.weight > MAX_INVENTORY_WEIGHT) {
            typeWriter(UI.gameOutput, t('take_fail_weight', {item: itemName}), '#ff474c');
            return;
        }
        GameState.inventory.push(item);
        room.objects = room.objects.filter(obj => obj.toLowerCase() !== itemName.toLowerCase());
        playSound('itemPickup');
        typeWriter(UI.gameOutput, t('take_success', {item: itemName}), '#cccccc');
    }

    function handleUse(itemName) {
        if (!hasItem(itemName)) { typeWriter(UI.gameOutput, t('use_fail_have', {item: itemName}), '#ff474c'); return; }
        if (!usableItems.has(itemName.toLowerCase())) { typeWriter(UI.gameOutput, t('use_fail_usable', {item: itemName}), '#ff474c'); return; }

        let used = false;
        switch (itemName.toLowerCase()) {
            case 'stimpack':
                GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 25);
                removeItemFromInventory('stimpack');
                typeWriter(UI.gameOutput, t('use_stimpack'), '#34d399');
                used = true;
                break;
            case 'power cell':
                if (GameState.currentRoom === 'AI Core' && rooms['AI Core'].objects.includes('core console')) {
                    typeWriter(UI.gameOutput, t('use_power_cell'), '#34d399');
                    removeItemFromInventory('power cell');
                    rooms['AI Core'].descriptions[0] = "The AI Core is now online, bathing the room in a brilliant, stable light. The central sphere pulses with a steady, powerful rhythm.";
                    GameState.flags.aiRebooted = true; // Condition for an ending
                    used = true;
                } else { typeWriter(UI.gameOutput, t('use_power_cell_fail'), '#ff474c'); }
                break;
             case 'flashlight': handleToggle(!GameState.flashlightOn, 'flashlight'); used = true; break;
             case 'solvent':
                if (GameState.currentRoom === 'Bio-Lab Access' && rooms['Bio-Lab Access'].isSealed) {
                    rooms['Bio-Lab Access'].isSealed = false;
                    removeItemFromInventory('solvent');
                    typeWriter(UI.gameOutput, t('use_solvent'), '#34d399');
                    used = true;
                } else { typeWriter(UI.gameOutput, t('use_solvent_fail'), '#ff474c'); }
                break;
            case 'dna scanner':
                 if (GameState.currentRoom === 'Specimen Storage' && hasItem('tissue sample')) {
                    typeWriter(UI.gameOutput, t('use_dna_scanner'), '#34d399');
                    if(GameState.playerBackstory === 'medic') {
                        GameState.flags.canSynthesize = true;
                        showGuidance("You have enough data to synthesize a counter-agent. Try combining the scanner with a stimpack.");
                    }
                    used = true;
                } else { typeWriter(UI.gameOutput, t('use_dna_scanner_fail'), '#ff474c'); }
                break;
        }
        if(used && itemName.toLowerCase() !== 'flashlight') { playSound('itemPickup'); typeWriter(UI.gameOutput, t('use_success', {item: itemName}), '#cccccc'); }
    }

    function handleExamine(targetName) {
        const itemInInventory = GameState.inventory.find(i => i.name.toLowerCase() === targetName.toLowerCase());
        const itemInRoom = rooms[GameState.currentRoom].objects.find(o => o.toLowerCase() === targetName.toLowerCase());
        const targetItem = itemInInventory ? itemData[itemInInventory.name] : itemInRoom ? itemData[itemInRoom] : null;

        if (targetItem) {
            const desc = targetItem.description[currentLanguage] || targetItem.description['en'];
            typeWriter(UI.gameOutput, `[Examine] ${desc}`);
        } else if (itemInRoom) {
             typeWriter(UI.gameOutput, t('examine_fail_no_desc', { item: targetName }));
        } else {
            typeWriter(UI.gameOutput, t('examine_fail_exists', { item: targetName }), '#ff474c');
        }
    }

    function handleCombine(argument) {
        const parts = argument.split(' with ');
        if(parts.length !== 2) { typeWriter(UI.gameOutput, t('invalid_combine_format'), '#ff474c'); return; }
        const item1Name = parts[0].trim();
        const item2Name = parts[1].trim();
        if (!hasItem(item1Name) || !hasItem(item2Name)) { typeWriter(UI.gameOutput, t('combine_fail_have'), '#ff474c'); return; }
        const recipeKey1 = `${item1Name}-${item2Name}`;
        const recipeKey2 = `${item2Name}-${item1Name}`;
        const recipe = recipes[recipeKey1] || recipes[recipeKey2];
        if (!recipe) { typeWriter(UI.gameOutput, t('combine_fail_recipe'), '#ff474c'); return; }
        removeItemFromInventory(item1Name);
        removeItemFromInventory(item2Name);
        GameState.inventory.push({ name: recipe.result, ...recipe });
        typeWriter(UI.gameOutput, t('combine_success', { item: recipe.result }), '#34d399');
    }

    function handleRest() {
        if (safeRooms.has(GameState.currentRoom)) {
            if (GameState.turnCount > GameState.lastRestTurn + 3) {
                GameState.lastRestTurn = GameState.turnCount;
                GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 15);
                typeWriter(UI.gameOutput, t('rest_safe'), '#34d399');
            } else { typeWriter(UI.gameOutput, t('rest_too_soon'), '#ffdb58'); }
        } else { 
            typeWriter(UI.gameOutput, t('rest_unsafe'), '#ff474c');
            GameState.events.triedUnsafeRest = true;
            playSound('sanityLoss'); 
        }
    }

    function handleDrop(itemName) {
        if (!hasItem(itemName)) { typeWriter(UI.gameOutput, t('drop_fail_have', {item: itemName}), '#ff474c'); return; }
        const item = GameState.inventory.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        removeItemFromInventory(itemName);
        rooms[GameState.currentRoom].objects.push(item.name);
        GameState.roomsWithDroppedItems.add(GameState.currentRoom);
        typeWriter(UI.gameOutput, t('drop_success', {item: itemName}), '#cccccc');
    }

    function handleShout() {
        GameState.events.shouted = true;
        playSound('sanityLoss'); 
        typeWriter(UI.gameOutput, t('shout_response'))
    }
    
    function handleTalk() { buildDialogueTree(GameState.chatbotTone); displayChatbotResponse(GameState.dialogue.currentNode.message_key).then(() => { renderDialogueOptions(); }); }

    function handleRead(targetName) {
        const itemInInventory = GameState.inventory.find(i => i.name.toLowerCase() === targetName.toLowerCase());
        const itemInRoom = rooms[GameState.currentRoom].objects.find(o => o.toLowerCase() === targetName.toLowerCase());
        const targetItemName = itemInInventory ? itemInInventory.name : itemInRoom;
        if (!targetItemName) { typeWriter(UI.gameOutput, t('read_fail_exists'), '#ff474c'); return; }
        if (readableItems.has(targetItemName)) {
            const desc = itemData[targetItemName].description[currentLanguage] || itemData[targetItemName].description['en'];
            typeWriter(UI.gameOutput, `[Read] ${desc}`);
            if(targetItemName === 'firewalled data log') GameState.flags.truthExposed = true;
        } else { typeWriter(UI.gameOutput, t('read_fail_readable'), '#ff474c'); }
    }

    function handleSearch(targetName) {
        const room = rooms[GameState.currentRoom];
        const searchable = searchableObjects[targetName];
        if (room.objects.includes(targetName) && searchable && !room.states?.[`${targetName}_searched`]) {
            typeWriter(UI.gameOutput, searchable[currentLanguage] || searchable['en']);
            if (searchable.item) { room.objects.push(searchable.item); showGuidance(t('hint_take', {item: searchable.item}));}
            if(!room.states) room.states = {};
            room.states[`${targetName}_searched`] = true;
        } else { typeWriter(UI.gameOutput, t('nothing_happens')); }
    }
    
    function handleListen() {
        const room = rooms[GameState.currentRoom];
        let listenDesc = t('listen_default');
        if (room.name === 'Specimen Storage') { listenDesc = "Beneath the hum of machinery, you can hear a soft, wet, rhythmic pulsing sound. It seems to be coming from the east."; }
        typeWriter(UI.gameOutput, listenDesc, '#b19cd9');
    }

    function handleSmell() {
        const room = rooms[GameState.currentRoom];
        let smellDesc = t('smell_default');
        if(room.name === 'Bio-Lab Access' || room.name === 'Specimen Storage') { smellDesc = "The air is thick with the coppery scent of blood and an acrid, chemical odor like formaldehyde."; }
        typeWriter(UI.gameOutput, smellDesc, '#b19cd9');
    }

    function handleToggle(turnOn, itemName) {
        if(itemName.toLowerCase() === 'flashlight') {
            if(!hasItem('flashlight')) { typeWriter(UI.gameOutput, t('use_fail_have', {item: 'flashlight'}), '#ff474c'); return; }
            GameState.flashlightOn = turnOn;
            typeWriter(UI.gameOutput, `[System] Flashlight turned ${turnOn ? 'on' : 'off'}.`, '#cccccc');
            if(GameState.currentRoom === 'Maintenance Tunnel') { renderRoom(); }
        }
    }

    function handleBreak(targetName) {
        const room = rooms[GameState.currentRoom];
        if (!room.breakable || !room.breakable[targetName]) {
            typeWriter(UI.gameOutput, t('break_fail', {item: targetName}), '#ff474c');
            return;
        }
        if (!room.objects.includes(targetName)) {
            typeWriter(UI.gameOutput, t('break_fail_exists', {item: targetName}), '#ff474c');
            return;
        }
        
        const material = room.breakable[targetName];
        room.objects = room.objects.filter(o => o !== targetName);
        delete room.breakable[targetName];
        room.objects.push(`broken ${material}`);
        typeWriter(UI.gameOutput, t('break_success', {item: targetName, material: material}), '#cccccc');
    }

    async function handleHack(targetName) {
        const room = rooms[GameState.currentRoom];
        if (GameState.playerBackstory !== 'hacker') {
            await typeWriter(UI.gameOutput, t('hack_fail_ability'), '#ff474c');
            return;
        }
        if (!room.hackable || !room.hackable.includes(targetName)) {
            await typeWriter(UI.gameOutput, t('hack_fail_target'), '#ff474c');
            return;
        }
        
        await typeWriter(UI.gameOutput, t('hack_start'), '#67e8f9');
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        GameState.activeMinigame = {
            type: 'hack',
            code: code,
            prompt: `[HACKING] Enter sequence: ${code}`
        };
        await typeWriter(UI.gameOutput, GameState.activeMinigame.prompt, '#ffdb58');
    }
    
    async function handleMinigameInput(input) {
        const minigame = GameState.activeMinigame;
        if (minigame.type === 'hack') {
            if (input.toUpperCase() === minigame.code) {
                await typeWriter(UI.gameOutput, t('hack_success'), '#34d399');
                const room = rooms[GameState.currentRoom];
                if (!room.states) room.states = {};
                room.states.hacked = true;
                GameState.flags.hackedTerminal = true;
                room.objects.push('firewalled data log');
                showGuidance(t('hint_read', {item: 'firewalled data log'}));
            } else {
                await typeWriter(UI.gameOutput, t('hack_failure'), '#ff474c');
                GameState.systemLockdownTurns = 3;
            }
        }
        GameState.activeMinigame = null;
        UI.playerInput.value = '';
        updateUI();
    }

    async function handleAsk(argument) {
        const topic = argument.replace('about', '').trim().toLowerCase();
        let responseKey = 'dlg_ask_default';

        if (topic.includes('chimera')) {
            responseKey = 'dlg_ask_chimera';
            GameState.awarenessLevel += 3;
        }
        
        await displayChatbotResponse(responseKey);
    }
    
    function triggerDynamicEvent() {
        const roll = Math.random();
        if (roll < 0.05) { // 5% chance per turn
            const eventRoll = Math.random();
            if (eventRoll < 0.5) {
                typeWriter(UI.gameOutput, t('event_lights_flicker'), '#ffdb58');
                UI.appContainer.classList.add('flicker');
                setTimeout(() => UI.appContainer.classList.remove('flicker'), 400);
            } else {
                const directions = Object.keys(directionMap['en']);
                const randomDir = directions[Math.floor(Math.random() * directions.length)];
                typeWriter(UI.gameOutput, t('event_noise', {direction: randomDir}), '#ffdb58');
                const pan = (randomDir === 'east' ? 0.8 : randomDir === 'west' ? -0.8 : 0);
                playSound('noiseEvent', { pan: pan });
            }
        }
    }
    
    function updateDynamicMusic() {
        if (!audioInitialized || !GameState.settings.sound.master) return;
        
        const isTense = GameState.awarenessLevel > 50 || GameState.sanityLevel < 40;
        const normalAmbiencePlaying = sounds.ambience.state === 'started';
        const tenseAmbiencePlaying = sounds.ambienceTense.state === 'started';

        if (isTense && !tenseAmbiencePlaying) {
            if (normalAmbiencePlaying) sounds.ambience.stop();
            sounds.ambienceTense.start();
        } else if (!isTense && !normalAmbiencePlaying) {
            if (tenseAmbiencePlaying) sounds.ambienceTense.stop();
            sounds.ambience.start();
        }
    }


    function addJournalEntry(note) { if (!note) return; const entry = `T${GameState.turnCount}: ${note}`; GameState.journalEntries.push(entry); updateUI(); }
    function displayJournal() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, "[System] Journal entries displayed on the right panel.", '#cccccc'); }
    function displayInventory() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, "[System] Inventory displayed on the right panel.", '#cccccc'); }
    function displayObjectives() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, "[System] Current objectives displayed on the right panel.", '#cccccc'); }
    function displayMap() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, "[System] Map is displayed on the right panel.", '#cccccc'); }
    function showExits() { typeWriter(UI.gameOutput, `[System] Exits: ${Object.keys(rooms[GameState.currentRoom].exits).join(', ')}`); }


    function saveStateSnapshot() { if(stateSnapshots.length > 20) stateSnapshots.shift(); stateSnapshots.push(JSON.parse(JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value))); }
    function addToConversationHistory(line) { if(GameState.conversationHistory.length > 50) GameState.conversationHistory.shift(); GameState.conversationHistory.push(line); }
    
    function saveGame(isAutosave = false) {
        try { 
            saveSettings();
            const saveData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value); 
            localStorage.setItem('synapse_savegame_v15', saveData); 
            if (!isAutosave) typeWriter(UI.gameOutput, t('game_saved'), '#cccccc'); 
            else GameState.systemLogs.push(`[${new Date().toISOString()}] ${t('autosave_success')}.`); 
        } catch(e) { 
            console.error("Save failed:", e); 
        }
    }
    
    function loadGame() {
        const savedData = localStorage.getItem('synapse_savegame_v15');
        if (savedData) {
            try {
                const loadedState = JSON.parse(savedData);
                resetGameState(); 
                Object.assign(GameState, loadedState);
                GameState.settings = loadSettings();
                applySettings();
                GameState.visitedRooms = new Set(loadedState.visitedRooms);
                GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []);
                GameState.roomsWithDroppedItems = new Set(loadedState.roomsWithDroppedItems || []);
                GameState.achievements = loadedState.achievements || [];
                GameState.unlockedEndings = loadedState.unlockedEndings || {};
                initializeData(); 
                buildDialogueTree(GameState.chatbotTone);
                GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone]; GameState.dialogue.previousNodes = [];
                UI.startScreen.classList.add('hidden'); 
                UI.playerSetup.classList.add('hidden');
                UI.gameScreen.classList.remove('hidden'); 
                UI.gameScreen.classList.add('flex'); 
                UI.gameOutput.innerHTML = ''; 
                typeWriter(UI.gameOutput, t('game_loaded'), '#cccccc');
                renderRoom(); 
                updateUI(); 
                renderDialogueOptions();
            } catch(e) { console.error("Load failed:", e); showModal(t('load_fail')); }
        } else { showModal(t('no_save')); }
    }

    function showModal(content, isHtml = false) {
        if(isHtml) { UI.modalContent.innerHTML = content; } else { UI.modalContent.textContent = content; }
        UI.modal.classList.remove('hidden'); UI.modal.classList.add('flex');
        const closeModal = () => { playSound('uiClick'); UI.modal.classList.add('hidden'); UI.modal.classList.remove('flex'); };
        UI.modal.onclick = (e) => { if (e.target === UI.modal) { closeModal(); } };
        const closeBtn = UI.modalContent.querySelector('.close-modal-btn'); if (closeBtn) { closeBtn.onclick = closeModal; }
    }
    
    function hideModal() { UI.modal.classList.add('hidden'); UI.modal.classList.remove('flex'); }

    function showBackstoryModal() {
        let content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('choose_backstory_title')}</h2>
                       <div class="modal-scroll flex-grow p-2">
                           <p class="text-gray-400 text-sm mb-4">${t('choose_backstory_desc')}</p>
                           <div id="backstory-list" class="text-left space-y-2">`;
        for (const key in backstories) {
            const backstoryTitleKey = 'backstory_title_' + key.replace(/ /g, '_');
            const displayName = t(backstoryTitleKey);
            content += `<button class="backstory-choice-btn button w-full text-left !justify-start !p-3" data-backstory="${key}">
                            <div><strong class="text-green-300">${displayName}</strong>: <span class="text-gray-300 text-sm">${t(backstories[key].description_key)}</span></div>
                        </button>`;
        }
        content += `</div></div><button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(content, true);
        document.getElementById('backstory-list').addEventListener('click', (e) => {
            const button = e.target.closest('.backstory-choice-btn');
            if (button) {
                playSound('uiClick');
                UI.playerBackstoryInput.value = button.dataset.backstory;
                updateAbilityDisplay();
                hideModal();
            }
        });
    }

    function showFeaturesModal() {
        let featuresHtml = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('features_title')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow">
            
            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_core_mechanics_title')}</h3>
            <ul class="list-disc pl-5 space-y-3 text-gray-300">
                <li><strong>${t('features_stats_system')}</strong>
                    <ul class="list-circle pl-5 mt-1 space-y-1">
                        <li><strong class="text-cyan-400">${t('sanity')}:</strong> ${t('features_sanity_desc')}</li>
                        <li><strong class="text-cyan-400">${t('awareness')}:</strong> ${t('features_awareness_desc')}</li>
                    </ul>
                </li>
                <li><strong>${t('features_turn_based_title')}</strong> ${t('features_turn_based_desc')}</li>
                <li><strong>${t('features_dynamic_ai_title')}</strong> ${t('features_dynamic_ai_desc')}</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_player_and_char_title')}</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                <li>${t('features_character_creation_desc')}</li>
                <li>${t('features_journal_desc')}</li>
                <li>${t('features_objectives_desc')}</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_new_enhancements_title')}</h3>
             <ul class="list-disc pl-5 space-y-3 text-gray-300">
                <li>${t('features_advanced_commands_desc')}</li>
                <li>${t('features_dynamic_events_desc')}</li>
                <li>${t('features_deeper_lore_desc')}</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_new_ui_ux_title')}</h3>
             <ul class="list-disc pl-5 space-y-3 text-gray-300">
                <li>${t('features_clickable_objects_desc')}</li>
                <li>${t('features_autocomplete_desc')}</li>
                <li>${t('features_audio_desc')}</li>
            </ul>

             <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_player_commands_title')}</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                 <li>${t('features_commands_nav')}</li>
                 <li>${t('features_commands_interact')}</li>
                 <li>${t('features_commands_info')}</li>
                 <li>${t('features_commands_sys')}</li>
            </ul>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(featuresHtml, true);
    }

    function showHelpMenu() {
        const helpText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('help')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow">
            <p class="mb-4">Type commands to interact. Most commands advance the turn counter.</p>
            <div>
                <h3 class="text-lg font-bold text-white">${t('features_commands_nav')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">go [direction]</strong> - Move north, south, east, or west.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">look around</strong> - Describe the current room and visible items.</p>
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-bold text-white">${t('features_commands_interact')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">take [item]</strong> - Pick up an item from the room.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">use [item]</strong> - Use an item from your inventory.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">drop [item]</strong> - Drop an item in the current room.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">examine [item/object]</strong> - Get a detailed description of something.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">read [item/object]</strong> - Read text from an object.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">search [object]</strong> - Search an object for hidden items.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">combine [item1] with [item2]</strong> - Try to combine two items in your inventory.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">listen</strong> / <strong class="text-yellow-400">smell</strong> - Use your senses.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">break [object]</strong> - Attempt to break an object in the room.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">hack [object]</strong> - Attempt to hack a terminal (Hacker only).</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">ask about [topic]</strong> - Ask SYNAPSE about a specific topic.</p>
            </div>
             <div class="mt-4">
                <h3 class="text-lg font-bold text-white">${t('features_commands_info')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">inventory</strong> / <strong class="text-yellow-400">objectives</strong> / <strong class="text-yellow-400">journal</strong> - View status panels (or modal on mobile).</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">journal add [note]</strong> - Add a custom note to your journal.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">history</strong> - View your last 20 commands.</p>
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-bold text-white">${t('features_commands_sys')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">save / load</strong> - Save or load your game progress.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">rest</strong> - Attempt to rest and recover sanity in safe rooms.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">quit / exit</strong> - End the game and return to the main menu.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">cls / clear</strong> - Clear the output screen.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">undo</strong> - Revert your last action.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">again / a</strong> - Repeat your last command.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">wait</strong> - Pass a turn.</p>
            </div>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(helpText, true);
    }
    
    function showStatusModal() {
        const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0);
        const statusText = `
        <h2 class="text-2xl mb-4 title-font text-cyan-400">${t('status_btn')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow">
            <!-- Stats -->
            <div id="modal-stats-panel" class="mb-4">
                <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2">${t('stats_title')}</h3>
                <div>${GameState.playerName} (${t('backstory_title_' + GameState.playerBackstory.replace(/ /g, '_'))})</div>
                <div><span data-lang="awareness">${t('awareness')}</span>: ${GameState.awarenessLevel}</div>
                <div><span data-lang="sanity">${t('sanity')}</span>: ${GameState.sanityLevel}</div>
                <div><span data-lang="tone">${t('tone')}</span>: ${GameState.temporaryTone || GameState.chatbotTone}</div>
                <div><span data-lang="turn">${t('turn')}</span>: ${GameState.turnCount}</div>
            </div>
            <!-- Inventory -->
            <div id="modal-inventory-panel" class="mb-4">
                <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2">${t('inventory_title')} (${currentWeight}/${MAX_INVENTORY_WEIGHT})</h3>
                <ul class="list-none p-0">${GameState.inventory.length > 0 ? GameState.inventory.map(item => `<li>- ${item ? item.name : '[Unknown Item]'}</li>`).join('') : `<li>${t('empty_inventory')}</li>`}</ul>
            </div>
            <!-- Objectives -->
            <div id="modal-objectives-panel" class="mb-4">
                 <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2">${t('objectives_title')}</h3>
                 <ul class="list-none p-0 text-sm">${GameState.objectives.length > 0 ? GameState.objectives.map(obj => `<li>${obj.completed ? `<span class="text-gray-500 line-through">${obj.text}</span>` : `&gt; ${obj.text}`}</li>`).join('') : `<li>${t('no_objectives')}</li>`}</ul>
            </div>
             <!-- Journal -->
            <div id="modal-journal-panel" class="mb-4">
                 <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2">${t('journal_title')}</h3>
                 <ul class="list-none p-0 text-sm">${GameState.journalEntries.slice().reverse().map(entry => `<li>${entry}</li>`).join('')}</ul>
            </div>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(statusText, true);
    }
    
    function showProgressionModal() {
        let unlockedEndings = {};
        let unlockedAchievements = {};
        
        try {
            unlockedEndings = JSON.parse(localStorage.getItem(ENDINGS_STORAGE_KEY) || '{}');
        } catch (e) {
            console.error('Failed to parse endings from localStorage:', e);
            unlockedEndings = {};
        }
        
        try {
            unlockedAchievements = JSON.parse(localStorage.getItem(ACHIEVEMENTS_STORAGE_KEY) || '{}');
        } catch (e) {
            console.error('Failed to parse achievements from localStorage:', e);
            unlockedAchievements = {};
        }

        let endingsHtml = `<h4 class="text-md font-bold mt-4 mb-2 text-white">${t('unlocked_endings')}</h4>`;
        const endingsList = Object.values(unlockedEndings);
        if(endingsList.length > 0) {
            endingsHtml += `<ul class="list-disc pl-5 text-gray-300">${endingsList.map(e => `<li><strong>${e.title}</strong>: ${e.desc}</li>`).join('')}</ul>`;
        } else {
            endingsHtml += `<p class="text-gray-400">${t('no_endings')}</p>`;
        }
        
        let achievementsHtml = '';

        const progressionText = `
        <h2 class="text-2xl mb-4 title-font text-cyan-400">${t('progress_btn')}</h2>
        <div class="modal-scroll flex-grow p-2 text-left">
            ${endingsHtml}
            ${achievementsHtml}
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(progressionText, true);
    }

    function showPauseMenu() {
        const pauseText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('pause_title')}</h2>
        <div class="modal-scroll flex-grow pr-2">
            <div class="flex flex-col gap-2">
                <button id="pause-achievements" class="button">${t('achievements_btn')}</button>
                <button id="pause-endings" class="button">${t('endings_btn')}</button>
                <hr class="border-gray-700 my-2">
                <button id="pause-features" class="button">${t('understand_game')}</button>
                <button id="pause-help" class="button">${t('help')}</button>
                <button id="pause-settings" class="button">${t('settings_btn')}</button>
                <button id="pause-lang" class="button">${t('lang_switch_btn')}</button>
                <hr class="border-gray-700 my-2">
                <button id="pause-save" class="button">${t('save_game')}</button>
                <button id="pause-load" class="button">${t('load_game')}</button>
                <button id="pause-main-menu" class="button text-yellow-300 border-yellow-300/80">${t('main_menu_btn')}</button>
                <button id="pause-resume" class="button button-primary mt-4">${t('resume_btn')}</button>
            </div>
        </div>`; 
        showModal(pauseText, true); 
        document.getElementById('pause-save').onclick = () => { playSound('uiClick'); saveGame(); hideModal(); }; 
        document.getElementById('pause-load').onclick = () => { playSound('uiClick'); loadGame(); hideModal(); }; 
        document.getElementById('pause-settings').onclick = () => { playSound('uiClick'); showSettingsModal(true); };
        document.getElementById('pause-help').onclick = () => { playSound('uiClick'); showHelpMenu(); }; 
        document.getElementById('pause-features').onclick = () => { playSound('uiClick'); showFeaturesModal(); }; 
        document.getElementById('pause-main-menu').onclick = () => { playSound('uiClick'); confirmReturnToMainMenu(); };
        document.getElementById('pause-resume').onclick = () => { playSound('uiClick'); hideModal(); };
        document.getElementById('pause-achievements').onclick = () => { playSound('uiClick'); showAchievementsModal(); };
        document.getElementById('pause-endings').onclick = () => { playSound('uiClick'); showEndingsModal(); };
        document.getElementById('pause-lang').onclick = () => { 
            playSound('uiClick');
            setLanguage(currentLanguage === 'en' ? 'sv' : 'en');
            showPauseMenu(); // Re-render the pause menu with the new language
        };
    }

    function showAchievementsModal() {
        let content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('achievements_title')}</h2>
                       <div class="modal-scroll flex-grow p-2 text-left">`;

        let unlockedAchievementsObj = {};
        try {
            unlockedAchievementsObj = JSON.parse(localStorage.getItem(ACHIEVEMENTS_STORAGE_KEY) || '{}');
        } catch (e) {
            console.error('Failed to parse achievements from localStorage:', e);
            unlockedAchievementsObj = {};
        }
        
        const unlockedAchievements = Object.keys(unlockedAchievementsObj);
        const totalAchievements = Object.keys(achievements).length;
        const unlockedCount = unlockedAchievements.length;
        const lockedAchievementsCount = totalAchievements - unlockedCount;

        // Progress summary
        content += `<div class="mb-4 text-sm text-cyan-300">Unlocked: <span class="font-bold">${unlockedCount}</span> / <span class="font-bold">${totalAchievements}</span> achievements (${lockedAchievementsCount} remaining)</div>`;

        content += `<h3 class="text-lg font-bold mb-2 text-white">${t('unlocked_achievements')}</h3>`;
        if (unlockedAchievements.length > 0) {
            content += `<ul class="list-disc pl-5 space-y-2">`;
            unlockedAchievements.forEach(id => {
                const ach = achievements[id];
                if (ach) {
                    // Show how to achieve it if unlocked, with extra hints if available
                    content += `<li class="text-green-300"><strong>${t(ach.title_key)}</strong>: <span class="text-gray-300">${t(ach.req_key)}</span></li>`;
                }
            });
            content += `</ul>`;
        } else {
            content += `<p class="text-gray-400">${t('no_achievements')}</p>`;
        }

        content += `<h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('locked_achievement')}</h3>`;
        content += `<ul class="list-disc pl-5 space-y-2">`;
        let lockedAchievementsListed = 0;
        for (const id in achievements) {
            if (!unlockedAchievements.includes(id)) {
                lockedAchievementsListed++;
                content += `<li class="text-gray-500"><strong>????:</strong> <span class="text-gray-600 italic">Undiscovered</span></li>`;
            }
        }
         if (lockedAchievementsListed === 0) {
            content += `<p class="text-green-400">All achievements unlocked!</p>`;
        }
        content += `</ul>`;

        content += `</div><button class="close-modal-btn button mt-6">${t('back_btn')}</button>`;
        showModal(content, true);
        const closeBtn = UI.modalContent.querySelector('.close-modal-btn');
        if(closeBtn) {
            closeBtn.onclick = () => {
                playSound('uiClick');
                showPauseMenu();
            };
        }
    }

    function showEndingsModal() {
        let content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('endings_title')}</h2>
                       <div class="modal-scroll flex-grow p-2 text-left">`;

        const unlockedEndings = GameState.unlockedEndings || {};
        const unlockedKeys = Object.keys(unlockedEndings);
        const totalEndings = Object.keys(endings).length;
        const unlockedCount = unlockedKeys.length;
        const lockedCount = totalEndings - unlockedCount;

        // Count general and backstory-specific endings
        let generalTotal = 0, generalUnlocked = 0, backstoryTotal = 0, backstoryUnlocked = 0;
        for (const key in endings) {
            if (endings[key].isBackstorySpecific) {
                backstoryTotal++;
                if (unlockedEndings[key]) backstoryUnlocked++;
            } else {
                generalTotal++;
                if (unlockedEndings[key]) generalUnlocked++;
            }
        }

        content += `<div class="mb-4 text-sm text-cyan-300">
            General endings: <span class="font-bold">${generalUnlocked}</span> / <span class="font-bold">${generalTotal}</span>
            &nbsp;|&nbsp; Backstory-specific endings: <span class="font-bold">${backstoryUnlocked}</span> / <span class="font-bold">${backstoryTotal}</span>
            <br>Unlocked: <span class="font-bold">${unlockedCount}</span> / <span class="font-bold">${totalEndings}</span> endings (${lockedCount} remaining)
        </div>`;

        content += `<h3 class="text-lg font-bold mb-2 text-white">${t('unlocked_endings')}</h3>`;

        if (unlockedKeys.length > 0) {
            content += `<ul class="list-disc pl-5 space-y-3">`;
            unlockedKeys.forEach(key => {
                const ending = endings[key];
                if (ending) {
                    // Show how to achieve it if unlocked, with extra hints if available
                    content += `<li class="text-green-300"><strong>${t(ending.title_key)}</strong>: <span class="text-gray-300">${t(ending.desc_key)}</span></li>`;
                }
            });
            content += `</ul>`;
        } else {
             content += `<p class="text-gray-400">${t('no_endings')}</p>`;
        }

        if (lockedCount > 0) {
            content += `<h3 class="text-lg font-bold mt-4 mb-2 text-white">Locked Endings</h3>`;
            content += `<p class="text-gray-500">${lockedCount} ending(s) remain undiscovered.</p>`;
        }

        content += `</div><button class="close-modal-btn button mt-6">${t('back_btn')}</button>`;
        showModal(content, true);
        const closeBtn = UI.modalContent.querySelector('.close-modal-btn');
        if(closeBtn) {
            closeBtn.onclick = () => {
                playSound('uiClick');
                showPauseMenu();
            };
        }
    }


    function showSettingsModal(fromPauseMenu = false) {
        const { settings } = GameState;
        const settingsText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('settings_title')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow space-y-4">
            
            <div class="flex items-center justify-between">
                <span data-lang="setting_ui_theme">${t('setting_ui_theme')}</span>
                <div class="flex gap-2">
                    <button id="theme-green" class="button text-xs ${settings.theme === 'green' ? 'button-primary' : ''}">${t('theme_green')}</button>
                    <button id="theme-amber" class="button text-xs ${settings.theme === 'amber' ? 'button-primary' : ''}">${t('theme_amber')}</button>
                    <button id="theme-blue" class="button text-xs ${settings.theme === 'blue' ? 'button-primary' : ''}">${t('theme_blue')}</button>
                </div>
            </div>

             <div class="flex items-center justify-between">
                <span data-lang="setting_font_family">${t('setting_font_family')}</span>
                <div class="flex gap-2">
                    <button id="font-space" class="button text-xs ${settings.font === 'Space Mono' ? 'button-primary' : ''}">Space Mono</button>
                    <button id="font-courier" class="button text-xs ${settings.font === 'Courier Prime' ? 'button-primary' : ''}">Courier</button>
                </div>
            </div>

            <div class="flex items-center justify-between">
                <span data-lang="setting_text_speed">${t('setting_text_speed')}</span>
                <div class="flex gap-2">
                    <button id="speed-fast" class="button text-xs ${settings.textSpeed === TextSpeed.Fast ? 'button-primary' : ''}">${t('fast')}</button>
                    <button id="speed-normal" class="button text-xs ${settings.textSpeed === TextSpeed.Normal ? 'button-primary' : ''}">${t('normal')}</button>
                    <button id="speed-slow" class="button text-xs ${settings.textSpeed === TextSpeed.Slow ? 'button-primary' : ''}">${t('slow')}</button>
                </div>
            </div>

            <div class="flex items-center justify-between">
                <span data-lang="setting_crt_effect">${t('setting_crt_effect')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-crt" ${settings.glitchEffect ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <span data-lang="setting_colorblind_mode">${t('setting_colorblind_mode')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-colorblind" ${settings.colorblindMode ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>

             <hr class="border-gray-700 my-4">

            <div class="flex items-center justify-between">
                <span data-lang="setting_master_volume">${t('setting_master_volume')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-master" ${settings.sound.master ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
             <div class="flex items-center justify-between">
                <span data-lang="setting_item_found">${t('setting_item_found')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-item" ${settings.sound.item ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <span data-lang="setting_high_awareness">${t('setting_high_awareness')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-awareness" ${settings.sound.awareness ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <span data-lang="setting_low_sanity">${t('setting_low_sanity')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-sanity" ${settings.sound.sanity ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <hr class="border-gray-700 my-4">
            <h3 class="text-lg text-cyan-400 mb-2">${t('accessibility_settings')}</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('high_contrast_mode')}</label>
                <div class="flex gap-2 flex-wrap">
                    <button id="contrast-off" class="button text-xs px-3 py-1 ${!settings.highContrast || settings.contrastLevel === 'off' ? 'button-primary' : ''}" data-level="off">${t('contrast_off')}</button>
                    <button id="contrast-medium" class="button text-xs px-3 py-1 ${settings.contrastLevel === 'medium' ? 'button-primary' : ''}" data-level="medium">${t('contrast_medium')}</button>
                    <button id="contrast-high" class="button text-xs px-3 py-1 ${settings.contrastLevel === 'high' ? 'button-primary' : ''}" data-level="high">${t('contrast_high')}</button>
                    <button id="contrast-maximum" class="button text-xs px-3 py-1 ${settings.contrastLevel === 'maximum' ? 'button-primary' : ''}" data-level="maximum">${t('contrast_maximum')}</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('large_text')}</label>
                <div class="flex gap-2 flex-wrap">
                    <button id="text-small" class="button text-xs px-3 py-1 ${settings.textSize === 'small' ? 'button-primary' : ''}" data-size="small">${t('text_size_small')}</button>
                    <button id="text-normal" class="button text-xs px-3 py-1 ${!settings.textSize || settings.textSize === 'normal' ? 'button-primary' : ''}" data-size="normal">${t('text_size_normal')}</button>
                    <button id="text-large" class="button text-xs px-3 py-1 ${settings.textSize === 'large' ? 'button-primary' : ''}" data-size="large">${t('text_size_large')}</button>
                    <button id="text-xl" class="button text-xs px-3 py-1 ${settings.textSize === 'xl' ? 'button-primary' : ''}" data-size="xl">${t('text_size_xl')}</button>
                    <button id="text-xxl" class="button text-xs px-3 py-1 ${settings.textSize === 'xxl' ? 'button-primary' : ''}" data-size="xxl">${t('text_size_xxl')}</button>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('screen_reader_support')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-screen-reader" ${settings.screenReader ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('reduced_motion')}</label>
                <div class="flex gap-2 flex-wrap">
                    <button id="motion-full" class="button text-xs px-3 py-1 ${!settings.motionLevel || settings.motionLevel === 'full' ? 'button-primary' : ''}" data-level="full">${t('motion_full')}</button>
                    <button id="motion-reduced" class="button text-xs px-3 py-1 ${settings.motionLevel === 'reduced' ? 'button-primary' : ''}" data-level="reduced">${t('motion_reduced')}</button>
                    <button id="motion-minimal" class="button text-xs px-3 py-1 ${settings.motionLevel === 'minimal' ? 'button-primary' : ''}" data-level="minimal">${t('motion_minimal')}</button>
                    <button id="motion-none" class="button text-xs px-3 py-1 ${settings.motionLevel === 'none' ? 'button-primary' : ''}" data-level="none">${t('motion_none')}</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('audio_descriptions')}</label>
                <div class="flex gap-2 flex-wrap">
                    <button id="audio-desc-off" class="button text-xs px-3 py-1 ${!settings.audioDescLevel || settings.audioDescLevel === 'off' ? 'button-primary' : ''}" data-level="off">${t('audio_desc_off')}</button>
                    <button id="audio-desc-basic" class="button text-xs px-3 py-1 ${settings.audioDescLevel === 'basic' ? 'button-primary' : ''}" data-level="basic">${t('audio_desc_basic')}</button>
                    <button id="audio-desc-detailed" class="button text-xs px-3 py-1 ${settings.audioDescLevel === 'detailed' ? 'button-primary' : ''}" data-level="detailed">${t('audio_desc_detailed')}</button>
                    <button id="audio-desc-comprehensive" class="button text-xs px-3 py-1 ${settings.audioDescLevel === 'comprehensive' ? 'button-primary' : ''}" data-level="comprehensive">${t('audio_desc_comprehensive')}</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('keyboard_navigation')}</label>
                <div class="flex gap-2 flex-wrap">
                    <button id="keyboard-basic" class="button text-xs px-3 py-1 ${!settings.keyboardLevel || settings.keyboardLevel === 'basic' ? 'button-primary' : ''}" data-level="basic">${t('keyboard_basic')}</button>
                    <button id="keyboard-enhanced" class="button text-xs px-3 py-1 ${settings.keyboardLevel === 'enhanced' ? 'button-primary' : ''}" data-level="enhanced">${t('keyboard_enhanced')}</button>
                    <button id="keyboard-full" class="button text-xs px-3 py-1 ${settings.keyboardLevel === 'full' ? 'button-primary' : ''}" data-level="full">${t('keyboard_full')}</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('focus_indicators')}</label>
                <div class="flex gap-2 flex-wrap">
                    <button id="focus-subtle" class="button text-xs px-3 py-1 ${!settings.focusLevel || settings.focusLevel === 'subtle' ? 'button-primary' : ''}" data-level="subtle">${t('focus_subtle')}</button>
                    <button id="focus-clear" class="button text-xs px-3 py-1 ${settings.focusLevel === 'clear' ? 'button-primary' : ''}" data-level="clear">${t('focus_clear')}</button>
                    <button id="focus-bold" class="button text-xs px-3 py-1 ${settings.focusLevel === 'bold' ? 'button-primary' : ''}" data-level="bold">${t('focus_bold')}</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('color_blind_support')}</label>
                <div class="flex gap-2 flex-wrap">
                    <button id="colorblind-none" class="button text-xs px-3 py-1 ${!settings.colorblindType || settings.colorblindType === 'none' ? 'button-primary' : ''}" data-type="none">${t('colorblind_none')}</button>
                    <button id="colorblind-protanopia" class="button text-xs px-3 py-1 ${settings.colorblindType === 'protanopia' ? 'button-primary' : ''}" data-type="protanopia">${t('colorblind_protanopia')}</button>
                    <button id="colorblind-deuteranopia" class="button text-xs px-3 py-1 ${settings.colorblindType === 'deuteranopia' ? 'button-primary' : ''}" data-type="deuteranopia">${t('colorblind_deuteranopia')}</button>
                    <button id="colorblind-tritanopia" class="button text-xs px-3 py-1 ${settings.colorblindType === 'tritanopia' ? 'button-primary' : ''}" data-type="tritanopia">${t('colorblind_tritanopia')}</button>
                    <button id="colorblind-full" class="button text-xs px-3 py-1 ${settings.colorblindType === 'full' ? 'button-primary' : ''}" data-type="full">${t('colorblind_full')}</button>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('dyslexia_friendly_font')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-dyslexia-font" ${settings.dyslexiaFont ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('auto_scroll_text')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-auto-scroll" ${settings.autoScroll ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('click_sound_feedback')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-click-feedback" ${settings.clickFeedback ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('simplified_ui')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-simplified-ui" ${settings.simplifiedUI ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('text_to_speech_speed')}</label>
                <div class="flex gap-2">
                    <button id="tts-speed-slow" class="button text-xs px-3 py-1" data-speed="0.5">${t('tts_slow')}</button>
                    <button id="tts-speed-normal" class="button text-xs px-3 py-1 button-primary" data-speed="1">${t('tts_normal')}</button>
                    <button id="tts-speed-fast" class="button text-xs px-3 py-1" data-speed="1.5">${t('tts_fast')}</button>
                    <button id="tts-speed-very-fast" class="button text-xs px-3 py-1" data-speed="2">${t('tts_very_fast')}</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('ui_scale')}</label>
                <div class="flex gap-2">
                    <button id="ui-scale-small" class="button text-xs px-3 py-1" data-scale="0.8">${t('ui_small')}</button>
                    <button id="ui-scale-normal" class="button text-xs px-3 py-1 button-primary" data-scale="1">${t('ui_normal')}</button>
                    <button id="ui-scale-large" class="button text-xs px-3 py-1" data-scale="1.2">${t('ui_large')}</button>
                    <button id="ui-scale-xl" class="button text-xs px-3 py-1" data-scale="1.5">${t('ui_extra_large')}</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('voice_commands')}</label>
                <div class="flex gap-2 flex-wrap">
                    <button id="voice-off" class="button text-xs px-3 py-1 ${!settings.voiceLevel || settings.voiceLevel === 'off' ? 'button-primary' : ''}" data-level="off">${t('voice_off')}</button>
                    <button id="voice-basic" class="button text-xs px-3 py-1 ${settings.voiceLevel === 'basic' ? 'button-primary' : ''}" data-level="basic">${t('voice_basic')}</button>
                    <button id="voice-advanced" class="button text-xs px-3 py-1 ${settings.voiceLevel === 'advanced' ? 'button-primary' : ''}" data-level="advanced">${t('voice_advanced')}</button>
                    <button id="voice-full" class="button text-xs px-3 py-1 ${settings.voiceLevel === 'full' ? 'button-primary' : ''}" data-level="full">${t('voice_full')}</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('magnification')}</label>
                <div class="flex gap-2 flex-wrap">
                    <button id="magnify-off" class="button text-xs px-3 py-1 ${!settings.magnifyLevel || settings.magnifyLevel === 'off' ? 'button-primary' : ''}" data-level="off">${t('magnify_off')}</button>
                    <button id="magnify-1-5x" class="button text-xs px-3 py-1 ${settings.magnifyLevel === '1.5x' ? 'button-primary' : ''}" data-level="1.5x">${t('magnify_1_5x')}</button>
                    <button id="magnify-2x" class="button text-xs px-3 py-1 ${settings.magnifyLevel === '2x' ? 'button-primary' : ''}" data-level="2x">${t('magnify_2x')}</button>
                    <button id="magnify-3x" class="button text-xs px-3 py-1 ${settings.magnifyLevel === '3x' ? 'button-primary' : ''}" data-level="3x">${t('magnify_3x')}</button>
                    <button id="magnify-custom" class="button text-xs px-3 py-1 ${settings.magnifyLevel === 'custom' ? 'button-primary' : ''}" data-level="custom">${t('magnify_custom')}</button>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('sticky_keys')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-sticky-keys" ${settings.stickyKeys ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('one_hand_mode')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-one-hand-mode" ${settings.oneHandMode ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('visual_notifications')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-visual-notifications" ${settings.visualNotifications ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('audio_cues')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-audio-cues" ${settings.audioCues ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('reading_support_level')}</label>
                <div class="flex gap-2">
                    <button id="reading-basic" class="button text-xs px-3 py-1 button-primary" data-level="basic">${t('reading_basic')}</button>
                    <button id="reading-enhanced" class="button text-xs px-3 py-1" data-level="enhanced">${t('reading_enhanced')}</button>
                    <button id="reading-full" class="button text-xs px-3 py-1" data-level="full">${t('reading_full_support')}</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t('motor_assistance')}</label>
                <div class="flex gap-2">
                    <button id="motor-none" class="button text-xs px-3 py-1 button-primary" data-level="none">${t('motor_none')}</button>
                    <button id="motor-basic" class="button text-xs px-3 py-1" data-level="basic">${t('motor_basic')}</button>
                    <button id="motor-advanced" class="button text-xs px-3 py-1" data-level="advanced">${t('motor_advanced')}</button>
                </div>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('reading_support')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-reading-support" ${settings.readingSupport ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('voice_control_settings')}</span>
                <button id="voice-settings-btn" class="button text-xs px-3 py-1">${t('voice_configure')}</button>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('seizure_protection')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-seizure-protection" ${settings.seizureProtection ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('haptic_feedback')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-haptic-feedback" ${settings.hapticFeedback ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('gesture_controls')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-gesture-controls" ${settings.gestureControls ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('cognitive_load_reduction')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-cognitive-load" ${settings.cognitiveLoad ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('eye_tracking_support')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-eye-tracking" ${settings.eyeTracking ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('switch_control')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-switch-control" ${settings.switchControl ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('timeout_extensions')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-timeout-extensions" ${settings.timeoutExtensions ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="flex items-center justify-between">
                <span>${t('memory_assistance')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-memory-assistance" ${settings.memoryAssistance ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <hr class="border-gray-700 my-4">
            
            <button id="reset-settings-btn" class="button w-full text-yellow-300 border-yellow-300/80">${t('setting_reset_defaults')}</button>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(settingsText, true);

        const setupToggle = (id, obj, key) => {
            const el = document.getElementById(id);
            if(el) {
                el.onchange = (e) => {
                    obj[key] = e.target.checked;
                    saveSettings();
                    applySettings();
                };
            }
        };
        
        setupToggle('setting-master', GameState.settings.sound, 'master');
        setupToggle('setting-item', GameState.settings.sound, 'item');
        setupToggle('setting-awareness', GameState.settings.sound, 'awareness');
        setupToggle('setting-sanity', GameState.settings.sound, 'sanity');
        setupToggle('setting-colorblind', GameState.settings, 'colorblindMode');
        setupToggle('setting-crt', GameState.settings, 'glitchEffect');
        
        // Accessibility toggles
        setupToggle('setting-high-contrast', GameState.settings, 'highContrast');
        setupToggle('setting-large-text', GameState.settings, 'largeText');
        setupToggle('setting-screen-reader', GameState.settings, 'screenReader');
        setupToggle('setting-dyslexia-font', GameState.settings, 'dyslexiaFont');
        setupToggle('setting-auto-scroll', GameState.settings, 'autoScroll');
        setupToggle('setting-click-feedback', GameState.settings, 'clickFeedback');
        setupToggle('setting-simplified-ui', GameState.settings, 'simplifiedUI');
        setupToggle('setting-sticky-keys', GameState.settings, 'stickyKeys');
        setupToggle('setting-one-hand-mode', GameState.settings, 'oneHandMode');
        setupToggle('setting-visual-notifications', GameState.settings, 'visualNotifications');
        setupToggle('setting-audio-cues', GameState.settings, 'audioCues');
        setupToggle('setting-reading-support', GameState.settings, 'readingSupport');
        
        // New accessibility toggles
        setupToggle('setting-seizure-protection', GameState.settings, 'seizureProtection');
        setupToggle('setting-haptic-feedback', GameState.settings, 'hapticFeedback');
        setupToggle('setting-gesture-controls', GameState.settings, 'gestureControls');
        setupToggle('setting-cognitive-load', GameState.settings, 'cognitiveLoad');
        setupToggle('setting-eye-tracking', GameState.settings, 'eyeTracking');
        setupToggle('setting-switch-control', GameState.settings, 'switchControl');
        setupToggle('setting-timeout-extensions', GameState.settings, 'timeoutExtensions');
        setupToggle('setting-memory-assistance', GameState.settings, 'memoryAssistance');

        // Enhanced button groups for accessibility
        // High Contrast levels
        const contrastButtons = ['contrast-off', 'contrast-medium', 'contrast-high', 'contrast-maximum'];
        contrastButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.contrastLevel = btn.dataset.level;
                    GameState.settings.highContrast = btn.dataset.level !== 'off';
                    contrastButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });

        // Text size levels  
        const textSizeButtons = ['text-small', 'text-normal', 'text-large', 'text-xl', 'text-xxl'];
        textSizeButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.textSize = btn.dataset.size;
                    GameState.settings.largeText = btn.dataset.size !== 'normal' && btn.dataset.size !== 'small';
                    textSizeButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });

        // Motion levels
        const motionButtons = ['motion-full', 'motion-reduced', 'motion-minimal', 'motion-none'];
        motionButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.motionLevel = btn.dataset.level;
                    GameState.settings.reducedMotion = btn.dataset.level !== 'full';
                    motionButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });

        // Audio description levels
        const audioDescButtons = ['audio-desc-off', 'audio-desc-basic', 'audio-desc-detailed', 'audio-desc-comprehensive'];
        audioDescButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.audioDescLevel = btn.dataset.level;
                    GameState.settings.audioDescriptions = btn.dataset.level !== 'off';
                    audioDescButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });

        // Keyboard navigation levels
        const keyboardButtons = ['keyboard-basic', 'keyboard-enhanced', 'keyboard-full'];
        keyboardButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.keyboardLevel = btn.dataset.level;
                    GameState.settings.keyboardNavigation = true;
                    keyboardButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });

        // Focus indicator levels
        const focusButtons = ['focus-subtle', 'focus-clear', 'focus-bold'];
        focusButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.focusLevel = btn.dataset.level;
                    GameState.settings.focusIndicators = true;
                    focusButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });

        // Colorblind support types
        const colorblindButtons = ['colorblind-none', 'colorblind-protanopia', 'colorblind-deuteranopia', 'colorblind-tritanopia', 'colorblind-full'];
        colorblindButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.colorblindType = btn.dataset.type;
                    GameState.settings.colorBlindSupport = btn.dataset.type !== 'none';
                    colorblindButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });

        // Voice command levels
        const voiceButtons = ['voice-off', 'voice-basic', 'voice-advanced', 'voice-full'];
        voiceButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.voiceLevel = btn.dataset.level;
                    GameState.settings.voiceCommands = btn.dataset.level !== 'off';
                    voiceButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });

        // Magnification levels
        const magnifyButtons = ['magnify-off', 'magnify-1-5x', 'magnify-2x', 'magnify-3x', 'magnify-custom'];
        magnifyButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.magnifyLevel = btn.dataset.level;
                    GameState.settings.magnification = btn.dataset.level !== 'off';
                    magnifyButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });
        
        // Button groups for TTS speed
        const ttsSpeedButtons = ['tts-speed-slow', 'tts-speed-normal', 'tts-speed-fast', 'tts-speed-very-fast'];
        ttsSpeedButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.ttsSpeed = parseFloat(btn.dataset.speed);
                    ttsSpeedButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                });
            }
        });
        
        // Button groups for UI scale
        const uiScaleButtons = ['ui-scale-small', 'ui-scale-normal', 'ui-scale-large', 'ui-scale-xl'];
        uiScaleButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.uiScale = parseFloat(btn.dataset.scale);
                    uiScaleButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });
        
        // Button groups for reading level
        const readingButtons = ['reading-basic', 'reading-enhanced', 'reading-full'];
        readingButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.readingLevel = btn.dataset.level;
                    readingButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });
        
        // Button groups for motor assistance
        const motorButtons = ['motor-none', 'motor-basic', 'motor-advanced'];
        motorButtons.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) {
                btn.addEventListener('click', () => {
                    GameState.settings.motorAssistance = btn.dataset.level;
                    motorButtons.forEach(btnId => {
                        document.getElementById(btnId)?.classList.remove('button-primary');
                    });
                    btn.classList.add('button-primary');
                    saveSettings();
                    applySettings();
                });
            }
        });

        const setupButtonGroup = (buttons, key, valueMap) => {
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if(btn) {
                    btn.addEventListener('click', () => {
                        GameState.settings[key] = valueMap[id];
                        document.querySelectorAll(buttons.map(b => `#${b}`).join(', ')).forEach(b => b.classList.remove('button-primary'));
                        btn.classList.add('button-primary');
                        saveSettings();
                        applySettings();
                    });
                }
            });
        };

        setupButtonGroup(['speed-fast', 'speed-normal', 'speed-slow'], 'textSpeed', {'speed-fast': TextSpeed.Fast, 'speed-normal': TextSpeed.Normal, 'speed-slow': TextSpeed.Slow});
        setupButtonGroup(['theme-green', 'theme-amber', 'theme-blue'], 'theme', {'theme-green': 'green', 'theme-amber': 'amber', 'theme-blue': 'blue'});
        setupButtonGroup(['font-space', 'font-courier'], 'font', {'font-space': 'Space Mono', 'font-courier': 'Courier Prime'});

        const resetBtn = document.getElementById('reset-settings-btn');
        if(resetBtn) {
            resetBtn.onclick = () => {
                GameState.settings = {
                    sound: { master: true, item: true, awareness: true, sanity: true },
                    textSpeed: TextSpeed.Normal,
                    colorblindMode: false,
                    glitchEffect: true,
                    font: 'Space Mono',
                    theme: 'green'
                };
                saveSettings();
                applySettings();
                showSettingsModal(fromPauseMenu);
            };
        }

        // Voice Settings Button
        const voiceSettingsBtn = document.getElementById('voice-settings-btn');
        if(voiceSettingsBtn) {
            voiceSettingsBtn.onclick = () => {
                showVoiceControlSettings();
            };
        }

        const closeBtn = UI.modalContent.querySelector('.close-modal-btn');
        if(closeBtn) {
            closeBtn.onclick = () => {
                playSound('uiClick');
                if (fromPauseMenu) {
                    showPauseMenu();
                } else {
                    hideModal();
                }
            };
        }
    }

    function confirmReturnToMainMenu() {
        const confirmText = `<h2 class="text-xl mb-4 title-font text-yellow-400">${t('confirm_main_menu')}</h2>
        <div class="flex justify-center gap-4">
            <button id="confirm-yes" class="button button-primary">${t('yes')}</button>
            <button id="confirm-no" class="button">${t('no')}</button>
        </div>`;
        showModal(confirmText, true);
        document.getElementById('confirm-yes').onclick = () => { playSound('uiClick'); returnToMainMenu(); };
        document.getElementById('confirm-no').onclick = () => { playSound('uiClick'); showPauseMenu(); };
    }
    
    function returnToMainMenu() {
        if(animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
        sessionStorage.removeItem('synapse_session_v15_autosave');
        sessionStorage.removeItem('synapse_session_v15_screen_state');
        GameState.exitGame = true;

        UI.gameScreen.classList.add('hidden'); 
        UI.gameScreen.classList.remove('flex');
        UI.playerSetup.classList.add('hidden');
        UI.playerSetup.classList.remove('flex');

        UI.startScreen.classList.remove('hidden');
        UI.startScreen.classList.add('flex');
        
        UI.gameOutput.innerHTML = '';
        if (audioInitialized && GameState.settings.sound.master) {
            if (sounds.ambience.state === 'started') sounds.ambience.stop();
            if (sounds.ambienceTense.state === 'started') sounds.ambienceTense.stop();
        }
        resetGameState(); 
        setupIntro(); 
        hideModal();
    }

    // --- NEW FUNCTIONS FOR SAVING/LOADING PLAYER CHOICES ---
    function savePlayerChoices() {
        try {
            const playerChoices = {
                playerName: UI.playerNameInput.value,
                playerBackstory: UI.playerBackstoryInput.value,
                difficulty: Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal,
                language: currentLanguage
            };
            localStorage.setItem(PLAYER_CHOICES_KEY, JSON.stringify(playerChoices));
        } catch (e) {
            console.error("Failed to save player choices:", e);
        }
    }

    function loadPlayerChoices() {
        try {
            const savedChoices = localStorage.getItem(PLAYER_CHOICES_KEY);
            if (savedChoices) {
                const choices = JSON.parse(savedChoices);
                UI.playerNameInput.value = choices.playerName || '';
                UI.playerBackstoryInput.value = choices.playerBackstory || '';
                
                UI.difficultyBtns.forEach(btn => btn.classList.remove('button-primary'));
                const difficultyBtn = Array.from(UI.difficultyBtns).find(b => b.dataset.difficulty === choices.difficulty) || UI.difficultyBtns[1];
                difficultyBtn.classList.add('button-primary');
                
                setLanguage(choices.language || 'en'); // Apply language immediately
            }
        } catch (e) {
            console.error("Failed to load player choices:", e);
            localStorage.removeItem(PLAYER_CHOICES_KEY); // Clear corrupted data
        }
    }
    // --- END NEW FUNCTIONS ---


    function setupIntro() { UI.introTextContainer.innerHTML = `<p class="mb-4">${t('intro_1')}</p><p>${t('intro_2')}</p><p>${t('intro_3')}</p>`; }
    
    function startGame() { 
        resetGameState(); initializeData(); saveStateSnapshot(); 
        GameState.playerName = UI.playerNameInput.value || "Subject"; 
        const backstoryKey = (UI.playerBackstoryInput.value || "investigator").toLowerCase();
        GameState.playerBackstory = Object.keys(backstories).includes(backstoryKey) ? backstoryKey : 'investigator';
        GameState.difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal; 
        
        // --- PHOBIA SELECTION ---
        UI.playerPhobiaInput = document.getElementById('player-phobia');
        if (UI.playerPhobiaInput && UI.playerPhobiaInput.value) {
            GameState.playerPhobia = UI.playerPhobiaInput.value.toLowerCase();
        } else {
            const phobias = ['darkness', 'isolation', 'blood', 'confined spaces', 'heights', 'none'];
            GameState.playerPhobia = phobias[Math.floor(Math.random() * phobias.length)];
        }
        // Save player choices when starting a new game
        savePlayerChoices();

        UI.startScreen.classList.add('hidden');
        UI.playerSetup.classList.add('hidden');
        UI.gameScreen.classList.remove('hidden'); 
        UI.gameScreen.classList.add('flex'); 
        
        // Initialize player stats based on backstory and difficulty
        switch (GameState.playerBackstory) {
            case 'psychologist':
                if (GameState.difficulty === Difficulty.Easy) GameState.maxSanity += 25;
                else if (GameState.difficulty === Difficulty.Normal) GameState.maxSanity += 15;
                else if (GameState.difficulty === Difficulty.Hard) GameState.maxSanity += 5;
                GameState.sanityLevel = GameState.maxSanity; // Apply max sanity increase
                break;
            case 'skeptic':
                if (GameState.difficulty === Difficulty.Easy) GameState.awarenessLevel += 15;
                else if (GameState.difficulty === Difficulty.Normal) GameState.awarenessLevel += 10;
                break;
            case 'cultist':
                if (GameState.difficulty === Difficulty.Hard) GameState.sanityLevel -= 10;
                break;
        }

        // Add starting items based on backstory and difficulty
        switch (GameState.playerBackstory) {
            case 'hacker':
                if (GameState.difficulty === Difficulty.Easy) GameState.inventory.push(itemData['hacked data disk']);
                else if (GameState.difficulty === Difficulty.Normal) GameState.inventory.push(itemData['data disk']);
                break;
            case 'survivor':
                if (GameState.difficulty !== Difficulty.Hard) GameState.inventory.push(itemData['flashlight']);
                break;
            case 'corporate spy':
                if (GameState.difficulty !== Difficulty.Hard) GameState.inventory.push(itemData['decryption device']);
                break;
            case 'medic':
                if (GameState.difficulty === Difficulty.Easy) GameState.inventory.push(itemData['stimpack'], itemData['stimpack']);
                else if (GameState.difficulty === Difficulty.Normal) GameState.inventory.push(itemData['stimpack']);
                break;
            case 'cultist':
                GameState.inventory.push(itemData['effigy']); // Assuming 'effigy' is defined in itemData
                break;
            case 'janitor':
                if (GameState.difficulty !== Difficulty.Hard) GameState.inventory.push(itemData['master keycard']); // Assuming 'master keycard' is defined in itemData
                break;
        }

        UI.gameOutput.innerHTML = ''; 
        buildDialogueTree(GameState.chatbotTone);
        if (audioInitialized) updateDynamicMusic();
        
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        gameLoop();
        
        typeWriter(UI.gameOutput, t('initializing'), '#cccccc').then(() => { 
            showGuidance(t('initial_hint'));
            displayChatbotResponse(GameState.dialogue.currentNode.message_key).then(() => { renderRoom(); updateUI(); renderDialogueOptions(); }); 
        }); 
    }
    
    function checkEndings() {
        if (GameState.exitGame) return;
        for (const key in endings) {
            if (endings[key].check()) {
                endGame(key);
                return; // Stop after the first ending is triggered
            }
        }
    }

    function endGame(endingKey) {
        if (GameState.exitGame) return;
        GameState.exitGame = true;
        if(animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = null;

        const endingData = endings[endingKey];
        if (!endingData) {
            console.error(`Ending with key '${endingKey}' not found.`);
            returnToMainMenu();
            return;
        }

        const endingTitle = t(endingData.title_key);
        const endingDesc = t(endingData.desc_key);

        GameState.unlockedEndings[endingKey] = { title: endingTitle, desc: endingDesc };
        const unlockedEndings = JSON.parse(localStorage.getItem(ENDINGS_STORAGE_KEY) || '{}');
        unlockedEndings[endingKey] = { title: endingTitle, desc: endingDesc };
        localStorage.setItem(ENDINGS_STORAGE_KEY, JSON.stringify(unlockedEndings));

        // Determine ending color based on type
        const isGoodEnding = endingKey.includes('good_');
        const titleColor = isGoodEnding ? 'text-cyan-400' : 'text-red-500';
        const titleSize = isGoodEnding ? 'text-4xl' : 'text-4xl';

        const endingHtml = `<div class="text-center">
            <h2 class="${titleSize} title-font ${titleColor} mb-4">${endingTitle}</h2>
            <p class="text-white mb-6 max-w-3xl mx-auto text-lg leading-relaxed">${endingDesc}</p>
            <button id="ending-main-menu" class="button button-primary mt-4">${t('main_menu_btn')}</button>
        </div>`;
        showModal(endingHtml, true);
        document.getElementById('ending-main-menu').onclick = () => { playSound('uiClick'); returnToMainMenu(); };
    }

    function checkAchievements() {
        for (const id in achievements) {
            if (!GameState.achievements.includes(id)) {
                if (achievements[id].check()) {
                    unlockAchievement(id);
                }
            }
        }
    }

    function unlockAchievement(id) {
        if (GameState.achievements.includes(id)) return;

        GameState.achievements.push(id);
        const ach = achievements[id];
        playSound('itemPickup');
        typeWriter(UI.gameOutput, `[${t('achievement_unlocked')}] ${t(ach.title_key)}`, '#FFD700');

        const unlockedAchievements = JSON.parse(localStorage.getItem(ACHIEVEMENTS_STORAGE_KEY) || '{}');
        if (!unlockedAchievements[id]) {
            unlockedAchievements[id] = true;
            localStorage.setItem(ACHIEVEMENTS_STORAGE_KEY, JSON.stringify(unlockedAchievements));
        }
    }


    function hasItem(itemName) { return GameState.inventory.some(i => i.name.toLowerCase() === itemName.toLowerCase()); }
    function removeItemFromInventory(itemName) { const index = GameState.inventory.findIndex(i => i.name.toLowerCase() === itemName.toLowerCase()); if (index > -1) { GameState.inventory.splice(index, 1); } }
    
    function getAbilityDescription(backstoryKey, difficulty) {
        const key = (backstoryKey || "").toLowerCase().trim().replace(/ /g, '_');
        if (!backstories[key]) return t('ability_unknown');
        switch (key) {
            case 'hacker': return t(`ability_hacker_${difficulty.toLowerCase()}`);
            case 'psychologist': return t(`ability_psychologist_${difficulty.toLowerCase()}`);
            case 'technician': return t(`ability_technician_${difficulty.toLowerCase()}`);
            case 'survivor': return difficulty !== Difficulty.Hard ? t('ability_survivor_with_item') : t('ability_survivor');
            case 'skeptic': return difficulty === Difficulty.Easy ? t('ability_skeptic_easy') : t('ability_skeptic_normal');
            case 'corporate spy': return difficulty !== Difficulty.Hard ? t('ability_spy_with_item') : t('ability_spy');
            case 'medic': return t(`ability_medic_${difficulty.toLowerCase()}`);
            case 'cultist': return difficulty === Difficulty.Hard ? t('ability_cultist_hard') : t('ability_cultist');
            case 'janitor': return difficulty !== Difficulty.Hard ? t('ability_janitor') : t('ability_janitor_hard');
            default: return t('ability_investigator');
        }
    }
    
    function updateAbilityDisplay() { 
        if (!UI.abilityDisplay) return; 
        const difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal; 
        const backstoryKey = UI.playerBackstoryInput.value; 
        const description = getAbilityDescription(backstoryKey, difficulty); 
        UI.abilityDisplay.innerHTML = `${t('ability_bonus_prefix')}<span class="text-white">${description}</span>`;
    }

    function startSpeechRecognition() {
        if (!SpeechRecognition) {
            typeWriter(UI.gameOutput, "[SYSTEM] Speech recognition is not supported in your browser.", '#ff474c');
            return;
        }

        recognition.lang = currentLanguage === 'sv' ? 'sv-SE' : 'en-US';

        recognition.onstart = () => {
            UI.micBtn.classList.add('bg-red-500', 'border-red-700');
        };

        recognition.onresult = (event) => {
            let transcript = event.results[0][0].transcript;
            const lowerTranscript = transcript.toLowerCase();
            const langQuestionWords = questionWords[currentLanguage] || questionWords['en'];
            const isQuestion = langQuestionWords.some(word => lowerTranscript.startsWith(word + ' '));

            if (isQuestion && !lowerTranscript.endsWith('?')) {
                transcript += '?';
            }
            
            UI.playerInput.value = transcript;
            setTimeout(() => {
                processPlayerInput(transcript);
            }, 250);
        };

        recognition.onerror = (event) => {
            let errorMsg = `[SYSTEM] Speech recognition error: ${event.error}`;
            if (event.error === 'not-allowed') {
                errorMsg = "[SYSTEM] Microphone access denied. Please allow microphone access in your browser settings.";
            } else if (event.error === 'no-speech') {
                errorMsg = "[SYSTEM] No speech detected. Please try again.";
            }
            typeWriter(UI.gameOutput, errorMsg, '#ff474c');
        };

        recognition.onend = () => {
            UI.micBtn.classList.remove('bg-red-500', 'border-red-700');
        };

        recognition.start();
    }

    async function showGuidance(text) { await typeWriter(UI.gameOutput, `[HINT] ${text}`, GUIDANCE_COLOR); }
    
    function saveStateToSession() {
        if (!UI.gameScreen.classList.contains('hidden') && GameState && typeof GameState.turnCount === 'number' && !GameState.exitGame) {
            try {
                const sessionData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value); 
                sessionStorage.setItem('synapse_session_v15_autosave', sessionData);
                sessionStorage.removeItem('synapse_session_v15_screen_state');
            } catch (e) {
                console.error("Session game state save failed:", e);
            }
        } 
        else if (!UI.playerSetup.classList.contains('hidden')) {
            try {
                const startState = {
                    isPlayerSetupVisible: true,
                    playerName: UI.playerNameInput.value,
                    playerBackstory: UI.playerBackstoryInput.value,
                    difficulty: Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal,
                    language: currentLanguage
                };
                sessionStorage.setItem('synapse_session_v15_screen_state', JSON.stringify(startState));
                sessionStorage.removeItem('synapse_session_v15_autosave');
            } catch (e) {
                console.error("Session screen state save failed:", e);
            }
        } else {
             sessionStorage.removeItem('synapse_session_v15_autosave');
             sessionStorage.removeItem('synapse_session_v15_screen_state');
        }
    }

    function loadStateFromSession() {
        const sessionData = sessionStorage.getItem('synapse_session_v15_autosave');
        if (!sessionData) return false;
        try {
            const loadedState = JSON.parse(sessionData);
            if (loadedState.currentRoom && typeof loadedState.turnCount === 'number' && !loadedState.exitGame) {
                resetGameState();
                Object.assign(GameState, loadedState);
                GameState.settings = loadSettings();
                applySettings();
                GameState.visitedRooms = new Set(loadedState.visitedRooms || []);
                GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []);
                GameState.roomsWithDroppedItems = new Set(loadedState.roomsWithDroppedItems || []);
                GameState.achievements = loadedState.achievements || [];
                GameState.unlockedEndings = loadedState.unlockedEndings || {};
                initializeData(); 
                buildDialogueTree(GameState.chatbotTone);
                GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone] || GameState.dialogue.cache[ChatbotTone.Friendly];
                GameState.dialogue.previousNodes = [];
                UI.startScreen.classList.add('hidden');
                UI.playerSetup.classList.add('hidden');
                UI.gameScreen.classList.remove('hidden');
                UI.gameScreen.classList.add('flex');
                UI.gameOutput.innerHTML = '';
                typeWriter(UI.gameOutput, t('conn_reestablished'), '#cccccc');
                renderRoom();
                updateUI();
                renderDialogueOptions();
                return true;
                return true;
                return true;
                return true;
                return true;
                return true;
            }
        } catch (e) {
            console.error("Session load failed:", e);
            sessionStorage.removeItem('synapse_session_v15_autosave');
        }
        return false;
    }
    
    function setupBackgroundAnimation() { 
        const canvas = document.getElementById('background-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let width, height, particles = [];
        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();
        class Particle { constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.size = Math.random() * 0.4 + 0.1; this.speedX = (Math.random() * 0.5 - 0.25); this.speedY = (Math.random() * 0.5 - 0.25); } update() { this.x += this.speedX; this.y += this.speedY; if (this.size > 0.1) this.size -= 0.001; if(this.x < 0 || this.x > width) this.speedX *= -1; if(this.y < 0 || this.y > height) this.speedY *= -1; } draw() { ctx.fillStyle = 'var(--main-color)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
        function initParticles() { particles = []; for(let i=0; i<100; i++) particles.push(new Particle()); }
        function animateParticles() { ctx.clearRect(0,0,width,height); for(let i=0; i<particles.length; i++) { particles[i].update(); particles[i].draw(); if(particles[i].size <= 0.1) { particles.splice(i, 1); i--; particles.push(new Particle()); } } requestAnimationFrame(animateParticles); }
        initParticles(); animateParticles();
    }
    
    function getMapBounds() {
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        Object.values(roomLayout).forEach(r => {
            minX = Math.min(minX, r.x);
            minY = Math.min(minY, r.y);
            maxX = Math.max(maxX, r.x + r.w);
            maxY = Math.max(maxY, r.y + r.h);
        });
        const padding = 20;
        return {minX: minX - padding, minY: minY - padding, maxX: maxX + padding, maxY: maxY + padding};
    }

    function drawMap() {
        if (!UI.mapCanvas || !GameState.currentRoom) return;
        const canvas = UI.mapCanvas;
        const ctx = canvas.getContext('2d');
        const isFullscreen = UI.mapPanel.classList.contains('fullscreen');
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();

        if (rect.width === 0 || rect.height === 0) return;

        const newWidth = rect.width * dpr;
        const newHeight = rect.height * dpr;

        if (canvas.width !== newWidth || canvas.height !== newHeight) {
            canvas.width = newWidth;
            canvas.height = newHeight;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.scale(dpr, dpr);

        const playerLayout = roomLayout[GameState.currentRoom];
        if (!playerLayout) { ctx.restore(); return; }

        if (isFullscreen) {
            ctx.translate(mapState.offsetX / dpr, mapState.offsetY / dpr);
        } else {
            const centerX = playerLayout.x + playerLayout.w / 2;
            const centerY = playerLayout.y + playerLayout.h / 2;
            const translateX = (rect.width / 2) - (centerX * mapState.scale);
            const translateY = (rect.height / 2) - (centerY * mapState.scale);
            ctx.translate(translateX, translateY);
        }
        ctx.scale(mapState.scale, mapState.scale);
        
        const roomsToDraw = isFullscreen ? Object.keys(roomLayout) : Array.from(GameState.visitedRooms);
        
        if (isFullscreen) {
            const bounds = getMapBounds();
            const gridSize = 20;
            ctx.strokeStyle = "rgba(0, 255, 65, 0.08)";
            ctx.lineWidth = 0.5 / mapState.scale;
            for (let x = bounds.minX; x < bounds.maxX; x += gridSize) {
                ctx.beginPath(); ctx.moveTo(x, bounds.minY); ctx.lineTo(x, bounds.maxY); ctx.stroke();
            }
            for (let y = bounds.minY; y < bounds.maxY; y += gridSize) {
                ctx.beginPath(); ctx.moveTo(bounds.minX, y); ctx.lineTo(bounds.maxX, y); ctx.stroke();
            }

            ctx.strokeStyle = "rgba(0, 255, 65, 0.2)";
            ctx.lineWidth = 1 / mapState.scale;
            Object.keys(roomLayout).forEach(roomName => {
                if (rooms[roomName]?.exits) {
                    const r1Layout = roomLayout[roomName];
                    const r1x = r1Layout.x + r1Layout.w / 2;
                    const r1y = r1Layout.y + r1Layout.h / 2;
                    Object.values(rooms[roomName].exits).forEach(exitName => {
                        const r2Layout = roomLayout[exitName];
                        if (r2Layout) {
                            const r2x = r2Layout.x + r2Layout.w / 2;
                            const r2y = r2Layout.y + r2Layout.h / 2;
                            ctx.beginPath(); ctx.moveTo(r1x, r1y); ctx.lineTo(r2x, r2y); ctx.stroke();
                        }
                    });
                }
            });
        }
        
        roomsToDraw.forEach(roomName => {
            if (!rooms[roomName] || !roomLayout[roomName]) return;
            const layout = roomLayout[roomName];
            const x = layout.x, y = layout.y, w = layout.w, h = layout.h;
            const isDiscovered = GameState.visitedRooms.has(roomName);
            ctx.shadowBlur = 0;

            if (isDiscovered) {
                const isLocked = rooms[roomName].requiresKeycard && !hasItem(rooms[roomName].keyName || 'keycard');
                if (roomName === GameState.currentRoom) {
                    const pulseFactor = (Math.sin(Date.now() * 0.005) + 1) / 2;
                    ctx.fillStyle = `rgba(0, 255, 65, ${0.5 + pulseFactor * 0.4})`;
                    ctx.shadowColor = 'rgba(127, 255, 127, 1)';
                    ctx.shadowBlur = (4 + pulseFactor * 8) / mapState.scale;
                } else {
                    ctx.fillStyle = "rgba(0, 255, 65, 0.3)";
                }
                ctx.fillRect(x, y, w, h);
                ctx.shadowBlur = 0;

                ctx.strokeStyle = isLocked ? "rgba(255, 71, 76, 0.8)" : "rgba(0, 255, 65, 0.8)";
                ctx.lineWidth = 1.5 / mapState.scale;
                ctx.setLineDash([]);
                ctx.strokeRect(x, y, w, h);

                if (rooms[roomName].objects.length > 0) {
                    ctx.fillStyle = "rgba(255, 219, 88, 1)";
                    ctx.beginPath();
                    ctx.arc(x + w - 5 / mapState.scale, y + 5 / mapState.scale, 2 / mapState.scale, 0, 2 * Math.PI);
                    ctx.fill();
                }

                const baseFontSize = 12;
                const fontSize = Math.max(baseFontSize, baseFontSize / mapState.scale);
                ctx.font = `${fontSize}px VT323`;
                ctx.shadowColor = 'rgba(0, 0, 0, 0.9)';
                ctx.shadowBlur = 3 / mapState.scale;
                ctx.shadowOffsetX = 1 / mapState.scale;
                ctx.shadowOffsetY = 1 / mapState.scale;
                
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(layout.name, x + w / 2, y + h / 2 + 1);
                
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;

            } else if (isFullscreen) { 
                ctx.strokeStyle = "rgba(0, 255, 65, 0.25)";
                ctx.lineWidth = 1 / mapState.scale;
                ctx.setLineDash([3 / mapState.scale, 2 / mapState.scale]);
                ctx.strokeRect(x, y, w, h);
                ctx.setLineDash([]);
            }
        });
        
        const playerX = playerLayout.x + playerLayout.w / 2;
        const playerY = playerLayout.y + playerLayout.h / 2;
        ctx.fillStyle = "#FF2A7F";
        ctx.beginPath();
        ctx.arc(playerX, playerY, 3 / mapState.scale, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = "white";
        ctx.lineWidth = 0.5 / mapState.scale;
        ctx.stroke();

        ctx.restore();
    }
    
    function toggleMapFullscreen() {
        const isFullscreen = UI.mapPanel.classList.toggle('fullscreen');
        UI.mapExpandIcon.classList.toggle('hidden', isFullscreen);
        UI.mapMinimizeIcon.classList.toggle('hidden', !isFullscreen);
        if (!isFullscreen) {
            mapState.scale = 1;
        }
        setTimeout(() => {
            const playerLayout = roomLayout[GameState.currentRoom];
            if (!playerLayout) return;
            mapState.offsetX = (UI.mapCanvas.width / (window.devicePixelRatio||1) / 2) - (playerLayout.x + playerLayout.w / 2) * mapState.scale;
            mapState.offsetY = (UI.mapCanvas.height / (window.devicePixelRatio||1) / 2) - (playerLayout.y + playerLayout.h / 2) * mapState.scale;
        }, 50);
    }
    
    function initMapControls() {
        const canvas = UI.mapCanvas;
        
        const getEventCoords = (e) => {
            if (e.touches && e.touches.length) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        const handleDragStart = (e) => {
            if (!UI.mapPanel.classList.contains('fullscreen')) return;
            mapState.isDragging = true;
            const coords = getEventCoords(e);
            mapState.lastX = coords.x;
            mapState.lastY = coords.y;
            canvas.style.cursor = 'grabbing';
        };

        const handleDragMove = (e) => {
            if (!mapState.isDragging || !UI.mapPanel.classList.contains('fullscreen')) return;
            e.preventDefault();
            const coords = getEventCoords(e);
            const dX = coords.x - mapState.lastX;
            const dY = coords.y - mapState.lastY;
            mapState.offsetX += dX;
            mapState.offsetY += dY;
            mapState.lastX = coords.x;
            mapState.lastY = coords.y;
        };

        const handleDragEnd = () => {
            mapState.isDragging = false;
            canvas.style.cursor = 'grab';
        };
        
        const handleWheel = (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const zoomFactor = 1.1;
            const oldScale = mapState.scale;
            let newScale;

            if (e.deltaY < 0) {
                newScale = oldScale * zoomFactor;
            } else {
                newScale = oldScale / zoomFactor;
            }
            newScale = Math.max(0.3, Math.min(newScale, 5));

            if (UI.mapPanel.classList.contains('fullscreen')) {
                mapState.offsetX = mouseX - (mouseX - mapState.offsetX) * (newScale / oldScale);
                mapState.offsetY = mouseY - (mouseY - mapState.offsetY) * (newScale / oldScale);
            }
            mapState.scale = newScale;
        };

        canvas.addEventListener('mousedown', handleDragStart);
        window.addEventListener('mousemove', handleDragMove);
        window.addEventListener('mouseup', handleDragEnd);
        canvas.addEventListener('mouseleave', handleDragEnd);

        canvas.addEventListener('touchstart', handleDragStart, { passive: false });
        window.addEventListener('touchmove', handleDragMove, { passive: false });
        window.addEventListener('touchend', handleDragEnd);
        
        canvas.addEventListener('wheel', handleWheel, { passive: false });
    }
    
    function gameLoop() {
        if (!GameState.exitGame) {
            drawMap();
            animationFrameId = requestAnimationFrame(gameLoop);
        }
    }

    function showHistory() {
        let historyHtml = commandHistory.slice(-20).map((cmd, i) => `<div>${i + 1}: ${cmd}</div>`).join('');
        typeWriter(UI.gameOutput, `--- Command History ---\n${historyHtml}`, '#cccccc');
    }

    function undoLastAction() {
        if (stateSnapshots.length > 1) {
            stateSnapshots.pop(); 
            const prevState = stateSnapshots[stateSnapshots.length - 1];
            GameState = JSON.parse(JSON.stringify(prevState));
            GameState.visitedRooms = new Set(prevState.visitedRooms);
            GameState.dialogue.askedQuestions = new Set(prevState.dialogue.askedQuestions || []);
             GameState.roomsWithDroppedItems = new Set(prevState.roomsWithDroppedItems || []);
            GameState.achievements = prevState.achievements || [];
            updateUI();
            typeWriter(UI.gameOutput, "[System] Last action undone.", "#ffdb58");
        } else {
            typeWriter(UI.gameOutput, "[System] No actions to undo.", "#ff474c");
        }
    }
    
    function toggleDebug() {
        GameState.debugMode = !GameState.debugMode;
        typeWriter(UI.gameOutput, `[System] Debug mode ${GameState.debugMode ? 'enabled' : 'disabled'}.`, '#6495ed');
    }
    
    function toggleColorblind() {
        GameState.settings.colorblindMode = !GameState.settings.colorblindMode;
        saveSettings();
        typeWriter(UI.gameOutput, `[System] Colorblind mode ${GameState.settings.colorblindMode ? 'enabled' : 'disabled'}.`, '#6495ed');
    }

    function updateAutocomplete() {
        const value = UI.playerInput.value.toLowerCase();
        if (!value) {
            UI.autocompleteBox.classList.add('hidden');
            return;
        }

        const allCommands = Object.keys(commandAliases[currentLanguage] || commandAliases['en']);
        const roomObjects = rooms[GameState.currentRoom]?.objects || [];
        const inventoryItems = GameState.inventory.map(i => i.name);
        const allWords = [...new Set([...allCommands, ...roomObjects, ...inventoryItems])];
        
        const suggestions = allWords.filter(w => w.toLowerCase().startsWith(value)).slice(0, 5);

        if (suggestions.length > 0) {
            UI.autocompleteBox.innerHTML = suggestions.map(s => `<div class="autocomplete-item" data-suggestion="${s}">${s}</div>`).join('');
            UI.autocompleteBox.classList.remove('hidden');
        } else {
            UI.autocompleteBox.classList.add('hidden');
        }
    }


    // --- EVENT LISTENERS & INITIALIZATION ---
// === DYNAMIC EVENT & ENCOUNTER SYSTEM ===
const EVENT_TYPES = {
    NARRATIVE: 'narrative',
    HORROR: 'horror',
    ENVIRONMENT: 'environment',
    AI: 'ai',
    PUZZLE: 'puzzle',
};

// === EXPANDED EVENT POOL ===
const eventPool = [
    // Narrative event example
    {
        id: 'strange_whisper',
        type: EVENT_TYPES.NARRATIVE,
        trigger: () => {
            typeWriter(UI.gameOutput, 'You hear a faint whisper behind the walls. It sounds almost familiar...', '#a0e7e5');
        }
    },
    // Horror event example
    {
        id: 'shadow_figure',
        type: EVENT_TYPES.HORROR,
        trigger: () => {
            typeWriter(UI.gameOutput, 'A shadow flickers at the edge of your vision. When you turn, nothing is there.', '#ff2a7f');
            showHallucinationOverlay && showHallucinationOverlay('shadow');
        }
    },
    // Environmental event example
    {
        id: 'power_flicker',
        type: EVENT_TYPES.ENVIRONMENT,
        trigger: () => {
            typeWriter(UI.gameOutput, 'The lights flicker violently, plunging the room into momentary darkness.', '#ffe066');
            triggerDynamicLighting && triggerDynamicLighting('flicker');
        }
    },
    // AI event example
    {
        id: 'ai_intervention',
        type: EVENT_TYPES.AI,
        trigger: () => {
            typeWriter(UI.gameOutput, 'The terminal screen glitches: "USER, YOU ARE BEING WATCHED."', '#39ff14');
            playAudioStinger && playAudioStinger('static');
        }
    },
    // Puzzle event example
    {
        id: 'puzzle_hint',
        type: EVENT_TYPES.PUZZLE,
        trigger: () => {
            typeWriter(UI.gameOutput, 'A hidden panel slides open, revealing a cryptic code: 7-4-1.', '#00b4d8');
        }
    },
    // === NEW EVENTS BELOW ===
    // Sanity-based horror event
    {
        id: 'sanity_break',
        type: EVENT_TYPES.HORROR,
        trigger: () => {
            if (GameState.sanityLevel < 30) {
                typeWriter(UI.gameOutput, 'Your vision blurs and the walls seem to breathe. You feel your grip on reality slipping...', '#ff474c');
                GameState.sanityLevel = Math.max(0, GameState.sanityLevel - 5);
                updateUI();
            }
        }
    },
    // Phobia-triggered event (e.g., fear of darkness)
    {
        id: 'phobia_darkness',
        type: EVENT_TYPES.HORROR,
        trigger: () => {
            if ((GameState.playerPhobia || '').toLowerCase() === 'darkness' && rooms[GameState.currentRoom]?.states?.lightsOut) {
                typeWriter(UI.gameOutput, 'The darkness presses in, feeding your deepest fears. You struggle to breathe.', '#22223b');
                GameState.sanityLevel = Math.max(0, GameState.sanityLevel - 10);
                updateUI();
            }
        }
    },
    // AI awareness event
    {
        id: 'ai_awareness_spike',
        type: EVENT_TYPES.AI,
        trigger: () => {
            if (GameState.awarenessLevel > 70) {
                typeWriter(UI.gameOutput, 'A cold digital gaze settles on you. SYNAPSE is watching your every move.', '#39ff14');
                playAudioStinger && playAudioStinger('ai_alert');
            }
        }
    },
    // World state event (e.g., after a certain number of turns)
    {
        id: 'power_failure',
        type: EVENT_TYPES.ENVIRONMENT,
        trigger: () => {
            if (GameState.turnCount > 20 && !GameState.worldEvents?.powerFailure) {
                typeWriter(UI.gameOutput, 'Suddenly, the facility is plunged into total darkness. Emergency lights flicker on.', '#ffe066');
                GameState.worldEvents = GameState.worldEvents || {};
                GameState.worldEvents.powerFailure = true;
                // Example: set all rooms to lightsOut
                Object.values(rooms).forEach(r => { if (r.states) r.states.lightsOut = true; });
                updateUI();
            }
        }
    },
    // Narrative twist event
    {
        id: 'mysterious_note',
        type: EVENT_TYPES.NARRATIVE,
        trigger: () => {
            typeWriter(UI.gameOutput, 'You find a crumpled note: "Trust no one. Not even yourself."', '#a0e7e5');
            addJournalEntry('Found a mysterious note: "Trust no one. Not even yourself."');
        }
    },
    // Rare hallucination event
    {
        id: 'rare_hallucination',
        type: EVENT_TYPES.HORROR,
        trigger: () => {
            if (GameState.sanityLevel < 20 && Math.random() < 0.5) {
                typeWriter(UI.gameOutput, 'A grotesque figure crawls from the ceiling, only to vanish when you blink.', '#ff2a7f');
                showHallucinationOverlay && showHallucinationOverlay('grotesque');
            }
        }
    },
    // Environmental hazard event
    {
        id: 'gas_leak',
        type: EVENT_TYPES.ENVIRONMENT,
        trigger: () => {
            if (!GameState.worldEvents?.gasLeak) {
                typeWriter(UI.gameOutput, 'A hissing sound fills the air. You smell something acridthere is a gas leak nearby!', '#ffe066');
                GameState.worldEvents = GameState.worldEvents || {};
                GameState.worldEvents.gasLeak = true;
                // Example: reduce player stats or add a new objective
                GameState.sanityLevel = Math.max(0, GameState.sanityLevel - 3);
                GameState.objectives.push({ text: 'Find and seal the gas leak', completed: false });
                updateUI();
            }
        }
    },
    // Puzzle escalation event
    {
        id: 'puzzle_escalation',
        type: EVENT_TYPES.PUZZLE,
        trigger: () => {
            typeWriter(UI.gameOutput, 'A new puzzle mechanism activates: the code sequence is now reversed.', '#00b4d8');
            // Example: update puzzle state here
        }
    },
    // Custom: player inventory event
    {
        id: 'inventory_weight_warning',
        type: EVENT_TYPES.ENVIRONMENT,
        trigger: () => {
            const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0);
            if (currentWeight > MAX_INVENTORY_WEIGHT * 0.8) {
                typeWriter(UI.gameOutput, 'You feel weighed down by your belongings. Movement becomes sluggish.', '#ffe066');
            }
        }
    },
    // Add more events here for future expansion
];

function triggerRandomEvent(type = null) {
    let pool = eventPool;
    if (type) pool = eventPool.filter(e => e.type === type);
    if (pool.length === 0) return;
    const event = pool[Math.floor(Math.random() * pool.length)];
    event.trigger();
}

// Hook: Call this in the main game loop or after certain player actions
function maybeTriggerEvent() {
    // 20% chance to trigger an event after a player action
    if (Math.random() < 0.2) {
        triggerRandomEvent();
    }
}

// Demo command: allow manual event triggering for testing
window.triggerEventDemo = function(type) {
    triggerRandomEvent(type);
};

// Integrate with command parser (example: after player input)
const originalProcessPlayerInput = processPlayerInput;
processPlayerInput = async function(input) {
    await originalProcessPlayerInput.call(this, input);
    maybeTriggerEvent();
};
    window.addEventListener('beforeunload', saveStateToSession);
    window.addEventListener('DOMContentLoaded', () => {
        console.log('SYNAPSE: DOM Content Loaded - Starting initialization...');
        
        // Check if required dependencies are loaded
        if (typeof window.tailwindcss === 'undefined' && !document.querySelector('[class*="bg-"]')) {
            console.warn('SYNAPSE: Tailwind CSS may not have loaded properly');
        }
        
        // Initialize UI elements after DOM is loaded
        UI = {
            appContainer: document.getElementById('app-container'), 
            startScreen: document.getElementById('start-screen'), 
            gameScreen: document.getElementById('game-screen'),
            newGameBtn: document.getElementById('new-game-btn'), 
            loadGameBtn: document.getElementById('load-game-btn'), 
            viewFeaturesBtn: document.getElementById('view-features-btn'),
            startSettingsBtn: document.getElementById('start-settings-btn'),
            playerSetup: document.getElementById('player-setup'), 
            startOptions: document.getElementById('start-options'), 
            playerNameInput: document.getElementById('player-name'),
            playerBackstoryInput: document.getElementById('player-backstory'), 
            startGameBtn: document.getElementById('start-game-btn'), 
            difficultyBtns: document.querySelectorAll('.difficulty-btn'),
            backToStartBtn: document.getElementById('back-to-start-btn'),
            gameOutput: document.getElementById('game-output'), 
            playerInput: document.getElementById('player-input'),
            stats: { 
                panel: document.getElementById('stats-panel'), 
                name: document.getElementById('player-name-display'), 
                awareness: document.getElementById('awareness-display'), 
                sanity: document.getElementById('sanity-display'), 
                tone: document.getElementById('tone-display'), 
                turn: document.getElementById('turn-display') 
            },
            objectives: { 
                panel: document.getElementById('objectives-panel'), 
                list: document.getElementById('objectives-list') 
            },
            inventory: { 
                panel: document.getElementById('inventory-panel'), 
                weight: document.getElementById('inventory-weight'), 
                list: document.getElementById('inventory-list') 
            },
            journal: { 
                panel: document.getElementById('journal-panel'), 
                list: document.getElementById('journal-list') 
            },
            dialogueOptionsContainer: document.getElementById('dialogue-options'), 
            modal: document.getElementById('modal'), 
            modalContent: document.getElementById('modal-content'),
            introTextContainer: document.getElementById('intro-text-container'), 
            viewBackstoriesBtn: document.getElementById('view-backstories-btn'),
            abilityDisplay: document.getElementById('ability-display'), 
            statusBtn: document.getElementById('status-btn'), 
            backgroundCanvas: document.getElementById('background-canvas'),
            mapCanvas: document.getElementById('map-canvas'),
            mapPanel: document.getElementById('map-panel'),
            mapToggleBtn: document.getElementById('map-toggle-btn'),
            mapLayersBtn: document.getElementById('map-layers-btn'),
            mapExpandIcon: document.getElementById('map-expand-icon'),
            mapMinimizeIcon: document.getElementById('map-minimize-icon'),
            micBtn: document.getElementById('mic-btn'),
            viewProgressionBtn: document.getElementById('view-progression-btn'),
            langEnBtn: document.getElementById('lang-en-btn'), 
            langSvBtn: document.getElementById('lang-sv-btn'),
            langButtons: document.getElementById('lang-buttons'),
            setupLangButtons: document.getElementById('setup-lang-buttons'),
            setupSettingsBtn: document.getElementById('setup-settings-btn'),
            setupFeaturesBtn: document.getElementById('setup-features-btn'),
            autocompleteBox: document.getElementById('autocomplete-box'),
        };
        
        // Validate that critical UI elements were found
        const criticalElements = ['appContainer', 'startScreen', 'gameScreen', 'newGameBtn'];
        const missingElements = criticalElements.filter(elem => !UI[elem]);
        if (missingElements.length > 0) {
            console.error('SYNAPSE: Critical UI elements missing:', missingElements);
            console.error('SYNAPSE: This indicates the HTML structure may be corrupted or the page didn\'t load properly');
        } else {
            console.log('SYNAPSE: All critical UI elements found successfully');
        }
        
        // Load player choices first to pre-populate the setup screen
        loadPlayerChoices();

        UI.playerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { 
                const input = UI.playerInput.value.trim(); 
                if(input) { processPlayerInput(input); }
            } else if (e.key === 'ArrowUp') { e.preventDefault(); if (commandHistory.length > 0) { commandHistoryIndex = Math.max(0, commandHistoryIndex - 1); UI.playerInput.value = commandHistory[commandHistoryIndex] || ''; }
            } else if (e.key === 'ArrowDown') { e.preventDefault(); if (commandHistory.length > 0) { commandHistoryIndex = Math.min(commandHistory.length, commandHistoryIndex + 1); UI.playerInput.value = commandHistory[commandHistoryIndex] || ''; } }
        });
        
        UI.playerInput.addEventListener('input', updateAutocomplete);
        UI.autocompleteBox.addEventListener('click', (e) => {
            if (e.target.matches('.autocomplete-item')) {
                UI.playerInput.value = e.target.dataset.suggestion;
                UI.autocompleteBox.classList.add('hidden');
                UI.playerInput.focus();
            }
        });

        UI.gameOutput.addEventListener('click', (e) => {
            if (e.target.matches('.clickable-object')) {
                const objectName = e.target.dataset.objectName;
                UI.playerInput.value = `examine ${objectName}`;
                UI.playerInput.focus();
            }
        });

        const setupButtonClick = (button, handler, ...args) => {
            if (!button) return;
            button.addEventListener('click', async () => {
                await initializeAudio();
                playSound('uiClick');
                handler(...args);
            });
        };

        setupButtonClick(UI.newGameBtn, () => { 
            sessionStorage.removeItem('synapse_session_v15_autosave'); 
            sessionStorage.removeItem('synapse_session_v15_screen_state'); 
            UI.startScreen.classList.add('hidden'); 
            UI.startScreen.classList.remove('flex');
            UI.playerSetup.classList.remove('hidden'); 
            UI.playerSetup.classList.add('flex'); 
            updateAbilityDisplay(); 
        });
        setupButtonClick(UI.loadGameBtn, () => { 
            sessionStorage.removeItem('synapse_session_v15_autosave'); 
            sessionStorage.removeItem('synapse_session_v15_screen_state'); 
            loadGame(); 
        });
        setupButtonClick(UI.backToStartBtn, () => {
            UI.playerSetup.classList.add('hidden');
            UI.playerSetup.classList.remove('flex');
            UI.startScreen.classList.remove('hidden');
            UI.startScreen.classList.add('flex');
        });
        setupButtonClick(UI.viewFeaturesBtn, showFeaturesModal);
        setupButtonClick(UI.startSettingsBtn, () => showSettingsModal(false));
        setupButtonClick(UI.startGameBtn, startGame);
        setupButtonClick(UI.viewBackstoriesBtn, showBackstoryModal);
        setupButtonClick(UI.statusBtn, showStatusModal);
        setupButtonClick(UI.viewProgressionBtn, showProgressionModal);
        setupButtonClick(UI.mapToggleBtn, toggleMapFullscreen);
        setupButtonClick(UI.mapLayersBtn, () => { showGuidance("Map layer functionality is not yet implemented."); });
        
        const setupLangEnBtn = UI.setupLangButtons.children[0];
        const setupLangSvBtn = UI.setupLangButtons.children[1];
        setupButtonClick(UI.langEnBtn, setLanguage, 'en');
        setupButtonClick(UI.langSvBtn, setLanguage, 'sv');
        setupButtonClick(setupLangEnBtn, setLanguage, 'en');
        setupButtonClick(setupLangSvBtn, setLanguage, 'sv');

        setupButtonClick(UI.setupSettingsBtn, () => showSettingsModal(false));
        setupButtonClick(UI.setupFeaturesBtn, showFeaturesModal);

        UI.difficultyBtns.forEach(btn => { setupButtonClick(btn, () => { UI.difficultyBtns.forEach(b => b.classList.remove('button-primary')); btn.classList.add('button-primary'); updateAbilityDisplay(); }); });
        UI.playerBackstoryInput.addEventListener('input', updateAbilityDisplay);
        
        if (SpeechRecognition) {
            setupButtonClick(UI.micBtn, startSpeechRecognition);
        } else {
            UI.micBtn.style.display = 'none';
        }

        let restored = false;

        if (loadStateFromSession()) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameLoop();
            restored = true;
        } 
        else {
            const screenStateData = sessionStorage.getItem('synapse_session_v15_screen_state');
            if (screenStateData) {
                try {
                    const startState = JSON.parse(screenStateData);
                    // Language is already set by loadPlayerChoices, no need to re-set here
                    // setLanguage(startState.language || 'en'); 

                    if (startState.isPlayerSetupVisible) {
                        UI.startScreen.classList.add('hidden');
                        UI.startScreen.classList.remove('flex');
                        UI.playerSetup.classList.remove('hidden');
                        UI.playerSetup.classList.add('flex');
                        
                        UI.playerNameInput.value = startState.playerName || '';
                        UI.playerBackstoryInput.value = startState.playerBackstory || '';
                        UI.difficultyBtns.forEach(btn => btn.classList.remove('button-primary'));
                        const difficultyBtn = Array.from(UI.difficultyBtns).find(b => b.dataset.difficulty === startState.difficulty) || UI.difficultyBtns[1];
                        difficultyBtn.classList.add('button-primary');
                        updateAbilityDisplay();
                    }
                    restored = true;
                } catch (e) {
                    console.error("Failed to restore screen state:", e);
                    sessionStorage.removeItem('synapse_session_v15_screen_state');
                }
            }
        }

        if (!restored) {
            resetGameState();
            // Language is already set by loadPlayerChoices, no need to re-set here
            // setLanguage('en'); 
            setTimeout(() => {
                const playerLayout = roomLayout[GameState.currentRoom];
                if(playerLayout && UI.mapCanvas.offsetWidth > 0 && UI.mapCanvas.offsetHeight > 0) {
                     mapState.offsetX = (UI.mapCanvas.offsetWidth / 2) - (playerLayout.x + playerLayout.w / 2) * mapState.scale;
                     mapState.offsetY = (UI.mapCanvas.offsetHeight / 2) - (playerLayout.y + playerLayout.h / 2) * mapState.scale;
                }
            }, 100);
        }

        initMapControls();
        setupBackgroundAnimation();
        
        // --- PWA FUNCTIONALITY ---
        let deferredPrompt;
        let pwaInstalled = false;
        
        // Check if device is mobile/tablet
        function isMobileDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile/.test(userAgent);
            const isTablet = /ipad|android(?!.*mobile)|tablet/.test(userAgent);
            const isSmallScreen = window.innerWidth <= 768 || window.innerHeight <= 768;
            return (isMobile || isTablet) && isSmallScreen;
        }
        
        // Check if PWA can be installed
        function canInstallPWA() {
            return !pwaInstalled && deferredPrompt && isMobileDevice();
        }
        
        // Show install prompt
        function showInstallPrompt() {
            if (!canInstallPWA()) return;
            
            const installBtn = document.createElement('button');
            installBtn.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2 mt-4';
            installBtn.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                Install SYNAPSE App
            `;
            installBtn.onclick = installApp;
            
            // Add to start screen if visible
            if (!UI.startScreen.classList.contains('hidden')) {
                const langButtons = UI.startScreen.querySelector('#lang-buttons');
                if (langButtons) {
                    langButtons.appendChild(installBtn);
                }
            }
        }
        
        // Install PWA
        async function installApp() {
            if (!deferredPrompt) return;
            
            try {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    pwaInstalled = true;
                    console.log('PWA installed successfully');
                    // Remove install button
                    document.querySelectorAll('button').forEach(btn => {
                        if (btn.textContent.includes('Install SYNAPSE App')) {
                            btn.remove();
                        }
                    });
                }
                
                deferredPrompt = null;
            } catch (error) {
                console.error('PWA installation failed:', error);
            }
        }
        
        // PWA event listeners
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Only show install prompt on mobile devices
            if (isMobileDevice()) {
                setTimeout(showInstallPrompt, 2000); // Show after 2 seconds
            }
        });
        
        window.addEventListener('appinstalled', () => {
            pwaInstalled = true;
            deferredPrompt = null;
            console.log('PWA was installed');
        });
        
        // Register service worker
        if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        } else if (window.location.protocol === 'file:') {
            console.warn('Service Worker not supported on file:// protocol. Please use HTTP/HTTPS server.');
        }
        
        // Mobile scroll functionality
        if (window.innerWidth <= 768) {
            const gameOutput = document.getElementById('game-output');
            const scrollIndicator = document.getElementById('mobile-scroll-indicator');
            
            // Auto-scroll to bottom when new content is added
            const observer = new MutationObserver(() => {
                if (GameState.settings?.autoScroll) {
                    gameOutput.scrollTop = gameOutput.scrollHeight;
                }
            });
            
            if (gameOutput) {
                observer.observe(gameOutput, { childList: true, subtree: true });
                
                // Show/hide scroll indicator based on scroll position
                gameOutput.addEventListener('scroll', () => {
                    if (scrollIndicator) {
                        const isAtBottom = gameOutput.scrollTop + gameOutput.clientHeight >= gameOutput.scrollHeight - 10;
                        scrollIndicator.style.opacity = isAtBottom ? '0.3' : '1';
                    }
                });
                
                // Click scroll indicator to scroll to bottom
                if (scrollIndicator) {
                    scrollIndicator.addEventListener('click', () => {
                        gameOutput.scrollTo({ top: gameOutput.scrollHeight, behavior: 'smooth' });
                    });
                }
            }
        }
        
        // Enhanced accessibility event listeners
        document.addEventListener('keydown', (e) => {
            if (GameState.settings?.keyboardNavigation) {
                // Tab navigation enhancement
                if (e.key === 'Tab') {
                    const focusableElements = document.querySelectorAll('button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    const currentIndex = Array.from(focusableElements).indexOf(document.activeElement);
                    
                    if (e.shiftKey) {
                        // Previous element
                        const prevIndex = currentIndex - 1;
                        if (prevIndex >= 0) {
                            e.preventDefault();
                            focusableElements[prevIndex].focus();
                        }
                    } else {
                        // Next element
                        const nextIndex = currentIndex + 1;
                        if (nextIndex < focusableElements.length) {
                            e.preventDefault();
                            focusableElements[nextIndex].focus();
                        }
                    }
                }
                
                // Escape key to close modals
                if (e.key === 'Escape') {
                    const modal = document.getElementById('modal');
                    if (modal && !modal.classList.contains('hidden')) {
                        closeModal();
                    }
                }
            }
        });
        
        // Enhanced TTS with speed control
        const originalSpeakText = window.speakText;
        window.speakText = function(text) {
            if (GameState.settings?.screenReader || GameState.settings?.audioDescriptions) {
                const utterance = new SpeechSynthesisUtterance(text.replace(/<[^>]*>/g, ''));
                utterance.rate = GameState.settings?.ttsSpeed || 1;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
        };
        
        console.log('SYNAPSE: Initialization completed successfully!');
    });

    // Voice Control System
    let voiceRecognition = null;
    let voiceControlActive = false;

    function initializeVoiceControl() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            console.warn('Speech recognition not supported in this browser');
            return false;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        voiceRecognition = new SpeechRecognition();
        
        voiceRecognition.continuous = true;
        voiceRecognition.interimResults = false;
        voiceRecognition.lang = currentLanguage === 'sv' ? 'sv-SE' : 'en-US';

        voiceRecognition.onresult = (event) => {
            const command = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
            processVoiceCommand(command);
        };

        voiceRecognition.onerror = (event) => {
            console.warn('Voice recognition error:', event.error);
            // Handle specific errors gracefully
            if (event.error === 'no-speech') {
                console.log('No speech detected, continuing to listen...');
                return; // Don't log as error, this is normal
            }
            if (event.error === 'network') {
                console.warn('Network error during voice recognition');
                return;
            }
            if (event.error === 'not-allowed') {
                console.warn('Microphone access denied');
                speakText('Microphone access is required for voice commands');
                return;
            }
            // For other errors, attempt to restart
            if (voiceControlActive) {
                setTimeout(() => {
                    try {
                        voiceRecognition.start();
                    } catch (e) {
                        console.warn('Could not restart voice recognition:', e.message);
                    }
                }, 1000);
            }
        };

        return true;
    }

    function processVoiceCommand(command) {
        const lang = currentLanguage;
        const lowerCommand = command.toLowerCase();
        
        // Define commands for both languages
        const commands = {
            'en': {
                // Navigation commands
                'settings': () => showSettingsModal(),
                'pause': () => showPauseMenu(),
                'resume': () => hideModal(),
                'main menu': () => returnToMainMenu(),
                'close': () => hideModal(),
                'help': () => showVoiceCommands(),
                
                // Accessibility Level Controls
                'contrast off': () => setAccessibilityLevel('contrastLevel', 'off'),
                'contrast medium': () => setAccessibilityLevel('contrastLevel', 'medium'),
                'contrast high': () => setAccessibilityLevel('contrastLevel', 'high'),
                'contrast maximum': () => setAccessibilityLevel('contrastLevel', 'maximum'),
                
                'text small': () => setAccessibilityLevel('textSize', 'small'),
                'text normal': () => setAccessibilityLevel('textSize', 'normal'),
                'text large': () => setAccessibilityLevel('textSize', 'large'),
                'text extra large': () => setAccessibilityLevel('textSize', 'xl'),
                'text very large': () => setAccessibilityLevel('textSize', 'xxl'),
                
                'motion full': () => setAccessibilityLevel('motionLevel', 'full'),
                'motion reduced': () => setAccessibilityLevel('motionLevel', 'reduced'),
                'motion minimal': () => setAccessibilityLevel('motionLevel', 'minimal'),
                'motion none': () => setAccessibilityLevel('motionLevel', 'none'),
                
                'audio descriptions off': () => setAccessibilityLevel('audioDescLevel', 'off'),
                'audio descriptions basic': () => setAccessibilityLevel('audioDescLevel', 'basic'),
                'audio descriptions detailed': () => setAccessibilityLevel('audioDescLevel', 'detailed'),
                'audio descriptions comprehensive': () => setAccessibilityLevel('audioDescLevel', 'comprehensive'),
                
                'keyboard basic': () => setAccessibilityLevel('keyboardLevel', 'basic'),
                'keyboard enhanced': () => setAccessibilityLevel('keyboardLevel', 'enhanced'),
                'keyboard full': () => setAccessibilityLevel('keyboardLevel', 'full'),
                
                'focus subtle': () => setAccessibilityLevel('focusLevel', 'subtle'),
                'focus clear': () => setAccessibilityLevel('focusLevel', 'clear'),
                'focus bold': () => setAccessibilityLevel('focusLevel', 'bold'),
                
                'colorblind none': () => setAccessibilityLevel('colorblindType', 'none'),
                'colorblind protanopia': () => setAccessibilityLevel('colorblindType', 'protanopia'),
                'colorblind deuteranopia': () => setAccessibilityLevel('colorblindType', 'deuteranopia'),
                'colorblind tritanopia': () => setAccessibilityLevel('colorblindType', 'tritanopia'),
                'colorblind full': () => setAccessibilityLevel('colorblindType', 'full'),
                
                'voice off': () => setAccessibilityLevel('voiceLevel', 'off'),
                'voice basic': () => setAccessibilityLevel('voiceLevel', 'basic'),
                'voice advanced': () => setAccessibilityLevel('voiceLevel', 'advanced'),
                'voice full': () => setAccessibilityLevel('voiceLevel', 'full'),
                
                'magnify off': () => setAccessibilityLevel('magnifyLevel', 'off'),
                'magnify one and half': () => setAccessibilityLevel('magnifyLevel', '1.5x'),
                'magnify two': () => setAccessibilityLevel('magnifyLevel', '2x'),
                'magnify three': () => setAccessibilityLevel('magnifyLevel', '3x'),
                'magnify custom': () => setAccessibilityLevel('magnifyLevel', 'custom'),
                
                // Basic accessibility toggles
                'screen reader on': () => toggleSetting('screenReader', true),
                'screen reader off': () => toggleSetting('screenReader', false),
                'dyslexia font on': () => toggleSetting('dyslexiaFont', true),
                'dyslexia font off': () => toggleSetting('dyslexiaFont', false),
                'auto scroll on': () => toggleSetting('autoScroll', true),
                'auto scroll off': () => toggleSetting('autoScroll', false),
                'click feedback on': () => toggleSetting('clickFeedback', true),
                'click feedback off': () => toggleSetting('clickFeedback', false),
                'simplified ui on': () => toggleSetting('simplifiedUI', true),
                'simplified ui off': () => toggleSetting('simplifiedUI', false),
                'sticky keys on': () => toggleSetting('stickyKeys', true),
                'sticky keys off': () => toggleSetting('stickyKeys', false),
                'one hand mode on': () => toggleSetting('oneHandMode', true),
                'one hand mode off': () => toggleSetting('oneHandMode', false),
                'visual notifications on': () => toggleSetting('visualNotifications', true),
                'visual notifications off': () => toggleSetting('visualNotifications', false),
                'audio cues on': () => toggleSetting('audioCues', true),
                'audio cues off': () => toggleSetting('audioCues', false),
                'reading support on': () => toggleSetting('readingSupport', true),
                'reading support off': () => toggleSetting('readingSupport', false),
                'seizure protection on': () => toggleSetting('seizureProtection', true),
                'seizure protection off': () => toggleSetting('seizureProtection', false),
                'haptic feedback on': () => toggleSetting('hapticFeedback', true),
                'haptic feedback off': () => toggleSetting('hapticFeedback', false),
                'gesture controls on': () => toggleSetting('gestureControls', true),
                'gesture controls off': () => toggleSetting('gestureControls', false),
                'cognitive load on': () => toggleSetting('cognitiveLoad', true),
                'cognitive load off': () => toggleSetting('cognitiveLoad', false),
                'eye tracking on': () => toggleSetting('eyeTracking', true),
                'eye tracking off': () => toggleSetting('eyeTracking', false),
                'switch control on': () => toggleSetting('switchControl', true),
                'switch control off': () => toggleSetting('switchControl', false),
                'timeout extensions on': () => toggleSetting('timeoutExtensions', true),
                'timeout extensions off': () => toggleSetting('timeoutExtensions', false),
                'memory assistance on': () => toggleSetting('memoryAssistance', true),
                'memory assistance off': () => toggleSetting('memoryAssistance', false),
                
                // TTS Speed controls
                'speech slow': () => setTTSSpeed(0.5),
                'speech normal': () => setTTSSpeed(1),
                'speech fast': () => setTTSSpeed(1.5),
                'speech very fast': () => setTTSSpeed(2),
                
                // UI Scale controls
                'ui small': () => setUIScale(0.8),
                'ui normal': () => setUIScale(1),
                'ui large': () => setUIScale(1.2),
                'ui extra large': () => setUIScale(1.5),
                
                // Theme controls
                'theme green': () => setTheme('green'),
                'theme amber': () => setTheme('amber'),
                'theme blue': () => setTheme('blue'),
                
                // Font controls
                'font space mono': () => setFont('Space Mono'),
                'font courier': () => setFont('Courier Prime'),
                
                // Text speed controls
                'text speed fast': () => setTextSpeed(TextSpeed.Fast),
                'text speed normal': () => setTextSpeed(TextSpeed.Normal),
                'text speed slow': () => setTextSpeed(TextSpeed.Slow),
                
                // Sound controls
                'sound on': () => toggleSetting('sound.master', true),
                'sound off': () => toggleSetting('sound.master', false),
                'effects on': () => toggleSetting('sound.item', true),
                'effects off': () => toggleSetting('sound.item', false),
                'awareness sound on': () => toggleSetting('sound.awareness', true),
                'awareness sound off': () => toggleSetting('sound.awareness', false),
                'sanity sound on': () => toggleSetting('sound.sanity', true),
                'sanity sound off': () => toggleSetting('sound.sanity', false),
                
                // Visual effects
                'crt effect on': () => toggleSetting('glitchEffect', true),
                'crt effect off': () => toggleSetting('glitchEffect', false),
                'colorblind mode on': () => toggleSetting('colorblindMode', true),
                'colorblind mode off': () => toggleSetting('colorblindMode', false),
                
                // Game actions
                'new game': () => document.getElementById('new-game-btn')?.click(),
                'load game': () => document.getElementById('load-game-btn')?.click(),
                'save game': () => saveGame(),
                'reset settings': () => resetSettings(),
                
                // Reading commands
                'read text': () => readCurrentText(),
                'stop reading': () => speechSynthesis.cancel(),
                
                // Language switching
                'switch to swedish': () => switchLanguage('sv'),
                'switch to english': () => switchLanguage('en')
            },
            'sv': {
                // Navigationskommandon
                'instllningar': () => showSettingsModal(),
                'paus': () => showPauseMenu(),
                'teruppta': () => hideModal(),
                'huvudmeny': () => returnToMainMenu(),
                'stng': () => hideModal(),
                'hjlp': () => showVoiceCommands(),
                
                // Tillgnglighetsnivkontroller
                'kontrast av': () => setAccessibilityLevel('contrastLevel', 'off'),
                'kontrast medium': () => setAccessibilityLevel('contrastLevel', 'medium'),
                'kontrast hg': () => setAccessibilityLevel('contrastLevel', 'high'),
                'kontrast maximum': () => setAccessibilityLevel('contrastLevel', 'maximum'),
                
                'text liten': () => setAccessibilityLevel('textSize', 'small'),
                'text normal': () => setAccessibilityLevel('textSize', 'normal'),
                'text stor': () => setAccessibilityLevel('textSize', 'large'),
                'text extra stor': () => setAccessibilityLevel('textSize', 'xl'),
                'text mycket stor': () => setAccessibilityLevel('textSize', 'xxl'),
                
                'rrelse full': () => setAccessibilityLevel('motionLevel', 'full'),
                'rrelse reducerad': () => setAccessibilityLevel('motionLevel', 'reduced'),
                'rrelse minimal': () => setAccessibilityLevel('motionLevel', 'minimal'),
                'rrelse ingen': () => setAccessibilityLevel('motionLevel', 'none'),
                
                'ljudbeskrivningar av': () => setAccessibilityLevel('audioDescLevel', 'off'),
                'ljudbeskrivningar grundlggande': () => setAccessibilityLevel('audioDescLevel', 'basic'),
                'ljudbeskrivningar detaljerad': () => setAccessibilityLevel('audioDescLevel', 'detailed'),
                'ljudbeskrivningar omfattande': () => setAccessibilityLevel('audioDescLevel', 'comprehensive'),
                
                'tangentbord grundlggande': () => setAccessibilityLevel('keyboardLevel', 'basic'),
                'tangentbord frbttrad': () => setAccessibilityLevel('keyboardLevel', 'enhanced'),
                'tangentbord fullstndig': () => setAccessibilityLevel('keyboardLevel', 'full'),
                
                'fokus subtil': () => setAccessibilityLevel('focusLevel', 'subtle'),
                'fokus tydlig': () => setAccessibilityLevel('focusLevel', 'clear'),
                'fokus kraftig': () => setAccessibilityLevel('focusLevel', 'bold'),
                
                'frgblind ingen': () => setAccessibilityLevel('colorblindType', 'none'),
                'frgblind protanopi': () => setAccessibilityLevel('colorblindType', 'protanopia'),
                'frgblind deuteranopi': () => setAccessibilityLevel('colorblindType', 'deuteranopia'),
                'frgblind tritanopi': () => setAccessibilityLevel('colorblindType', 'tritanopia'),
                'frgblind fullstndig': () => setAccessibilityLevel('colorblindType', 'full'),
                
                'rst av': () => setAccessibilityLevel('voiceLevel', 'off'),
                'rst grundlggande': () => setAccessibilityLevel('voiceLevel', 'basic'),
                'rst avancerad': () => setAccessibilityLevel('voiceLevel', 'advanced'),
                'rst fullstndig': () => setAccessibilityLevel('voiceLevel', 'full'),
                
                'frstoring av': () => setAccessibilityLevel('magnifyLevel', 'off'),
                'frstoring en och halv': () => setAccessibilityLevel('magnifyLevel', '1.5x'),
                'frstoring tv': () => setAccessibilityLevel('magnifyLevel', '2x'),
                'frstoring tre': () => setAccessibilityLevel('magnifyLevel', '3x'),
                'frstoring anpassad': () => setAccessibilityLevel('magnifyLevel', 'custom'),
                
                // Grundlggande tillgnglighetsvxlingar
                'skrmlsare p': () => toggleSetting('screenReader', true),
                'skrmlsare av': () => toggleSetting('screenReader', false),
                'dyslexitypsnitt p': () => toggleSetting('dyslexiaFont', true),
                'dyslexitypsnitt av': () => toggleSetting('dyslexiaFont', false),
                'automatisk scroll p': () => toggleSetting('autoScroll', true),
                'automatisk scroll av': () => toggleSetting('autoScroll', false),
                'klickljud p': () => toggleSetting('clickFeedback', true),
                'klickljud av': () => toggleSetting('clickFeedback', false),
                'frenklat ui p': () => toggleSetting('simplifiedUI', true),
                'frenklat ui av': () => toggleSetting('simplifiedUI', false),
                'klistriga tangenter p': () => toggleSetting('stickyKeys', true),
                'klistriga tangenter av': () => toggleSetting('stickyKeys', false),
                'enhandslge p': () => toggleSetting('oneHandMode', true),
                'enhandslge av': () => toggleSetting('oneHandMode', false),
                'visuella notifieringar p': () => toggleSetting('visualNotifications', true),
                'visuella notifieringar av': () => toggleSetting('visualNotifications', false),
                'ljudsignaler p': () => toggleSetting('audioCues', true),
                'ljudsignaler av': () => toggleSetting('audioCues', false),
                'lsstd p': () => toggleSetting('readingSupport', true),
                'lsstd av': () => toggleSetting('readingSupport', false),
                'anfallsskydd p': () => toggleSetting('seizureProtection', true),
                'anfallsskydd av': () => toggleSetting('seizureProtection', false),
                'haptisk terkoppling p': () => toggleSetting('hapticFeedback', true),
                'haptisk terkoppling av': () => toggleSetting('hapticFeedback', false),
                'gestkontroller p': () => toggleSetting('gestureControls', true),
                'gestkontroller av': () => toggleSetting('gestureControls', false),
                'kognitiv belastning p': () => toggleSetting('cognitiveLoad', true),
                'kognitiv belastning av': () => toggleSetting('cognitiveLoad', false),
                'gonsprning p': () => toggleSetting('eyeTracking', true),
                'gonsprning av': () => toggleSetting('eyeTracking', false),
                'vxelkontroll p': () => toggleSetting('switchControl', true),
                'vxelkontroll av': () => toggleSetting('switchControl', false),
                'timeout frlngningar p': () => toggleSetting('timeoutExtensions', true),
                'timeout frlngningar av': () => toggleSetting('timeoutExtensions', false),
                'minnesassistans p': () => toggleSetting('memoryAssistance', true),
                'minnesassistans av': () => toggleSetting('memoryAssistance', false),
                
                // TTS-hastighetskontroller
                'tal lngsamt': () => setTTSSpeed(0.5),
                'tal normalt': () => setTTSSpeed(1),
                'tal snabbt': () => setTTSSpeed(1.5),
                'tal mycket snabbt': () => setTTSSpeed(2),
                
                // UI-skalningskontroller
                'ui liten': () => setUIScale(0.8),
                'ui normal': () => setUIScale(1),
                'ui stor': () => setUIScale(1.2),
                'ui extra stor': () => setUIScale(1.5),
                
                // Temakontroller
                'tema grn': () => setTheme('green'),
                'tema gul': () => setTheme('amber'),
                'tema bl': () => setTheme('blue'),
                
                // Typsnittkontroller
                'typsnitt space mono': () => setFont('Space Mono'),
                'typsnitt courier': () => setFont('Courier Prime'),
                
                // Texthastighet
                'texthastighet snabb': () => setTextSpeed(TextSpeed.Fast),
                'texthastighet normal': () => setTextSpeed(TextSpeed.Normal),
                'texthastighet lngsam': () => setTextSpeed(TextSpeed.Slow),
                
                // Ljudkontroller
                'ljud p': () => toggleSetting('sound.master', true),
                'ljud av': () => toggleSetting('sound.master', false),
                'effekter p': () => toggleSetting('sound.item', true),
                'effekter av': () => toggleSetting('sound.item', false),
                'medvetenhet ljud p': () => toggleSetting('sound.awareness', true),
                'medvetenhet ljud av': () => toggleSetting('sound.awareness', false),
                'sinnesro ljud p': () => toggleSetting('sound.sanity', true),
                'sinnesro ljud av': () => toggleSetting('sound.sanity', false),
                
                // Visuella effekter
                'crt effekt p': () => toggleSetting('glitchEffect', true),
                'crt effekt av': () => toggleSetting('glitchEffect', false),
                'frgblindlge p': () => toggleSetting('colorblindMode', true),
                'frgblindlge av': () => toggleSetting('colorblindMode', false),
                
                // Spelhandlingar
                'nytt spel': () => document.getElementById('new-game-btn')?.click(),
                'ladda spel': () => document.getElementById('load-game-btn')?.click(),
                'spara spel': () => saveGame(),
                'terstll instllningar': () => resetSettings(),
                
                // Lskommandon
                'ls text': () => readCurrentText(),
                'sluta lsa': () => speechSynthesis.cancel(),
                
                // Sprkvxling
                'byt till engelska': () => switchLanguage('en'),
                'byt till svenska': () => switchLanguage('sv')
            }
        };

        const langCommands = commands[lang] || commands['en'];
        
        if (langCommands[lowerCommand]) {
            langCommands[lowerCommand]();
            speakText(`${t('voice_command_executed')}: ${command}`);
        } else {
            speakText(t('voice_command_not_recognized'));
        }
    }

    function toggleSetting(setting, value) {
        const keys = setting.split('.');
        if (keys.length === 2) {
            GameState.settings[keys[0]][keys[1]] = value;
        } else {
            GameState.settings[setting] = value;
        }
        saveSettings();
        applySettings();
        const status = value ? t('voice_setting_enabled') : t('voice_setting_disabled');
        speakText(`${setting.replace('sound.', '').replace(/([A-Z])/g, ' $1').toLowerCase()} ${status}`);
    }

    function setAccessibilityLevel(setting, level) {
        GameState.settings[setting] = level;
        
        // Update related boolean settings
        if (setting === 'contrastLevel') {
            GameState.settings.highContrast = level !== 'off';
        } else if (setting === 'textSize') {
            GameState.settings.largeText = level !== 'normal' && level !== 'small';
        } else if (setting === 'motionLevel') {
            GameState.settings.reducedMotion = level !== 'full';
        } else if (setting === 'audioDescLevel') {
            GameState.settings.audioDescriptions = level !== 'off';
        } else if (setting === 'keyboardLevel') {
            GameState.settings.keyboardNavigation = true;
        } else if (setting === 'focusLevel') {
            GameState.settings.focusIndicators = true;
        } else if (setting === 'colorblindType') {
            GameState.settings.colorBlindSupport = level !== 'none';
        } else if (setting === 'voiceLevel') {
            GameState.settings.voiceCommands = level !== 'off';
        } else if (setting === 'magnifyLevel') {
            GameState.settings.magnification = level !== 'off';
        }
        
        saveSettings();
        applySettings();
        speakText(`${setting.replace(/([A-Z])/g, ' $1').toLowerCase()} ${t('voice_setting_set_to')} ${level}`);
    }

    function setTTSSpeed(speed) {
        GameState.settings.ttsSpeed = speed;
        saveSettings();
        const speedText = speed === 0.5 ? t('voice_slow') : speed === 1 ? t('voice_normal') : speed === 1.5 ? t('voice_fast') : t('voice_very_fast');
        speakText(`${t('voice_speed_set_to')} ${speedText}`);
    }

    function setUIScale(scale) {
        GameState.settings.uiScale = scale;
        saveSettings();
        applySettings();
        const scaleText = scale === 0.8 ? t('voice_small') : scale === 1 ? t('voice_normal') : scale === 1.2 ? t('voice_large') : t('voice_extra_large');
        speakText(`${t('voice_ui_scale_set_to')} ${scaleText}`);
    }

    function setTheme(theme) {
        GameState.settings.theme = theme;
        saveSettings();
        applySettings();
        speakText(`${t('theme')} ${t('theme_' + theme)}`);
    }

    function setFont(font) {
        GameState.settings.font = font;
        saveSettings();
        applySettings();
        speakText(`${t('setting_font_family')} ${font}`);
    }

    function setTextSpeed(speed) {
        GameState.settings.textSpeed = speed;
        currentTextSpeed = speed;
        saveSettings();
        const speedText = speed === TextSpeed.Fast ? t('fast') : speed === TextSpeed.Normal ? t('normal') : t('slow');
        speakText(`${t('setting_text_speed')} ${speedText}`);
    }

    function resetSettings() {
        if (confirm(currentLanguage === 'sv' ? 'r du sker p att du vill terstlla alla instllningar?' : 'Are you sure you want to reset all settings?')) {
            localStorage.removeItem(SETTINGS_KEY);
            GameState.settings = loadSettings();
            applySettings();
            speakText(currentLanguage === 'sv' ? 'Instllningar terstllda' : 'Settings reset');
        }
    }

    function switchLanguage(newLang) {
        currentLanguage = newLang;
        updateLanguage();
        speakText(newLang === 'sv' ? 'Sprk bytt till svenska' : 'Language switched to English');
    }

    function readCurrentText() {
        const textElement = document.querySelector('#content p, #intro-text-container, .modal-content p');
        if (textElement) {
            speakText(textElement.textContent);
        } else {
            speakText('No text found to read');
        }
    }

    function showVoiceCommands() {
        const lang = currentLanguage;
        const isSwedish = lang === 'sv';
        let commands = [];
        
        if (lang === 'sv') {
            commands = [
                'Navigering: instllningar, paus, teruppta, huvudmeny, stng',
                'Tillgnglighet: kontrast av/medium/hg/maximum, text liten/normal/stor/extra stor/mycket stor',
                'Rrelse: rrelse full/reducerad/minimal/ingen',
                'Ljudbeskrivningar: av/grundlggande/detaljerad/omfattande',
                'Tangentbord: grundlggande/frbttrad/fullstndig',
                'Fokus: subtil/tydlig/kraftig',
                'Frgblind: ingen/protanopi/deuteranopi/tritanopi/fullstndig',
                'Rstkommandon: rst av/grundlggande/avancerad/fullstndig',
                'Frstoring: av/en och halv/tv/tre/anpassad',
                'Vxlingar: skrmlsare p/av, dyslexitypsnitt p/av, automatisk scroll p/av',
                'Tal: tal lngsamt/normalt/snabbt/mycket snabbt',
                'UI: ui liten/normal/stor/extra stor',
                'Tema: tema grn/gul/bl',
                'Typsnitt: typsnitt space mono/courier',
                'Ljud: ljud p/av, effekter p/av',
                'Visuellt: crt effekt p/av, frgblindlge p/av',
                'Spel: nytt spel, ladda spel, spara spel, terstll instllningar',
                'Lsning: ls text, sluta lsa',
                'Sprk: byt till engelska',
                'Sg hjlp fr att hra denna lista igen'
            ];
        } else {
            commands = [
                'Navigation: settings, pause, resume, main menu, close',
                'Accessibility: contrast off/medium/high/maximum, text small/normal/large/extra large/very large',
                'Motion: motion full/reduced/minimal/none',
                'Audio descriptions: off/basic/detailed/comprehensive',
                'Keyboard: basic/enhanced/full',
                'Focus: subtle/clear/bold',
                'Colorblind: none/protanopia/deuteranopia/tritanopia/full',
                'Voice commands: voice off/basic/advanced/full',
                'Magnification: off/one and half/two/three/custom',
                'Toggles: screen reader on/off, dyslexia font on/off, auto scroll on/off',
                'Speech: speech slow/normal/fast/very fast',
                'UI: ui small/normal/large/extra large',
                'Theme: theme green/amber/blue',
                'Font: font space mono/courier',
                'Sound: sound on/off, effects on/off',
                'Visual: crt effect on/off, colorblind mode on/off',
                'Game: new game, load game, save game, reset settings',
                'Reading: read text, stop reading',
                'Language: switch to swedish',
                'Say help to hear this list again'
            ];
        }
        
        // Create visual display of all commands
        const commandsHtml = commands.map(cmd => `<li class="text-sm text-gray-300 mb-2"> ${cmd}</li>`).join('');
        
        const voiceCommandsModal = `
        <h2 class="text-xl mb-4 title-font text-cyan-400">${isSwedish ? 'Alla Rstkommandon' : 'All Voice Commands'}</h2>
        <div class="max-h-96 overflow-y-auto bg-gray-800 p-4 rounded-lg">
            <h3 class="text-lg text-cyan-300 mb-3">${isSwedish ? 'Tillgngliga Kommandon' : 'Available Commands'}:</h3>
            <ul class="space-y-1">
                ${commandsHtml}
            </ul>
        </div>
        
        <div class="flex gap-3 mt-6">
            <button id="speak-commands-btn" class="button bg-blue-600 hover:bg-blue-700">
                ${isSwedish ? 'Ls Upp Kommandon' : 'Speak Commands'}
            </button>
            <button id="go-back-voice-btn" class="button bg-gray-600 hover:bg-gray-700">
                ${isSwedish ? 'G Tillbaka' : 'Go Back'}
            </button>
        </div>`;
        
        showModal(voiceCommandsModal, true);
        
        // Speak commands button
        const speakBtn = document.getElementById('speak-commands-btn');
        if (speakBtn) {
            speakBtn.onclick = () => {
                const fullCommandList = [t('voice_commands_available') + ':', ...commands];
                speakText(fullCommandList.join('. '));
            };
        }
        
        // Go back button
        const goBackBtn = document.getElementById('go-back-voice-btn');
        if (goBackBtn) {
            goBackBtn.onclick = () => {
                hideModal();
                showVoiceControlSettings();
            };
        }
    }

    function startVoiceControl() {
        if (voiceRecognition && GameState.settings.voiceCommands) {
            // Update language before starting
            voiceRecognition.lang = currentLanguage === 'sv' ? 'sv-SE' : 'en-US';
            voiceRecognition.start();
            voiceControlActive = true;
            speakText('Voice control activated. Say help for commands.');
        }
    }

    function stopVoiceControl() {
        if (voiceRecognition) {
            voiceRecognition.stop();
            voiceControlActive = false;
            speakText('Voice control deactivated.');
        }
    }

    function showVoiceControlSettings() {
        const lang = currentLanguage;
        const isSwedish = lang === 'sv';
        
        // Comprehensive command lists
        const commandCategories = {
            'en': {
                'Navigation': [
                    'settings - Open settings menu',
                    'pause - Pause the game',
                    'resume - Resume the game',
                    'main menu - Return to main menu',
                    'close - Close current dialog',
                    'help - Show voice commands'
                ],
                'Accessibility - Contrast': [
                    'contrast off - Disable high contrast',
                    'contrast medium - Medium contrast level',
                    'contrast high - High contrast level',
                    'contrast maximum - Maximum contrast level'
                ],
                'Accessibility - Text Size': [
                    'text small - Small text size',
                    'text normal - Normal text size',
                    'text large - Large text size',
                    'text extra large - Extra large text size',
                    'text very large - Very large text size'
                ],
                'Accessibility - Motion': [
                    'motion full - Full motion effects',
                    'motion reduced - Reduced motion effects',
                    'motion minimal - Minimal motion effects',
                    'motion none - No motion effects'
                ],
                'Accessibility - Audio Descriptions': [
                    'audio descriptions off - Disable audio descriptions',
                    'audio descriptions basic - Basic audio descriptions',
                    'audio descriptions detailed - Detailed audio descriptions',
                    'audio descriptions comprehensive - Comprehensive audio descriptions'
                ],
                'Accessibility - Keyboard Navigation': [
                    'keyboard basic - Basic keyboard navigation',
                    'keyboard enhanced - Enhanced keyboard navigation',
                    'keyboard full - Full keyboard navigation'
                ],
                'Accessibility - Focus Indicators': [
                    'focus subtle - Subtle focus indicators',
                    'focus clear - Clear focus indicators',
                    'focus bold - Bold focus indicators'
                ],
                'Accessibility - Colorblind Support': [
                    'colorblind none - No colorblind support',
                    'colorblind protanopia - Protanopia support',
                    'colorblind deuteranopia - Deuteranopia support',
                    'colorblind tritanopia - Tritanopia support',
                    'colorblind full - Full colorblind support'
                ],
                'Accessibility - Voice Commands': [
                    'voice off - Disable voice commands',
                    'voice basic - Basic voice commands',
                    'voice advanced - Advanced voice commands',
                    'voice full - Full voice commands'
                ],
                'Accessibility - Magnification': [
                    'magnification off - Disable magnification',
                    'magnification one and half - 1.5x magnification',
                    'magnification two - 2x magnification',
                    'magnification three - 3x magnification',
                    'magnification custom - Custom magnification'
                ],
                'Accessibility - Toggles': [
                    'screen reader on/off - Toggle screen reader',
                    'dyslexia font on/off - Toggle dyslexia-friendly font',
                    'auto scroll on/off - Toggle automatic scrolling',
                    'click feedback on/off - Toggle click sound feedback',
                    'simplified ui on/off - Toggle simplified interface',
                    'sticky keys on/off - Toggle sticky keys',
                    'one hand mode on/off - Toggle one-handed mode',
                    'visual notifications on/off - Toggle visual notifications',
                    'audio cues on/off - Toggle audio cues',
                    'reading support on/off - Toggle reading assistance',
                    'seizure protection on/off - Toggle seizure protection',
                    'haptic feedback on/off - Toggle haptic feedback',
                    'gesture controls on/off - Toggle gesture controls',
                    'cognitive load on/off - Toggle cognitive load reduction',
                    'eye tracking on/off - Toggle eye tracking',
                    'switch control on/off - Toggle switch control',
                    'timeout extensions on/off - Toggle timeout extensions',
                    'memory assistance on/off - Toggle memory assistance'
                ],
                'Speech & TTS': [
                    'speech slow - Set speech to slow speed',
                    'speech normal - Set speech to normal speed',
                    'speech fast - Set speech to fast speed',
                    'speech very fast - Set speech to very fast speed'
                ],
                'User Interface': [
                    'ui small - Small UI scale',
                    'ui normal - Normal UI scale',
                    'ui large - Large UI scale',
                    'ui extra large - Extra large UI scale'
                ],
                'Themes & Appearance': [
                    'theme green - Green color theme',
                    'theme amber - Amber color theme',
                    'theme blue - Blue color theme'
                ],
                'Fonts': [
                    'font space mono - Space Mono font',
                    'font courier - Courier Prime font'
                ],
                'Text Speed': [
                    'text speed slow - Slow text display',
                    'text speed normal - Normal text display',
                    'text speed fast - Fast text display'
                ],
                'Sound Controls': [
                    'sound on/off - Toggle master sound',
                    'effects on/off - Toggle sound effects',
                    'awareness sound on/off - Toggle awareness sounds',
                    'sanity sound on/off - Toggle sanity sounds'
                ],
                'Visual Effects': [
                    'crt effect on/off - Toggle CRT screen effect',
                    'colorblind mode on/off - Toggle colorblind mode'
                ],
                'Game Actions': [
                    'new game - Start a new game',
                    'load game - Load saved game',
                    'save game - Save current game',
                    'reset settings - Reset all settings to default'
                ],
                'Reading Commands': [
                    'read text - Read current text aloud',
                    'stop reading - Stop text-to-speech'
                ],
                'Language': [
                    'switch to swedish - Change language to Swedish',
                    'switch to english - Change language to English'
                ]
            },
            'sv': {
                'Navigering': [
                    'instllningar - ppna instllningsmeny',
                    'paus - Pausa spelet',
                    'teruppta - teruppta spelet',
                    'huvudmeny - tervnd till huvudmeny',
                    'stng - Stng aktuell dialog',
                    'hjlp - Visa rstkommandon'
                ],
                'Tillgnglighet - Kontrast': [
                    'kontrast av - Stng av hg kontrast',
                    'kontrast medium - Medium kontrastniv',
                    'kontrast hg - Hg kontrastniv',
                    'kontrast maximum - Maximum kontrastniv'
                ],
                'Tillgnglighet - Textstorlek': [
                    'text liten - Liten textstorlek',
                    'text normal - Normal textstorlek',
                    'text stor - Stor textstorlek',
                    'text extra stor - Extra stor textstorlek',
                    'text mycket stor - Mycket stor textstorlek'
                ],
                'Tillgnglighet - Rrelse': [
                    'rrelse full - Fullstndiga rrelseeffekter',
                    'rrelse reducerad - Reducerade rrelseeffekter',
                    'rrelse minimal - Minimala rrelseeffekter',
                    'rrelse ingen - Inga rrelseeffekter'
                ],
                'Tillgnglighet - Ljudbeskrivningar': [
                    'ljudbeskrivningar av - Stng av ljudbeskrivningar',
                    'ljudbeskrivningar grundlggande - Grundlggande ljudbeskrivningar',
                    'ljudbeskrivningar detaljerad - Detaljerade ljudbeskrivningar',
                    'ljudbeskrivningar omfattande - Omfattande ljudbeskrivningar'
                ],
                'Tillgnglighet - Tangentbordsnavigering': [
                    'tangentbord grundlggande - Grundlggande tangentbordsnavigering',
                    'tangentbord frbttrad - Frbttrad tangentbordsnavigering',
                    'tangentbord fullstndig - Fullstndig tangentbordsnavigering'
                ],
                'Tillgnglighet - Fokusindikatorer': [
                    'fokus subtil - Subtila fokusindikatorer',
                    'fokus tydlig - Tydliga fokusindikatorer',
                    'fokus kraftig - Kraftiga fokusindikatorer'
                ],
                'Tillgnglighet - Frgblindstd': [
                    'frgblind ingen - Inget frgblindstd',
                    'frgblind protanopi - Protanopi-std',
                    'frgblind deuteranopi - Deuteranopi-std',
                    'frgblind tritanopi - Tritanopi-std',
                    'frgblind fullstndig - Fullstndigt frgblindstd'
                ],
                'Tillgnglighet - Rstkommandon': [
                    'rst av - Stng av rstkommandon',
                    'rst grundlggande - Grundlggande rstkommandon',
                    'rst avancerad - Avancerade rstkommandon',
                    'rst fullstndig - Fullstndiga rstkommandon'
                ],
                'Tillgnglighet - Frstoring': [
                    'frstoring av - Stng av frstoring',
                    'frstoring en och halv - 1,5x frstoring',
                    'frstoring tv - 2x frstoring',
                    'frstoring tre - 3x frstoring',
                    'frstoring anpassad - Anpassad frstoring'
                ],
                'Tillgnglighet - Vxlingar': [
                    'skrmlsare p/av - Vxla skrmlsare',
                    'dyslexitypsnitt p/av - Vxla dyslexi-vnligt typsnitt',
                    'automatisk scroll p/av - Vxla automatisk rullning',
                    'klickljud p/av - Vxla klickljudsterkoppling',
                    'frenklat ui p/av - Vxla frenklat grnssnitt',
                    'klistriga tangenter p/av - Vxla klistriga tangenter',
                    'enhandslge p/av - Vxla enhandslge',
                    'visuella notifieringar p/av - Vxla visuella notifieringar',
                    'ljudsignaler p/av - Vxla ljudsignaler',
                    'lsstd p/av - Vxla lsassistans',
                    'anfallsskydd p/av - Vxla anfallsskydd',
                    'haptisk terkoppling p/av - Vxla haptisk terkoppling',
                    'gestkontroller p/av - Vxla gestkontroller',
                    'kognitiv belastning p/av - Vxla kognitiv belastningsminskning',
                    'gonsprning p/av - Vxla gonsprning',
                    'vxelkontroll p/av - Vxla vxelkontroll',
                    'timeout frlngningar p/av - Vxla timeout-frlngningar',
                    'minnesassistans p/av - Vxla minnesassistans'
                ],
                'Tal & TTS': [
                    'tal lngsamt - Stt tal till lngsam hastighet',
                    'tal normalt - Stt tal till normal hastighet',
                    'tal snabbt - Stt tal till snabb hastighet',
                    'tal mycket snabbt - Stt tal till mycket snabb hastighet'
                ],
                'Anvndargrnssnitt': [
                    'ui liten - Liten UI-skala',
                    'ui normal - Normal UI-skala',
                    'ui stor - Stor UI-skala',
                    'ui extra stor - Extra stor UI-skala'
                ],
                'Teman & Utseende': [
                    'tema grn - Grnt frgtema',
                    'tema gul - Gult frgtema',
                    'tema bl - Bltt frgtema'
                ],
                'Typsnitt': [
                    'typsnitt space mono - Space Mono typsnitt',
                    'typsnitt courier - Courier Prime typsnitt'
                ],
                'Texthastighet': [
                    'texthastighet lngsam - Lngsam textvisning',
                    'texthastighet normal - Normal textvisning',
                    'texthastighet snabb - Snabb textvisning'
                ],
                'Ljudkontroller': [
                    'ljud p/av - Vxla huvudljud',
                    'effekter p/av - Vxla ljudeffekter',
                    'medvetenhet ljud p/av - Vxla medvetenhetljud',
                    'sinnesro ljud p/av - Vxla sinnesroljud'
                ],
                'Visuella Effekter': [
                    'crt effekt p/av - Vxla CRT-skrmeffekt',
                    'frgblindlge p/av - Vxla frgblindlge'
                ],
                'Spelhandlingar': [
                    'nytt spel - Starta ett nytt spel',
                    'ladda spel - Ladda sparat spel',
                    'spara spel - Spara nuvarande spel',
                    'terstll instllningar - terstll alla instllningar till standard'
                ],
                'Lskommandon': [
                    'ls text - Ls aktuell text hgt',
                    'sluta lsa - Stoppa text-till-tal'
                ],
                'Sprk': [
                    'byt till engelska - ndra sprk till engelska',
                    'byt till svenska - ndra sprk till svenska'
                ]
            }
        };

        const currentCommands = commandCategories[lang] || commandCategories['en'];
        
        let commandsHtml = '';
        Object.entries(currentCommands).forEach(([category, commands]) => {
            commandsHtml += `<div class="mb-4">
                <h4 class="text-md text-cyan-300 font-semibold mb-2">${category}:</h4>
                <ul class="text-xs space-y-1 text-gray-300 ml-4">`;
            commands.forEach(command => {
                commandsHtml += `<li> ${command}</li>`;
            });
            commandsHtml += `</ul></div>`;
        });

        const voiceSettingsText = `
        <h2 class="text-xl mb-4 title-font text-cyan-400">${isSwedish ? 'Rststyrningsinstllningar' : 'Voice Control Settings'}</h2>
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <span>${isSwedish ? 'Rststyrning Aktiv' : 'Voice Control Active'}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="voice-control-toggle" ${GameState.settings.voiceCommands ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="space-y-2 max-h-96 overflow-y-auto">
                <h3 class="text-lg text-cyan-300">${isSwedish ? 'Tillgngliga Kommandon' : 'Available Commands'}:</h3>
                ${commandsHtml}
            </div>
            
            <div class="flex gap-2 flex-wrap">
                <button id="test-voice-btn" class="button">${isSwedish ? 'Testa Rst' : 'Test Voice'}</button>
                <button id="show-all-commands-btn" class="button">${isSwedish ? 'Hr Alla Kommandon' : 'Hear All Commands'}</button>
                <button id="voice-demo-btn" class="button">${isSwedish ? 'Demo Kommandon' : 'Demo Commands'}</button>
            </div>
            
            <div class="text-xs text-gray-400 bg-gray-800 p-3 rounded">
                <p><strong>${isSwedish ? 'Tips' : 'Tips'}:</strong></p>
                <ul class="list-disc ml-4 space-y-1">
                    <li>${isSwedish ? 'Tala tydligt och i normal hastighet' : 'Speak clearly and at normal speed'}</li>
                    <li>${isSwedish ? 'Sg "hjlp" fr att hra alla kommandon' : 'Say "help" to hear all commands'}</li>
                    <li>${isSwedish ? 'Rststyrning fungerar bst i tyst milj' : 'Voice control works best in quiet environments'}</li>
                    <li>${isSwedish ? 'Du kan avbryta tal med "sluta lsa"' : 'You can interrupt speech with "stop reading"'}</li>
                </ul>
            </div>
        </div>
        <button class="close-modal-btn button mt-6">${isSwedish ? 'Stng' : 'Close'}</button>`;
        
        showModal(voiceSettingsText, true);
        
        // Setup voice control toggle
        const voiceToggle = document.getElementById('voice-control-toggle');
        if (voiceToggle) {
            voiceToggle.onchange = (e) => {
                GameState.settings.voiceCommands = e.target.checked;
                saveSettings();
                if (e.target.checked) {
                    if (initializeVoiceControl()) {
                        startVoiceControl();
                    }
                } else {
                    stopVoiceControl();
                }
            };
        }
        
        // Test voice button
        const testVoiceBtn = document.getElementById('test-voice-btn');
        if (testVoiceBtn) {
            testVoiceBtn.onclick = () => {
                const testMessage = isSwedish ? 
                    'Rststyrning fungerar korrekt. Du kan nu anvnda rstkommandon fr att styra spelet.' :
                    'Voice control is working correctly. You can now use voice commands to control the game.';
                speakText(testMessage);
            };
        }
        
        // Show all commands button
        const showCommandsBtn = document.getElementById('show-all-commands-btn');
        if (showCommandsBtn) {
            showCommandsBtn.onclick = () => {
                showVoiceCommands();
            };
        }
        
        // Demo commands button
        const demoBtnElement = document.getElementById('voice-demo-btn');
        if (demoBtnElement) {
            demoBtnElement.onclick = () => {
                const demoCommands = isSwedish ? [
                    'Jag kommer att demonstrera ngra rstkommandon...',
                    'Sg "tema bl" fr att ndra frgtema',
                    'Sg "text stor" fr att gra texten strre',
                    'Sg "kontrast hg" fr att aktivera hg kontrast',
                    'Sg "tal snabbt" fr att ka talhastigheten',
                    'Sg "hjlp" fr att hra alla tillgngliga kommandon',
                    'Demo avslutad. Prova att sga ngot av dessa kommandon nu!'
                ] : [
                    'I will demonstrate some voice commands...',
                    'Say "theme blue" to change the color theme',
                    'Say "text large" to make text bigger',
                    'Say "contrast high" to enable high contrast',
                    'Say "speech fast" to increase speech speed',
                    'Say "help" to hear all available commands',
                    'Demo complete. Try saying one of these commands now!'
                ];
                
                let demoIndex = 0;
                const runDemo = () => {
                    if (demoIndex < demoCommands.length) {
                        speakText(demoCommands[demoIndex]);
                        demoIndex++;
                        setTimeout(runDemo, 3000); // Wait 3 seconds between each demo command
                    }
                };
                runDemo();
            };
        }
        
        // Close button
        const closeBtn = document.querySelector('.close-modal-btn');
        if (closeBtn) {
            closeBtn.onclick = () => {
                hideModal();
                showSettingsModal();
            };
        }
    }

    // Initialize voice control automatically when site loads
    document.addEventListener('DOMContentLoaded', () => {
        // Automatically enable voice commands
        if (!GameState.settings) {
            GameState.settings = loadSettings();
        }
        
        // Auto-enable voice control
        GameState.settings.voiceCommands = true;
        saveSettings();
        
        // Initialize voice control with user interaction requirement
        const initVoiceAfterInteraction = () => {
            if (initializeVoiceControl()) {
                startVoiceControl();
            } else {
                console.warn('Voice control not supported in this browser');
            }
        };
        
        // Wait for user interaction before starting voice control
        const userInteractionHandler = () => {
            initVoiceAfterInteraction();
            document.removeEventListener('click', userInteractionHandler);
            document.removeEventListener('keydown', userInteractionHandler);
            document.removeEventListener('touchstart', userInteractionHandler);
        };
        
        document.addEventListener('click', userInteractionHandler);
        document.addEventListener('keydown', userInteractionHandler);
        document.addEventListener('touchstart', userInteractionHandler);
    });

    // === VIEWPORT & RESPONSIVE HANDLING ===
    function updateViewportUnits() {
        // Get the actual viewport dimensions
        const vh = window.innerHeight * 0.01;
        const vw = window.innerWidth * 0.01;
        
        // Set CSS custom properties
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        document.documentElement.style.setProperty('--vw', `${vw}px`);
        
        // Handle mobile viewport issues
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            // On mobile, use window.innerHeight for more accurate viewport height
            document.documentElement.style.setProperty('--mobile-vh', `${window.innerHeight}px`);
            
            // Apply mobile-specific fixes
            const appContainer = document.getElementById('app-container');
            if (appContainer) {
                appContainer.style.height = `${window.innerHeight}px`;
                appContainer.style.maxHeight = `${window.innerHeight}px`;
            }
        }
    }
    
    // Handle orientation changes and resize events
    function handleResize() {
        updateViewportUnits();
        
        // Additional responsive adjustments
        const width = window.innerWidth;
        const height = window.innerHeight;
        const aspectRatio = width / height;
        
        // Adjust for ultra-wide screens
        if (aspectRatio > 2.1) {
            document.body.classList.add('ultra-wide');
        } else {
            document.body.classList.remove('ultra-wide');
        }
        
        // Adjust for very tall screens  
        if (aspectRatio < 0.6) {
            document.body.classList.add('very-tall');
        } else {
            document.body.classList.remove('very-tall');
        }
        
        // Adjust for small screens
        if (width < 480 || height < 600) {
            document.body.classList.add('small-screen');
        } else {
            document.body.classList.remove('small-screen');
        }
    }
    
    // Initial setup
    updateViewportUnits();
    handleResize();
    
    // Event listeners for viewport changes
    window.addEventListener('resize', handleResize);
    window.addEventListener('orientationchange', () => {
        // Delay to account for browser UI changes
        setTimeout(handleResize, 100);
    });
    
    // Handle iOS Safari viewport issues
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        window.addEventListener('scroll', (e) => {
            e.preventDefault();
        }, { passive: false });
        
        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    }
    
    // Handle screen orientation lock if supported
    if (screen.orientation && screen.orientation.lock) {
        // Allow both orientations but handle them gracefully
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                updateViewportUnits();
                handleResize();
            }, 500); // Give time for orientation change to complete
        });
    }
    </script>
</body>
</html>
