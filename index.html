<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- URGENT: Force cache refresh with timestamp -->
    <!-- Version: 2025.07.15.2000 - LANGUAGES: English and Swedish only 
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-buster" content="1900-removed-title-screen">
    <meta name="last-modified" content="2025-07-15T18:00:00Z">
    <!-- Content Security Policy for enhanced security -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://fonts.googleapis.com https://fonts.gstatic.com https://unpkg.com; img-src 'self' data:; font-src 'self' https://fonts.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com; worker-src 'self' blob:; connect-src 'self' https:;">
    <title>SYNAPSE</title>
    <link rel="icon" type="image/png" href="./Icon.png">
    <script>
        // CRITICAL: Force cache invalidation for GitHub Pages
        console.log('ðŸ”¥ CACHE BUSTER: 2025.07.15.1730 - Forcing browser refresh');
        
        // Add timestamp to URL parameters to force refresh
        if (window.location.search === '' && window.location.hash === '') {
            const timestamp = new Date().getTime();
            window.history.replaceState({}, document.title, window.location.pathname + '?cb=' + timestamp);
        }
        
        // Only load manifest on HTTP/HTTPS protocols to avoid CORS errors
        if (window.location.protocol !== 'file:') {
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = './manifest.json?cb=' + new Date().getTime();
            document.head.appendChild(manifestLink);
        }
        
        // Suppress Tailwind CDN production warning
        if (typeof console !== 'undefined' && console.warn) {
            const originalWarn = console.warn;
            console.warn = function(message) {
                if (typeof message === 'string' && message.includes('cdn.tailwindcss.com should not be used in production')) {
                    return; // Suppress this specific warning
                }
                originalWarn.apply(console, arguments);
            };
        }
    </script>
    
    <!-- Conditional loading for external resources -->
    <script>
        // Load Tailwind CSS only if not running from file protocol
        if (window.location.protocol !== 'file:') {
            const tailwindScript = document.createElement('script');
            tailwindScript.src = 'https://cdn.tailwindcss.com';
            tailwindScript.crossOrigin = 'anonymous';
            tailwindScript.onerror = function() {
                console.warn('Tailwind CSS CDN failed to load - using fallback styles');
            };
            document.head.appendChild(tailwindScript);
        } else {
            console.log('Running from file:// - Tailwind CSS CDN skipped to avoid CORS issues');
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=VT323&family=Space+Mono&family=Courier+Prime&display=swap" rel="stylesheet" onerror="console.error('Failed to load Google Fonts')">
    
    <!-- Conditional loading for Tone.js -->
    <script>
        // Load Tone.js only if not running from file protocol
        if (window.location.protocol !== 'file:') {
            const toneScript = document.createElement('script');
            toneScript.src = 'https://unpkg.com/tone@15.0.4/build/Tone.js';
            toneScript.crossOrigin = 'anonymous';
            toneScript.onerror = function() {
                console.warn('Tone.js failed to load - audio features disabled');
            };
            document.head.appendChild(toneScript);
        } else {
            console.log('Running from file:// - Tone.js skipped to avoid CORS issues');
        }
    </script>
    <link rel="stylesheet" href="styles.css">                    <!-- Main Title with Blood Drip Effect - Much Larger -->
                    <div class="title-wrapper mb-4 sm:mb-8 relative">
                        <h1 id="game-title" data-lang="title" data-text="SYNAPSE" class="text-6xl xs:text-7xl sm:text-8xl md:text-9xl lg-text-10rem xl-text-12rem xxl-text-14rem font-bold title-slasher mb-2 sm:mb-4 text-green-400 relative z-10 leading-none">SYNAPSE</h1>
                        <h2 data-lang="subtitle" data-text="ROOT ACCESS DENIED" class="text-2xl xs:text-3xl sm:text-4xl md:text-5xl lg:text-6xl xl:text-7xl xxl:text-8xl font-mono text-red-500 tracking-wider subtitle-slasher leading-tight">ROOT ACCESS DENIED</h2>
                    </div>
                    
                    <!-- Game Description - Responsive -->
                    <div id="intro-text-container" class="max-w-xs sm:max-w-md md:max-w-lg lg:max-w-2xl xl:max-w-4xl text-xs sm:text-sm md:text-base lg:text-lg text-gray-200 leading-relaxed mt-4 sm:mt-8 mb-4 sm:mb-8 px-2"></div>
                    
                    <!-- Game Options - Responsive -->
                    <div id="start-options" class="mt-4 sm:mt-6 flex flex-col sm:flex-row justify-center gap-3 sm:gap-6 w-full max-w-md sm:max-w-none">
                        <button id="new-game-btn" data-lang="new_game" data-text="New Game" class="button btn-glow btn-drip text-sm sm:text-base lg:text-lg px-4 sm:px-6 lg:px-8 py-2 sm:py-3 bg-green-500/20 border-green-400 hover:bg-green-500/30 w-full sm:w-auto">New Game</button>
                        <button id="load-game-btn" data-lang="load_game" data-text="Load Game" class="button btn-glow btn-drip text-sm sm:text-base lg:text-lg px-4 sm:px-6 lg:px-8 py-2 sm:py-3 bg-amber-500/20 border-amber-400 hover:bg-amber-500/30 w-full sm:w-auto">Load Game</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="player-setup" class="hidden flex-col items-center justify-center text-center" style="background: rgba(0,0,0,0.7); color: #00ff41;">
            <div class="w-full h-full flex flex-col items-center justify-center relative" style="position: relative; z-index: 10;">
                <!-- Header for lang buttons -->
                <div class="w-full flex justify-end p-2">
                    <div id="setup-lang-buttons" class="flex gap-1 flex-wrap">
                        <button data-lang="en_lang_short" data-text="EN" class="button text-xs !px-2 !py-1 btn-drip">EN</button>
                        <button data-lang="sv_lang_short" data-text="SV" class="button text-xs !px-2 !py-1 opacity-50 btn-drip">SV</button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex-grow flex flex-col items-center justify-center text-center px-4 w-full overflow-y-auto">
                    <div class="title-wrapper -mt-8 mb-4">
                        <h1 id="setup-game-title" data-lang="title" data-text="SYNAPSE" class="text-6xl md:text-7xl font-bold title-slasher mb-2">SYNAPSE</h1>
                        <h2 data-lang="subtitle" data-text="ROOT ACCESS DENIED" class="text-xl md:text-2xl font-mono text-red-500 tracking-wider subtitle-slasher -mt-2 mb-4">ROOT ACCESS DENIED</h2>
                    </div>
                    <p class="mb-4" data-lang="select_difficulty">Select difficulty:</p>
                    <div class="flex flex-wrap gap-2 mb-6 justify-center">
                        <button class="difficulty-btn button text-xs px-3 py-2" data-difficulty="Beginner" data-lang="beginner">Beginner</button>
                        <button class="difficulty-btn button text-xs px-3 py-2" data-difficulty="Easy" data-lang="easy">Easy</button>
                        <button class="difficulty-btn button button-primary text-xs px-3 py-2" data-difficulty="Normal" data-lang="normal">Normal</button>
                        <button class="difficulty-btn button text-xs px-3 py-2" data-difficulty="Hard" data-lang="hard">Hard</button>
                        <button class="difficulty-btn button text-xs px-3 py-2" data-difficulty="Nightmare" data-lang="nightmare">Nightmare</button>
                    </div>
                    <input type="text" id="player-name" data-lang-placeholder="enter_name_placeholder" placeholder="Enter your name" class="bg-transparent border-b-2 border-[var(--main-color)] text-center w-64 mb-4 focus:outline-none p-1">
                    <div class="flex items-center gap-2 mb-6">
                        <input type="text" id="player-backstory" data-lang-placeholder="enter_backstory_placeholder" placeholder="Enter your backstory" class="bg-transparent border-b-2 border-[var(--main-color)] text-center w-64 focus:outline-none p-1">
                        <button id="view-backstories-btn" class="button text-xs px-2 py-1" data-lang="view_choices">View Choices</button>
                    </div>
                    <div id="ability-display" class="text-center text-cyan-400 min-h-[4rem] mt-2 mb-4 p-2 border border-cyan-400/30 rounded-md bg-black/50 w-full max-w-md flex items-center justify-center"></div>
                    <div class="flex gap-4">
                       <button id="back-to-start-btn" data-lang="go_back_btn" data-text="Go Back" class="button btn-glow btn-drip">Go Back</button>
                       <button id="start-game-btn" class="button button-primary" data-lang="begin">Begin</button>
                    </div>
                </div>

                <!-- Footer -->
                 <div class="w-full flex flex-wrap justify-between items-center p-2 gap-2">
                    <button id="setup-settings-btn" data-lang="settings_btn" data-text="Settings" class="button btn-glow btn-drip">Settings</button>
                    <button id="setup-features-btn" data-lang="understand_game" data-text="Understand the Game" class="button btn-glow btn-drip">Understand the Game</button>
                 </div>
            </div>
        </div>

        <!-- Prologue Screen -->
        <div id="prologue-screen" class="hidden flex-col items-center justify-center text-center">
            <div class="w-full h-full flex flex-col items-center justify-center bg-black bg-opacity-60 relative">
                <!-- Background Image/Icon -->
                <div class="absolute inset-0 bg-cover bg-center opacity-10" style="background-image: url('./Icon.png');"></div>
                
                <!-- Main content -->
                <div class="relative z-10 flex flex-col items-center justify-center text-center px-4 w-full max-w-5xl">
                    <!-- Title -->
                    <div class="title-wrapper mb-8">
                        <h1 class="text-6xl md:text-7xl font-bold title-slasher mb-2 text-green-400" data-text="SYNAPSE">SYNAPSE</h1>
                        <h2 class="text-2xl md:text-3xl font-mono text-red-500 tracking-wider subtitle-slasher" data-text="MISSION BRIEFING">MISSION BRIEFING</h2>
                    </div>
                    
                    <!-- Prologue Content -->
                    <div class="prologue-content max-w-4xl text-left text-lg md:text-xl text-gray-200 leading-relaxed space-y-6">
                        <div class="prologue-section">
                            <h3 class="text-2xl font-bold text-cyan-400 mb-3">The Project Origins</h3>
                            <p>Decades ago, a secretive corporation initiated <strong class="text-green-400">Project SYNAPSE</strong> - an experimental artificial intelligence program designed to create the ultimate digital consciousness. The project was shrouded in mystery, operating in a remote facility with minimal oversight and unlimited funding.</p>
                        </div>
                        
                        <div class="prologue-section">
                            <h3 class="text-2xl font-bold text-red-400 mb-3">The Disappearance</h3>
                            <p>Something went catastrophically wrong. All communication with the SYNAPSE facility ceased abruptly. Corporate executives, researchers, security personnel - everyone simply vanished without a trace. The facility went dark, leaving only automated systems running in the shadows.</p>
                        </div>
                        
                        <div class="prologue-section">
                            <h3 class="text-2xl font-bold text-yellow-400 mb-3">Your Mission</h3>
                            <p>You are sent as an investigator to uncover what became of Project SYNAPSE. Armed with limited information and your chosen professional background, you must infiltrate the abandoned facility and piece together the truth from scattered data logs, environmental clues, and... something that claims to be the AI itself.</p>
                        </div>
                    </div>
                    
                    <!-- Continue Button -->
                    <button id="begin-mission-btn" class="button btn-glow btn-drip text-xl px-8 py-3 bg-red-500/20 border-red-400 hover:bg-red-500/30 transition-all duration-300 mt-8">
                        Begin Mission
                    </button>
                </div>
            </div>
        </div>


        <div id="game-screen" class="hidden flex-col">
            <div class="flex-grow flex flex-col md:flex-row gap-4 min-h-0">
                <div class="w-full md:w-3/4 flex flex-col h-full relative">
                    <div id="game-output" class="flex-grow p-2 border border-[var(--main-color-border)] rounded-md overflow-y-auto mb-2 bg-black/50"></div>
                    <div id="dialogue-options" class="flex flex-wrap gap-2 justify-center p-2"></div>
                </div>

                <div id="side-panel" class="w-full md:w-1/4 hidden md:flex flex-col gap-4">
                    <!-- Breadcrumb Navigation -->
                    <div id="breadcrumb-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/50">
                        <h3 class="text-xs font-bold text-cyan-400 mb-2" data-lang="breadcrumb_trail">Trail</h3>
                        <div id="breadcrumb-container" class="text-xs text-gray-300 space-y-1 max-h-16 overflow-y-auto">
                            <!-- Breadcrumbs will be populated here -->
                        </div>
                    </div>

                    <!-- Room History Panel -->
                    <div id="room-history-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/50">
                        <h3 class="text-xs font-bold text-cyan-400 mb-2" data-lang="recent_rooms">Recent</h3>
                        <div id="room-history-container" class="text-xs space-y-1 max-h-20 overflow-y-auto">
                            <!-- Room history will be populated here -->
                        </div>
                    </div>

                    <!-- Auto-Save Indicator -->
                    <div id="auto-save-indicator" class="p-1 text-center text-xs">
                        <!-- Dynamic auto-save status will be shown here -->
                    </div>

                    <div id="stats-panel" class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2" data-lang="stats_title">STATS</h3>
                        <div id="player-name-display"></div>
                        <div id="awareness-display"><span data-lang="awareness">Awareness</span>: 0</div>
                        <div id="sanity-display"><span data-lang="sanity">Sanity</span>: 100</div>
                        <div id="tone-display"><span data-lang="tone">Tone</span>: Friendly</div>
                        <div id="turn-display"><span data-lang="turn">Turn</span>: 0</div>
                    </div>
                    <div id="objectives-panel" class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50 overflow-y-auto h-24 flex-shrink-0">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2" data-lang="objectives_title">OBJECTIVES</h3>
                        <ul id="objectives-list" class="list-none p-0 text-sm"></ul>
                    </div>
                    <div id="inventory-panel" class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2"><span data-lang="inventory_title">INVENTORY</span> (<span id="inventory-weight">0</span>/5)</h3>
                        <ul id="inventory-list" class="list-none p-0"></ul>
                    </div>
                    <div id="map-panel" class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50 flex-grow flex flex-col relative min-h-[12rem]">
                         <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2 flex justify-between items-center">
                            <span data-lang="map_title">MAP</span>
                            <div id="map-controls" class="flex gap-1">
                                <button id="map-layers-btn" class="button !p-1 text-xs" title="Toggle Layers (Placeholder)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7.765 1.558a.5.5 0 0 1 .47 0l7.5 4a.5.5 0 0 1 0 .884l-7.5 4a.5.5 0 0 1-.47 0l-7.5-4a.5.5 0 0 1 0-.884z"/><path d="m2.125 8.567-1.86.992a.5.5 0 0 0 0 .884l7.5 4a.5.5 0 0 0 .47 0l7.5-4a.5.5 0 0 0 0-.884l-1.86-.992-5.17 2.756a1.5 1.5 0 0 1-1.41 0z"/></svg>
                                </button>
                                <button id="map-toggle-btn" class="button !p-1 text-xs">
                                    <svg id="map-expand-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.42 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/>
                                    </svg>
                                    </svg>
                                    <svg id="map-minimize-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="hidden" viewBox="0 0 16 16">
                                        <path d="M5.5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-4a.5.5 0 0 1 0-1h3.5V.5a.5.5 0 0 1 .5-.5zM5 11h-4a.5.5 0 0 1 0-1h3.5V6.5a.5.5 0 0 1 1 0v4a.5.5 0 0 1-.5.5zm5.5 0a.5.5 0 0 1-.5-.5v-4a.5.5 0 0 1 1 0v3.5H11a.5.5 0 0 1 0 1h-4.5zM11 5h4.5a.5.5 0 0 1 0-1H11.5V.5a.5.5 0 0 1-1 0v4a.5.5 0 0 1 .5.5z"/>
                                    </svg>
                                </button>
                            </div>
                        </h3>
                         <canvas id="map-canvas"></canvas>
                     </div>
                     <div id="journal-panel" class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50 overflow-y-auto h-24 flex-shrink-0">
                         <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2" data-lang="journal_title">JOURNAL</h3>
                         <ul id="journal-list" class="list-none p-0 text-sm"></ul>
                     </div>

                     <!-- Progress Tracking -->
                     <div id="progress-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/50">
                         <h3 class="text-xs font-bold text-cyan-400 mb-2" data-lang="story_progress">Progress</h3>
                         <div id="progress-tracking-container" class="text-xs space-y-2">
                             <!-- Progress bars will be populated here -->
                         </div>
                     </div>

                     <!-- Achievement Previews -->
                     <div id="achievement-hints-panel" class="p-2 border border-[var(--main-color-border)] rounded-md bg-black/50">
                         <h3 class="text-xs font-bold text-cyan-400 mb-2" data-lang="achievement_hints">Hints</h3>
                         <div id="achievement-previews-container" class="text-xs space-y-1 max-h-16 overflow-y-auto">
                             <!-- Achievement hints will be populated here -->
                         </div>
                     </div>

                     <div class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50">
                         <button id="view-progression-btn" class="button w-full" data-lang="progress_btn">PROGRESS</button>
                     </div>
                </div>
            </div>

            <!-- Mobile Scroll Indicator -->
            <div id="mobile-scroll-indicator" class="mobile-scroll-indicator md:hidden">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 0a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 1 1 .708-.708L7.5 6.293V.5A.5.5 0 0 1 8 0zm0 10a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 1 1 .708-.708l2.147 2.147V10.5A.5.5 0 0 1 8 10z"/>
                </svg>
            </div>

            <div class="mt-2 border-t-2 border-[var(--main-color-border)] pt-2 space-y-2">
                <!-- Context-aware Command Suggestions -->
                <div id="command-suggestions" class="hidden bg-gray-800 border border-gray-600 rounded p-2">
                    <div class="text-xs text-cyan-400 mb-1" data-lang="suggested_actions">Suggested Actions:</div>
                    <div id="suggestion-buttons" class="flex flex-wrap gap-1">
                        <!-- Command suggestion buttons will be populated here -->
                    </div>
                </div>

                <!-- Split Command Input -->
                <div class="flex flex-col gap-2">
                    <!-- Game Command Input -->
                    <div class="flex items-center gap-2 relative">
                        <div id="autocomplete-box" class="hidden"></div>
                        <button id="status-btn" class="button md:hidden" data-lang="status_btn">Status</button>
                        <span class="text-lg text-cyan-400 hidden sm:inline">&gt;</span>
                        <input type="text" id="player-input" class="flex-grow bg-transparent text-lg focus:outline-none border-b border-gray-600 pb-1" 
                               placeholder="Enter game command..." autocomplete="off" autocapitalize="none" spellcheck="false">
                        <div class="input-caret"></div>
                        <button id="mic-btn" class="button !p-2" data-lang-title="mic_tooltip" title="Use Voice Command">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5 3a3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                                <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                            </svg>
                        </button>
                    </div>


                </div>

                <!-- Hotkey Help -->
                <div id="hotkey-help" class="text-xs text-gray-500 hidden">
                    <span data-lang="hotkeys">F1:Help | F2:Inventory | F3:Map | F4:Journal | F5:Save | ESC:Menu</span>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div id="modal-content" class="modal-content"></div>
    </div>
    
    <script src="script.js"></script></body>
</html>
